<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yiduoyunq.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="yiduoyunQ">
<meta property="og:url" content="https://yiduoyunq.github.io/page/4/index.html">
<meta property="og:site_name" content="yiduoyunQ">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yiduoyunQ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yiduoyunq.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>yiduoyunQ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yiduoyunQ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/11/go/sync.pool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/go/sync.pool/" class="post-title-link" itemprop="url">go sync.pool</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 13:39:23" itemprop="dateCreated datePublished" datetime="2020-05-11T13:39:23+00:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>sync.pool是用于临时取还对象的池子，对于需要频繁分配和回收的对象使用sync.pool降低GC压力<br>sync.pool是线程安全的，一般设置new函数，在pool中没有对象时创建新对象<br>fmt、encoding/json等都用到sync.pool</p>
<h2 id="fmt用例"><a href="#fmt用例" class="headerlink" title="fmt用例"></a>fmt用例</h2><p>fmt包print类函数使用sync.pool</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Printf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> format<span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">Fprintf</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> <span class="token function">newPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    p<span class="token punctuation">.</span><span class="token function">doPrintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
    n<span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>pp <span class="token punctuation">{</span>
    p <span class="token operator">:=</span> ppFree<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>pp<span class="token punctuation">)</span>
    p<span class="token punctuation">.</span>panicking <span class="token operator">=</span> <span class="token boolean">false</span>
    p<span class="token punctuation">.</span>erroring <span class="token operator">=</span> <span class="token boolean">false</span>
    p<span class="token punctuation">.</span>wrapErrs <span class="token operator">=</span> <span class="token boolean">false</span>
    p<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>
    <span class="token keyword">return</span> p
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>pp<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 初始put的大对象可能经过多个GC后才被回收，避免放回大对象</span>
    <span class="token comment">// See https://golang.org/issue/23199</span>
    <span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">64</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    p<span class="token punctuation">.</span>buf <span class="token operator">=</span> p<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>
    p<span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token boolean">nil</span>
    p<span class="token punctuation">.</span>value <span class="token operator">=</span> reflect<span class="token punctuation">.</span>Value<span class="token punctuation">{</span><span class="token punctuation">}</span>
    p<span class="token punctuation">.</span>wrappedErr <span class="token operator">=</span> <span class="token boolean">nil</span>
    ppFree<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> ppFree <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span>
    New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="pool-test"><a href="#pool-test" class="headerlink" title="pool test"></a>pool test</h2><p>略</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">defer</span> debug<span class="token punctuation">.</span><span class="token function">SetGCPercent</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">SetGCPercent</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>vv <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="pool结构"><a href="#pool结构" class="headerlink" title="pool结构"></a>pool结构</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// poolDequeue是单生产多消费的ring，方法pushHead/popHead/popTail</span>
<span class="token keyword">type</span> poolDequeue <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// head = index of next slot to fill</span>
    <span class="token comment">// tail = index of oldest data in queue</span>
    headTail <span class="token builtin">uint64</span>

    <span class="token comment">// 固定大小的ring，通过head/tail索引</span>
    vals <span class="token punctuation">[</span><span class="token punctuation">]</span>eface
<span class="token punctuation">}</span>

<span class="token keyword">type</span> eface <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    typ<span class="token punctuation">,</span> val unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// poolChain是双向链表的poolDequeue，方法pushHead/popHead/popTail</span>
<span class="token comment">// 第一次pushHead创建poolDequeue初始大小8</span>
<span class="token comment">// 每次pushHead若已用满，新建poolDequeue大小翻倍</span>
<span class="token comment">// popHead从头到尾遍历链表，对每个poolDequeue执行popHead尝试pop</span>
<span class="token comment">// popTail从尾到头遍历链表，对每个poolDequeue执行popTail尝试pop</span>
<span class="token keyword">type</span> poolChain <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    head <span class="token operator">*</span>poolChainElt
    tail <span class="token operator">*</span>poolChainElt
<span class="token punctuation">}</span>

<span class="token keyword">type</span> poolChainElt <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    poolDequeue
    next<span class="token punctuation">,</span> prev <span class="token operator">*</span>poolChainElt
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Pool <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    noCopy noCopy

    local     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 每个P的本地队列，实际类型为[P]poolLocal</span>
    localSize <span class="token builtin">uintptr</span>

    victim     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local from previous cycle</span>
    victimSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of victims array</span>

    <span class="token comment">// pool无可用对象时调用</span>
    New <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> poolLocalInternal <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    private <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 每个P的私有共享，使用时无需加锁</span>
    shared  poolChain   <span class="token comment">// poolChain对象，本地P可以pushHead/popHead，其他P仅能popTail</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> poolLocal <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    poolLocalInternal

    <span class="token comment">// 伪共享，仅占位用，防止在cache line上分配多个poolLocalInternal</span>
    pad <span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>poolLocalInternal<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 1. 优先放poolLocal.private</span>
<span class="token comment">// 2. 其次放poolLocal.shared</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token comment">// Randomly drop x on floor.</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        race<span class="token punctuation">.</span><span class="token function">ReleaseMerge</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    l<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> l<span class="token punctuation">.</span>private <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        l<span class="token punctuation">.</span>private <span class="token operator">=</span> x
        x <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
        race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 根据p获取poolLocal和pid</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在runtime_procUnpin前当前G和P不会被抢占，防止下面pid发生改变</span>
    s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span>
    l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local
    <span class="token comment">// pid &lt; p.local数组长度时，在p.local里查找poolLocal对象</span>
    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid
    <span class="token punctuation">}</span>
    <span class="token comment">// 否则调用pinSlow创建新poolLocal</span>
    <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// pid在pool中没有对应poolLocal对象时，创建新对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 先解除抢占再lock</span>
    allPoolsMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> allPoolsMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    s <span class="token operator">:=</span> p<span class="token punctuation">.</span>localSize
    l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local
    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid <span class="token comment">// 解除抢期间可能p.local已发生变化</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>local <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        allPools <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>allPools<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 创建新poolLocal数组，旧数组进入gc</span>
    size <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    local <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>poolLocal<span class="token punctuation">,</span> size<span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>local<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>local<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">,</span> pid
<span class="token punctuation">}</span>

<span class="token comment">// 1。调用pin获取poolLocal和pid</span>
<span class="token comment">// 2. poolLocal.private为空，依次尝试以下方式</span>
<span class="token comment">// 2.1 从poolLocal.shared队列中获取对象</span>
<span class="token comment">// 2.2 调用getSlow从其他P偷取对象</span>
<span class="token comment">// 2.3 调用new创建对象</span>
<span class="token comment">// 3. poolLocal.private不为空，直接复用对象返回</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
        race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    l<span class="token punctuation">,</span> pid <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private <span class="token comment">// poolLocal.private不为空时，复用对象返回</span>
    l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// poolLocal.private为空，从poolLocal.shared队列中获取对象</span>
        x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getSlow</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
        race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>New <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 用new()函数创建对象</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> x
<span class="token punctuation">}</span>

<span class="token comment">// 当本地P无可用对象，从其他P偷取对象</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">getSlow</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    size <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span>
    locals <span class="token operator">:=</span> p<span class="token punctuation">.</span>local
    <span class="token comment">// 循环尝试从其他P偷取对象，popTail从链表尾获取</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> x
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    size <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> size <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    locals <span class="token operator">=</span> p<span class="token punctuation">.</span>victim
    l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> pid<span class="token punctuation">)</span>
    <span class="token keyword">if</span> x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private<span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>
        <span class="token keyword">return</span> x
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> x
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mark the victim cache as empty for future gets don't bother</span>
    <span class="token comment">// with it.</span>
    atomic<span class="token punctuation">.</span><span class="token function">StoreUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="nocopy"><a href="#nocopy" class="headerlink" title="nocopy"></a>nocopy</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// noCopy 用于嵌入一个结构体中来保证其第一次使用后不会被复制</span>
<span class="token comment">// https://golang.org/issues/8005#issuecomment-190753527</span>
<span class="token keyword">type</span> noCopy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// Lock 是一个空操作用来给 `go vet` 的 -copylocks 静态分析</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="pad"><a href="#pad" class="headerlink" title="pad"></a>pad</h2><ul>
<li><a href="https://www.jianshu.com/p/dc4b5562aad2" title="" target="">什么是cpu cache</a></li>
</ul>
<h2 id="pin-x2F-unpin"><a href="#pin-x2F-unpin" class="headerlink" title="pin/unpin"></a>pin/unpin</h2><p><code>sync.runtime_procPin</code>和<code>sync.runtime_procUnpin</code>通过go:linkname关联到<code>runtime.procPin</code>和<code>runtime.procUnpin</code><br>pin/unpin抢占方式为对m的locks增减，实际GPM调度判断M是否能被抢占的判断就包含<code>mp.locks == 0</code></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    mp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m

    mp<span class="token punctuation">.</span>locks<span class="token operator">++</span>
    <span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">--</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:linkname sync_runtime_procPin sync.runtime_procPin</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">sync_runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:linkname sync_runtime_procUnpin sync.runtime_procUnpin</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">sync_runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// preempt.go</span>
<span class="token comment">// canPreemptM reports whether mp is in a state that is safe to preempt.</span>
<span class="token comment">//</span>
<span class="token comment">// It is nosplit because it has nosplit callers.</span>
<span class="token comment">//</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">canPreemptM</span><span class="token punctuation">(</span>mp <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> mp<span class="token punctuation">.</span>locks <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>mallocing <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>preemptoff <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status <span class="token operator">==</span> _Prunning
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="go-linkname用例"><a href="#go-linkname用例" class="headerlink" title="go:linkname用例"></a>go:linkname用例</h3><p>go:linkname让私有方法可以跨包访问，甚至导出为公开方法</p>
<p>目录结构：</p>
<img src="/2020/05/11/go/sync.pool/go_linkname.png" class="">

<p>go build 默认使用<code>-complete</code>检查方法完整性，直接build会报错：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go build
<span class="token comment"># github.com/yiduoyunQ/test/b</span>
b/b.go:10:6: missing <span class="token keyword">function</span> body<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>通过在b包中添加一个汇编文件，让go build编译器突破方法完整性限制，汇编文件名称任意<br>参考： - <a href="http://sitano.github.io/2016/04/28/golang-private/" title="" target="">How to call private functions (bind to hidden symbols) in GoLang</a></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// a.go</span>
<span class="token keyword">package</span> a

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
    <span class="token boolean">_</span> <span class="token string">"unsafe"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"private func_a in package a"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:linkname b_func_a github.com/yiduoyunQ/test/b.Func_b</span>
<span class="token keyword">func</span> <span class="token function">b_func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// b.go</span>
<span class="token keyword">package</span> b

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token boolean">_</span> <span class="token string">"unsafe"</span>

    <span class="token boolean">_</span> <span class="token string">"github.com/yiduoyunQ/test/a"</span>
<span class="token punctuation">)</span>

<span class="token comment">// 仅有方法名，方法体通过go:linkname在a包中关联</span>
<span class="token keyword">func</span> <span class="token function">Func_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// test.go</span>
<span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/yiduoyunQ/test/b"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用b的公开方法，在b中仅有方法名的申明</span>
    b<span class="token punctuation">.</span><span class="token function">Func_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>输出： <code>private func_a in package a</code></p>
<h2 id="锁竞争"><a href="#锁竞争" class="headerlink" title="锁竞争"></a>锁竞争</h2><p><code>pushHead</code>先取slot再判断是否可插入最后修改</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">pushHead</span><span class="token punctuation">(</span>val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>
    head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tail<span class="token operator">+</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> head <span class="token punctuation">{</span>
        <span class="token comment">// Queue is full.</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    slot <span class="token operator">:=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>head<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment">// Check if the head slot has been released by popTail.</span>
    typ <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>
    <span class="token keyword">if</span> typ <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// Another goroutine is still cleaning up the tail, so</span>
        <span class="token comment">// the queue is actually still full.</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The head slot is free, so we own it.</span>
    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> val

    <span class="token comment">// Increment head. This passes ownership of slot to popTail</span>
    <span class="token comment">// and acts as a store barrier for writing the slot.</span>
    atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>popTail</code>先修改headTail再取slot然后重置slot</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> slot <span class="token operator">*</span>eface
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>
        head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> tail <span class="token operator">==</span> head <span class="token punctuation">{</span>
            <span class="token comment">// Queue is empty.</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Confirm head and tail (for our speculative check</span>
        <span class="token comment">// above) and increment tail. If this succeeds, then</span>
        <span class="token comment">// we own the slot at tail.</span>
        ptrs2 <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> tail<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> ptrs<span class="token punctuation">,</span> ptrs2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Success.</span>
            slot <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>tail<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// We now own slot.</span>
    val <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Tell pushHead that we're done with this slot. Zeroing the</span>
    <span class="token comment">// slot is also important so we don't leave behind references</span>
    <span class="token comment">// that could keep this object live longer than necessary.</span>
    <span class="token comment">//</span>
    <span class="token comment">// We write to val first and then publish that we're done with</span>
    <span class="token comment">// this slot by atomically writing to typ.</span>
    slot<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token boolean">nil</span>
    atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token comment">// At this point pushHead owns the slot.</span>

    <span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>考虑正常push/pop情况，head和tail指向slot不会有交集，仅需原子获取修改<strong>headTail</strong></p>
<img src="/2020/05/11/go/sync.pool/poolDequeue_1.png" class="">

<p>考虑当发生写溢出，pop速度跟不上push速度时</p>
<img src="/2020/05/11/go/sync.pool/poolDequeue_2.png" class="">

<ul>
<li>若<code>pushHead</code>先执行，在第一次计算队列时发现队列满，false退出</li>
<li>若<code>popTail</code>先执行，tail成功+1<ul>
<li>此时<code>pushHead</code>执行，在第一次计算队列时发现队列没满，接着原子判断slot.typ<ul>
<li>若在判断前，<code>popTail</code>先执行原子设置slot.typ为空，则<code>pushHead</code>能获得slot正常插入，pop+push后队列仍满</li>
<li>若<code>pushHead</code>先执行原子判断slot.typ，此时typ非空，push失败</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>poolChain使用双向链表存储poolDequeue，对poolChain执行<code>popTail</code>如图</p>
<img src="/2020/05/11/go/sync.pool/poolDequeue_3.png" class="">

<p>若pop速度很快，当前队列已空且无next队列，则保留当前队列用于下一次pushHead<br>若push速度大于pop，pool使用内存会不断扩展，不加入victime和gc机制的话会导致内存溢出</p>
<h2 id="oldPools-allPools，victim，gc"><a href="#oldPools-allPools，victim，gc" class="headerlink" title="oldPools, allPools，victim，gc"></a>oldPools, allPools，victim，gc</h2><p>victime作为二级缓存，用来降低GC压力并提高命中率。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// This function is called with the world stopped, at the beginning of a garbage collection.</span>
<span class="token keyword">func</span> <span class="token function">poolCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Drop victim caches from all pools.</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> oldPools <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>victim <span class="token operator">=</span> <span class="token boolean">nil</span>
        p<span class="token punctuation">.</span>victimSize <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Move primary cache to victim cache.</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allPools <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>victim <span class="token operator">=</span> p<span class="token punctuation">.</span>local
        p<span class="token punctuation">.</span>victimSize <span class="token operator">=</span> p<span class="token punctuation">.</span>localSize
        p<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token boolean">nil</span>
        p<span class="token punctuation">.</span>localSize <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The pools with non-empty primary caches now have non-empty</span>
    <span class="token comment">// victim caches and no pools have primary caches.</span>
    oldPools<span class="token punctuation">,</span> allPools <span class="token operator">=</span> allPools<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 在pool的init中注册gc时的清理函数</span>
<span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">runtime_registerPoolCleanup</span><span class="token punctuation">(</span>poolCleanup<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>初始状态，oldPools和allPools均为nil</li>
<li>第1次调用<code>Get</code>，由于p.local为nil，将会在pinSlow中创建p.local，然后将p放入allPools，此时allPools长度为1，oldPools为nil</li>
<li>对象使用完毕，第1次调用<code>Put</code>放回对象</li>
<li>第1次GC STW阶段，allPools中所有p.local将值赋值给victim并置为nil，最后allPools为nil，oldPools长度为1</li>
<li>第2次调用<code>Get</code>，由于p.local为nil，此时会从p.victim里面尝试取对象</li>
<li>对象使用完毕，第2次调用<code>Put</code>放回对象，但由于p.local为nil，重新创建p.local，并将对象放回，此时allPools长度为1，oldPools长度为1</li>
<li>第2次GC STW阶段，oldPools中所有p.victim置nil，前一次的cache在本次GC时被回收，allPools所有p.local将值赋值给victim并置为nil，最后allPools为&nbsp;nil，oldPools长度为1</li>
</ol>
<p>Go 1.13以前poolCleanup的实现：<br>3层循环清空，时间复杂度为总长度O(n)</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">poolCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allPools <span class="token punctuation">{</span>
        allPools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
            l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>local<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
            l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>
            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> l<span class="token punctuation">.</span>shared <span class="token punctuation">{</span>
                l<span class="token punctuation">.</span>shared<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
            l<span class="token punctuation">.</span>shared <span class="token operator">=</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        p<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token boolean">nil</span>
        p<span class="token punctuation">.</span>localSize <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    allPools <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Pool<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Go 1.13以前每次GC遍历allPools清空所有字段，新版相比Go 1.13以前，通过引入<strong>victim</strong>拉大了GC的粒度，且减小了GC的开销。<br><strong>victim</strong>在GC时将当前对象放入其中，在下一次GC前仍可作为二级缓存获取数据，直到下一次GC时回收，即GC的粒度从原来每次GC回收空对象变为2次GC才回收空对象。同时由于从<strong>victim</strong>中获取的数据没有再次放回<strong>victim</strong>中，相应GC的开销也减小了。<br>Go 1.13通过增加缓存方式，每次对allPools对象一次性清空，相比以前使用循环遍历，GC时间复杂度由原来的O(n)变为O(1)</p>
<p>gc调用链：<br>在runtime包mgc.go中创建函数钩子，通过go:linkname链接到sync包pool.go中，进行注册</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pool.go</span>
<span class="token comment">// Implemented in runtime.</span>
<span class="token keyword">func</span> <span class="token function">runtime_registerPoolCleanup</span><span class="token punctuation">(</span>cleanup <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// mgc.go</span>
<span class="token comment">// Hooks for other packages</span>
<span class="token keyword">var</span> poolcleanup <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//go:linkname sync_runtime_registerPoolCleanup sync.runtime_registerPoolCleanup</span>
<span class="token keyword">func</span> <span class="token function">sync_runtime_registerPoolCleanup</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	poolcleanup <span class="token operator">=</span> f
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="无锁化"><a href="#无锁化" class="headerlink" title="无锁化"></a>无锁化</h2><h3 id="原子操作代替锁"><a href="#原子操作代替锁" class="headerlink" title="原子操作代替锁"></a>原子操作代替锁</h3><p>通过<strong>headTail</strong>和<strong>slot.type</strong>的CAS原子操作代替锁，保证并发的前提下降低开销</p>
<h3 id="操作行为隔离"><a href="#操作行为隔离" class="headerlink" title="操作行为隔离"></a>操作行为隔离</h3><p>通过双向链表将<code>pushHead</code>和<code>popTail</code>行为尽可能隔离开</p>
<h3 id="victim"><a href="#victim" class="headerlink" title="victim"></a>victim</h3><p>通过<strong>victim</strong>二级缓存降低GC开销</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/133638023" title="" target="">深度解密Go语言之sync.Pool</a></li>
<li><a href="https://xargin.com/lock-contention-in-go/" title="" target="">几个Go系统可能遇到的锁问题</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/11/go/goroutine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/11/go/goroutine/" class="post-title-link" itemprop="url">goroutine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-11 13:39:23" itemprop="dateCreated datePublished" datetime="2020-05-11T13:39:23+00:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>runtime/HACKING.md</p>
</blockquote>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>一个goroutine是一个g对象，main也是一个g</li>
<li>p数量默认为cpu核线程数，通过<code>GOMAXPROCS</code>调整</li>
<li>m数量一般比p多一点，最大10000个</li>
<li>goroutine入口<code>newproc</code>，m入口<code>mstart</code></li>
<li>getg()获取g，g.m关联的m，g.m.p关联的p</li>
<li>一般getg顺序为本地pop/全局拿最多32个/其他p偷一半(timer)/network</li>
<li>m通过<code>schedule</code>/<code>findrunnable</code>不断找活干，处于<strong>spinning</strong>状态。如果已经没活，退出spinning状态，调用<code>stopm</code>进入全局midle，同时释放p进入全局pidle</li>
<li><code>newproc</code>中的g不会直接分配给m，而是由spinning的m自己找g处理。当有idle的p和非spinning的m，则将全局midle设置为<strong>spinning</strong>，然后找g处理。若m不足使用newm新创建m(比如程序刚开始启动时)</li>
<li><code>sysmon</code>在main方法中注册，每个10ms检查g(初始20us逐渐增加到10ms，发生抢占后重置)，设置g.stackguard0=stackPreempt，在g运行过程中分配新stack时进行判断，将g放回全局runnable g队列，并调用一次schedule。每2分钟如果没有gc过，执行gc。若开启了strace，在sysmon中输出debug信息</li>
<li>gc根据上一次gc动态调整</li>
</ul>
<h2 id="g状态"><a href="#g状态" class="headerlink" title="g状态"></a>g状态</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>
    _Gidle <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0 newg默认值为iota</span>
    _Grunnable <span class="token comment">// 1 分配到runq</span>
    _Grunning <span class="token comment">// 2 从runq等取出，与mp绑定执行go代码</span>
    _Gsyscall <span class="token comment">// 3 执行系统调用，只与m绑定</span>
    _Gwaiting <span class="token comment">// 4 阻塞等待io/gc/channel等，不在runq中</span>
    _Gmoribund_unused <span class="token comment">// 5 保留</span>
    _Gdead <span class="token comment">// 6 未使用状态，可能在本地或全局gFree，可能有stack或nostack</span>
    _Genqueue_unused <span class="token comment">// 7 保留</span>
    _Gcopystack <span class="token comment">// 8 running-&gt;copystack-&gt;running，避免stack拷贝过程中被gc</span>
    _Gpreempted <span class="token comment">// 9 标示竞争</span>

    <span class="token comment">// 用于标示gc</span>
    _Gscan          <span class="token operator">=</span> <span class="token number">0x1000</span>
    _Gscanrunnable  <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunnable  <span class="token comment">// 0x1001</span>
    _Gscanrunning   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunning   <span class="token comment">// 0x1002</span>
    _Gscansyscall   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gsyscall   <span class="token comment">// 0x1003</span>
    _Gscanwaiting   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gwaiting   <span class="token comment">// 0x1004</span>
    _Gscanpreempted <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gpreempted <span class="token comment">// 0x1009</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><blockquote>
<p>平台不同对应汇编文件不同</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// rt0_linux_arm64.s</span>
TEXT <span class="token function">main</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token operator">|</span>NOFRAME<span class="token punctuation">,</span>$<span class="token number">0</span>
    MOVD    $runtime·<span class="token function">rt0_go</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> R2
    BL    <span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// asm_arm64.s</span>

<span class="token comment">// 启动顺序:</span>
<span class="token comment">//</span>
<span class="token comment">//    call osinit</span>
<span class="token comment">//    call schedinit</span>
<span class="token comment">//    make &amp; queue new G</span>
<span class="token comment">//    call runtime·mstart</span>
<span class="token comment">//</span>
<span class="token comment">// The new G calls runtime·main.</span>
TEXT runtime·<span class="token function">rt0_go</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>
    <span class="token comment">// 初始化g0，m0</span>

    CALL    runtime·<span class="token function">args</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>
    CALL    runtime·<span class="token function">osinit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>
    CALL    runtime·<span class="token function">schedinit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>

    <span class="token comment">// create a new goroutine to start program</span>
    MOVD    $runtime·<span class="token function">mainPC</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> R0        <span class="token comment">// mainPC是main的入口</span>
    MOVD    RSP<span class="token punctuation">,</span> R7
    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>
    MOVD<span class="token punctuation">.</span>W    R0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>
    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>
    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>
    MOVD    R7<span class="token punctuation">,</span> RSP
    BL    runtime·<span class="token function">newproc</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// 调用newproc为mainPC创建goroutine</span>
    ADD    $<span class="token number">32</span><span class="token punctuation">,</span> RSP

    <span class="token comment">// start this M</span>
    BL    runtime·<span class="token function">mstart</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// m的入口</span>

<span class="token comment">// mstart() =&gt; schedule() =&gt; execute() =&gt; xxx() =&gt; goexit()</span>
TEXT runtime·<span class="token function">goexit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
    BYTE    $<span class="token number">0x90</span>    <span class="token comment">// NOP</span>
    CALL    runtime·<span class="token function">goexit1</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>    <span class="token comment">// does not return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>schedinit使用cpu线程数或环境变量<code>GOMAXPROCS</code>初始化全局allp</p>
</blockquote>
<ol>
<li>allp不够大的话进行扩容和拷贝旧p</li>
<li>增加procs时，对增量p初始化，当前g的p复用</li>
<li>减少procs且当前p比新值小时，释放当前p，使用allp[0]</li>
<li>调小procs时，释放nprocs～old的p资源</li>
<li>关联有g的p和空闲m，空g的p放入全局空p对象，并返回第一个可用p</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sched<span class="token punctuation">.</span>maxmcount <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">// m最大10000个，一般比p多一点</span>

    <span class="token operator">...</span>

    <span class="token comment">// cpu线程数或环境变量GOMAXPROCS设置p数量</span>
    procs <span class="token operator">:=</span> ncpu
    <span class="token keyword">if</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">atoi32</span><span class="token punctuation">(</span><span class="token function">gogetenv</span><span class="token punctuation">(</span><span class="token string">"GOMAXPROCS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        procs <span class="token operator">=</span> n
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">procresize</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unknown runnable goroutine during bootstrap"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">procresize</span><span class="token punctuation">(</span>nprocs <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>p <span class="token punctuation">{</span>
    old <span class="token operator">:=</span> gomaxprocs

    <span class="token comment">// 1. Grow allp if necessary.</span>
    <span class="token keyword">if</span> nprocs <span class="token operator">&gt;</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Synchronize with retake, which could be running</span>
        <span class="token comment">// concurrently since it doesn't run on a P.</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
        <span class="token keyword">if</span> nprocs <span class="token operator">&lt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            allp <span class="token operator">=</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span>nprocs<span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            nallp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">,</span> nprocs<span class="token punctuation">)</span>
            <span class="token comment">// Copy everything up to allp's cap so we</span>
            <span class="token comment">// never lose old allocated Ps.</span>
            <span class="token function">copy</span><span class="token punctuation">(</span>nallp<span class="token punctuation">,</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">cap</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            allp <span class="token operator">=</span> nallp
        <span class="token punctuation">}</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. initialize new P's</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> old<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nprocs<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        pp <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            pp <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        pp<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token function">atomicstorep</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 2. 增加procs，复用g的p</span>
    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token operator">&lt;</span> nprocs <span class="token punctuation">{</span>
        <span class="token comment">// continue to use the current P</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status <span class="token operator">=</span> _Prunning
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mcache<span class="token punctuation">.</span><span class="token function">prepareForSweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 3. 减少procs且当前g的p比新值小，释放当前g的p，使用allp[0]</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token number">0</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>mcache <span class="token operator">=</span> <span class="token boolean">nil</span>
        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        p<span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">0</span>
        p<span class="token punctuation">.</span>status <span class="token operator">=</span> _Pidle
        <span class="token function">acquirep</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 4. 调小procs，释放nprocs～old的p资源</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> nprocs<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> old<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        p<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// can't free P itself because it can be referenced by an M in syscall</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Trim allp.</span>
    <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nprocs <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
        allp <span class="token operator">=</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span>nprocs<span class="token punctuation">]</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 关联有g的p和空闲m，空g的p放入全局空p对象，并返回第一个可用p</span>
    <span class="token keyword">var</span> runnablePs <span class="token operator">*</span>p
    <span class="token keyword">for</span> i <span class="token operator">:=</span> nprocs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> p <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        p<span class="token punctuation">.</span>status <span class="token operator">=</span> _Pidle
        <span class="token keyword">if</span> <span class="token function">runqempty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">pidleput</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            p<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>runnablePs<span class="token punctuation">)</span>
            runnablePs <span class="token operator">=</span> p
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    stealOrder<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>nprocs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> int32p <span class="token operator">*</span><span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>gomaxprocs <span class="token comment">// make compiler check that gomaxprocs is an int32</span>
    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uint32</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>int32p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>nprocs<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> runnablePs
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="newproc"><a href="#newproc" class="headerlink" title="newproc"></a>newproc</h3><blockquote>
<p>newproc是goroutine入口(main也是goroutine)</p>
</blockquote>
<ol>
<li>获取free g<br> 1.1 本地free g队列获取g<br> 1.2 若本地free g队列空，全局free g队列获取最多32个g到本地，优先取有栈g<br> 1.3 若全局free g队列空，创建新g，默认stack为2k，状态默认idle-&gt;dead，避免gc</li>
<li>栈信息拷贝</li>
<li>状态dead-&gt;runnable</li>
<li>从goidcache设置goid，采用了预分配id段，预分配加解锁一次，设置无需锁</li>
<li>保存g到p<br> 5.1 保存g到runnext，旧的runnext排到本地runnable g队列尾(大小固定256)<br> 5.2 若本地runnable g队列满，取一半放到全局runnable g队列</li>
<li>有空闲p，并且没有spinning状态m，调用wakep消化g。 main函数也是一个goroutine，通过mainStarted过滤，无需执行wakep<br> 6.1 wakep调用startm，首先查看有无全局midle，若有直接绑定gpm，若没有newm创建一个spinning的m，由m调用mstart找g处理</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    argp <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// debug trace用</span>
    pc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">newproc1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> argp<span class="token punctuation">,</span> siz<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newproc1</span><span class="token punctuation">(</span>fn <span class="token operator">*</span>funcval<span class="token punctuation">,</span> argp unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> narg <span class="token builtin">int32</span><span class="token punctuation">,</span> callergp <span class="token operator">*</span>g<span class="token punctuation">,</span> callerpc <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    _p_ <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    newg <span class="token operator">:=</span> <span class="token function">gfget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token comment">// 1. 获取free g</span>

    <span class="token comment">// 如果本地g和全局g都用完，创建新g，newg=new(g)</span>
    <span class="token comment">// _StackMin=2048，因此默认创建出来的g栈大小为2k</span>
    <span class="token keyword">if</span> newg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        newg <span class="token operator">=</span> <span class="token function">malg</span><span class="token punctuation">(</span>_StackMin<span class="token punctuation">)</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>newg<span class="token punctuation">,</span> _Gidle<span class="token punctuation">,</span> _Gdead<span class="token punctuation">)</span> <span class="token comment">// 状态_Gidle -&gt; _Gdead</span>
        <span class="token function">allgadd</span><span class="token punctuation">(</span>newg<span class="token punctuation">)</span> <span class="token comment">// publishes with a g-&gt;status of Gdead so GC scanner doesn't look at uninitialized stack.</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 拷贝栈信息</span>

    newg<span class="token punctuation">.</span>ancestors <span class="token operator">=</span> <span class="token function">saveAncestors</span><span class="token punctuation">(</span>callergp<span class="token punctuation">)</span> <span class="token comment">// 用于go trace</span>

    <span class="token function">casgstatus</span><span class="token punctuation">(</span>newg<span class="token punctuation">,</span> _Gdead<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span> <span class="token comment">// 3. 状态_Gdead -&gt; _Grunnable</span>

    <span class="token comment">// 4. 防止每次访问全局计数器goidgen，采用预分配id段方式</span>
    <span class="token keyword">if</span> _p_<span class="token punctuation">.</span>goidcache <span class="token operator">==</span> _p_<span class="token punctuation">.</span>goidcacheend <span class="token punctuation">{</span>
        _p_<span class="token punctuation">.</span>goidcache <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>goidgen<span class="token punctuation">,</span> _GoidCacheBatch<span class="token punctuation">)</span>
        _p_<span class="token punctuation">.</span>goidcache <span class="token operator">-=</span> _GoidCacheBatch <span class="token operator">-</span> <span class="token number">1</span>
        _p_<span class="token punctuation">.</span>goidcacheend <span class="token operator">=</span> _p_<span class="token punctuation">.</span>goidcache <span class="token operator">+</span> _GoidCacheBatch
    <span class="token punctuation">}</span>
    newg<span class="token punctuation">.</span>goid <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>goidcache<span class="token punctuation">)</span>
    _p_<span class="token punctuation">.</span>goidcache<span class="token operator">++</span>

    <span class="token comment">// 5. 保存g到p</span>
    <span class="token function">runqput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> newg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>

    <span class="token comment">// 6. 有空闲p，并且没有spinning状态m，重新唤醒p。 main函数也是一个goroutine，通过mainStarted过滤，无需执行wakep</span>
    <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mainStarted <span class="token punctuation">{</span>
        <span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">releasem</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="p-runnext测试"><a href="#p-runnext测试" class="headerlink" title="p.runnext测试"></a>p.runnext测试</h4><p>单cpu下每次输出都为9012345678，9是runnext，0-8是本地runnable g队列</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 如果设置为多核，不同核间顺序随机</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">go</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token number">9</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="mstart"><a href="#mstart" class="headerlink" title="mstart"></a>mstart</h3><blockquote>
<p>mstart是m的入口，调用顺序mstart-&gt;schedule-&gt;execute</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">mstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token operator">...</span>

    <span class="token function">mstart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token operator">...</span>

    <span class="token function">mexit</span><span class="token punctuation">(</span>osStack<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">mstart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>schedule是单次调度的公共函数，找一个g放m上执行，调用excute</p>
</blockquote>
<ol>
<li>有locked g，直接在上面跑execute</li>
<li>61轮一次从全局runnable g取 (增加循环间隔，避免全局g被某几个goroutine占有)</li>
<li>从本地runnable g取，优先取runnext</li>
<li>调用findrunnable()获取runnable g，直到取到1个g为止</li>
<li>若当前m处于spinning，取消spinning</li>
<li>获取的g已有lockedm，绑定g和lockedm，从2.重新判断</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token comment">// 1. 有locked g，直接在上面跑execute</span>
    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">stoplockedm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">execute</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Never returns.</span>
    <span class="token punctuation">}</span>

top<span class="token punctuation">:</span>
    pp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>

    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">gcstopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> top
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> gp <span class="token operator">*</span>g
    <span class="token keyword">var</span> inheritTime <span class="token builtin">bool</span>

    <span class="token comment">// 2. 61轮一次从全局runnable g取</span>
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// Check the global runnable queue once in a while to ensure fairness.</span>
        <span class="token comment">// Otherwise two goroutines can completely occupy the local runqueue</span>
        <span class="token comment">// by constantly respawning each other.</span>
        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 从本地runnable g取，优先取runnext</span>
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 4. 调用findrunnable()获取runnable g，直到取到1个g为止</span>
    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 若当前m处于spinning，取消spinning</span>
    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>
        <span class="token function">resetspinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 6. 获取的g已有lockedm，绑定g和lockedm，从2.重新判断</span>
    <span class="token keyword">if</span> gp<span class="token punctuation">.</span>lockedm <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token comment">// Hands off own p to the locked m,</span>
        <span class="token comment">// then blocks waiting for a new p.</span>
        <span class="token function">startlockedm</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> top
    <span class="token punctuation">}</span>

    <span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>findrunnable()尝试从本地g/全局g/net poll/其他p偷取g或timer g/执行gc 各种途径find a work</p>
</blockquote>
<ol>
<li>再尝试从本地runnable g取</li>
<li>从全局runnable g取</li>
<li>从net poll取g</li>
<li>大量m已处于spinning，而非idle的p数量少，通常为代码并发度低，跳过5.</li>
<li>从其他p偷取一半本地runnable g，尝试4次，最后一次会尝试偷取runNext和p2的到期timer g<br> 5.1 若有timer，可能有timer g结束入队，重新从1.开始判断</li>
<li>gc阶段，查看有无gc工作可做</li>
<li>再尝试从全局runnable g取</li>
<li>释放p，放回全局pidle<br> 8.1 m状态变为非spinning，nmspinning计数-1</li>
<li>从allp重新获取idle的p，并设置spinning和nmspinning+1，重新从1.开始判断</li>
<li>处于gc阶段，重新从6.开始判断</li>
<li>再次从net poll取g</li>
<li>将m放入全局idle m，并与当前g关联，重新从1.开始判断</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

top<span class="token punctuation">:</span>
    _p_ <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// 1. 再尝试从本地runnable g取</span>
    <span class="token keyword">if</span> gp<span class="token punctuation">,</span> inheritTime <span class="token operator">:=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> inheritTime
    <span class="token punctuation">}</span>

    <span class="token comment">// 2. 从全局runnable g取</span>
    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        gp <span class="token operator">:=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token keyword">if</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3. 从net poll取g</span>

    procs <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>gomaxprocs<span class="token punctuation">)</span>
    ranTimer <span class="token operator">:=</span> <span class="token boolean">false</span>
    <span class="token comment">// If number of spinning M's &gt;= number of busy P's, block.</span>
    <span class="token comment">// 4. 大量m已处于spinning，而非idle的p数量少，通常为代码并发度低</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">&amp;&amp;</span> <span class="token number">2</span><span class="token operator">*</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> procs<span class="token operator">-</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> stop
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 设置为spinning</span>
        atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 从其他p偷取一半本地runnable g，尝试4次，最后一次会尝试偷取runNext和p2的到期timer g</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> enum <span class="token operator">:=</span> stealOrder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>enum<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> enum<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token keyword">goto</span> top
            <span class="token punctuation">}</span>
            stealRunNextG <span class="token operator">:=</span> i <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token comment">// first look for ready queues with more than 1 g</span>
            p2 <span class="token operator">:=</span> allp<span class="token punctuation">[</span>enum<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> _p_ <span class="token operator">==</span> p2 <span class="token punctuation">{</span>
                <span class="token keyword">continue</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> gp <span class="token operator">:=</span> <span class="token function">runqsteal</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> stealRunNextG<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 偷取p2的timer g</span>
            <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldStealTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                tnow<span class="token punctuation">,</span> w<span class="token punctuation">,</span> ran <span class="token operator">:=</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> now<span class="token punctuation">)</span>
                now <span class="token operator">=</span> tnow
                <span class="token keyword">if</span> w <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pollUntil <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> w <span class="token operator">&lt;</span> pollUntil<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    pollUntil <span class="token operator">=</span> w
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> ran <span class="token punctuation">{</span>
                    <span class="token comment">// p2的timer g入队，可以偷取</span>
                    <span class="token keyword">if</span> gp<span class="token punctuation">,</span> inheritTime <span class="token operator">:=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> inheritTime
                    <span class="token punctuation">}</span>
                    ranTimer <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 5. 若有timer，可能有timer g结束入队，重新从1.开始判断</span>
    <span class="token keyword">if</span> ranTimer <span class="token punctuation">{</span>
        <span class="token comment">// Running a timer may have made some goroutine ready.</span>
        <span class="token keyword">goto</span> top
    <span class="token punctuation">}</span>

stop<span class="token punctuation">:</span>
    <span class="token comment">// 6. gc阶段，查看有无gc工作可做</span>
    <span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _p_<span class="token punctuation">.</span>gcBgMarkWorker <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerIdleMode
        gp <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>gcBgMarkWorker<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
        <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>
            <span class="token function">traceGoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 7. 再尝试从全局runnable g取</span>
    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        gp <span class="token operator">:=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 8. 释放m的p，放回全局pidle</span>
    <span class="token keyword">if</span> <span class="token function">releasep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> _p_ <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"findrunnable: wrong p"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">pidleput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    <span class="token comment">// 8.1 m状态变为非spinning，nmspinning-1</span>
    wasSpinning <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning
    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"findrunnable: negative nmspinning"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 9. 从allp重新获取idle的p，并设置spinning和nmspinning+1，重新从1.开始判断</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> _p_ <span class="token operator">:=</span> <span class="token keyword">range</span> allpSnapshot <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">runqempty</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            _p_ <span class="token operator">=</span> <span class="token function">pidleget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            <span class="token keyword">if</span> _p_ <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
                <span class="token function">acquirep</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>
                <span class="token keyword">if</span> wasSpinning <span class="token punctuation">{</span>
                    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">true</span>
                    atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">goto</span> top
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 10. 处于gc阶段，重新从6.开始判断</span>

    <span class="token comment">// 11. 再次从net poll取g</span>

    <span class="token comment">// 12. 将m放入全局idle m，并与当前g关联，重新从1.开始判断</span>
    <span class="token function">stopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">goto</span> top
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>execute设置g状态为running，并执行g</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp
    gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m
    <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>inheritTime <span class="token punctuation">{</span>
        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">++</span>
    <span class="token punctuation">}</span>

    <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span> <span class="token comment">// gp.sched在newproc中设置，调用asm_arm64.s汇编函数gogo执行g代码</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="抢占"><a href="#抢占" class="headerlink" title="抢占"></a>抢占</h2><blockquote>
<p><code>runtime/proc.go</code>的main函数中注册了sysmon</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    g <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span>
    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>PtrSize <span class="token operator">==</span> <span class="token number">8</span> <span class="token punctuation">{</span>
        maxstacksize <span class="token operator">=</span> <span class="token number">1000000000</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        maxstacksize <span class="token operator">=</span> <span class="token number">250000000</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Allow newproc to start new Ms.</span>
    mainStarted <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token keyword">if</span> GOARCH <span class="token operator">!=</span> <span class="token string">"wasm"</span> <span class="token punctuation">{</span> <span class="token comment">// no threads on wasm yet, so no sysmon</span>
        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">newm</span><span class="token punctuation">(</span>sysmon<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fn <span class="token operator">:=</span> main_main <span class="token comment">// go:linkname main_main main.main</span>
    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> x <span class="token operator">*</span><span class="token builtin">int32</span>
        <span class="token operator">*</span>x <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>sysmon</code>为死循环，调用<code>retake</code>来调度长时间执行的g；调用<code>gcTrigger.test</code>方法判断2分钟没执行过gc；如果设置strace，根据设置间隔输出debug信息</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    sched<span class="token punctuation">.</span>nmsys<span class="token operator">++</span>
    <span class="token function">checkdead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    lasttrace <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    idle <span class="token operator">:=</span> <span class="token number">0</span>
    delay <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> idle <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// start with 20us sleep...</span>
            delay <span class="token operator">=</span> <span class="token number">20</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> idle <span class="token operator">&gt;</span> <span class="token number">50</span> <span class="token punctuation">{</span> <span class="token comment">// start doubling the sleep after 1ms...</span>
            delay <span class="token operator">*=</span> <span class="token number">2</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> delay <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">{</span> <span class="token comment">// up to 10ms</span>
            delay <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span>
        <span class="token punctuation">}</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
        now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment">// retake P's blocked in syscalls</span>
        <span class="token comment">// and preempt long running G's</span>
        <span class="token keyword">if</span> <span class="token function">retake</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            idle <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            idle<span class="token operator">++</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// check if we need to force a GC，判断在t.test()中</span>
        <span class="token keyword">if</span> t <span class="token operator">:=</span> <span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerTime<span class="token punctuation">,</span> now<span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            forcegc<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">var</span> list gList
            list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>forcegc<span class="token punctuation">.</span>g<span class="token punctuation">)</span>
            <span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> debug<span class="token punctuation">.</span>schedtrace <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lasttrace<span class="token operator">+</span><span class="token function">int64</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>schedtrace<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span> <span class="token operator">&lt;=</span> now <span class="token punctuation">{</span>
            lasttrace <span class="token operator">=</span> now
            <span class="token function">schedtrace</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>scheddetail <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>retake</code>遍历allp判断执行超过10ms的p，传给<code>preemptone</code></p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> forcePreemptNS <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 10ms</span>

<span class="token keyword">func</span> <span class="token function">retake</span><span class="token punctuation">(</span>now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span> <span class="token punctuation">{</span>
    n <span class="token operator">:=</span> <span class="token number">0</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
        _p_ <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span> _p_ <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token comment">// 在procresize代码中，还没初始化</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        pd <span class="token operator">:=</span> <span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>sysmontick
        s <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>status
        sysretake <span class="token operator">:=</span> <span class="token boolean">false</span>
        <span class="token keyword">if</span> s <span class="token operator">==</span> _Prunning <span class="token operator">||</span> s <span class="token operator">==</span> _Psyscall <span class="token punctuation">{</span>
            <span class="token comment">// Preempt G if it's running for too long.</span>
            t <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>schedtick<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token function">int64</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>schedtick<span class="token punctuation">)</span> <span class="token operator">!=</span> t <span class="token punctuation">{</span>
                pd<span class="token punctuation">.</span>schedtick <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>
                pd<span class="token punctuation">.</span>schedwhen <span class="token operator">=</span> now
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> pd<span class="token punctuation">.</span>schedwhen<span class="token operator">+</span>forcePreemptNS <span class="token operator">&lt;=</span> now <span class="token punctuation">{</span>
                <span class="token function">preemptone</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>
                sysretake <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">uint32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p><code>preemptone</code>设置g.stackguard0=stackPreempt。<br>创建新g后stack默认2k，之后根据代码执行不断调整stack大小。<br>调用汇编函数<code>morestack</code>，CALL <code>newstack</code>时检查<strong>stackPreempt</strong>，将g放回全局runnable g队列，并调用schedule</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">preemptone</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    mp <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    gp <span class="token operator">:=</span> mp<span class="token punctuation">.</span>curg
    gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">true</span>

    <span class="token comment">// Every call in a go routine checks for stack overflow by</span>
    <span class="token comment">// comparing the current stack pointer to gp-&gt;stackguard0.</span>
    <span class="token comment">// Setting gp-&gt;stackguard0 to StackPreempt folds</span>
    <span class="token comment">// preemption into the normal stack overflow check.</span>
    gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> stackPreempt

    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// stack.go</span>
<span class="token keyword">func</span> <span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    preempt <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>stackguard0<span class="token punctuation">)</span> <span class="token operator">==</span> stackPreempt

    <span class="token keyword">if</span> preempt <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">canPreemptM</span><span class="token punctuation">(</span>thisg<span class="token punctuation">.</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Let the goroutine keep running for now.</span>
            <span class="token comment">// gp-&gt;preempt is set, so it will be preempted next time.</span>
            gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard
            <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span> <span class="token comment">// never return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> preempt <span class="token punctuation">{</span>
        <span class="token operator">...</span>

        <span class="token comment">// 将g放回全局runnable g队列，调用schedule</span>
        <span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="schedtrace"><a href="#schedtrace" class="headerlink" title="schedtrace"></a>schedtrace</h2><ul>
<li>gomaxprocs:      p数量</li>
<li>idleprocs:       idle p数量</li>
<li>threads:         m数量</li>
<li>spinningthreads: spinning状态的m</li>
<li>nmidle:          idle m数量</li>
<li>runqueue:        全局runnable g队列长度</li>
<li>[x, y, z..]:     per p的本地runnable g队列长度</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedtrace</span><span class="token punctuation">(</span>detailed <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"SCHED "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>starttime<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1e6</span><span class="token punctuation">,</span> <span class="token string">"ms: gomaxprocs="</span><span class="token punctuation">,</span> gomaxprocs<span class="token punctuation">,</span> <span class="token string">" idleprocs="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>npidle<span class="token punctuation">,</span> <span class="token string">" threads="</span><span class="token punctuation">,</span> <span class="token function">mcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" spinningthreads="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token string">" idlethreads="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>nmidle<span class="token punctuation">,</span> <span class="token string">" runqueue="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>runqsize<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h2><p>runtime/mgc.go</p>
<p>通过<code>gcSetTriggerRatio</code>动态调整gc速度，略</p>
<h2 id="tool"><a href="#tool" class="headerlink" title="tool"></a>tool</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span>schedtrace<span class="token operator">=</span><span class="token number">1000</span> godoc <span class="token parameter variable">-http</span><span class="token operator">=</span>:6060
SCHED 0ms: <span class="token assign-left variable">gomaxprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">idleprocs</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">threads</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">spinningthreads</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">idlethreads</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">runqueue</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span>
using module mode<span class="token punctuation">;</span> <span class="token assign-left variable">GOMOD</span><span class="token operator">=</span>/PATHTO/go.mod
SCHED 0ms: <span class="token assign-left variable">gomaxprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">idleprocs</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">threads</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">spinningthreads</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">idlethreads</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">runqueue</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">1</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span>
SCHED 1005ms: <span class="token assign-left variable">gomaxprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">idleprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">threads</span><span class="token operator">=</span><span class="token number">20</span> <span class="token assign-left variable">spinningthreads</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">idlethreads</span><span class="token operator">=</span><span class="token number">15</span> <span class="token assign-left variable">runqueue</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span>
SCHED 2013ms: <span class="token assign-left variable">gomaxprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">idleprocs</span><span class="token operator">=</span><span class="token number">4</span> <span class="token assign-left variable">threads</span><span class="token operator">=</span><span class="token number">20</span> <span class="token assign-left variable">spinningthreads</span><span class="token operator">=</span><span class="token number">0</span> <span class="token assign-left variable">idlethreads</span><span class="token operator">=</span><span class="token number">16</span> <span class="token assign-left variable">runqueue</span><span class="token operator">=</span><span class="token number">0</span> <span class="token punctuation">[</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><a href="https://www.ardanlabs.com/blog/2018/08/scheduling-in-go-part1.html" title="" target="">Scheduling In Go</a>
<a href="https://zhuanlan.zhihu.com/p/364813527" title="" target="">一文教你搞懂 Go 中栈操作</a>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/07/go/interface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/07/go/interface/" class="post-title-link" itemprop="url">go inferface</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-07 14:18:13" itemprop="dateCreated datePublished" datetime="2020-05-07T14:18:13+00:00">2020-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="接口类型判断"><a href="#接口类型判断" class="headerlink" title="接口类型判断"></a>接口类型判断</h2><ol>
<li>对于S类型仅能看到S的方法，<em>S类型能看到S和</em>S的所有方法</li>
<li>接口类型判断方法，判断时严格匹配类型的可见函数</li>
</ol>
<blockquote>
<p>变量.(类型) // 判断是不是某个具体类型<br>switch 变量.(type) // 返回具体类型的值拷贝，必须搭配swith语句</p>
</blockquote>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">type</span> I1 <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> I2 <span class="token keyword">interface</span> <span class="token punctuation">{</span>
    <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    n <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>n<span class="token operator">++</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>s S<span class="token punctuation">)</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s<span class="token punctuation">.</span>n <span class="token operator">=</span> s<span class="token punctuation">.</span>n <span class="token operator">*</span> s<span class="token punctuation">.</span>n
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestI1</span><span class="token punctuation">(</span>i I1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    i<span class="token punctuation">.</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">TestI2</span><span class="token punctuation">(</span>i I2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i<span class="token punctuation">.</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PrintIf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I1 type[%T] %v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I2 type[%T] %v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">PrintSwtich</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%p %v\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
    <span class="token keyword">switch</span> t <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> I1<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I1 type[%T] %v\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
    <span class="token keyword">case</span> I2<span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I2 type[%T] %v\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"unknow\n"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> s S

    <span class="token function">TestI1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
    <span class="token comment">// TestI1(s)</span>
    <span class="token comment">// cannot use s (type S) as type I1 in argument to TestI1:</span>
    <span class="token comment">// does not implement I1 (add method has pointer receiver)</span>

    <span class="token function">TestI2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
    <span class="token function">TestI2</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>

    <span class="token function">PrintIf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token function">PrintIf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"------------\n"</span><span class="token punctuation">)</span>
    <span class="token function">PrintSwtich</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token function">PrintSwtich</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">I2 <span class="token keyword">type</span><span class="token punctuation">[</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// S类型只能看到sqr方法，仅能匹配I2</span>
I1 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// *S类型可以匹配I1</span>
I2 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// 和I2</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token number">0xc0001021e0</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
I2 <span class="token keyword">type</span><span class="token punctuation">[</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// S类型只能看到sqr方法，仅能匹配I2</span>
<span class="token number">0xc0001021f0</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>
I1 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// *S类型可以匹配I1，switch分支退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="接口组成"><a href="#接口组成" class="headerlink" title="接口组成"></a>接口组成</h2><p>从接口源码看，接口组成为<code>类型</code>和<code>数据</code>，判断两个接口是否相等，就是看<code>类型</code>和<code>数据</code>是否相等<br><code>类型</code>和<code>数据</code>都为nil，才代表该接口为nil</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">var a interface{}
var b interface{} = (*int)(nil)
fmt.Println(a == nil, b == nil) //true false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="接口类型转换-多态"><a href="#接口类型转换-多态" class="headerlink" title="接口类型转换(多态)"></a>接口类型转换(多态)</h2><p>不包含任何方法的空接口A，任意类型都符合转换成A<br>即使B=nil，A本身非nil，仅A.数据=nil<br>若要对A判断空，需构造B的空对象用于A的判断</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> A <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">type</span> B <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">var</span> b_nil <span class="token operator">=</span> B<span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> A <span class="token punctuation">{</span>
    <span class="token keyword">var</span> b <span class="token operator">*</span>B <span class="token comment">// b = nil</span>
    <span class="token keyword">return</span> b <span class="token comment">// 函数返回触发值拷贝，A.类型=*B, A.数据=nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f_nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> A <span class="token punctuation">{</span>
    <span class="token keyword">return</span> b_nil
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a = (A)(nil&lt;*B&gt;)，此处类型为A，数据为*B类型的nil</span>
    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil B"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"non nil A"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    a <span class="token operator">=</span> <span class="token function">f_nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> a <span class="token operator">==</span> b_nil <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil B"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">non <span class="token boolean">nil</span> A
<span class="token boolean">nil</span> B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="interface-和-interface"><a href="#interface-和-interface" class="headerlink" title="interface{}和*interface{}"></a>interface{}和*interface{}</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// all type is OK</span>
<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token comment">// only *interface{} is OK</span>
<span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span>x <span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> S<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// var</span>
    p <span class="token operator">:=</span> <span class="token operator">&amp;</span>s  <span class="token comment">// point</span>
    <span class="token function">f</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>     <span class="token comment">// var -&gt; interface: OK</span>
    <span class="token function">g</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>     <span class="token comment">// error</span>
    <span class="token function">f</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>     <span class="token comment">// point -&gt; interface: OK</span>
    <span class="token function">g</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>     <span class="token comment">// error</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="接口结构"><a href="#接口结构" class="headerlink" title="接口结构"></a>接口结构</h2><p>接口分空接口和非空接口，runtime2.go:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 空接口定义</span>
<span class="token keyword">type</span> eface <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    _type <span class="token operator">*</span>_type
    data  unsafe<span class="token punctuation">.</span>Pointer
<span class="token punctuation">}</span>

<span class="token comment">// 非空接口定义</span>
<span class="token keyword">type</span> iface <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tab  <span class="token operator">*</span>itab
    data unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 指向runtime申请的内存，存储实际数据</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> itab <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    inter <span class="token operator">*</span>interfacetype <span class="token comment">// 接口类型</span>
    _type <span class="token operator">*</span>_type <span class="token comment">// 数据类型，iface.data指向值的类型信息</span>
    hash  <span class="token builtin">uint32</span> <span class="token comment">// copy of _type.hash. Used for type switches. golang Duck-typing机制</span>
    <span class="token boolean">_</span>     <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token builtin">byte</span>

    <span class="token comment">// 函数地址占位符</span>
    <span class="token comment">// fun[0]==0 means _type does not implement inter.</span>
    <span class="token comment">// fun[0]!=0，fun存放第一个接口方法的地址，其他方法依次向后存放，空间换时间，对应_type中也可以查到方法，使用时不用再动态查找</span>
    fun   <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> interfacetype <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    typ     _type
    pkgpath name <span class="token comment">// 接口包名</span>
    mhdr    <span class="token punctuation">[</span><span class="token punctuation">]</span>imethod <span class="token comment">// 接口中定义的函数，由连接器嵌入</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> imethod <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    name nameOff <span class="token comment">// name of method</span>
    ityp typeOff <span class="token comment">// .(*FuncType) underneath</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> _type <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    size       <span class="token builtin">uintptr</span>
    ptrdata    <span class="token builtin">uintptr</span> <span class="token comment">// size of memory prefix holding all pointers</span>
    hash       <span class="token builtin">uint32</span>
    tflag      tflag
    align      <span class="token builtin">uint8</span>
    fieldAlign <span class="token builtin">uint8</span>
    kind       <span class="token builtin">uint8</span>
    <span class="token comment">// function for comparing objects of this type</span>
    <span class="token comment">// (ptr to object A, ptr to object B) -&gt; ==?</span>
    equal <span class="token keyword">func</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span>
    <span class="token comment">// gcdata stores the GC type data for the garbage collector.</span>
    <span class="token comment">// If the KindGCProg bit is set in kind, gcdata is a GC program.</span>
    <span class="token comment">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span>
    gcdata    <span class="token operator">*</span><span class="token builtin">byte</span>
    str       nameOff
    ptrToThis typeOff
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="全局itab"><a href="#全局itab" class="headerlink" title="全局itab"></a>全局itab</h2><p>全局itab使用数组保存，iface.go:</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> itabInitSize <span class="token operator">=</span> <span class="token number">512</span>

<span class="token keyword">var</span> <span class="token punctuation">(</span>
    itabLock      mutex                               <span class="token comment">// lock for accessing itab table</span>
    itabTable     <span class="token operator">=</span> <span class="token operator">&amp;</span>itabTableInit                    <span class="token comment">// pointer to current table</span>
    itabTableInit <span class="token operator">=</span> itabTableType<span class="token punctuation">{</span>size<span class="token punctuation">:</span> itabInitSize<span class="token punctuation">}</span> <span class="token comment">// starter table</span>
<span class="token punctuation">)</span>

<span class="token comment">// Note: change the formula in the mallocgc call in itabAdd if you change these fields.</span>
<span class="token keyword">type</span> itabTableType <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    size    <span class="token builtin">uintptr</span>             <span class="token comment">// 数组大小，2的幂次方</span>
    count   <span class="token builtin">uintptr</span>             <span class="token comment">// 已保存记录数</span>
    entries <span class="token punctuation">[</span>itabInitSize<span class="token punctuation">]</span><span class="token operator">*</span>itab <span class="token comment">// *itab数组，初始大小512</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="接口转换函数"><a href="#接口转换函数" class="headerlink" title="接口转换函数"></a>接口转换函数</h2><p>接口转换调用conv系列函数</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 类型转为空接口，</span>
<span class="token keyword">func</span> <span class="token function">convT2E</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>e eface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
        <span class="token function">raceReadObjectPC</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>convT2E<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> msanenabled <span class="token punctuation">{</span>
        <span class="token function">msanread</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    x <span class="token operator">:=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>size<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// mallocgc内存用于拷贝源值</span>
    <span class="token comment">// TODO: We allocate a zeroed object only to overwrite it with actual data.</span>
    <span class="token comment">// Figure out how to avoid zeroing. Also below in convT2Eslice, convT2I, convT2Islice.</span>
    <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> x<span class="token punctuation">,</span> elem<span class="token punctuation">)</span>
    e<span class="token punctuation">.</span>_type <span class="token operator">=</span> t <span class="token comment">// type直接复制源type</span>
    e<span class="token punctuation">.</span>data <span class="token operator">=</span> x <span class="token comment">// data指针指向mallocgc内存</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 类型转为非空接口</span>
<span class="token keyword">func</span> <span class="token function">convT2I</span><span class="token punctuation">(</span>tab <span class="token operator">*</span>itab<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>i iface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t <span class="token operator">:=</span> tab<span class="token punctuation">.</span>_type
    <span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>
        <span class="token function">raceReadObjectPC</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>convT2I<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> msanenabled <span class="token punctuation">{</span>
        <span class="token function">msanread</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    x <span class="token operator">:=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>size<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// // mallocgc内存用于拷贝源值</span>
    <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> x<span class="token punctuation">,</span> elem<span class="token punctuation">)</span>
    i<span class="token punctuation">.</span>tab <span class="token operator">=</span> tab <span class="token comment">// tab指向类型T的同一个tab，由编译器生成</span>
    i<span class="token punctuation">.</span>data <span class="token operator">=</span> x <span class="token comment">// data指针指向mallocgc内存</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 接口转为接口</span>
<span class="token keyword">func</span> <span class="token function">convI2I</span><span class="token punctuation">(</span>inter <span class="token operator">*</span>interfacetype<span class="token punctuation">,</span> i iface<span class="token punctuation">)</span> <span class="token punctuation">(</span>r iface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tab <span class="token operator">:=</span> i<span class="token punctuation">.</span>tab
    <span class="token keyword">if</span> tab <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> tab<span class="token punctuation">.</span>inter <span class="token operator">==</span> inter <span class="token punctuation">{</span>
        r<span class="token punctuation">.</span>tab <span class="token operator">=</span> tab
        r<span class="token punctuation">.</span>data <span class="token operator">=</span> i<span class="token punctuation">.</span>data
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    r<span class="token punctuation">.</span>tab <span class="token operator">=</span> <span class="token function">getitab</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> tab<span class="token punctuation">.</span>_type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 调用getitab函数获取tab</span>
    r<span class="token punctuation">.</span>data <span class="token operator">=</span> i<span class="token punctuation">.</span>data
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 其他特定类型转换，如果是0值指向zeroVal[0]，非0值使用mallocgc开辟内存空间</span>
<span class="token keyword">func</span> <span class="token function">convTstring</span><span class="token punctuation">(</span>val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        x <span class="token operator">=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> stringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> val
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="getitab流程"><a href="#getitab流程" class="headerlink" title="getitab流程"></a>getitab流程</h2><ol>
<li>t=itabTable地址，保存地址避免执行find时地址被改变，t.find查找，不加锁</li>
<li>加锁使用itabTable.find，在itabAdd函数中新添加的itab在此处查到</li>
<li>加锁后没查到，新建m，调用itabAdd函数添加到itabTable</li>
<li>itabAdd函数中，容量超过3/4会进行翻倍扩容</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">getitab</span><span class="token punctuation">(</span>inter <span class="token operator">*</span>interfacetype<span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> canfail <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>itab <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"internal error - misuse of itab"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// easy case</span>
    <span class="token keyword">if</span> typ<span class="token punctuation">.</span>tflag<span class="token operator">&amp;</span>tflagUncommon <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> canfail <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        name <span class="token operator">:=</span> inter<span class="token punctuation">.</span>typ<span class="token punctuation">.</span><span class="token function">nameOff</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TypeAssertionError<span class="token punctuation">{</span><span class="token boolean">nil</span><span class="token punctuation">,</span> typ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inter<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> m <span class="token operator">*</span>itab

    <span class="token comment">// First, look in the existing table to see if we can find the itab we need.</span>
    <span class="token comment">// This is by far the most common case, so do it without locks.</span>
    <span class="token comment">// Use atomic to ensure we see any previous writes done by the thread</span>
    <span class="token comment">// that updates the itabTable field (with atomic.Storep in itabAdd).</span>
    t <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>itabTableType<span class="token punctuation">)</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Loadp</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabTable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> m <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> typ<span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">goto</span> finish
    <span class="token punctuation">}</span>

    <span class="token comment">// Not found.  Grab the lock and try again.</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>
    <span class="token keyword">if</span> m <span class="token operator">=</span> itabTable<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> typ<span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> finish
    <span class="token punctuation">}</span>

    <span class="token comment">// Entry doesn't exist yet. Make a new entry &amp; add it.</span>
    m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>itab<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">persistentalloc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>itab<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>
    m<span class="token punctuation">.</span>inter <span class="token operator">=</span> inter
    m<span class="token punctuation">.</span>_type <span class="token operator">=</span> typ
    <span class="token comment">// The hash is used in type switches. However, compiler statically generates itab's</span>
    <span class="token comment">// for all interface/type pairs used in switches (which are added to itabTable</span>
    <span class="token comment">// in itabsinit). The dynamically-generated itab's never participate in type switches,</span>
    <span class="token comment">// and thus the hash is irrelevant.</span>
    <span class="token comment">// Note: m.hash is _not_ the hash used for the runtime itabTable hash table.</span>
    m<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token number">0</span>
    m<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">itabAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>
finish<span class="token punctuation">:</span>
    <span class="token keyword">if</span> m<span class="token punctuation">.</span>fun<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> m
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> canfail <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// this can only happen if the conversion</span>
    <span class="token comment">// was already done once using the , ok form</span>
    <span class="token comment">// and we have a cached negative result.</span>
    <span class="token comment">// The cached result doesn't record which</span>
    <span class="token comment">// interface function was missing, so initialize</span>
    <span class="token comment">// the itab again to get the missing function name.</span>
    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TypeAssertionError<span class="token punctuation">{</span>concrete<span class="token punctuation">:</span> typ<span class="token punctuation">,</span> asserted<span class="token punctuation">:</span> <span class="token operator">&amp;</span>inter<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> missingMethod<span class="token punctuation">:</span> m<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/125488954" title="" target="">Golang中interface内部构造</a></li>
<li><a href="https://www.jianshu.com/p/5f8ecbe4f6af" title="" target="">剖析golang interface实现</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/07/go/defer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/07/go/defer/" class="post-title-link" itemprop="url">go defer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-07 13:07:35" itemprop="dateCreated datePublished" datetime="2020-05-07T13:07:35+00:00">2020-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h2><h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>先进后出的栈，在return后倒序执行</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">C
B
A<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="作用于函数返回值参数"><a href="#作用于函数返回值参数" class="headerlink" title="作用于函数返回值参数"></a>作用于函数返回值参数</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">returnWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>t <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1. t = 0</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        t <span class="token operator">=</span> t <span class="token operator">*</span> <span class="token number">10</span> <span class="token comment">// 3. t= 1*10</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token comment">// 2. t = 1</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">returnWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="panic和recover执行顺序"><a href="#panic和recover执行顺序" class="headerlink" title="panic和recover执行顺序"></a>panic和recover执行顺序</h3><p>根据出栈顺序先执行defer后输出panic，如不捕获panic直接异常退出</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"fmt"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main return"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer1 before panic, with recover"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer2 before panic, without recover"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"normal message before panic"</span><span class="token punctuation">)</span>

    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"panic message"</span><span class="token punctuation">)</span>

    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer after panic is unreachable"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">normal message before <span class="token builtin">panic</span>
defer2 before <span class="token builtin">panic</span><span class="token punctuation">,</span> without <span class="token builtin">recover</span>
defer1 before <span class="token builtin">panic</span><span class="token punctuation">,</span> with <span class="token builtin">recover</span>
<span class="token builtin">panic</span> message
main <span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="panic捕获顺序"><a href="#panic捕获顺序" class="headerlink" title="panic捕获顺序"></a>panic捕获顺序</h3><p>根据出栈顺序捕获最后一个panic</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"fatal"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"defer1 panic message"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"defer2 panic message"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"panic message"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">defer1 <span class="token builtin">panic</span> message<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="参数包含子函数"><a href="#参数包含子函数" class="headerlink" title="参数包含子函数"></a>参数包含子函数</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>src <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
    dst <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"'"</span>

    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go">a <span class="token comment">// f(f("a"))入栈，执行f("a")结果作为参数传入f(f("a"))</span>
b <span class="token comment">// f(f("b"))入栈，执行f("b")结果作为参数传入f(f("b"))</span>
b' <span class="token comment">// f(f("b")</span>
a' <span class="token comment">// f(f("a")</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h2><p>defer在编译阶段转换为<code>runtime.deferproc</code>，创建defer函数并注册到原函数中，使用单向链表保存，新注册defer添加到链表头<br>原函数的exit中插入<code>runtime.deferreturn</code>，负责函数exit返回前执行链表中的defer函数<br>per-P保存本地defer池，sched保存全局defer池，一般defer创建每次先从本地取，若本地池空，从全局池取到本地填满一半，用完后返回池子。如果是大空间defer使用mallocgc新分配空间，用完释放空间，不返回池子。</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> _defer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    siz     <span class="token builtin">int32</span> <span class="token comment">// 参数+返回</span>
    sp        <span class="token builtin">uintptr</span>  <span class="token comment">// 栈指针</span>
    pc        <span class="token builtin">uintptr</span>  <span class="token comment">// 返回地址</span>
    fn        <span class="token operator">*</span>funcval <span class="token comment">// 传入函数</span>
    _panic    <span class="token operator">*</span>_panic  <span class="token comment">// panic that is running defer</span>
    link      <span class="token operator">*</span>_defer <span class="token comment">// 单向链表指针，指向下一个defer</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">deferproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    d <span class="token operator">:=</span> <span class="token function">newdefer</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span>
    d<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn
    d<span class="token punctuation">.</span>pc <span class="token operator">=</span> callerpc
    d<span class="token punctuation">.</span>sp <span class="token operator">=</span> sp
    <span class="token keyword">switch</span> siz <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment">// Do nothing.</span>
    <span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token function">return0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">newdefer</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>_defer <span class="token punctuation">{</span>
    <span class="token keyword">var</span> d <span class="token operator">*</span>_defer
    sc <span class="token operator">:=</span> <span class="token function">deferclass</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> sc <span class="token operator">&lt;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>deferpool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 普通defer使用per-P本地池，如果为空从全局池取，取满到本地池一半的量</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token comment">// Allocate new defer+args.</span>
        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            total <span class="token operator">:=</span> <span class="token function">roundupsize</span><span class="token punctuation">(</span><span class="token function">totaldefersize</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>_defer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> deferType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    d<span class="token punctuation">.</span>siz <span class="token operator">=</span> siz
    d<span class="token punctuation">.</span>heap <span class="token operator">=</span> <span class="token boolean">true</span>
    d<span class="token punctuation">.</span>link <span class="token operator">=</span> gp<span class="token punctuation">.</span>_defer
    gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d
    <span class="token keyword">return</span> d
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">deferreturn</span><span class="token punctuation">(</span>arg0 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    d <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_defer
    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    sp <span class="token operator">:=</span> <span class="token function">getcallersp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> d<span class="token punctuation">.</span>sp <span class="token operator">!=</span> sp <span class="token punctuation">{</span> <span class="token comment">// 判断是否为caller注册的defer，用于函数返回</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> d<span class="token punctuation">.</span>openDefer <span class="token punctuation">{</span>
		done <span class="token operator">:=</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unfinished open-coded defers in deferreturn"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link
		<span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

    <span class="token keyword">switch</span> d<span class="token punctuation">.</span>siz <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment">// Do nothing.</span>
    <span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>
        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token function">memmove</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    fn <span class="token operator">:=</span> d<span class="token punctuation">.</span>fn
    d<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token boolean">nil</span>
    gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link
    <span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token boolean">_</span> <span class="token operator">=</span> fn<span class="token punctuation">.</span>fn
    <span class="token function">jmpdefer</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 实现defer循环</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">freedefer</span><span class="token punctuation">(</span>d <span class="token operator">*</span>_defer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>d<span class="token punctuation">.</span>heap <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    sc <span class="token operator">:=</span> <span class="token function">deferclass</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> sc <span class="token operator">&gt;=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>deferpool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 大空间defer不返回池子中</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    pp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">cap</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本地per-P的defer池子满，先放一半到全局defer池</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清空d信息</span>

    pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token comment">// 加入本地池</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="嵌套defer"><a href="#嵌套defer" class="headerlink" title="嵌套defer"></a>嵌套defer</h3><ol>
<li>A的defer链表为A2-&gt;A1</li>
<li>A返回前，A2.sp==sp of A，将A2从链表删除，同时执行A2的函数<code>_ = fn.fn</code>，<br>链表变为B2-&gt;B1-&gt;A1，执行<code>jmpdefer</code>跳转到A2</li>
<li>A2返回前，B2.s==sp of A2，将B2从链表删除，链表变为B1-&gt;A1</li>
<li>A2返回前，B1.s==sp of A2，将B1从链表删除，链表变为A1</li>
<li>此时A1.sp!=sp of A2，退出A2 defer的deferreturn，A2执行结束</li>
<li>A返回前，A1.sp==sp of A，将A1从链表删除</li>
<li>A返回</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">A1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">A2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">A2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">defer</span> <span class="token function">B1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">B2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="panic-x2F-recover"><a href="#panic-x2F-recover" class="headerlink" title="panic / recover"></a>panic / recover</h2><p>panic时，如果g有注册defer链表，使用<code>reflectcall</code>调用defer函数<br>若无recover，调用<code>fatalpanic</code>终止程序<br>若有recover，通过设置<strong>recovered</strong>字段标示，最后调用<code>recovery</code>恢复程序执行</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> _panic <span class="token keyword">struct</span> <span class="token punctuation">{</span>
  argp unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// defer函数指针</span>
  arg <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// panic参数</span>
  link <span class="token operator">*</span>_panic <span class="token comment">// panic的单向链表指针</span>
  pc <span class="token builtin">uintptr</span>
  sp unsafe<span class="token punctuation">.</span>Pointer
  recovered <span class="token builtin">bool</span> <span class="token comment">// recover标示</span>
  aborted <span class="token builtin">bool</span>
  goexit <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gopanic</span><span class="token punctuation">(</span>e <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> p _panic
    p<span class="token punctuation">.</span>arg <span class="token operator">=</span> e
    p<span class="token punctuation">.</span>link <span class="token operator">=</span> gp<span class="token punctuation">.</span>_panic
    gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>_panic<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">noescape</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> <span class="token punctuation">{</span>
        d <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_defer
        <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
            <span class="token keyword">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 执行reflectcall调用注册的defer函数</span>
        <span class="token keyword">if</span> d<span class="token punctuation">.</span>openDefer <span class="token punctuation">{</span>
            done <span class="token operator">=</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
            <span class="token keyword">if</span> done <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>recovered <span class="token punctuation">{</span>
                <span class="token function">addOneOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            p<span class="token punctuation">.</span>argp <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">getargp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reflectcall</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> p<span class="token punctuation">.</span>recovered <span class="token punctuation">{</span>
            gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> p<span class="token punctuation">.</span>link
            <span class="token keyword">for</span> gp<span class="token punctuation">.</span>_panic <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>aborted <span class="token punctuation">{</span>
                gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> gp<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>link
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> gp<span class="token punctuation">.</span>_panic <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// must be done with signal</span>
                gp<span class="token punctuation">.</span>sig <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
            gp<span class="token punctuation">.</span>sigcode0 <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>
            gp<span class="token punctuation">.</span>sigcode1 <span class="token operator">=</span> pc
            <span class="token function">mcall</span><span class="token punctuation">(</span>recovery<span class="token punctuation">)</span> <span class="token comment">// 调用recovery恢复程序</span>
            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"recovery failed"</span><span class="token punctuation">)</span> <span class="token comment">// mcall should not return</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">preprintpanics</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>_panic<span class="token punctuation">)</span>

    <span class="token function">fatalpanic</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>_panic<span class="token punctuation">)</span> <span class="token comment">// 终止程序</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>      <span class="token comment">// not reached</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">gorecover</span><span class="token punctuation">(</span>argp <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    p <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_panic
    <span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>goexit <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>recovered <span class="token operator">&amp;&amp;</span> argp <span class="token operator">==</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>argp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">.</span>recovered <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">return</span> p<span class="token punctuation">.</span>arg
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">recovery</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>sigcode0
    pc <span class="token operator">:=</span> gp<span class="token punctuation">.</span>sigcode1

    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>sp <span class="token operator">=</span> sp
    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>pc <span class="token operator">=</span> pc
    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>lr <span class="token operator">=</span> <span class="token number">0</span>
    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>ret <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/115472856" title="" target="">Golang中的Defer必掌握的7知识点</a></li>
<li><a href="https://www.bilibili.com/video/BV1E5411x7NC" title="" target="">defer1.12</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/05/go/dlv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/05/go/dlv/" class="post-title-link" itemprop="url">dlv调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-05 21:06:42" itemprop="dateCreated datePublished" datetime="2020-05-05T21:06:42+00:00">2020-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dlv安装"><a href="#dlv安装" class="headerlink" title="dlv安装"></a>dlv安装</h2><p><a target="_blank" rel="noopener" href="https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md">https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md</a></p>
<p>使用<code>make install</code>安装</p>
<h2 id="vscode调试"><a href="#vscode调试" class="headerlink" title="vscode调试"></a>vscode调试</h2><p><a target="_blank" rel="noopener" href="https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code">https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/04/go/modules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/04/go/modules/" class="post-title-link" itemprop="url">go module</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-04 22:10:36" itemprop="dateCreated datePublished" datetime="2020-05-04T22:10:36+00:00">2020-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="go-module"><a href="#go-module" class="headerlink" title="go_module"></a>go_module</h2><h3 id="1-11之前"><a href="#1-11之前" class="headerlink" title="1.11之前"></a>1.11之前</h3><ul>
<li>依赖<code>$GOPATH</code></li>
<li>版本使用克隆时分支代码</li>
<li>采用 vendor手动版本管理 / godep锁定版本管理</li>
</ul>
<h3 id="最小化版本选择-MVS-Minimal-Version-Selection"><a href="#最小化版本选择-MVS-Minimal-Version-Selection" class="headerlink" title="最小化版本选择 MVS(Minimal Version Selection)"></a>最小化版本选择 MVS(Minimal Version Selection)</h3><img src="/2020/05/04/go/modules/go-modules-mvs-1.png" class="">

<ol>
<li>godep会选择D的1.X.X最新最大版本，在语义版本化和遵守社会契约的前提下可以正常工作。</li>
<li>go会选择最小版本：</li>
</ol>
<ul>
<li>A -&gt; D v1.0.6</li>
<li>A+B -&gt; D v1.2.0</li>
<li>A+B+C -&gt; D v1.3.2</li>
</ul>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li>go.mod文件，它与package.json或Pipfile文件的功能类似。</li>
<li>验证文件go.sum。</li>
<li>不再有GOPATH限制。模块可以位于任何路径中。</li>
</ol>
<h3 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> mod init github<span class="token punctuation">.</span>com<span class="token operator">/</span>username<span class="token operator">/</span>repository<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="升级依赖关系，默认最小化升级"><a href="#升级依赖关系，默认最小化升级" class="headerlink" title="升级依赖关系，默认最小化升级"></a>升级依赖关系，默认最小化升级</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ go get <span class="token parameter variable">-t</span> <span class="token parameter variable">-d</span> <span class="token parameter variable">-v</span> ./<span class="token punctuation">..</span>.<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>-t flag：考虑构建测试所需的module。<br>-d flag：下载每个module的源代码，但不要构建或安装它们。<br>-v flag：提供详细输出。<br>./… ：在整个源代码树中执行这些操作，并且仅更新所需的依赖项。<br>-u flag 最新最大升级，通常不使用</p>
</blockquote>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="列出软件包的可用版本"><a href="#列出软件包的可用版本" class="headerlink" title="列出软件包的可用版本"></a>列出软件包的可用版本</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ go list <span class="token parameter variable">-m</span> <span class="token parameter variable">-versions</span> github.com/getsentry/raven-go
github.com/getsentry/raven-go v0.1.0 v0.1.1 v0.1.2 v0.2.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>添加依赖项是隐式的。在代码中导入依赖项后，运行go build或go test命令将获取模块的最新版本并将其添加到go.mod文件中。<br>如果要显式添加依赖项，请运行go get github.com/username/repository。</p>
<h4 id="依赖项的升级-x2F-降级"><a href="#依赖项的升级-x2F-降级" class="headerlink" title="依赖项的升级/降级"></a>依赖项的升级/降级</h4><p>go get github.com/username/<a href="mailto:repository@vx.x.x">repository@vx.x.x</a>下载并设置依赖项和更新go.mod文件的特定版本</p>
<h4 id="mod命令"><a href="#mod命令" class="headerlink" title="mod命令"></a>mod命令</h4><ul>
<li>go mod init：生成 go.mod 文件</li>
<li>go mod download : 下载 go.mod 文件中指明的所有依赖</li>
<li>go mod tidy: 整理现有的依赖</li>
<li>go mod graph: 查看现有的依赖结构</li>
<li>go mod edit : 编辑 go.mod 文件</li>
<li>go mod vendor : 导出项目所有的依赖到vendor目录</li>
<li>go mod verify: 校验一个模块是否被篡改过</li>
<li>go mod why : 查看为什么需要依赖某模块</li>
</ul>
<h3 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h3><ul>
<li><p>阿里云<br><a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/goproxy/">https://mirrors.aliyun.com/goproxy/</a></p>
</li>
<li><p>七牛云<br>goproxy.cn,direct</p>
</li>
</ul>
<p>设置：<br><code>$ go env -w GOPROXY=https://goproxy.cn,direct</code><br>direct用于proxy代理返404后回源到源地址</p>
<h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>GOOS=linux GOARCH=amd64 go build</p>
<h2 id="node-module"><a href="#node-module" class="headerlink" title="node_module"></a>node_module</h2><h3 id="依赖黑洞"><a href="#依赖黑洞" class="headerlink" title="依赖黑洞"></a>依赖黑洞</h3><p>项目依赖A和C，A和C依赖不同版本的B</p>
<img src="/2020/05/04/go/modules/npm_v0.jpg" class="">
<img src="/2020/05/04/go/modules/npm_v1.jpg" class="">

<p>考虑两个问题：</p>
<ol>
<li>B的次要版本可以共存，并且没有副作用。但node有js全局污染可能。</li>
<li>B的次要版本可以共存，如何保证A和C正确加载<code>B v2.0</code></li>
</ol>
<h3 id="npm解决方式"><a href="#npm解决方式" class="headerlink" title="npm解决方式"></a>npm解决方式</h3><p>递归向上查找node_modules里的package，如果在 ‘/home/my/projects/foo.js’ 文件里调用了 require(‘bar.js’)，则 Node.js 会按以下顺序查找：</p>
<ul>
<li>/home/my/projects/node_modules/bar.js</li>
<li>/home/my/node_modules/bar.js</li>
<li>/home/node_modules/bar.js</li>
<li>/node_modules/bar.js</li>
</ul>
<p>算法核心</p>
<ul>
<li>优先读取最近的node_modules的依赖</li>
<li>递归向上查找node_modules依赖</li>
</ul>
<p>假设D也依赖<code>B v2.0</code>，node_modules结构如下</p>
<img src="/2020/05/04/go/modules/npm_v1.1.jpg" class="">

<p> 相同的<code>B v2.0</code>被依赖了两次，在node中lodash等公用插件会造成极大空间浪费</p>
<p>利用<code>递归向上</code>特性，将公共库放在顶层</p>
<img src="/2020/05/04/go/modules/npm_v3.jpg" class="">

<p>若B和E依赖<code>B v1.0</code>，C和D依赖<code>B v2.0</code>，问题依旧存在</p>
<img src="/2020/05/04/go/modules/npm_v3.1.jpg" class="">

<h3 id="幻依赖"><a href="#幻依赖" class="headerlink" title="幻依赖"></a>幻依赖</h3><img src="/2020/05/04/go/modules/Phantom_1.jpg" class="">
<img src="/2020/05/04/go/modules/Phantom_2.jpg" class="">

<p>glob和brace-expansion都不在depdencies里，但是我们开发和运行时都可以正常工作（因为这个是rimraf的依赖），一旦将该库发布，因为用户安装我们的库的时候并不会安装库的devDepdency，这导致在用户的地方会运行报错。</p>
<h3 id="yarn-lock-vs-npm-lock"><a href="#yarn-lock-vs-npm-lock" class="headerlink" title="yarn lock vs npm lock"></a>yarn lock vs npm lock</h3><img src="/2020/05/04/go/modules/package.jpg" class="">
<img src="/2020/05/04/go/modules/yarn.jpg" class="">

<p>通过lock开发版本在生产复现环境。但无法规避npm全局cli。</p>
<h3 id="库里应该提交lock文件吗"><a href="#库里应该提交lock文件吗" class="headerlink" title="库里应该提交lock文件吗"></a>库里应该提交lock文件吗</h3><p>应该。可以很大程度避免环境差异。</p>
<h3 id="确定性"><a href="#确定性" class="headerlink" title="确定性"></a>确定性</h3><img src="/2020/05/04/go/modules/yarn.lock.jpg" class="">

<p>yarn.lock仅提供版本确定性，无法保证node_modules拓扑，如下两种拓扑都是合理的</p>
<p>第一种</p>
<img src="/2020/05/04/go/modules/topo1.jpg" class="">

<p>第二种</p>
<img src="/2020/05/04/go/modules/topo2.jpg" class="">

<p>npm的lock包含拓扑信息</p>
<img src="/2020/05/04/go/modules/npm_topo.jpg" class="">

<h3 id="PNPM"><a href="#PNPM" class="headerlink" title="PNPM"></a>PNPM</h3><p>npm和yarn通过文件目录和node resolve算法模拟的实际上是有向无环图的一个超集（多出了很多错误祖先节点和兄弟节点之间的链接），这导致了很多的问题，所以我们需要更加接近DAG的模拟。pnpm正是采取了这种解决方式，通过更加精确的模拟DAG来解决yarn和npm代理的问题。</p>
<p>npm的结构</p>
<img src="/2020/05/04/go/modules/npm_arch.jpg" class="">

<p>代码可以使用<code>express</code>引入的<code>debug</code>模块，即使没有显式的引入</p>
<img src="/2020/05/04/go/modules/pnpm_package.jpg" class="">

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// src/index.js</span>
<span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>pnpm的结构</p>
<img src="/2020/05/04/go/modules/pnpm_arch.jpg" class="">

<p>顶层已没有<code>debug</code>模块，因此代码里不会错误的引用</p>
<h3 id="pnpm-vs-yarn"><a href="#pnpm-vs-yarn" class="headerlink" title="pnpm vs yarn"></a>pnpm vs yarn</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>
    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"4.0.0"</span><span class="token punctuation">,</span>
    <span class="token property">"koa"</span><span class="token operator">:</span> <span class="token string">"^2.11.0"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token literal-property property">dependencies</span><span class="token operator">:</span>
debug <span class="token number">3.1</span><span class="token number">.0</span>
express <span class="token number">4.0</span><span class="token number">.0</span>
├── debug <span class="token number">0.8</span><span class="token number">.1</span>
├─┬ send <span class="token number">0.2</span><span class="token number">.0</span>
│ └── debug <span class="token number">1.0</span><span class="token number">.5</span>
└─┬ serve<span class="token operator">-</span><span class="token keyword">static</span> <span class="token number">1.0</span><span class="token number">.1</span>
  └─┬ send <span class="token number">0.1</span><span class="token number">.4</span>
    └── debug <span class="token number">1.0</span><span class="token number">.5</span>
koa <span class="token number">2.11</span><span class="token number">.0</span>
└── debug <span class="token number">3.1</span><span class="token number">.0</span><span class="token operator">%</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>yarn放在不同层级，依赖递归查找算法来选择版本</p>
<img src="/2020/05/04/go/modules/pnpm_module.jpg" class="">

<p>pnpm将不同版本放在同一层级里通过软链选择加载版本，彻底避免了包重复问题，节省大量时间和空间</p>
<img src="/2020/05/04/go/modules/monorepo_sample.jpg" class="">

<h2 id="TODO-mvn"><a href="#TODO-mvn" class="headerlink" title="TODO mvn"></a>TODO mvn</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://semver.org/lang/zh-CN/" title="" target="">语义化版本</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/137535779" title="" target="">知乎 - node_modules 困境</a></li>
<li><a href="https://tonybai.com/2019/09/21/brief-history-of-go-package-management/" title="" target="">Go语言包管理简史</a></li>
<li><a href="https://tonybai.com/2019/12/21/go-modules-minimal-version-selection/" title="" target="">Go modules：最小版本选择</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/41627929" title="" target="">关于Go Module的争吵</a></li>
<li><a href="https://research.swtch.com/vgo-principles" title="" target="">The Principles of Versioning in Go</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/30/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/30/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">数据库测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-30 05:46:23" itemprop="dateCreated datePublished" datetime="2020-04-30T05:46:23+00:00">2020-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><h3 id="版本5-7"><a href="#版本5-7" class="headerlink" title="版本5.7"></a>版本5.7</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token operator">|</span> <span class="token number">5.7</span><span class="token number">.29</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="范围查询包含非key字段"><a href="#范围查询包含非key字段" class="headerlink" title="范围查询包含非key字段"></a>范围查询包含非key字段</h3><h4 id="1个字符，4000W"><a href="#1个字符，4000W" class="headerlink" title="1个字符，4000W"></a>1个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">5</span> min <span class="token number">19.25</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="90-范围查询，带text字段，不走索引"><a href="#90-范围查询，带text字段，不走索引" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41863640</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.13</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="10-范围查询，带text字段，不走索引"><a href="#10-范围查询，带text字段，不走索引" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41863640</span> <span class="token operator">|</span>    <span class="token number">19.10</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.12</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="树高度"><a href="#树高度" class="headerlink" title="树高度"></a>树高度</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> b<span class="token punctuation">.</span>name<span class="token punctuation">,</span> a<span class="token punctuation">.</span>name<span class="token punctuation">,</span> index_id<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>space<span class="token punctuation">,</span> a<span class="token punctuation">.</span>PAGE_NO <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_SYS_INDEXES a<span class="token punctuation">,</span> information_schema<span class="token punctuation">.</span>INNODB_SYS_TABLES b <span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>table_id <span class="token operator">=</span> b<span class="token punctuation">.</span>table_id <span class="token operator">AND</span> a<span class="token punctuation">.</span>space <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token operator">and</span> b<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'test/test'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span>
<span class="token operator">|</span> name      <span class="token operator">|</span> name    <span class="token operator">|</span> index_id <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> space <span class="token operator">|</span> PAGE_NO <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span>
<span class="token operator">|</span> test<span class="token operator">/</span>test <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span>       <span class="token number">93</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">60</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">|</span> test<span class="token operator">/</span>test <span class="token operator">|</span> uk1     <span class="token operator">|</span>       <span class="token number">94</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">60</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span>
<span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.08</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">// 主键 <span class="token number">3</span>*16384+64，level为0x02，高度为3
$ hexdump <span class="token parameter variable">-s</span> <span class="token number">49216</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> test.ibd
000c040 00 02 00 00 00 00 00 00 00 5d
000c04a
// uk1 <span class="token number">4</span>*16384+64，level为0x02，高度为3
$ hexdump <span class="token parameter variable">-s</span> <span class="token number">65600</span> <span class="token parameter variable">-n</span> <span class="token number">10</span> test.ibd
0010040 00 02 00 00 00 00 00 00 00 5e
001004a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="5个字符，4000W"><a href="#5个字符，4000W" class="headerlink" title="5个字符，4000W"></a>5个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">4</span> min <span class="token number">55.59</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="90-范围查询，带text字段，不走索引-1"><a href="#90-范围查询，带text字段，不走索引-1" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41853552</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="10-范围查询，带text字段，不走索引-1"><a href="#10-范围查询，带text字段，不走索引-1" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41853552</span> <span class="token operator">|</span>    <span class="token number">19.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="200个字符，4000W"><a href="#200个字符，4000W" class="headerlink" title="200个字符，4000W"></a>200个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">6</span> min <span class="token number">58.89</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="90-范围查询，带text字段，不走索引-2"><a href="#90-范围查询，带text字段，不走索引-2" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41342675</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="90-范围查询，仅查询索引字段或count-计数，走索引"><a href="#90-范围查询，仅查询索引字段或count-计数，走索引" class="headerlink" title="90%范围查询，仅查询索引字段或count(*)计数，走索引"></a>90%范围查询，仅查询索引字段或count(*)计数，走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="10-范围查询，带text字段，不走索引-2"><a href="#10-范围查询，带text字段，不走索引-2" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41342675</span> <span class="token operator">|</span>    <span class="token number">19.34</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="主键查询固定走索引"><a href="#主键查询固定走索引" class="headerlink" title="主键查询固定走索引"></a>主键查询固定走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="200个字符，1W"><a href="#200个字符，1W" class="headerlink" title="200个字符，1W"></a>200个字符，1W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span>
<span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.11</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="90-范围查询，带text字段，不走索引-3"><a href="#90-范围查询，带text字段，不走索引-3" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">10140</span> <span class="token operator">|</span>    <span class="token number">90.89</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="10-范围查询，带text字段，走索引"><a href="#10-范围查询，带text字段，走索引" class="headerlink" title="10%范围查询，带text字段，走索引"></a>10%范围查询，带text字段，走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">1024</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="200个字符，4000W，耗时比较"><a href="#200个字符，4000W，耗时比较" class="headerlink" title="200个字符，4000W，耗时比较"></a>200个字符，4000W，耗时比较</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token function">time</span> mysql <span class="token builtin class-name">test</span> <span class="token parameter variable">-e</span> <span class="token string">"select * from test where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'"</span> <span class="token operator">&gt;</span> /dev/null

real 2m54.656s
user 1m4.118s
sys 0m4.271s

$ <span class="token function">time</span> mysql <span class="token builtin class-name">test</span> <span class="token parameter variable">-e</span> <span class="token string">"select * from test force index(uk1) where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'"</span> <span class="token operator">&gt;</span> /dev/null

real 1m43.517s
user 0m59.562s
sys 0m3.959s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                                                                                                                                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">42990946</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020/04/01'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- insert into test values(1,'2020/04/01', repeat('a', 5));</span>
<span class="token comment">-- insert into test values(1,'2020/04/01', repeat('a', 200));</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/01'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="autoincrement-x2F-uuid-insert速度比较"><a href="#autoincrement-x2F-uuid-insert速度比较" class="headerlink" title="autoincrement / uuid  insert速度比较"></a>autoincrement / uuid  insert速度比较</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> test02<span class="token punctuation">(</span>
id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span>
<span class="token keyword">date</span> <span class="token keyword">timestamp</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token keyword">current_timestamp</span> <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">,</span>
name <span class="token keyword">text</span><span class="token punctuation">,</span>
<span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">key</span> uk1 <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>


<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token number">1048577</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test01<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/15'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1048577</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">12.73</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">1048577</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>


<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token number">1048577</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test02<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'2020/04/15'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1048576</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">17.31</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">1048576</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>


<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token number">16777232</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test01<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/30'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">16777232</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">4</span> min <span class="token number">11.18</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">16777232</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>


<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token number">16777216</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> test02<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'2020/04/30'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">16777216</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">5</span> min <span class="token number">41.65</span> sec<span class="token punctuation">)</span>
Records: <span class="token number">16777216</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="view"><a href="#view" class="headerlink" title="view"></a>view</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span>  <span class="token number">1048576</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.29</span> sec<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_view<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token operator">|</span> <span class="token number">10485760</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">34.62</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span>  test_view <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">500</span> <span class="token operator">and</span> id2 <span class="token operator">between</span> <span class="token number">700</span> <span class="token operator">and</span> <span class="token number">710</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span>   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">104695</span> <span class="token operator">|</span>    <span class="token number">11.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> test01     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1047386</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test02     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test03     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test04     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test05     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test06     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test07     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test08     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test09     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test10     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span>
<span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>


<span class="token keyword">explain</span> <span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span>  test_view_pk <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">500</span> <span class="token operator">and</span> id2 <span class="token operator">between</span> <span class="token number">700</span> <span class="token operator">and</span> <span class="token number">710</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span>   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">104695</span> <span class="token operator">|</span>    <span class="token number">11.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> test01     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1047386</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test02     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test03     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test04     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test05     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test06     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test07     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test08     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test09     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test10     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span>
<span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="语句-1"><a href="#语句-1" class="headerlink" title="语句"></a>语句</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test01<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>id2<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name1<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name2<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id1<span class="token punctuation">`</span></span><span class="token punctuation">,</span> <span class="token identifier"><span class="token punctuation">`</span>id2<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token comment">-- test02 -- test10</span>

<span class="token keyword">create</span> <span class="token keyword">view</span> test_view <span class="token keyword">as</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test02
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test04
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test05
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test06
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test07
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test08
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test09
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test10

<span class="token keyword">create</span> <span class="token keyword">view</span> test_view_pk <span class="token keyword">as</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test01
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test02
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test03
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test04
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test05
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test06
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test07
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test08
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test09
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">1024</span><span class="token punctuation">}</span>
<span class="token keyword">do</span>
    <span class="token assign-left variable">s</span><span class="token operator">=</span><span class="token string">""</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">j</span> <span class="token keyword">in</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">1024</span><span class="token punctuation">}</span>
    <span class="token keyword">do</span>
        <span class="token assign-left variable">s</span><span class="token operator">+=</span><span class="token string">"(<span class="token variable">$i</span>, <span class="token variable">$j</span>, 'a', 'b')"</span>
        <span class="token assign-left variable">s</span><span class="token operator">+=</span><span class="token string">","</span>
    <span class="token keyword">done</span>
    mysql <span class="token builtin class-name">test</span> <span class="token parameter variable">-e</span> <span class="token string">"insert into test01 values<span class="token variable">${s<span class="token operator">%</span><span class="token operator">,</span>}</span>"</span> <span class="token operator">&amp;</span>
<span class="token keyword">done</span>

<span class="token function">wait</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test02 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test10 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h3 id="binlog-row-image"><a href="#binlog-row-image" class="headerlink" title="binlog_row_image"></a>binlog_row_image</h3><p>full： before image和after image都为全量字段<br>minimal： before image仅用于区分记录字段(主键等)，after image仅语句指定字段(更新字段)</p>
<h4 id="create-table"><a href="#create-table" class="headerlink" title="create table"></a>create table</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s1<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>s2<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="full"><a href="#full" class="headerlink" title="full"></a>full</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a1'</span><span class="token punctuation">,</span> <span class="token string">'b1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">### INSERT INTO `test`.`test`</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">### DELETE FROM `test`.`test`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>

<span class="token keyword">update</span> test00 <span class="token keyword">set</span> s2<span class="token operator">=</span><span class="token string">'c123'</span> <span class="token keyword">where</span> s1<span class="token operator">=</span><span class="token string">'a1'</span><span class="token punctuation">;</span>

<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b3' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="minimal"><a href="#minimal" class="headerlink" title="minimal"></a>minimal</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a2'</span><span class="token punctuation">,</span> <span class="token string">'b2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">### INSERT INTO `test`.`test`</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @3='a2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">### DELETE FROM `test`.`test`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span>

<span class="token keyword">update</span> test00 <span class="token keyword">set</span> s2<span class="token operator">=</span><span class="token string">'d123'</span> <span class="token keyword">where</span> s1<span class="token operator">=</span><span class="token string">'a2'</span><span class="token punctuation">;</span>

<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### UPDATE `mysqltt`.`test00`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">### SET</span>
<span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="使用备份idb快速恢复历史数据"><a href="#使用备份idb快速恢复历史数据" class="headerlink" title="使用备份idb快速恢复历史数据"></a>使用备份idb快速恢复历史数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">45.11</span> sec<span class="token punctuation">)</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>
ERROR <span class="token number">1814</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Tablespace</span> has been discarded <span class="token keyword">for</span> <span class="token keyword">table</span> <span class="token string">'test'</span>


flush <span class="token keyword">table</span> test <span class="token keyword">for</span> export<span class="token punctuation">;</span>
scp <span class="token operator">/</span>backup_node<span class="token operator">/</span>path_to_dat<span class="token operator">/</span>test<span class="token punctuation">.</span>ibd <span class="token operator">/</span>recover_node<span class="token operator">/</span>path_to_dat<span class="token operator">/</span>

<span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">18.73</span> sec<span class="token punctuation">)</span>
<span class="token keyword">show</span> <span class="token keyword">full</span> processlist<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span>
<span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span> <span class="token operator">|</span> Host      <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State       <span class="token operator">|</span> Info                               <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> test <span class="token operator">|</span> Query   <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span> System <span class="token keyword">lock</span> <span class="token operator">|</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">starting</span>    <span class="token operator">|</span> <span class="token keyword">show</span> <span class="token keyword">full</span> processlist              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> name  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span> aaaaa <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="锁等待"><a href="#锁等待" class="headerlink" title="锁等待"></a>锁等待</h3><ul>
<li><code>show engine innodb status</code>看死锁/锁等待</li>
<li><code>information_schema.innodb_locks</code>和<code>information_schema.innodb_lock_waits</code>看锁关系信息</li>
<li><code>performance_schema.events_statements_history</code>和<code>performance_schema.threads</code>看<code>show processlist</code>中pid执行历史语句</li>
<li><code>information_schema.innodb_trx</code>看当前执行中未提交事务</li>
</ul>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session1</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session2</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
<span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session3</span>
<span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span>\G<span class="token punctuation">;</span>

LIST <span class="token keyword">OF</span> <span class="token keyword">TRANSACTIONS</span> <span class="token keyword">FOR</span> EACH <span class="token keyword">SESSION</span>:
<span class="token comment">---TRANSACTION 281479529381440, not started</span>
<span class="token number">0</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token comment">---TRANSACTION 160786, ACTIVE 16 sec starting index read</span>
mysql <span class="token keyword">tables</span> <span class="token operator">in</span> <span class="token keyword">use</span> <span class="token number">1</span><span class="token punctuation">,</span> locked <span class="token number">1</span>
<span class="token keyword">LOCK</span> WAIT <span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
MySQL thread id <span class="token number">2</span><span class="token punctuation">,</span> OS thread handle <span class="token number">123145348661248</span><span class="token punctuation">,</span> query id <span class="token number">74</span> localhost root updating
<span class="token keyword">delete</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">------- TRX HAS BEEN WAITING 16 SEC FOR THIS LOCK TO BE GRANTED:</span>
RECORD LOCKS space id <span class="token number">66</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">552</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>test01<span class="token punctuation">`</span></span> trx id <span class="token number">160786</span> lock_mode X locks rec but <span class="token operator">not</span> gap waiting
Record <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">32</span>
 <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">2</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000027411</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     t <span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">3</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">310000013</span>f2879<span class="token punctuation">;</span> <span class="token keyword">asc</span> <span class="token number">1</span>   ?<span class="token punctuation">(</span>y<span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">4</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">61</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> a<span class="token punctuation">;</span><span class="token punctuation">;</span>
 <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">62</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> b<span class="token punctuation">;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session4</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_lock_waits<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>
<span class="token operator">|</span> requesting_trx_id <span class="token operator">|</span> requested_lock_id <span class="token operator">|</span> blocking_trx_id <span class="token operator">|</span> blocking_lock_id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>
<span class="token operator">|</span> <span class="token number">160787</span>            <span class="token operator">|</span> <span class="token number">160787</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span>     <span class="token operator">|</span> <span class="token number">160785</span>          <span class="token operator">|</span> <span class="token number">160785</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_locks<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span>
<span class="token operator">|</span> lock_id       <span class="token operator">|</span> lock_trx_id <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_table      <span class="token operator">|</span> lock_index <span class="token operator">|</span> lock_space <span class="token operator">|</span> lock_page <span class="token operator">|</span> lock_rec <span class="token operator">|</span> lock_data <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span>
<span class="token operator">|</span> <span class="token number">160787</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">160787</span>      <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>test01<span class="token punctuation">`</span></span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">66</span> <span class="token operator">|</span>         <span class="token number">4</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">160785</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">160785</span>      <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span><span class="token punctuation">.</span><span class="token identifier"><span class="token punctuation">`</span>test01<span class="token punctuation">`</span></span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">66</span> <span class="token operator">|</span>         <span class="token number">4</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session5</span>
<span class="token keyword">SELECT</span> THREAD_ID<span class="token punctuation">,</span>TIMER_START<span class="token punctuation">,</span>TIMER_END<span class="token punctuation">,</span>TIMER_WAIT<span class="token punctuation">,</span>SQL_TEXT<span class="token punctuation">,</span>MESSAGE_TEXT <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>events_statements_history <span class="token keyword">WHERE</span> thread_id <span class="token operator">=</span> <span class="token punctuation">(</span>     <span class="token keyword">SELECT</span> THREAD_ID <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>threads <span class="token keyword">WHERE</span> PROCESSLIST_ID <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">)</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">36</span>
 TIMER_START: <span class="token number">2048071080000000</span>
   TIMER_END: <span class="token number">2048071201000000</span>
  TIMER_WAIT: <span class="token number">121000000</span>
    SQL_TEXT: <span class="token keyword">select</span> @<span class="token variable">@version_comment</span> <span class="token keyword">limit</span> <span class="token number">1</span>
MESSAGE_TEXT: <span class="token boolean">NULL</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">36</span>
 TIMER_START: <span class="token number">2049834364000000</span>
   TIMER_END: <span class="token number">2049834417000000</span>
  TIMER_WAIT: <span class="token number">53000000</span>
    SQL_TEXT: <span class="token keyword">begin</span>
MESSAGE_TEXT: <span class="token boolean">NULL</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">3.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">36</span>
 TIMER_START: <span class="token number">2055696930000000</span>
   TIMER_END: <span class="token number">2055730415000000</span>
  TIMER_WAIT: <span class="token number">33485000000</span>
    SQL_TEXT: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span>
MESSAGE_TEXT: <span class="token boolean">NULL</span>

<span class="token keyword">SELECT</span> THREAD_ID<span class="token punctuation">,</span>TIMER_START<span class="token punctuation">,</span>TIMER_END<span class="token punctuation">,</span>TIMER_WAIT<span class="token punctuation">,</span>SQL_TEXT<span class="token punctuation">,</span>MESSAGE_TEXT <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>events_statements_history <span class="token keyword">WHERE</span> thread_id <span class="token operator">=</span> <span class="token punctuation">(</span>     <span class="token keyword">SELECT</span> THREAD_ID <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>threads <span class="token keyword">WHERE</span> PROCESSLIST_ID <span class="token operator">=</span> <span class="token number">12</span> <span class="token punctuation">)</span>\G
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">38</span>
 TIMER_START: <span class="token number">2197004107000000</span>
   TIMER_END: <span class="token number">2197008105000000</span>
  TIMER_WAIT: <span class="token number">3998000000</span>
    SQL_TEXT: <span class="token keyword">select</span> @<span class="token variable">@version_comment</span> <span class="token keyword">limit</span> <span class="token number">1</span>
MESSAGE_TEXT: <span class="token boolean">NULL</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">38</span>
 TIMER_START: <span class="token number">2198577580000000</span>
   TIMER_END: <span class="token number">2198577653000000</span>
  TIMER_WAIT: <span class="token number">73000000</span>
    SQL_TEXT: <span class="token keyword">begin</span>
MESSAGE_TEXT: <span class="token boolean">NULL</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">3.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
   THREAD_ID: <span class="token number">38</span>
 TIMER_START: <span class="token number">2200660449000000</span>
   TIMER_END: <span class="token number">2251869851000000</span>
  TIMER_WAIT: <span class="token number">51209402000000</span>
    SQL_TEXT: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span>
MESSAGE_TEXT: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session 6</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_trx\G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
                    trx_id: <span class="token number">169733</span>
                 trx_state: <span class="token keyword">LOCK</span> WAIT
               trx_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">47</span>
     trx_requested_lock_id: <span class="token number">169733</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">3</span>
          trx_wait_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">47</span>
                trx_weight: <span class="token number">2</span>
       trx_mysql_thread_id: <span class="token number">3</span>
                 trx_query: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span>
       trx_operation_state: <span class="token keyword">starting</span> <span class="token keyword">index</span> <span class="token keyword">read</span>
         trx_tables_in_use: <span class="token number">1</span>
         trx_tables_locked: <span class="token number">1</span>
          trx_lock_structs: <span class="token number">2</span>
     trx_lock_memory_bytes: <span class="token number">1136</span>
           trx_rows_locked: <span class="token number">1</span>
         trx_rows_modified: <span class="token number">0</span>
   trx_concurrency_tickets: <span class="token number">0</span>
       trx_isolation_level: <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span>
         trx_unique_checks: <span class="token number">1</span>
    trx_foreign_key_checks: <span class="token number">1</span>
trx_last_foreign_key_error: <span class="token boolean">NULL</span>
 trx_adaptive_hash_latched: <span class="token number">0</span>
 trx_adaptive_hash_timeout: <span class="token number">0</span>
          trx_is_read_only: <span class="token number">0</span>
trx_autocommit_non_locking: <span class="token number">0</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
                    trx_id: <span class="token number">169732</span>
                 trx_state: RUNNING
               trx_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">32</span>
     trx_requested_lock_id: <span class="token boolean">NULL</span>
          trx_wait_started: <span class="token boolean">NULL</span>
                trx_weight: <span class="token number">3</span>
       trx_mysql_thread_id: <span class="token number">2</span>
                 trx_query: <span class="token boolean">NULL</span>
       trx_operation_state: <span class="token boolean">NULL</span>
         trx_tables_in_use: <span class="token number">0</span>
         trx_tables_locked: <span class="token number">1</span>
          trx_lock_structs: <span class="token number">2</span>
     trx_lock_memory_bytes: <span class="token number">1136</span>
           trx_rows_locked: <span class="token number">1</span>
         trx_rows_modified: <span class="token number">1</span>
   trx_concurrency_tickets: <span class="token number">0</span>
       trx_isolation_level: <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span>
         trx_unique_checks: <span class="token number">1</span>
    trx_foreign_key_checks: <span class="token number">1</span>
trx_last_foreign_key_error: <span class="token boolean">NULL</span>
 trx_adaptive_hash_latched: <span class="token number">0</span>
 trx_adaptive_hash_timeout: <span class="token number">0</span>
          trx_is_read_only: <span class="token number">0</span>
trx_autocommit_non_locking: <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test\G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
       <span class="token keyword">Table</span>: test
<span class="token keyword">Create</span> <span class="token keyword">Table</span>: <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">text</span><span class="token punctuation">,</span>
  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">,</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>uk1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>date<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">42990946</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8

<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>
<span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">19.10</span> sec<span class="token punctuation">)</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'20200402'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41849498</span> <span class="token operator">|</span>    <span class="token number">19.87</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span>

<span class="token comment">## 约束</span>
ERROR <span class="token number">1503</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: A <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> must include <span class="token keyword">all</span> <span class="token keyword">columns</span> <span class="token operator">in</span> the <span class="token keyword">table</span><span class="token string">'s partitioning function

du -sh test.ibd
2.1G   test.ibd

alter table test partition by range columns(date)(
  partition p20200331 values less than ('</span><span class="token number">20200401</span><span class="token string">'),
  partition p20200401 values less than ('</span><span class="token number">20200402</span><span class="token string">'),
  partition p20200402 values less than ('</span><span class="token number">20200403</span><span class="token string">'),
  partition p20200403 values less than ('</span><span class="token number">20200404</span><span class="token string">'),
  partition p20200404 values less than ('</span><span class="token number">20200405</span><span class="token string">'),
  partition p20200405 values less than ('</span><span class="token number">20200406</span><span class="token string">'),
  partition p20200406 values less than ('</span><span class="token number">20200407</span><span class="token string">'),
  partition p20200407 values less than ('</span><span class="token number">20200408</span><span class="token string">'),
  partition p20200408 values less than ('</span><span class="token number">20200409</span><span class="token string">'),
  partition p20200409 values less than ('</span><span class="token number">20200410</span><span class="token string">'),
  partition p20200410 values less than ('</span><span class="token number">20200411</span><span class="token string">')
);

du -sh test*.ibd
112K	test#P#p20200331.ibd
225M	test#P#p20200401.ibd
225M	test#P#p20200402.ibd
225M	test#P#p20200403.ibd
225M	test#P#p20200404.ibd
225M	test#P#p20200405.ibd
225M	test#P#p20200406.ibd
225M	test#P#p20200407.ibd
225M	test#P#p20200408.ibd
225M	test#P#p20200409.ibd
225M	test#P#p20200410.ibd
 44M	test01.ibd
 44M	test02.ibd
 44M	test03.ibd
 44M	test04.ibd
 44M	test05.ibd
 44M	test06.ibd
 44M	test07.ibd
 44M	test08.ibd
 44M	test09.ibd
 44M	test10.ibd

insert into test(date,name) values('</span><span class="token number">20200430</span><span class="token string">', '</span>bbbbb'<span class="token punctuation">)</span><span class="token punctuation">;</span>
ERROR <span class="token number">1526</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Table</span> has <span class="token keyword">no</span> <span class="token keyword">partition</span> <span class="token keyword">for</span> <span class="token keyword">value</span> <span class="token keyword">from</span> column_list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="partition快速删除分区数据"><a href="#partition快速删除分区数据" class="headerlink" title="partition快速删除分区数据"></a>partition快速删除分区数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>
<span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>
<span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------+---------------------+</span>

<span class="token comment">-- 阻塞DML，备份partition ibd物理文件</span>
flush <span class="token keyword">table</span> test <span class="token keyword">for</span> export<span class="token punctuation">;</span>

<span class="token comment">-- discard</span>
<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>

<span class="token comment">-- 拷贝回保留partition ibd文件，删除需要清理partition</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">drop</span> <span class="token keyword">partition</span> p20200331<span class="token punctuation">,</span>p20200401<span class="token punctuation">;</span>

<span class="token comment">-- import</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="MRR"><a href="#MRR" class="headerlink" title="MRR"></a>MRR</h3><blockquote>
<p>默认mrr_cost为on且代价非常高，直接关闭。<code>set @@optimizer_switch='mrr=on,mrr_cost_based=off'</code></p>
</blockquote>
<p>2级索引查询对主键排序后回表，磁盘接近顺序IO</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> id2 <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">and</span> id2 <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>  <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test01 <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx1          <span class="token operator">|</span> idx1 <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">17592</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> MRR <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="自增变量未持久化"><a href="#自增变量未持久化" class="headerlink" title="自增变量未持久化"></a>自增变量未持久化</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span> id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> test_auto <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_auto <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span> id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>

<span class="token keyword">delete</span> <span class="token keyword">from</span> test_auto <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token comment">-- restart mysql server</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> test_auto <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span> id <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="DDL非原子"><a href="#DDL非原子" class="headerlink" title="DDL非原子"></a>DDL非原子</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token operator">like</span> <span class="token string">'test1%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span>
<span class="token operator">|</span> Tables_in_test <span class="token punctuation">(</span>test1<span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span>
<span class="token operator">|</span> test10                  <span class="token operator">|</span>
<span class="token operator">|</span> test11                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span>

<span class="token keyword">drop</span> <span class="token keyword">table</span> test11<span class="token punctuation">,</span>test12<span class="token punctuation">;</span>
ERROR <span class="token number">1051</span> <span class="token punctuation">(</span><span class="token number">42</span>S02<span class="token punctuation">)</span>: Unknown <span class="token keyword">table</span> <span class="token string">'test.test12'</span>

<span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token operator">like</span> <span class="token string">'test1%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span>
<span class="token operator">|</span> Tables_in_test <span class="token punctuation">(</span>test1<span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span>
<span class="token operator">|</span> test10                  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="创建降序索引仍为升序"><a href="#创建降序索引仍为升序" class="headerlink" title="创建降序索引仍为升序"></a>创建降序索引仍为升序</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t1<span class="token punctuation">(</span>c1 <span class="token keyword">int</span><span class="token punctuation">,</span>c2 <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">index</span> idx_c1_c2<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2 <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> t1    <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>t1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> c1 <span class="token punctuation">,</span> c2 <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> t1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx1 <span class="token operator">|</span> <span class="token number">10</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">327519</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="innodb-rollback-on-timeout"><a href="#innodb-rollback-on-timeout" class="headerlink" title="innodb_rollback_on_timeout"></a>innodb_rollback_on_timeout</h3><blockquote>
<p>需重启生效，影响事务原子性，建议设为<code>ON</code></p>
</blockquote>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--my.cnf</span>
<span class="token comment">--innodb_rollback_on_timeout = OFF</span>
<span class="token comment">--innodb_lock_wait_timeout = 10</span>

<span class="token comment">-- session1</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>

<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token comment">-- session2</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token comment">-- session 1</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--my.cnf</span>
<span class="token comment">--innodb_rollback_on_timeout = ON</span>
<span class="token comment">--innodb_lock_wait_timeout = 10</span>

<span class="token comment">-- session1</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>

<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token comment">-- session2</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token comment">-- session 1</span>
<span class="token keyword">begin</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span>

<span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="delete备库回放"><a href="#delete备库回放" class="headerlink" title="delete备库回放"></a>delete备库回放</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test_no_primary<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>           <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                          <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> test_no_primary <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test_no_primary<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_no_primary<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> a    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> b    <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> c    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> test_no_primary <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>


<span class="token comment"># 主库-&gt;备库日志</span>
<span class="token comment">#201023 21:44:30 server id 2454784635  end_log_pos 5657 CRC32 0x7b63ea86  Delete_rows: table id 282 flags: STMT_END_F</span>
<span class="token comment">### DELETE FROM `test`.`test_no_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @2='a' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### DELETE FROM `test`.`test_no_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @2='b' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### DELETE FROM `test`.`test_no_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @2='c' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment"># at 5657</span>


mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test_with_primary<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> <span class="token keyword">Table</span>             <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                                                                                                            <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token operator">|</span> test_with_primary <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test_with_primary<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c0<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">31</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span>
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_with_primary<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span> c0 <span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> a    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> b    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">21</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span> c    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+</span>
<span class="token number">3</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">delete</span> <span class="token keyword">from</span> test_with_primary <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
Query OK<span class="token punctuation">,</span> <span class="token number">3</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>


<span class="token comment"># 主库-&gt;备库日志</span>
<span class="token comment">#201023 21:53:59 server id 2454784635  end_log_pos 7005 CRC32 0xc0c83f05  Delete_rows: table id 284 flags: STMT_END_F</span>
<span class="token comment">### DELETE FROM `test`.`test_with_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @3='a' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### DELETE FROM `test`.`test_with_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=11 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @3='b' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment">### DELETE FROM `test`.`test_with_primary`</span>
<span class="token comment">### WHERE</span>
<span class="token comment">###   @1=21 /* INT meta=0 nullable=0 is_null=0 */</span>
<span class="token comment">###   @2=1 /* INT meta=0 nullable=1 is_null=0 */</span>
<span class="token comment">###   @3='c' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span>
<span class="token comment"># at 7005</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="uuid-gt-auto-increment"><a href="#uuid-gt-auto-increment" class="headerlink" title="uuid -> auto_increment"></a>uuid -&gt; auto_increment</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+</span>
<span class="token operator">|</span> c1                                   <span class="token operator">|</span> c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+</span>
<span class="token operator">|</span> <span class="token number">17</span>f6ea4e<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> aaa  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>ab073fe<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> bbb  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>c2a32d8<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> ccc  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">desc</span> test<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> Field <span class="token operator">|</span> <span class="token keyword">Type</span>        <span class="token operator">|</span> <span class="token boolean">Null</span> <span class="token operator">|</span> <span class="token keyword">Key</span> <span class="token operator">|</span> <span class="token keyword">Default</span> <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>
<span class="token operator">|</span> c1    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">NO</span>   <span class="token operator">|</span> PRI <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">|</span> c2    <span class="token operator">|</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">|</span> YES  <span class="token operator">|</span>     <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span>       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------------+------+-----+---------+-------+</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">drop</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>
mysql<span class="token operator">&gt;</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">add</span> <span class="token keyword">column</span> c3 <span class="token keyword">int</span> <span class="token keyword">auto_increment</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">;</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+----+</span>
<span class="token operator">|</span> c1                                   <span class="token operator">|</span> c2   <span class="token operator">|</span> c3 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+----+</span>
<span class="token operator">|</span> <span class="token number">17</span>f6ea4e<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> aaa  <span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>ab073fe<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> bbb  <span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">1</span>c2a32d8<span class="token operator">-</span><span class="token number">1</span>ea8<span class="token operator">-</span><span class="token number">11</span>eb<span class="token operator">-</span><span class="token number">95</span>f7<span class="token operator">-</span>b54d65122ba1 <span class="token operator">|</span> ccc  <span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">--------------------------------------+------+----+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="字符串索引数字查询"><a href="#字符串索引数字查询" class="headerlink" title="字符串索引数字查询"></a>字符串索引数字查询</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test\G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
       <span class="token keyword">Table</span>: test
<span class="token keyword">Create</span> <span class="token keyword">Table</span>: <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c3<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c4<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c5<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i2<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1376221</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8
<span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.05</span> sec<span class="token punctuation">)</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c2<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> i1<span class="token punctuation">,</span>i2         <span class="token operator">|</span> i1   <span class="token operator">|</span> <span class="token number">63</span>      <span class="token operator">|</span> const <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> i1<span class="token punctuation">,</span>i2         <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">1044395</span> <span class="token operator">|</span>    <span class="token number">10.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>官方解释：<br>For comparisons of a string column with a number, MySQL cannot use an index on the column to look up the value quickly. If str_col is an indexed string column, the index cannot be used when performing the lookup in the following statement</p>
<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT * FROM tbl_name WHERE str_col=1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>The reason for this is that there are many different strings that may convert to the value 1, such as ‘1’, ‘ 1’, or ‘1a’.</p>
<h3 id="show-status-like-‘handler-read-’"><a href="#show-status-like-‘handler-read-’" class="headerlink" title="show status like ‘handler%read%’"></a>show status like ‘handler%read%’</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test<span class="token punctuation">.</span>test\G<span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
       <span class="token keyword">Table</span>: test
<span class="token keyword">Create</span> <span class="token keyword">Table</span>: <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>test<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c3<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c4<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>c5<span class="token punctuation">`</span></span> <span class="token keyword">char</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c1<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i1<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token keyword">KEY</span> <span class="token identifier"><span class="token punctuation">`</span>i2<span class="token punctuation">`</span></span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>c2<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">1310694</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8

<span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'handler%read%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Variable_name         <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Handler_read_first    <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_key      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_last     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_next     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_prev     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd_next <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test <span class="token keyword">where</span> c2<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+------+</span>
<span class="token operator">|</span> c1 <span class="token operator">|</span> c2   <span class="token operator">|</span> c3   <span class="token operator">|</span> c4   <span class="token operator">|</span> c5   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+------+------+------+------+</span>

<span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'handler%read%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Variable_name         <span class="token operator">|</span> <span class="token keyword">Value</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>
<span class="token operator">|</span> Handler_read_first    <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_key      <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_last     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_next     <span class="token operator">|</span> <span class="token number">1</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_prev     <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd      <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd_next <span class="token operator">|</span> <span class="token number">0</span>     <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+-------+</span>

<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test <span class="token keyword">where</span> c3<span class="token operator">=</span><span class="token string">'1'</span><span class="token punctuation">;</span>
Empty <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.40</span> sec<span class="token punctuation">)</span>

<span class="token keyword">show</span> <span class="token keyword">status</span> <span class="token operator">like</span> <span class="token string">'handler%read%'</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------------+---------+</span>
<span class="token operator">|</span> Variable_name         <span class="token operator">|</span> <span class="token keyword">Value</span>   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+---------+</span>
<span class="token operator">|</span> Handler_read_first    <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_key      <span class="token operator">|</span> <span class="token number">2</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_last     <span class="token operator">|</span> <span class="token number">0</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_next     <span class="token operator">|</span> <span class="token number">1</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_prev     <span class="token operator">|</span> <span class="token number">0</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd      <span class="token operator">|</span> <span class="token number">0</span>       <span class="token operator">|</span>
<span class="token operator">|</span> Handler_read_rnd_next <span class="token operator">|</span> <span class="token number">1048577</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------------+---------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="ibtmp1-临时表空间"><a href="#ibtmp1-临时表空间" class="headerlink" title="ibtmp1 临时表空间"></a>ibtmp1 临时表空间</h3><p>explain为Using temporary的使用ibtmp1，无法自动释放</p>
<pre class="line-numbers language-sql" data-language="sql"><code class="language-sql">mysql<span class="token operator">&gt;</span> <span class="token keyword">SELECT</span> @<span class="token variable">@innodb_temp_data_file_path</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------------------------------+</span>
<span class="token operator">|</span> @<span class="token variable">@innodb_temp_data_file_path</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------+</span>
<span class="token operator">|</span> ibtmp1:<span class="token number">12</span>M:autoextend        <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------------------------------+</span>

mysql<span class="token operator">&gt;</span> <span class="token keyword">explain</span> <span class="token keyword">insert</span> <span class="token keyword">into</span> test_tmp<span class="token punctuation">(</span>c2<span class="token punctuation">)</span> <span class="token keyword">select</span> c2 <span class="token keyword">from</span> test_tmp<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>
<span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>    <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">INSERT</span>      <span class="token operator">|</span> test_tmp <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>     <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>            <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test_tmp <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">temporary</span> <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span>

$ du <span class="token operator">-</span>sh <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>var<span class="token operator">/</span>mysql<span class="token operator">/</span>test<span class="token operator">/</span>test_tmp<span class="token punctuation">.</span>ibd 
<span class="token number">513</span>M	<span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>var<span class="token operator">/</span>mysql<span class="token operator">/</span>test<span class="token operator">/</span>test_tmp<span class="token punctuation">.</span>ibd
$ du <span class="token operator">-</span>sh <span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>var<span class="token operator">/</span>mysql<span class="token operator">/</span>ibtmp1 
<span class="token number">273</span>M	<span class="token operator">/</span>usr<span class="token operator">/</span><span class="token keyword">local</span><span class="token operator">/</span>var<span class="token operator">/</span>mysql<span class="token operator">/</span>ibtmp1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="快速找出无显式主键的表"><a href="#快速找出无显式主键的表" class="headerlink" title="快速找出无显式主键的表"></a>快速找出无显式主键的表</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span>
a<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span>
<span class="token punctuation">(</span>
<span class="token keyword">SELECT</span>
TABLE_SCHEMA<span class="token punctuation">,</span>
TABLE_NAME
<span class="token keyword">FROM</span>
information_schema<span class="token punctuation">.</span><span class="token keyword">TABLES</span> t
<span class="token keyword">WHERE</span>
TABLE_SCHEMA <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
<span class="token string">'mysql'</span><span class="token punctuation">,</span>
<span class="token string">'sys'</span><span class="token punctuation">,</span>
<span class="token string">'information_schema'</span><span class="token punctuation">,</span>
<span class="token string">'performance_schema'</span>
<span class="token punctuation">)</span> <span class="token operator">AND</span>
TABLE_TYPE <span class="token operator">=</span> <span class="token string">'BASE TABLE'</span>
<span class="token punctuation">)</span> <span class="token keyword">AS</span> a
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span>
<span class="token keyword">SELECT</span>
TABLE_SCHEMA<span class="token punctuation">,</span>
TABLE_NAME
<span class="token keyword">FROM</span>
information_schema<span class="token punctuation">.</span>TABLE_CONSTRAINTS c
<span class="token keyword">WHERE</span>
TABLE_SCHEMA <span class="token operator">NOT</span> <span class="token operator">IN</span> <span class="token punctuation">(</span>
<span class="token string">'mysql'</span><span class="token punctuation">,</span>
<span class="token string">'sys'</span><span class="token punctuation">,</span>
<span class="token string">'information_schema'</span><span class="token punctuation">,</span>
<span class="token string">'performance_schema'</span>
<span class="token punctuation">)</span> <span class="token operator">AND</span> CONSTRAINT_TYPE <span class="token operator">=</span> <span class="token string">'PRIMARY KEY'</span>
<span class="token punctuation">)</span> <span class="token keyword">AS</span> b <span class="token keyword">USING</span> <span class="token punctuation">(</span>TABLE_SCHEMA<span class="token punctuation">,</span> TABLE_NAME<span class="token punctuation">)</span>
<span class="token keyword">WHERE</span>
b<span class="token punctuation">.</span>TABLE_NAME <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h3 id=""><a href="#" class="headerlink" title=""></a><a href="https://redis.io/topics/notifications" title="" target="">Notifications</a></h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> config <span class="token builtin class-name">set</span> notify-keyspace-events KEA
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> psubscribe <span class="token string">'*'</span>
Reading messages<span class="token punctuation">..</span>. <span class="token punctuation">(</span>press Ctrl-C to quit<span class="token punctuation">)</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"psubscribe"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">1</span>

<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__keyspace@0__:foo"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"set"</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">"pmessage"</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">"*"</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">"__keyevent@0__:set"</span>
<span class="token number">4</span><span class="token punctuation">)</span> <span class="token string">"foo"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> foo <span class="token number">1</span>
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/30/go/goim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/30/go/goim/" class="post-title-link" itemprop="url">goim源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-30 04:03:46" itemprop="dateCreated datePublished" datetime="2020-04-30T04:03:46+00:00">2020-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>mid: member id<br>key: 绑定mid的会话key, auth时若token里没有, 在logic层使用uuid生成<br>accepts: mid的channel watch accepts, 在ch.NeedPush中check</p>
<h2 id="bufio"><a href="#bufio" class="headerlink" title="bufio"></a>bufio</h2><p>缓冲Reader/Writer, pop()复用peek()前移游标出栈, 读/写包头</p>
<h2 id="comet"><a href="#comet" class="headerlink" title="comet"></a>comet</h2><h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h3><p>p.ReadTCP(rr): 从rr pop一个proto<br>p.WriteTCP(wr): 如果是raw包, 直接用p.Body写wr; 否则写头+p.Body</p>
<h3 id="authTCP"><a href="#authTCP" class="headerlink" title="authTCP()"></a>authTCP()</h3><p>ch.CliProto.<font color="cyan">Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取auth proto<br>调用logic rpc connect进行auth, p.Body为token<br>调用p.WriteTCP(wr), 写authReply</p>
<h2 id="Operate"><a href="#Operate" class="headerlink" title="Operate()"></a>Operate()</h2><ul>
<li>OpChangeRoom: p.Body为rid, 将ch换到room</li>
<li>OpSub: ch.Watch, p.Body为ops</li>
<li>OpUnsub: ch.UnWatch, p.Body为ops</li>
<li>其他: logic rpc Receive, logic侧无处理</li>
</ul>
<h2 id="dispatchTCP"><a href="#dispatchTCP" class="headerlink" title="dispatchTCP()"></a>dispatchTCP()</h2><h3 id="ch-CliProto-Get-读取一个proto"><a href="#ch-CliProto-Get-读取一个proto" class="headerlink" title="ch.CliProto.Get()读取一个proto"></a>ch.CliProto.<font color="red">Get()</font>读取一个proto</h3><ul>
<li>OpHeartbeatReply: 调用p.WriteTCPHeart()写当前ch.room的online数</li>
<li>其他: 调用p.WriteTCP(wr), 写对应reply</li>
</ul>
<h2 id="TCP逻辑"><a href="#TCP逻辑" class="headerlink" title="TCP逻辑"></a>TCP逻辑</h2><p>绑定一个channel的Reader/Writer到conn</p>
<ol>
<li>handshake, 若timout则close conn</li>
<li>调用authTCP()认证, 返回accepts, key, rid, hb<br>  2.1 根据accepts得到ch.Watch<br>  2.2 根据key得到这个conn对应的Bucket, 使用CityHash32计算, 共32个桶<br>  2.3 根据rid将ch放到对应的room里</li>
<li>重置心跳超时</li>
<li>开启go dispatchTCP(), ch.CliProto.<font color="cyan">Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取proto<br>  4.1 <em>OpHeartbeat</em>: 调用logic rpc Heartbeat<br>  4.2 <em>其他</em>: 调用s.Operate()</li>
<li>处理完proto后触发dispatchTCP()写对应reply</li>
</ol>
<h2 id="RenewOnline逻辑"><a href="#RenewOnline逻辑" class="headerlink" title="RenewOnline逻辑"></a>RenewOnline逻辑</h2><p>comet侧go onlineproc统计所有bucket的所有room的online<br>调用rpc RenewOnline<br>logic侧根据roomId计算hashKey, redis存储格式server -&gt; hashKey:online, hashKey使用CityHash32放64个桶</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Online struct {
    Server    string           `json:"server"`
    RoomCount map[string]int32 `json:"room_count"`
    // logic侧5分钟未更新则DEL server
    Updated   int64            `json:"updated"` 
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Round"><a href="#Round" class="headerlink" title="Round"></a>Round</h2><p>reader/writer/timer资源池, 轮询获取降低高并发资源争用</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Round struct {
    readers []bytes.Pool
    writers []bytes.Pool
    timers  []time.Timer
    options RoundOptions
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h2><p>链表栈, 顶出顶入, 若无buf可用, 调用grow, 若入速度小于出速度会有内存溢出</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Buffer struct {
    buf  []byte
    next *Buffer // next free buffer
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Pool struct {
    lock sync.Mutex
    free *Buffer
    max  int
    num  int
    size int
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>




<h2 id="ring"><a href="#ring" class="headerlink" title="ring"></a>ring</h2><p>Proto的缓冲池，data数组大小[0:num-1], 游标wp比游标rp快会导致rp脏读</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Ring struct {
    // read
    rp   uint64   // rp&amp;mask寻址data
    num  uint64   // 2^N
    mask uint64   // num-1
    // write
    wp   uint64   // wp&amp;mask寻址data
    data []grpc.Proto
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><p>memberId绑定的channel, 保存Proto的缓冲池Ring<br>通过Signal()通知有一个proto待处理; 通过开一个goroutin的Ready()通知处理一个proto写wr<br>若proto写wr太慢, rp游标移动比wp慢, 可能导致rp脏读<br>广播/房播/单播 的proto直接写wr</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Channel struct {
    Room     *Room
    CliProto Ring
    signal   chan *grpc.Proto
    Writer   bufio.Writer
    Reader   bufio.Reader
    Next     *Channel
    Prev     *Channel

    Mid      int64
    Key      string
    IP       string
    watchOps map[int32]struct{}   // Watch(ops)添加ops; UnWatch(ops)删除ops; NeedPush(op)检查op in watch
    mutex    sync.RWMutex   // lock for watchOps
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="room"><a href="#room" class="headerlink" title="room"></a>room</h2><p>保存channel链表</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Room struct {
    ID        string
    rLock     sync.RWMutex
    next      *Channel
    drop      bool   // true if Online-- == 0
    Online    int32
    AllOnline int32   // dirty read because Bucket.UpRoomsCount with RLock
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h2 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h2><p>存放room和channel, channel可以change/put room, 自动创建new room<br>所有channel广播 或 指定room房播<br>routines处理job kafka rpc</p>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Bucket struct {
    c     *conf.Bucket
    cLock sync.RWMutex          // lock for chs/rooms
    chs   map[string]*Channel   // 1024
    // room
    rooms       map[string]*Room   // 1024
    routines    []chan *grpc.BroadcastRoomReq   // 32 (go b.roomproc((chan *grpc.BroadcastRoomReq, 1024)))
    routinesNum uint64   // routinesNum % 32

    ipCnts map[string]int32   // ip counter
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<img src="/2020/04/30/go/goim/%E6%88%BF%E9%97%B4%E4%BF%A1%E6%81%AF%E6%8E%A8%E9%80%81%E6%B5%81%E7%A8%8B.png" class="">

<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>根据SubKey获取Bucket</p>
<p>Operate:</p>
<ul>
<li>bucket.ChangeRoom</li>
<li>channel.Watch</li>
<li>channel.UnWatch</li>
</ul>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Server struct {
    c         *conf.Config
    round     *Round      // accept round store
    buckets   []*Bucket   // 32
    bucketIdx uint32      // 32

    serverID  string
    rpcClient logic.LogicClient
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="job"><a href="#job" class="headerlink" title="job"></a>job</h2><p>job从kafka consume, 通过rpc调用comet</p>
<p>根据pushMsg.Type分:</p>
<ul>
<li>单播</li>
<li>房播</li>
<li>广播</li>
</ul>
<pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">// clinet
var XXXRoutineSize int
var XXXChanSize int
var XXXChan = make([]chan *server.XXXReq, XXXRoutineSize)
var XXXChanCursor uint64

for i := 0; i &lt; XXXRoutineSize; i++ {
    XXXChan[i] = make(chan *server.XXXReq, XXXChanSize)
    go process(XXXChan[i])
}

func (c *client) process(XXXChan chan *server.XXXReq){
    for {
        select XXXArg := &lt;- XXXChan:
            reply, err := c.serverClient.XXX(context.Background(), &amp;server.XXXReq{
                key: XXXArg.value,
            })
        ...
    }
}

func (c *client) XXXFunc(arg *server.XXXReq) {
    idx := atomic.AddUint64(&amp;XXXChanCursor, 1) % XXXRoutineSize
    XXXChan[idx] &lt;- arg
}

// server
func (s *server) XXX(ctx context.Context, req *server.XXXReq) (reply *server.XXXReply, err error){
    ...
}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="job-room-kafka房播msg流程"><a href="#job-room-kafka房播msg流程" class="headerlink" title="job.room kafka房播msg流程"></a>job.room kafka房播msg流程</h2><ol>
<li>根据msg.roomId调用getRoom(), 若没有则NewRoom() -&gt; go pushproc()监听, 然后Push()</li>
<li>pushproc:  SigTime=1S, Batch=20, Idle=15M<br>  2.1 循环消费kafka msg, 直到超过1S未收到新msg，或&gt;=20次写<br>  2.2 调用rpc房播, 等待最大15M若未收到新msg则退出循环</li>
</ol>
<h2 id="logic"><a href="#logic" class="headerlink" title="logic"></a>logic</h2><p>redis存储格式</p>
<ul>
<li>mid -&gt; key:server</li>
<li>key -&gt; server</li>
<li>server -&gt; hashKey:online<br><code>hashKey使用roomId通过cityHash32算出,共64个桶</code><br><code>将1024个room装进64个桶里</code></li>
</ul>
<h2 id="business-http-push参照doc"><a href="#business-http-push参照doc" class="headerlink" title="business http push参照doc"></a>business http push参照doc</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_db/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_db/" class="post-title-link" itemprop="url">zookeeper源码-6.数据库和日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-29 14:29:01" itemprop="dateCreated datePublished" datetime="2020-04-29T14:29:01+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="数据库格式"><a href="#数据库格式" class="headerlink" title="数据库格式"></a>数据库格式</h2><p>ZKDatabase负责记录节点的数据信息，事务日志以及Snapshot日志，以及watch的管理，相关类图如下:</p>
<img src="/2020/04/29/zk/zkSrc_db/database.png" class="">

<p>主要的类信息如下:</p>
<ul>
<li>ZKDatabase 数据库类的封装</li>
<li>FileTxnSnapLog 日志类封装，包括事务日志和Snapshot日志的管理</li>
<li>SnapShot为Shapshot日志接口，FileSnap为具体实现类。</li>
<li>TxnLog为事务日志接口，FileTxnLog为具体实现类。</li>
<li>DataTree为节点数据管理类，负责保存节点的数据以及管理数据的Watcher。</li>
<li>DataNode保存节点的数据信息，状态信息以及子节点信息。</li>
</ul>
<h2 id="节点数据"><a href="#节点数据" class="headerlink" title="节点数据"></a>节点数据</h2><p>ZooKeeper的节点类似Linux文件目录，根目录为/,每个目录有唯一的路径，同时，在节点上可以绑定用户指定的数据。</p>
<h3 id="节点数据定义"><a href="#节点数据定义" class="headerlink" title="节点数据定义"></a>节点数据定义</h3><p>节点的目录信息存储于DataTree.nodes信息中，为树形结构。<br>节点的状态信息存储于类StatPersisted，具体字段的含义如下:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> czxid<span class="token punctuation">;</span> 节点创建时的zxid
<span class="token keyword">private</span> <span class="token keyword">long</span> mzxid<span class="token punctuation">;</span> 最后一次修改节点数据的zxid
<span class="token keyword">private</span> <span class="token keyword">long</span> ctime<span class="token punctuation">;</span> 创建节点的时间
<span class="token keyword">private</span> <span class="token keyword">long</span> mtime<span class="token punctuation">;</span> 最后一次修改节点数据的时间
<span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span> 节点的版本号，创建时为<span class="token number">0</span>，修改时<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> cversion<span class="token punctuation">;</span> 孩子节点版本信息，每创建一个孩子节点<span class="token operator">+</span><span class="token number">1</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> aversion<span class="token punctuation">;</span> <span class="token constant">ACL</span>版本信息
<span class="token keyword">private</span> <span class="token keyword">long</span> ephemeralOwner<span class="token punctuation">;</span> 节点的类型信息
<span class="token keyword">private</span> <span class="token keyword">long</span> pzxid<span class="token punctuation">;</span>  节点本身和孩子节点的最后一次修改zxid。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="节点类型定义"><a href="#节点类型定义" class="headerlink" title="节点类型定义"></a>节点类型定义</h3><p>总共有四种类型的节点，具体定义为enum EphemeralType，每种类型的含义为:</p>
<ul>
<li>VOID 持久化的节点，用户连接关闭后节点会一直存在。</li>
<li>NORMAL 临时节点，用户连接断开后临时节点会被删除。临时节点信息存储在DataTree.ephemerals中。</li>
<li>CONTAINER 和VOID节点一样，但是当该节点的孩子被删除后，该节点会被删除。Container节点信息存储在DataTree.containers中。</li>
<li>TTL 和VOID节点一样，但是当该节点无孩子节点，并且当前时间距离上次修改时间超过ttl时间，该节点会被删除。TTL节点信息存储在DataTree.ttls中。</li>
</ul>
<hr>
<h2 id="特殊节点类型"><a href="#特殊节点类型" class="headerlink" title="特殊节点类型"></a>特殊节点类型</h2><blockquote>
<p>ZooKeeper的节点有两个特殊的目录:</p>
</blockquote>
<h3 id="x2F-zookeeper-x2F-quota"><a href="#x2F-zookeeper-x2F-quota" class="headerlink" title="/zookeeper/quota"></a>/zookeeper/quota</h3><p>配置某个节点的配额信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* Rather than fight it, let root have an alias */</span>
<span class="token comment">// "/"</span>
nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>
nodes<span class="token punctuation">.</span><span class="token function">putWithoutDigest</span><span class="token punctuation">(</span>rootZookeeper<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** add the proc node and quota node */</span>
<span class="token comment">// "/zookeeper"</span>
root<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>procChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>
nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">,</span> procDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// "/zookeeper/quota"</span>
procDataNode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>quotaChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>
nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>quotaZookeeper<span class="token punctuation">,</span> quotaDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如某个节点的路径为/xx/yy,则对应的配额信息路径为/zookeeper/quota/xx/yy，其中/zookeeper/quota/xx/yy/zookeeper_limits包含管理员设置的配额信息，/zookeeper/quota/xx/yy/zookeeper_stats包含节点当前已使用的信息。</li>
<li>配额信息包含两个参数，分别表示大小(bytes)和节点数量(counts)。</li>
<li>在创建节点时会更新配额的信息，并检查是否超过配额。</li>
<li>配额设置详见cli包下SetQuotaCommand.java。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// also check to update the quotas for this node</span>
<span class="token class-name">String</span> lastPrefix <span class="token operator">=</span> <span class="token function">getMaxPrefixWithQuota</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">long</span> bytes <span class="token operator">=</span> data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>lastPrefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ok we have some match and need to update</span>
    <span class="token function">updateCountBytes</span><span class="token punctuation">(</span>lastPrefix<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * update the count/count of bytes of this stat datanode
 *
 * @param lastPrefix
 *            the path of the node that is quotaed.
 * @param bytesDiff
 *            the diff to be added to number of bytes
 * @param countDiff
 *            the diff to be added to the count
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCountBytes</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastPrefix<span class="token punctuation">,</span> <span class="token keyword">long</span> bytesDiff<span class="token punctuation">,</span> <span class="token keyword">int</span> countDiff<span class="token punctuation">)</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="x2F-zookeeper-x2F-config"><a href="#x2F-zookeeper-x2F-config" class="headerlink" title="/zookeeper/config"></a>/zookeeper/config</h3><p>保存所有节点信息</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * create a /zookeeper/config node for maintaining the configuration (membership and quorum system) info for
 * zookeeper
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addConfigNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">DataNode</span> zookeeperZnode <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zookeeperZnode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// should always be the case</span>
        zookeeperZnode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>configChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token string">"There's no /zookeeper znode - this should never happen."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// Reconfig node is access controlled by default (ZOOKEEPER-2014).</span>
        <span class="token function">setACL</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">READ_ACL_UNSAFE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token string">"There's no "</span> <span class="token operator">+</span> configZookeeper <span class="token operator">+</span> <span class="token string">" znode - this should never happen."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>PrepRequestProcessor::run处理request流程中，对<code>OpCode.reconfig</code>会更改config node信息</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>reconfig<span class="token operator">:</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    nodeRecord <span class="token operator">=</span> <span class="token function">getRecordForPath</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs</span><span class="token punctuation">.</span><span class="token constant">CONFIG_NODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "/zookeeper/config"</span>
    zks<span class="token punctuation">.</span><span class="token function">checkACL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cnxn<span class="token punctuation">,</span> nodeRecord<span class="token punctuation">.</span>acl<span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span><span class="token constant">WRITE</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>authInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">SetDataTxn</span> setDataTxn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetDataTxn</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs</span><span class="token punctuation">.</span><span class="token constant">CONFIG_NODE</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>qv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    nodeRecord<span class="token punctuation">.</span>data <span class="token operator">=</span> setDataTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// request.qv.toString().getBytes()</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">addChangeRecord</span><span class="token punctuation">(</span>nodeRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>request.qv.toString() 记录QuorumMaj中集群所有成员信息</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">StringBuilder</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">QuorumServer</span> member <span class="token operator">:</span> <span class="token function">getAllMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"server."</span> <span class="token operator">+</span> member<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> member<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> hexVersion <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"version="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>hexVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="Watcher管理"><a href="#Watcher管理" class="headerlink" title="Watcher管理"></a>Watcher管理</h2><p>有两种类型的Watcher</p>
<ul>
<li>childWatches 新增或者删除孩子节点时触发，可以在getChildren时注册。</li>
<li>dataWatches 在创建，删除，修改时触发。</li>
</ul>
<hr>
<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><h3 id="TxnLog"><a href="#TxnLog" class="headerlink" title="TxnLog"></a>TxnLog</h3><p>事务日志的文件格式如下所示:</p>
<table>
<thead>
<tr>
<th>文件头(16Byte)</th>
<th>事务列表</th>
<th>0补齐</th>
</tr>
</thead>
</table>
<p>文件头的格式为class FileHeader:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> magic<span class="token punctuation">;</span>   <span class="token comment">//字符串"ZKLG"</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span> <span class="token comment">//默认为2</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> dbid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>事务列表由多个事务组成，每个事务的格式如下:</p>
<table>
<thead>
<tr>
<th>校验和(8Bye)</th>
<th>数据长度(4Byte)</th>
<th>事务头信息(32Byte)</th>
<th>请求数据</th>
<th>结束符(0x42)</th>
</tr>
</thead>
</table>
<p>事务头的格式为class TxnHeader:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> clientId<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> cxid<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> zxid<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">int</span> type<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>写事务的详细逻辑见FileTxnLog.append,该函数会先检查日志文件是否存在，若不存在，则先创建文件，再写日志。每个日志文件的命名格式为log.{该文件第一个日志的zxid}。在commit到disk时判断是否需要roll一个新FileTxnLog。<br>日志文件生成后没有固定清理机制，需通过运维方法清理，或设置自动清理参数<code>autopurge.purgeInterval</code>，代码实现见DatadirCleanupManager::PurgeTask</p>
<h3 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h3><p>Snapshot文件格式如下:</p>
<table>
<thead>
<tr>
<th>文件头(16Byte)</th>
<th>session信息</th>
<th>节点信息</th>
</tr>
</thead>
</table>
<p>文件头格式和事务日志一样，只是Magic为“ZKSN”。</p>
<p>Session信息格式如下:</p>
<p>Count(4Byte)|1-id(8Byte)|1-Timeout(4Byte)|…|N-id|N-Timeout</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessSnap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    oa<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>sessSnap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> sessSnap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        oa<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oa<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dt<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> <span class="token string">"tree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h3><p>节点信息由类DataTree.serialize实现，该类会先序列化ACL信息，再按节点的树形结构序列化节点以及对应的状态信息，具体格式见代码。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token function">serializeAcls</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">serializeNodes</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_processPacket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_processPacket/" class="post-title-link" itemprop="url">zookeeper源码-5.客户端响应请求</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-29 14:23:17" itemprop="dateCreated datePublished" datetime="2020-04-29T14:23:17+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>NIOServerCnxn / NettyServerCnxn 调用ZooKeeperServer.processPacket，内部会调用submitRequest，最后submitRequest会将Request派发到firstProcessor</p>
<hr>
<h2 id="配置Processors"><a href="#配置Processors" class="headerlink" title="配置Processors"></a>配置Processors</h2><h3 id="Follower节点配置Processors"><a href="#Follower节点配置Processors" class="headerlink" title="Follower节点配置Processors"></a>Follower节点配置Processors</h3><p>Follower节点配置Processors详见FollowerZooKeeperServer.setupRequestProcessors, 链表结构如下:</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/follower_processors.png" class="">

<h3 id="Leader节点配置Processors"><a href="#Leader节点配置Processors" class="headerlink" title="Leader节点配置Processors"></a>Leader节点配置Processors</h3><p>Leader节点配置Processors详见LeaderZooKeeperServer.setupRequestProcessors, 链表结构如下:</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/leader_processors.png" class="">

<h3 id="客户端请求处理"><a href="#客户端请求处理" class="headerlink" title="客户端请求处理"></a>客户端请求处理</h3><p>Zookeeper将客户端的请求实际上分为两种类型:</p>
<ul>
<li>第一种类型的请求可以叫做读请求，如getData，getChildren等。<br>这种类型的请求不会修改zookeeper数据库的内容，因为zookeeper每个节点的数据库内容是一致的(不同的节点之间由于同步的时间不一致，可能会导致数据有不一致)，所以读请求只用在本地节点的数据库即可。</li>
<li>第二种节点会修改数据库内容，如create,delete等。<br>非Leader节点接收到此种请求，会先转发到Leader节点，Leader会按照先Proposal，后Commit的方式将请求同步到所有节点。</li>
</ul>
<h2 id="处理请求流程"><a href="#处理请求流程" class="headerlink" title="处理请求流程"></a>处理请求流程</h2><h3 id="Leader处理请求流程"><a href="#Leader处理请求流程" class="headerlink" title="Leader处理请求流程"></a>Leader处理请求流程</h3><h4 id="LeaderRequestProcessor"><a href="#LeaderRequestProcessor" class="headerlink" title="LeaderRequestProcessor"></a>LeaderRequestProcessor</h4><ul>
<li>如果是LocalSession，并且用户请求为创建临时节点（Session关闭时节点会删除），则升级Session到GlobalSession，并且创建一条createSession请求（upgradeRequest）。</li>
<li>如果createSession请求不为null，转发到PrepRequestProcessor。</li>
<li>转发用户请求到PrepRequestProcessor</li>
</ul>
<h4 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h4><p>PrepRequestProcessor设置Request的transcation信息，该Processor运行于独立的线程中。对于会改写zookeeper数据库的操作，该Processor会添加transcation信息，并且增加TxnHeader。对于读操作，则只检查session合法性。</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">Record</span> record<span class="token punctuation">,</span> <span class="token keyword">boolean</span> deserialize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">RequestProcessorException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        request<span class="token punctuation">.</span><span class="token function">setHdr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxnHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>cxid<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span>
                <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentWallTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setTxnDigest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">PrecalculatedDigest</span> preCalculatedDigest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>preCalculatedDigest <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    request<span class="token punctuation">.</span><span class="token function">setTxnDigest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxnDigest</span><span class="token punctuation">(</span>digestCalculator<span class="token punctuation">.</span><span class="token function">getDigestVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preCalculatedDigest<span class="token punctuation">.</span>treeDigest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="ProposalRequestProcessor"><a href="#ProposalRequestProcessor" class="headerlink" title="ProposalRequestProcessor"></a>ProposalRequestProcessor</h4><ul>
<li>ProposalRequestProcessor会先将请求派发给CommitProcessor</li>
<li>随后ProposalRequestProcessor检查哪些请求被添加了transcation信息，如果被添加了transcation信息，则会发送Proposal包给集群内所有节点。发送Proposal的时序图如下:</li>
</ul>
<img src="/2020/04/29/zk/zkSrc_processPacket/proposal_seq.png" class="">

<ul>
<li>发送完Proposal之后，再将该请求发送到SyncRequestProcessor。</li>
</ul>
<h4 id="SyncRequestProcessor"><a href="#SyncRequestProcessor" class="headerlink" title="SyncRequestProcessor"></a>SyncRequestProcessor</h4><p>SyncRequestProcessor用于存储请求Transcation日志以及数据库的Snapshot日志到文件，存储的逻辑详见run函数：</p>
<ul>
<li>通过snapCount和snapSizeInBytes控制多少次请求或多大log生成一个新的Transcation日志文件和保存Snapshot文件。</li>
<li>为了防止不同的节点都在相同的时间点进行snap，每次生成新的随机数，随机打散每个zk节点的snap时间点</li>
<li>Transcation日志格式以及Snapshot文件格式详见数据库格式。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resetSnapshotStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetSnapshotStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    randRoll <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>snapCount <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    randSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>snapSizeInBytes <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="AckRequestProcessor"><a href="#AckRequestProcessor" class="headerlink" title="AckRequestProcessor"></a>AckRequestProcessor</h4><p>在SyncRequestProcessor flush后，AckRequestProcessor仅仅是发送一个正在处理请求的ACK到Leader自己，用来模拟收到Leader节点的ACK。</p>
<h4 id="Leader-Proposal-ACK管理"><a href="#Leader-Proposal-ACK管理" class="headerlink" title="Leader Proposal ACK管理"></a>Leader Proposal ACK管理</h4><p>LearnerHandler在完成选举之后，会调用startSendingPackets来启动发送Packet的线程</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Start thread that blast packets in the queue to learner</span>
<span class="token function">startSendingPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<p>同时进入接收该节点返回数据的循环。 </p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在收到Proposal Packet的ACK后，LearnerHandler处理流程为：</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/proposal_ack.png" class="">

<ul>
<li>接收到节点所发的Proposal ACK数据，调用Leader.processAck</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">ACK</span><span class="token operator">:</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>learnerType <span class="token operator">==</span> <span class="token class-name">LearnerType</span><span class="token punctuation">.</span><span class="token constant">OBSERVER</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Received ACK from Observer {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    syncLimitCheck<span class="token punctuation">.</span><span class="token function">updateAck</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    learnerMaster<span class="token punctuation">.</span><span class="token function">processAck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">,</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sock<span class="token punctuation">.</span><span class="token function">getLocalSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将ACK的节点id添加到Proposal数据中，调用tryToCommit,尝试Commit该Request。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Proposal</span> p <span class="token operator">=</span> outstandingProposals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
p<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> hasCommitted <span class="token operator">=</span> <span class="token function">tryToCommit</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> followerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>调用Proposal.hasAllQuorums检查ACK的节点是否超过集群数量一半(包括Leader本身)，若超过，则向所有Follower发送Commit。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">commit</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Create a commit packet and send it to all the members of the quorum
 *
 * @param zxid
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lastCommitted <span class="token operator">=</span> zxid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">COMMIT</span><span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">COMMIT_COUNT</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>向所有Observer节点发送Inform。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">inform</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/**
 * Create an inform packet and send it to all observers.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inform</span><span class="token punctuation">(</span><span class="token class-name">Proposal</span> proposal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">INFORM</span><span class="token punctuation">,</span> proposal<span class="token punctuation">.</span>request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> proposal<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendObserverPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>通知CommitProcessor该请求已Commit。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">zk<span class="token punctuation">.</span>commitProcessor<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h4 id="CommitProcessor"><a href="#CommitProcessor" class="headerlink" title="CommitProcessor"></a>CommitProcessor</h4><p>CommitProcessor用于管理Session需要Commit的请求，该Processor Leader和Follower节点共用，CommitProcessor有自己的运行线程。</p>
<ul>
<li>接收到Request后，若该Request需要Commit，或者该Session中存在pendingRequest,则将该Request添加到对应Session的pendingRequest中。否则，直接将Request发送给下一个Processor。该处理方法能保证同一个Session 处理Request的顺序，例如该Session先发送了一个修改数据库的操作，又发送一个读数据库的操作，读的操作肯定会在写操作之后。</li>
<li>CommitProcessor收到某个Request已经Commit之后，（如上，Leader将Commit发送给Follower之后，或者Follower接收到Leader发送的Commit），将Commit的请求转发给下一个Processor。Follower和Leader都有两种Commit的请求。<ul>
<li>Follower Commit请求类型<ul>
<li>自己节点上的Session发送的修改数据库的请求。此种情况下，该Session对应的pendingReqeust的第一个Request肯定是Commit请求；</li>
<li>或者是Leader发送的其他节点接收到的修改数据库的请求，此种情况无对应的pendingRequest，触发入口来自Follower.processPacket。</li>
</ul>
</li>
<li>Leader Commit请求类型<ul>
<li>自己节点上Session发送的修改数据库请求。</li>
<li>Follower节点转发的，但是处理流程和自己节点上接收到的一样，触发入口来自LearnerHander.run调用LeaderZooKeeperServer.submitLearnerRequest。</li>
</ul>
</li>
</ul>
</li>
<li>CommitProcessor将已经Commit的Request发送给下一个Processor，并且将该Session上pendingRequest随后的读请求转发给下一个Processor。</li>
</ul>
<h4 id="Leader-TobeAppliedRequestProcessor"><a href="#Leader-TobeAppliedRequestProcessor" class="headerlink" title="Leader.TobeAppliedRequestProcessor"></a>Leader.TobeAppliedRequestProcessor</h4><p>在Commit Request之前，Leader会记录已Commit但未修改到数据库的写操作Proposal，该记录用于Follower和Leader选举之后的同步数据。本Processor的作用就是在操作数据库之前清除保存的Proposal信息。</p>
<h4 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h4><p>FinalRequestProcessor是操作数据库来响应对应的读或写操作。</p>
<h3 id="Follower处理请求流程"><a href="#Follower处理请求流程" class="headerlink" title="Follower处理请求流程"></a>Follower处理请求流程</h3><p>CommitProcessor和FinalRequestProcessor前面已说明，所以此处只用介绍FollowerRequestProcessor。</p>
<h4 id="FollowerRequestProcessor"><a href="#FollowerRequestProcessor" class="headerlink" title="FollowerRequestProcessor"></a>FollowerRequestProcessor</h4><p>FollowerRequestProcessor运行于独立的线程中。主要工作如下:</p>
<ul>
<li>提交Request时，如果Request是local session，且创建了临时节点，则升级session到Global类型，并且插入一个createSession request。</li>
<li>将Request转发到CommitProcessor。</li>
<li>如果为写请求，转发到Leader。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_serverCnxn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_serverCnxn/" class="post-title-link" itemprop="url">zookeeper源码-4.客户端连接管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-29 14:17:38" itemprop="dateCreated datePublished" datetime="2020-04-29T14:17:38+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>默认使用NIO，可配置为Netty</p>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/client_cnxn_class.png" class="">

<p>configure在QuorumPeerMain中调用，入口在QuorumPeer.startServerCnxnFactory</p>
<p>Factory使用Set&lt;ServerCnxn&gt;保存所有ServerCnxn</p>
<p>NIO Factory 使用一个AcceptThread接受所有连接，按照round-robin分配到Collection&lt;SelectorThread&gt;，每个SelectorThread创建一个NIOServerCnxn，通过WorkerService调度执行<br>Netty Factory 为pipeline添加@Sharable的CnxnChannelHandler处理函数，每个新连接创建NettyServerCnxn处理，</p>
<hr>
<h2 id="Netty实现"><a href="#Netty实现" class="headerlink" title="Netty实现"></a>Netty实现</h2><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><p>客户端的网络事件NettyServerCnxnFactory.CnxnChannelHandler</p>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>有新客户端连接，调用NettyServerCnxnFactory.CnxnChannelHandler.channelActive，新建NettyServerCnxn实例并保存</p>
<h3 id="处理客户端数据"><a href="#处理客户端数据" class="headerlink" title="处理客户端数据"></a>处理客户端数据</h3><p>NettyServerCnxn使用原子变量throttled，表示是否处理用户发送的请求。例如若客户端的连接未建立完成，则不会处理客户端的请求</p>
<h4 id="接收客户端数据"><a href="#接收客户端数据" class="headerlink" title="接收客户端数据"></a>接收客户端数据</h4><p>当服务器接收到数据时，调用NettyServerCnxnFactory.CnxnChannelHandler.processMessage接口。处理流程为</p>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/receive_data_flow.png" class="">

<h4 id="处理数据流程"><a href="#处理数据流程" class="headerlink" title="处理数据流程"></a>处理数据流程</h4><p>处理数据接口为NettyServerCnxn.receiveMessage。有两个ByteBuffer用来保存客户端发送过来的数据。处理流程为</p>
<ul>
<li>bbLen用于保存数据长度，或者判断请求是否是Command。对于普通的请求，前4个字节(Integer型长度)是请求数据长度；而对于Command，使用The Four Letter Words形式，即命令占用4个字节，正好是一个Integer型长度。bbLen固定为4Byte缓冲区。</li>
<li>bb用户保存请求的数据，该缓冲区默认为null。<ul>
<li>!initialized， 调用ZooKeeperServer.processConnectRequest</li>
<li>initialized， 调用ZooKeeperServer.processPacket</li>
</ul>
</li>
</ul>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/process_data_flow.png" class="">

<h4 id="返回数据"><a href="#返回数据" class="headerlink" title="返回数据"></a>返回数据</h4><p>在ZooKeeperServer.processPacket中调用NettyServerCnxn.sendResponse返回结果给客户端。</p>
<h4 id="Watch通知"><a href="#Watch通知" class="headerlink" title="Watch通知"></a>Watch通知</h4><p>zookeeper client可以监听数据的生命周期以及数据变化，client监听数据时，FinalRequestProcessor会调用ZKdatabase.setWatches将ServerCnxn添加到监听列表。当有事件发生时，会调用ServerCnxn.process发送数据回client。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_state/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_state/" class="post-title-link" itemprop="url">zookeeper源码-3.状态转换</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-04-29 14:10:33" itemprop="dateCreated datePublished" datetime="2020-04-29T14:10:33+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-03-20 04:08:02" itemprop="dateModified" datetime="2024-03-20T04:08:02+00:00">2024-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在选举完成后，进入FOLLOWING或LEADING状态。在其能对外提供服务之前，需要对各个服务器之间状态进行同步，使服务器的数据保持一致。</p>
<hr>
<h2 id="Leader同步"><a href="#Leader同步" class="headerlink" title="Leader同步"></a>Leader同步</h2><img src="/2020/04/29/zk/zkSrc_state/leader_sync.png" class="">

<p>在创建Leader对象时，会创建Leader监听的socket，在LeanerCnxAcceptor中会accept该连接，并且创建LearnerHandler的实例，该实例会新建线程，并处理和该新建的连接通信。</p>
<hr>
<h2 id="Follower同步"><a href="#Follower同步" class="headerlink" title="Follower同步"></a>Follower同步</h2><img src="/2020/04/29/zk/zkSrc_state/follower_sync.png" class="">

<hr>
<h2 id="tcp报文-FastLeaderElection-buildMsg"><a href="#tcp报文-FastLeaderElection-buildMsg" class="headerlink" title="tcp报文 FastLeaderElection::buildMsg"></a>tcp报文 FastLeaderElection::buildMsg</h2><p>length-&gt;ByteBuffer</p>
<p>ByteBuffer[state, leader, zxid, electionEpoch, epoch, version, configDataLength, configData]</p>
<hr>
<h2 id="lastMessageSent-异常重启时重发最后消息，重复消息可正确处理"><a href="#lastMessageSent-异常重启时重发最后消息，重复消息可正确处理" class="headerlink" title="lastMessageSent 异常重启时重发最后消息，重复消息可正确处理"></a>lastMessageSent 异常重启时重发最后消息，重复消息可正确处理</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> bq <span class="token operator">=</span> queueSendMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>bq <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isSendQueueEmpty</span><span class="token punctuation">(</span>bq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">ByteBuffer</span> b <span class="token operator">=</span> lastMessageSent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Attempting to send lastMessage to sid={}"</span><span class="token punctuation">,</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">send</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="状态同步"><a href="#状态同步" class="headerlink" title="状态同步"></a>状态同步</h2><img src="/2020/04/29/zk/zkSrc_state/sync_detail.png" class="">

<blockquote>
<h3 id="FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程"><a href="#FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程" class="headerlink" title="FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程"></a>FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程</h3></blockquote>
<ul>
<li>Follower节点在建立到Leader的连接后，立即发送<strong>FollowerInfo</strong>,数据中包括自身节点类型，zxid，协议号(0x10000)，以及节点ID(sid)。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">registerWithLeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> pktType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
     * Send follower info, including last zxid and sid
     */</span>
    <span class="token keyword">long</span> lastLoggedZxid <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qp<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>pktType<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// FOLLOWERINFO 或 OBSERVERINFO</span>
    qp<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span><span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*
     * Add sid to payload
     */</span>
    <span class="token comment">// 协议固定0x10000</span>
    <span class="token class-name">LearnerInfo</span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerInfo</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10000</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteArrayOutputStream</span> bsid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">BinaryOutputArchive</span> boa <span class="token operator">=</span> <span class="token class-name">BinaryOutputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>bsid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    boa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>li<span class="token punctuation">,</span> <span class="token string">"LearnerInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    qp<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>bsid<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送FollowerInfo 或 OBSERVERINFO</span>
    <span class="token function">writePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Leader回复<strong>LeaderInfo</strong>信息，信息包括zxid,以及版本号</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ver<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">QuorumPacket</span> newEpochPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">LEADERINFO</span><span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> ver<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>newEpochPacket<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageTracker<span class="token punctuation">.</span><span class="token function">trackSent</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">LEADERINFO</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Follower回复<strong>ACKEPOCH</strong>,信息包括lastLoggedZxid，epoch信息。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">readPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token keyword">long</span> newEpoch <span class="token operator">=</span> <span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">getEpochFromZxid</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">LEADERINFO</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// we are connected to a 1.0 server so accept the new epoch and read the next packet</span>
    leaderProtocolVersion <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0x10000</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> epochBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> wrappedEpochBytes <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>epochBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newEpoch <span class="token operator">&gt;</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wrappedEpochBytes<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> self<span class="token punctuation">.</span><span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        self<span class="token punctuation">.</span><span class="token function">setAcceptedEpoch</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEpoch <span class="token operator">==</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// since we have already acked an epoch equal to the leaders, we cannot ack</span>
        <span class="token comment">// again, but we still need to send our lastZxid to the leader so that we can</span>
        <span class="token comment">// sync with it if it does assume leadership of the epoch.</span>
        <span class="token comment">// the -1 indicates that this reply should not count as an ack for the new epoch</span>
        wrappedEpochBytes<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Leaders epoch, "</span>
                              <span class="token operator">+</span> newEpoch
                              <span class="token operator">+</span> <span class="token string">" is less than accepted epoch, "</span>
                              <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">QuorumPacket</span> ackNewEpoch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">ACKEPOCH</span><span class="token punctuation">,</span> lastLoggedZxid<span class="token punctuation">,</span> epochBytes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writePacket</span><span class="token punctuation">(</span>ackNewEpoch<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Leader等待超过半数节点回复的<strong>ACKEPOCH</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">QuorumPacket</span> ackEpochPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageTracker<span class="token punctuation">.</span><span class="token function">trackReceived</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">ACKEPOCH</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"{} is not ACKEPOCH"</span><span class="token punctuation">,</span> ackEpochPacket<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">ByteBuffer</span> bbepoch <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateSummary</span><span class="token punctuation">(</span>bbepoch<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackEpochPacket<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
learnerMaster<span class="token punctuation">.</span><span class="token function">waitForEpochAck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ss<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<h3 id="FOLLOW-syncWithLeader-newEpochZxid-状态同步流程"><a href="#FOLLOW-syncWithLeader-newEpochZxid-状态同步流程" class="headerlink" title="FOLLOW syncWithLeader(newEpochZxid) 状态同步流程"></a>FOLLOW syncWithLeader(newEpochZxid) 状态同步流程</h3></blockquote>
<ul>
<li>Leader会根据Follower发送的zxid信息，判断采用何种方式和Follower同步数据，并将同步数据的Request添加到队列。注意，此时消息并未发送，只是添加到队列。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">peerLastZxid <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">getLastZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Take any necessary action if we need to send TRUNC or DIFF</span>
<span class="token comment">// startForwarding() will be called in all cases</span>
<span class="token keyword">boolean</span> needSnap <span class="token operator">=</span> <span class="token function">syncFollower</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">,</span> learnerMaster<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
     * It is possible that committedLog is empty. In that case
     * setting these value to the latest txn in learnerMaster db
     * will reduce the case that we need to handle
     *
     * Here is how each case handle by the if block below
     * 1. lastProcessZxid == peerZxid -&gt; Handle by (2)
     * 2. lastProcessZxid &lt; peerZxid -&gt; Handle by (3)
     * 3. lastProcessZxid &gt; peerZxid -&gt; Handle by (5)
     */</span>
    minCommittedLog <span class="token operator">=</span> lastProcessedZxid<span class="token punctuation">;</span>
    maxCommittedLog <span class="token operator">=</span> lastProcessedZxid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*
 * Here are the cases that we want to handle
 *
 * 1. Force sending snapshot (for testing purpose)
 * 2. Peer and learnerMaster is already sync, send empty diff
 * 3. Follower has txn that we haven't seen. This may be old leader
 *    so we need to send TRUNC. However, if peer has newEpochZxid,
 *    we cannot send TRUNC since the follower has no txnlog
 * 4. Follower is within committedLog range or already in-sync.
 *    We may need to send DIFF or TRUNC depending on follower's zxid
 *    We always send empty DIFF if follower is already in-sync
 * 5. Follower missed the committedLog. We will try to use on-disk
 *    txnlog + committedLog to sync with follower. If that fail,
 *    we will send snapshot
 */</span>
needSnap <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>forceSnapSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// for testing purpose</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lastProcessedZxid <span class="token operator">==</span> peerLastZxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若Follower的事务id和Leader一样，则发送Leader.DIFF，表示不需要同步数据</span>
    <span class="token function">queueOpPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">DIFF</span><span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>peerLastZxid <span class="token operator">&gt;</span> maxCommittedLog <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPeerNewEpochZxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若Follower的事务id &gt; Leader事务id，则发送Leader.TRUNC，截断Follower的数据，使其和Leader保持一致</span>
    <span class="token function">queueOpPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">TRUNC</span><span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>maxCommittedLog <span class="token operator">&gt;=</span> peerLastZxid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>minCommittedLog <span class="token operator">&lt;=</span> peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若minCommittedLog &lt;= Follower事务id &lt;= maxCommittedLog, 则从ZKDatabase缓存中获取请求，将需要同步的每条请求先发送一条Proposal，再发送一条Commit。</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Using committedLog for peer sid: {}"</span><span class="token punctuation">,</span> <span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> itr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>peerLastZxid <span class="token operator">&lt;</span> minCommittedLog <span class="token operator">&amp;&amp;</span> txnLogSyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 若Follower事务id &lt; minCommittedLog, 则会从事务日志和ZKDatabase缓存中获取请求同步到Follower，每条请求也是先发送一条Proposal，再发送一条Commit。</span>
    <span class="token comment">// Use txnlog and committedLog to sync</span>
    <span class="token comment">// Calculate sizeLimit that we allow to retrieve txnlog from disk</span>
    <span class="token keyword">long</span> sizeLimit <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">calculateTxnLogSizeLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// This method can return empty iterator if the requested zxid</span>
    <span class="token comment">// is older than on-disk txnlog</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> txnLogItr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getProposalsFromTxnLog</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">,</span> sizeLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txnLogItr<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 非空</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Use txnlog and committedLog for peer sid: {}"</span><span class="token punctuation">,</span> <span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从 disk事务日志 同步</span>
        currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>txnLogItr<span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">,</span> minCommittedLog<span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentZxid <span class="token operator">&lt;</span> minCommittedLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                <span class="token string">"Detected gap between end of txnlog: 0x{} and start of committedLog: 0x{}"</span><span class="token punctuation">,</span>
                <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>currentZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>minCommittedLog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentZxid <span class="token operator">=</span> peerLastZxid<span class="token punctuation">;</span>
            <span class="token comment">// 退回为snap</span>
            queuedPackets<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            needOpPacket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Queueing committedLog 0x{}"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>currentZxid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 从 ZKDatabase缓存 同步</span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> committedLogItr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>committedLogItr<span class="token punctuation">,</span> currentZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
            needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// closing the resources</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>txnLogItr <span class="token keyword">instanceof</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">TxnLogProposalIterator</span> txnProposalItr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">)</span> txnLogItr<span class="token punctuation">;</span>
        txnProposalItr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>如果最后需要snap，发送<strong>snap</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>needSnap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    syncThrottler <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getLearnerSnapSyncThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syncThrottler<span class="token punctuation">.</span><span class="token function">beginSync</span><span class="token punctuation">(</span>exemptFromThrottle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> zxidToSend <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataTreeLastProcessedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">SNAP</span><span class="token punctuation">,</span> zxidToSend<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageTracker<span class="token punctuation">.</span><span class="token function">trackSent</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">SNAP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
            <span class="token string">"Sending snapshot last zxid of peer is 0x{}, zxid of leader is 0x{}, "</span>
                <span class="token operator">+</span> <span class="token string">"send zxid of db as 0x{}, {} concurrent snapshot sync, "</span>
                <span class="token operator">+</span> <span class="token string">"snapshot sync was {} from throttle"</span><span class="token punctuation">,</span>
            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>leaderLastZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>zxidToSend<span class="token punctuation">)</span><span class="token punctuation">,</span>
            syncThrottler<span class="token punctuation">.</span><span class="token function">getSyncInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            exemptFromThrottle <span class="token operator">?</span> <span class="token string">"exempt"</span> <span class="token operator">:</span> <span class="token string">"not exempt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Dump data to peer</span>
        learnerMaster<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serializeSnapshot</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>
        oa<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token string">"BenWasHere"</span><span class="token punctuation">,</span> <span class="token string">"signature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">SNAP_COUNT</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    syncThrottler <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getLearnerDiffSyncThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    syncThrottler<span class="token punctuation">.</span><span class="token function">beginSync</span><span class="token punctuation">(</span>exemptFromThrottle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token constant">DIFF_COUNT</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>将<strong>NEWLEADER</strong>添加到队列。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">QuorumPacket</span> newLeaderQP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">NEWLEADER</span><span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getQuorumVerifierBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newLeaderQP<span class="token punctuation">)</span><span class="token punctuation">;</span>
bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<ul>
<li>发送队列的消息，因为同步数据的队列在前，<strong>NEWLEADER</strong>在后，所以会先和Follower同步数据，再发送<strong>NEWLEADER</strong>。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Start thread that blast packets in the queue to learner</span>
<span class="token function">startSendingPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>Follower收到<strong>NEWLEADER</strong>后回复<strong>ACK</strong>。</li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">NEWLEADER</span><span class="token operator">:</span>
    <span class="token function">writePacket</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">ACK</span><span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<ul>
<li>Leader 等待大部分节点回复<strong>ACK</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/*
 * Have to wait for the first ACK, wait until
 * the learnerMaster is ready, and only then we can
 * start processing messages.
 */</span>
qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
messageTracker<span class="token punctuation">.</span><span class="token function">trackReceived</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">ACK</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Next packet was supposed to be an ACK, but received packet: {}"</span><span class="token punctuation">,</span> <span class="token function">packetToString</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token constant">LOG</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Received NEWLEADER-ACK message from {}"</span><span class="token punctuation">,</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>

learnerMaster<span class="token punctuation">.</span><span class="token function">waitForNewLeaderAck</span><span class="token punctuation">(</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>Leader发送<strong>UPTODATE</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">UPTODATE</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>FOLLOW接收<strong>UPTODATE</strong></li>
</ul>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">UPTODATE</span><span class="token operator">:</span>
    self<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span> outerLoop<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>在上述步骤完成后，集群状态已经稳定，可以对外提供服务。<br>心跳检测逻辑</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">// We ping twice a tick, so we only update the tick every other</span>
    <span class="token comment">// iteration</span>
    <span class="token keyword">boolean</span> tickSkip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token comment">// If not null then shutdown this leader</span>
    <span class="token class-name">String</span> shutdownMessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">long</span> cur <span class="token operator">=</span> start<span class="token punctuation">;</span>
            <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span>tickTime <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">wait</span><span class="token punctuation">(</span>end <span class="token operator">-</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cur <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                self<span class="token punctuation">.</span>tick<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 使用SyncedLearnerTracker来确认自己是否维持着quorum</span>
            <span class="token class-name">SyncedLearnerTracker</span> syncedAckSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncedLearnerTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            syncedAckSet<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                syncedAckSet<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            syncedAckSet<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 检测每个追随者</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LearnerHandler</span> f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// current tick &lt;= tick+syncLimit</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">synced</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    syncedAckSet<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// check leader running status</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// set shutdown flag</span>
                shutdownMessage <span class="token operator">=</span> <span class="token string">"Unexpected internal error"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>syncedAckSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// quorum没过半数，退出leader</span>
                shutdownMessage <span class="token operator">=</span> <span class="token string">"Not sufficient followers synced, only synced with sids: [ "</span>
                                  <span class="token operator">+</span> syncedAckSet<span class="token punctuation">.</span><span class="token function">ackSetsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                  <span class="token operator">+</span> <span class="token string">" ]"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tickSkip <span class="token operator">=</span> <span class="token operator">!</span>tickSkip<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 1个tick time内ping两次</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LearnerHandler</span> f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            f<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

``` java
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span><span class="token constant">PING</span><span class="token operator">:</span>
        <span class="token function">ping</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yiduoyunQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yiduoyunQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
