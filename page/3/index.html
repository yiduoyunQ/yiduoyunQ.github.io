<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yiduoyunq.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="yiduoyunQ">
<meta property="og:url" content="https://yiduoyunq.github.io/page/3/index.html">
<meta property="og:site_name" content="yiduoyunQ">
<meta property="article:author" content="yiduoyunQ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yiduoyunq.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-Hans'
  };
</script>

  <title>yiduoyunQ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yiduoyunQ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/05/go/dlv/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/05/go/dlv/" class="post-title-link" itemprop="url">dlv调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-05 13:06:42" itemprop="dateCreated datePublished" datetime="2020-05-05T13:06:42+00:00">2020-05-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dlv安装"><a href="#dlv安装" class="headerlink" title="dlv安装"></a>dlv安装</h2><p><a href="https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md" target="_blank" rel="noopener">https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md</a></p>
<p>使用<code>make install</code>安装</p>
<h2 id="vscode调试"><a href="#vscode调试" class="headerlink" title="vscode调试"></a>vscode调试</h2><p><a href="https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code" target="_blank" rel="noopener">https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/04/go/modules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/04/go/modules/" class="post-title-link" itemprop="url">go module</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-04 14:10:36" itemprop="dateCreated datePublished" datetime="2020-05-04T14:10:36+00:00">2020-05-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-22 16:19:53" itemprop="dateModified" datetime="2020-07-22T16:19:53+00:00">2020-07-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="go-module"><a href="#go-module" class="headerlink" title="go_module"></a>go_module</h2><h3 id="1-11之前"><a href="#1-11之前" class="headerlink" title="1.11之前"></a>1.11之前</h3><ul>
<li>依赖<code>$GOPATH</code></li>
<li>版本使用克隆时分支代码</li>
<li>采用 vendor手动版本管理 / godep锁定版本管理</li>
</ul>
<h3 id="最小化版本选择-MVS-Minimal-Version-Selection"><a href="#最小化版本选择-MVS-Minimal-Version-Selection" class="headerlink" title="最小化版本选择 MVS(Minimal Version Selection)"></a>最小化版本选择 MVS(Minimal Version Selection)</h3><img src="/2020/05/04/go/modules/go-modules-mvs-1.png" class="">

<ol>
<li>godep会选择D的1.X.X最新最大版本，在语义版本化和遵守社会契约的前提下可以正常工作。</li>
<li>go会选择最小版本：</li>
</ol>
<ul>
<li>A -&gt; D v1.0.6</li>
<li>A+B -&gt; D v1.2.0</li>
<li>A+B+C -&gt; D v1.3.2</li>
</ul>
<h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li>go.mod文件，它与package.json或Pipfile文件的功能类似。</li>
<li>验证文件go.sum。</li>
<li>不再有GOPATH限制。模块可以位于任何路径中。</li>
</ol>
<h3 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> mod init github.com/username/repository</span><br></pre></td></tr></table></figure>

<h3 id="升级依赖关系，默认最小化升级"><a href="#升级依赖关系，默认最小化升级" class="headerlink" title="升级依赖关系，默认最小化升级"></a>升级依赖关系，默认最小化升级</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go get -t -d -v ./...</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>-t flag：考虑构建测试所需的module。<br>-d flag：下载每个module的源代码，但不要构建或安装它们。<br>-v flag：提供详细输出。<br>./… ：在整个源代码树中执行这些操作，并且仅更新所需的依赖项。<br>-u flag 最新最大升级，通常不使用</p>
</blockquote>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="列出软件包的可用版本"><a href="#列出软件包的可用版本" class="headerlink" title="列出软件包的可用版本"></a>列出软件包的可用版本</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go list -m -versions github.com/getsentry/raven-go</span></span><br><span class="line">github.com/getsentry/raven-go v0.1.0 v0.1.1 v0.1.2 v0.2.0</span><br></pre></td></tr></table></figure>

<h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>添加依赖项是隐式的。在代码中导入依赖项后，运行go build或go test命令将获取模块的最新版本并将其添加到go.mod文件中。<br>如果要显式添加依赖项，请运行go get github.com/username/repository。</p>
<h4 id="依赖项的升级-降级"><a href="#依赖项的升级-降级" class="headerlink" title="依赖项的升级/降级"></a>依赖项的升级/降级</h4><p>go get github.com/username/repository@vx.x.x下载并设置依赖项和更新go.mod文件的特定版本</p>
<h4 id="mod命令"><a href="#mod命令" class="headerlink" title="mod命令"></a>mod命令</h4><ul>
<li>go mod init：生成 go.mod 文件</li>
<li>go mod download : 下载 go.mod 文件中指明的所有依赖</li>
<li>go mod tidy: 整理现有的依赖</li>
<li>go mod graph: 查看现有的依赖结构</li>
<li>go mod edit : 编辑 go.mod 文件</li>
<li>go mod vendor : 导出项目所有的依赖到vendor目录</li>
<li>go mod verify: 校验一个模块是否被篡改过</li>
<li>go mod why : 查看为什么需要依赖某模块</li>
</ul>
<h3 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h3><ul>
<li><p>阿里云<br><a href="https://mirrors.aliyun.com/goproxy/" target="_blank" rel="noopener">https://mirrors.aliyun.com/goproxy/</a></p>
</li>
<li><p>七牛云<br>goproxy.cn,direct</p>
</li>
</ul>
<p>设置：<br><code>$ go env -w GOPROXY=https://goproxy.cn,direct</code><br>direct用于proxy代理返404后回源到源地址</p>
<h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>GOOS=linux GOARCH=amd64 go build</p>
<h2 id="node-module"><a href="#node-module" class="headerlink" title="node_module"></a>node_module</h2><h3 id="依赖黑洞"><a href="#依赖黑洞" class="headerlink" title="依赖黑洞"></a>依赖黑洞</h3><p>项目依赖A和C，A和C依赖不同版本的B</p>
<img src="/2020/05/04/go/modules/npm_v0.jpg" class="">
<img src="/2020/05/04/go/modules/npm_v1.jpg" class="">

<p>考虑两个问题：</p>
<ol>
<li>B的次要版本可以共存，并且没有副作用。但node有js全局污染可能。</li>
<li>B的次要版本可以共存，如何保证A和C正确加载<code>B v2.0</code></li>
</ol>
<h3 id="npm解决方式"><a href="#npm解决方式" class="headerlink" title="npm解决方式"></a>npm解决方式</h3><p>递归向上查找node_modules里的package，如果在 ‘/home/my/projects/foo.js’ 文件里调用了 require(‘bar.js’)，则 Node.js 会按以下顺序查找：</p>
<ul>
<li>/home/my/projects/node_modules/bar.js</li>
<li>/home/my/node_modules/bar.js</li>
<li>/home/node_modules/bar.js</li>
<li>/node_modules/bar.js</li>
</ul>
<p>算法核心</p>
<ul>
<li>优先读取最近的node_modules的依赖</li>
<li>递归向上查找node_modules依赖</li>
</ul>
<p>假设D也依赖<code>B v2.0</code>，node_modules结构如下</p>
<img src="/2020/05/04/go/modules/npm_v1.1.jpg" class="">

<p> 相同的<code>B v2.0</code>被依赖了两次，在node中lodash等公用插件会造成极大空间浪费</p>
<p>利用<code>递归向上</code>特性，将公共库放在顶层</p>
<img src="/2020/05/04/go/modules/npm_v3.jpg" class="">

<p>若B和E依赖<code>B v1.0</code>，C和D依赖<code>B v2.0</code>，问题依旧存在</p>
<img src="/2020/05/04/go/modules/npm_v3.1.jpg" class="">

<h3 id="幻依赖"><a href="#幻依赖" class="headerlink" title="幻依赖"></a>幻依赖</h3><img src="/2020/05/04/go/modules/Phantom_1.jpg" class="">
<img src="/2020/05/04/go/modules/Phantom_2.jpg" class="">

<p>glob和brace-expansion都不在depdencies里，但是我们开发和运行时都可以正常工作（因为这个是rimraf的依赖），一旦将该库发布，因为用户安装我们的库的时候并不会安装库的devDepdency，这导致在用户的地方会运行报错。</p>
<h3 id="yarn-lock-vs-npm-lock"><a href="#yarn-lock-vs-npm-lock" class="headerlink" title="yarn lock vs npm lock"></a>yarn lock vs npm lock</h3><img src="/2020/05/04/go/modules/package.jpg" class="">
<img src="/2020/05/04/go/modules/yarn.jpg" class="">

<p>通过lock开发版本在生产复现环境。但无法规避npm全局cli。</p>
<h3 id="库里应该提交lock文件吗"><a href="#库里应该提交lock文件吗" class="headerlink" title="库里应该提交lock文件吗"></a>库里应该提交lock文件吗</h3><p>应该。可以很大程度避免环境差异。</p>
<h3 id="确定性"><a href="#确定性" class="headerlink" title="确定性"></a>确定性</h3><img src="/2020/05/04/go/modules/yarn.lock.jpg" class="">

<p>yarn.lock仅提供版本确定性，无法保证node_modules拓扑，如下两种拓扑都是合理的</p>
<p>第一种</p>
<img src="/2020/05/04/go/modules/topo1.jpg" class="">

<p>第二种</p>
<img src="/2020/05/04/go/modules/topo2.jpg" class="">

<p>npm的lock包含拓扑信息</p>
<img src="/2020/05/04/go/modules/npm_topo.jpg" class="">

<h3 id="PNPM"><a href="#PNPM" class="headerlink" title="PNPM"></a>PNPM</h3><p>npm和yarn通过文件目录和node resolve算法模拟的实际上是有向无环图的一个超集（多出了很多错误祖先节点和兄弟节点之间的链接），这导致了很多的问题，所以我们需要更加接近DAG的模拟。pnpm正是采取了这种解决方式，通过更加精确的模拟DAG来解决yarn和npm代理的问题。</p>
<p>npm的结构</p>
<img src="/2020/05/04/go/modules/npm_arch.jpg" class="">

<p>代码可以使用<code>express</code>引入的<code>debug</code>模块，即使没有显式的引入</p>
<img src="/2020/05/04/go/modules/pnpm_package.jpg" class="">

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/index.js</span></span><br><span class="line"><span class="keyword">const</span> debug = <span class="built_in">require</span>(<span class="string">'debug'</span>)</span><br></pre></td></tr></table></figure>

<p>pnpm的结构</p>
<img src="/2020/05/04/go/modules/pnpm_arch.jpg" class="">

<p>顶层已没有<code>debug</code>模块，因此代码里不会错误的引用</p>
<h3 id="pnpm-vs-yarn"><a href="#pnpm-vs-yarn" class="headerlink" title="pnpm vs yarn"></a>pnpm vs yarn</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"debug"</span>: <span class="string">"3"</span>,</span><br><span class="line">    <span class="attr">"express"</span>: <span class="string">"4.0.0"</span>,</span><br><span class="line">    <span class="attr">"koa"</span>: <span class="string">"^2.11.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies:</span><br><span class="line">debug <span class="number">3.1</span><span class="number">.0</span></span><br><span class="line">express <span class="number">4.0</span><span class="number">.0</span></span><br><span class="line">├── debug <span class="number">0.8</span><span class="number">.1</span></span><br><span class="line">├─┬ send <span class="number">0.2</span><span class="number">.0</span></span><br><span class="line">│ └── debug <span class="number">1.0</span><span class="number">.5</span></span><br><span class="line">└─┬ serve-<span class="keyword">static</span> <span class="number">1.0</span><span class="number">.1</span></span><br><span class="line">  └─┬ send <span class="number">0.1</span><span class="number">.4</span></span><br><span class="line">    └── debug <span class="number">1.0</span><span class="number">.5</span></span><br><span class="line">koa <span class="number">2.11</span><span class="number">.0</span></span><br><span class="line">└── debug <span class="number">3.1</span><span class="number">.0</span>%</span><br></pre></td></tr></table></figure>

<p>yarn放在不同层级，依赖递归查找算法来选择版本</p>
<img src="/2020/05/04/go/modules/pnpm_module.jpg" class="">

<p>pnpm将不同版本放在同一层级里通过软链选择加载版本，彻底避免了包重复问题，节省大量时间和空间</p>
<img src="/2020/05/04/go/modules/monorepo_sample.jpg" class="">

<h2 id="TODO-mvn"><a href="#TODO-mvn" class="headerlink" title="TODO mvn"></a>TODO mvn</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://semver.org/lang/zh-CN/" title="" target="">语义化版本</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/137535779" title="" target="">知乎 - node_modules 困境</a></li>
<li><a href="https://tonybai.com/2019/09/21/brief-history-of-go-package-management/" title="" target="">Go语言包管理简史</a></li>
<li><a href="https://tonybai.com/2019/12/21/go-modules-minimal-version-selection/" title="" target="">Go modules：最小版本选择</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/41627929" title="" target="">关于Go Module的争吵</a></li>
<li><a href="https://research.swtch.com/vgo-principles" title="" target="">The Principles of Versioning in Go</a>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/" class="post-title-link" itemprop="url">数据库测试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 21:46:23" itemprop="dateCreated datePublished" datetime="2020-04-29T21:46:23+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-01-03 02:01:34" itemprop="dateModified" datetime="2021-01-03T02:01:34+00:00">2021-01-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" itemprop="url" rel="index"><span itemprop="name">数据库</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><h3 id="版本5-7"><a href="#版本5-7" class="headerlink" title="版本5.7"></a>版本5.7</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">version</span>();</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| version() |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">| 5.7.29    |</span><br><span class="line">+<span class="comment">-----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="范围查询包含非key字段"><a href="#范围查询包含非key字段" class="headerlink" title="范围查询包含非key字段"></a>范围查询包含非key字段</h3><h4 id="1个字符，4000W"><a href="#1个字符，4000W" class="headerlink" title="1个字符，4000W"></a>1个字符，4000W</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">date</span>, <span class="keyword">length</span>(<span class="keyword">name</span>), <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span>, <span class="keyword">name</span>;</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| date                | length(name) | count(*) |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| 2020-04-01 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-02 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-03 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-04 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-05 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-06 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-07 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-08 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-09 00:00:00 |            1 |  4194304 |</span><br><span class="line">| 2020-04-10 00:00:00 |            1 |  4194304 |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">5</span> <span class="keyword">min</span> <span class="number">19.25</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="90-范围查询，带text字段，不走索引"><a href="#90-范围查询，带text字段，不走索引" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41863640 |    50.00 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.13</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="10-范围查询，带text字段，不走索引"><a href="#10-范围查询，带text字段，不走索引" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">id</span>, <span class="built_in">date</span>, <span class="keyword">name</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/02 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41863640 |    19.10 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.12</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="树高度"><a href="#树高度" class="headerlink" title="树高度"></a>树高度</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> b.name, a.name, index_id, <span class="keyword">type</span>, a.space, a.PAGE_NO <span class="keyword">FROM</span> information_schema.INNODB_SYS_INDEXES a, information_schema.INNODB_SYS_TABLES b <span class="keyword">WHERE</span> a.table_id = b.table_id <span class="keyword">AND</span> a.space &lt;&gt; <span class="number">0</span> <span class="keyword">and</span> b.name=<span class="string">'test/test'</span>;</span><br><span class="line">+<span class="comment">-----------+---------+----------+------+-------+---------+</span></span><br><span class="line">| name      | name    | index_id | type | space | PAGE_NO |</span><br><span class="line">+<span class="comment">-----------+---------+----------+------+-------+---------+</span></span><br><span class="line">| test/test | PRIMARY |       93 |    3 |    60 |       3 |</span><br><span class="line">| test/test | uk1     |       94 |    0 |    60 |       4 |</span><br><span class="line">+<span class="comment">-----------+---------+----------+------+-------+---------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.08</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// 主键 3*16384+64，level为0x02，高度为3</span><br><span class="line"><span class="meta">$</span><span class="bash"> hexdump -s 49216 -n 10 test.ibd</span></span><br><span class="line">000c040 00 02 00 00 00 00 00 00 00 5d</span><br><span class="line">000c04a</span><br><span class="line">// uk1 4*16384+64，level为0x02，高度为3</span><br><span class="line"><span class="meta">$</span><span class="bash"> hexdump -s 65600 -n 10 test.ibd</span></span><br><span class="line">0010040 00 02 00 00 00 00 00 00 00 5e</span><br><span class="line">001004a</span><br></pre></td></tr></table></figure>

<h4 id="5个字符，4000W"><a href="#5个字符，4000W" class="headerlink" title="5个字符，4000W"></a>5个字符，4000W</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">date</span>, <span class="keyword">length</span>(<span class="keyword">name</span>), <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span>, <span class="keyword">name</span>;</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| date                | length(name) | count(*) |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| 2020-04-01 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-02 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-03 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-04 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-05 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-06 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-07 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-08 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-09 00:00:00 |            5 |  4194304 |</span><br><span class="line">| 2020-04-10 00:00:00 |            5 |  4194304 |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">4</span> <span class="keyword">min</span> <span class="number">55.59</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="90-范围查询，带text字段，不走索引-1"><a href="#90-范围查询，带text字段，不走索引-1" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41853552 |    50.00 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="10-范围查询，带text字段，不走索引-1"><a href="#10-范围查询，带text字段，不走索引-1" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">id</span>, <span class="built_in">date</span>, <span class="keyword">name</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/02 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41853552 |    19.11 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="200个字符，4000W"><a href="#200个字符，4000W" class="headerlink" title="200个字符，4000W"></a>200个字符，4000W</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">date</span>, <span class="keyword">length</span>(<span class="keyword">name</span>), <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span>, <span class="keyword">name</span>;</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| date                | length(name) | count(*) |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| 2020-04-01 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-02 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-03 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-04 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-05 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-06 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-07 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-08 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-09 00:00:00 |          200 |  4194304 |</span><br><span class="line">| 2020-04-10 00:00:00 |          200 |  4194304 |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">6</span> <span class="keyword">min</span> <span class="number">58.89</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="90-范围查询，带text字段，不走索引-2"><a href="#90-范围查询，带text字段，不走索引-2" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41342675 |    50.00 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="90-范围查询，仅查询索引字段或count-计数，走索引"><a href="#90-范围查询，仅查询索引字段或count-计数，走索引" class="headerlink" title="90%范围查询，仅查询索引字段或count(*)计数，走索引"></a>90%范围查询，仅查询索引字段或count(*)计数，走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="built_in">date</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows     | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | range | uk1           | uk1  | 4       | NULL | 20671337 |   100.00 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows     | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | range | uk1           | uk1  | 4       | NULL | 20671337 |   100.00 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="10-范围查询，带text字段，不走索引-2"><a href="#10-范围查询，带text字段，不走索引-2" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/02 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41342675 |    19.34 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="主键查询固定走索引"><a href="#主键查询固定走索引" class="headerlink" title="主键查询固定走索引"></a>主键查询固定走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">1</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key     | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL | 20671337 |   100.00 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.02</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="200个字符，1W"><a href="#200个字符，1W" class="headerlink" title="200个字符，1W"></a>200个字符，1W</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">date</span>, <span class="keyword">length</span>(<span class="keyword">name</span>), <span class="keyword">count</span>(*) <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span>, <span class="keyword">name</span>;</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| date                | length(name) | count(*) |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">| 2020-04-01 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-02 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-03 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-04 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-05 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-06 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-07 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-08 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-09 00:00:00 |          200 |     1024 |</span><br><span class="line">| 2020-04-10 00:00:00 |          200 |     1024 |</span><br><span class="line">+<span class="comment">---------------------+--------------+----------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">0.11</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="90-范围查询，带text字段，不走索引-3"><a href="#90-范围查询，带text字段，不走索引-3" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/10 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 10140 |    90.89 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h5 id="10-范围查询，带text字段，走索引"><a href="#10-范围查询，带text字段，走索引" class="headerlink" title="10%范围查询，带text字段，走索引"></a>10%范围查询，带text字段，走索引</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &gt;= <span class="string">'2020/04/01 00:00:00'</span> <span class="keyword">and</span> <span class="built_in">date</span> &lt; <span class="string">'2020/04/02 00:00:00'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | range | uk1           | uk1  | 4       | NULL | 1024 |   100.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="200个字符，4000W，耗时比较"><a href="#200个字符，4000W，耗时比较" class="headerlink" title="200个字符，4000W，耗时比较"></a>200个字符，4000W，耗时比较</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> time mysql <span class="built_in">test</span> -e <span class="string">"select * from test where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'"</span> &gt; /dev/null</span></span><br><span class="line"></span><br><span class="line">real 2m54.656s</span><br><span class="line">user 1m4.118s</span><br><span class="line">sys 0m4.271s</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> time mysql <span class="built_in">test</span> -e <span class="string">"select * from test force index(uk1) where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'"</span> &gt; /dev/null</span></span><br><span class="line"></span><br><span class="line">real 1m43.517s</span><br><span class="line">user 0m59.562s</span><br><span class="line">sys 0m3.959s</span><br></pre></td></tr></table></figure>

<h4 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>;</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                                                                                                                                                                                                            |</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line">| <span class="keyword">test</span>  | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`date`</span> <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">text</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`uk1`</span> (<span class="string">`date`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">42990946</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 |</span><br><span class="line">+<span class="comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span></span><br><span class="line"><span class="number">1</span> <span class="keyword">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="number">1</span>,<span class="string">'2020/04/01'</span>, <span class="string">'a'</span>);</span><br><span class="line"><span class="comment">-- insert into test values(1,'2020/04/01', repeat('a', 5));</span></span><br><span class="line"><span class="comment">-- insert into test values(1,'2020/04/01', repeat('a', 200));</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span>(<span class="built_in">date</span>, <span class="keyword">name</span>) <span class="keyword">select</span> <span class="string">'2020/04/01'</span>,<span class="keyword">name</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> =<span class="string">'2020/04/01'</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="autoincrement-uuid-insert速度比较"><a href="#autoincrement-uuid-insert速度比较" class="headerlink" title="autoincrement / uuid  insert速度比较"></a>autoincrement / uuid  insert速度比较</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test02(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line"><span class="built_in">date</span> <span class="built_in">timestamp</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="keyword">current_timestamp</span> <span class="keyword">on</span> <span class="keyword">update</span> <span class="keyword">current_timestamp</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">text</span>,</span><br><span class="line">primary <span class="keyword">key</span>(<span class="keyword">id</span>),<span class="keyword">key</span> uk1 (<span class="built_in">date</span>)) <span class="keyword">engine</span>=<span class="keyword">innodb</span> <span class="keyword">default</span> <span class="keyword">charset</span>=utf8;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test01 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| 1048577 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(<span class="built_in">date</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="string">'2020/04/15'</span>,<span class="keyword">name</span> <span class="keyword">from</span> test01 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">Query OK, 1048577 rows affected (12.73 sec)</span><br><span class="line">Records: 1048577  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test02 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| 1048577 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test02(<span class="keyword">id</span>,<span class="built_in">date</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">replace</span>(<span class="keyword">uuid</span>(),<span class="string">'-'</span>,<span class="string">''</span>),<span class="string">'2020/04/15'</span>,<span class="keyword">name</span> <span class="keyword">from</span> test02 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">Query OK, 1048576 rows affected (17.31 sec)</span><br><span class="line">Records: 1048576  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test01 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| 16777232 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(<span class="built_in">date</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="string">'2020/04/30'</span>,<span class="keyword">name</span> <span class="keyword">from</span> test01 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">Query OK, 16777232 rows affected (4 min 11.18 sec)</span><br><span class="line">Records: 16777232  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test02 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| 16777216 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test02(<span class="keyword">id</span>,<span class="built_in">date</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">replace</span>(<span class="keyword">uuid</span>(),<span class="string">'-'</span>,<span class="string">''</span>),<span class="string">'2020/04/30'</span>,<span class="keyword">name</span> <span class="keyword">from</span> test02 <span class="keyword">where</span> <span class="built_in">date</span>=<span class="string">'2020/04/01'</span>;</span><br><span class="line">Query OK, 16777216 rows affected (5 min 41.65 sec)</span><br><span class="line">Records: 16777216  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure>

<h3 id="view"><a href="#view" class="headerlink" title="view"></a>view</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test01;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">|  1048576 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.29</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> test_view;</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| count(*) |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">| 10485760 |</span><br><span class="line">+<span class="comment">----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">34.62</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> id1, id2 <span class="keyword">from</span>  test_view <span class="keyword">where</span> id1=<span class="number">500</span> <span class="keyword">and</span> id2 <span class="keyword">between</span> <span class="number">700</span> <span class="keyword">and</span> <span class="number">710</span>;</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span></span><br><span class="line">| id | select_type | table      | partitions | type | possible_keys | key         | key_len | ref   | rows    | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span></span><br><span class="line">|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ref  | &lt;auto_key0&gt;   | &lt;auto_key0&gt; | 4       | const |  104695 |    11.11 | Using where |</span><br><span class="line">|  2 | DERIVED     | test01     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1047386 |   100.00 | NULL        |</span><br><span class="line">|  3 | UNION       | test02     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  4 | UNION       | test03     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  5 | UNION       | test04     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  6 | UNION       | test05     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  7 | UNION       | test06     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  8 | UNION       | test07     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">|  9 | UNION       | test08     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">| 10 | UNION       | test09     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">| 11 | UNION       | test10     | NULL       | ALL  | NULL          | NULL        | NULL    | NULL  | 1046904 |   100.00 | NULL        |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span></span><br><span class="line">11 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> id1, id2 <span class="keyword">from</span>  test_view_pk <span class="keyword">where</span> id1=<span class="number">500</span> <span class="keyword">and</span> id2 <span class="keyword">between</span> <span class="number">700</span> <span class="keyword">and</span> <span class="number">710</span>;</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table      | partitions | type  | possible_keys | key         | key_len | ref   | rows    | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span></span><br><span class="line">|  1 | PRIMARY     | &lt;derived2&gt; | NULL       | ref   | &lt;auto_key0&gt;   | &lt;auto_key0&gt; | 4       | const |  104695 |    11.11 | Using where; Using index |</span><br><span class="line">|  2 | DERIVED     | test01     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1047386 |   100.00 | Using index              |</span><br><span class="line">|  3 | UNION       | test02     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  4 | UNION       | test03     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  5 | UNION       | test04     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  6 | UNION       | test05     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  7 | UNION       | test06     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  8 | UNION       | test07     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">|  9 | UNION       | test08     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">| 10 | UNION       | test09     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">| 11 | UNION       | test10     | NULL       | index | NULL          | PRIMARY     | 8       | NULL  | 1046904 |   100.00 | Using index              |</span><br><span class="line">+<span class="comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span></span><br><span class="line">11 rows in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="语句-1"><a href="#语句-1" class="headerlink" title="语句"></a>语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test01`</span> (</span><br><span class="line">  <span class="string">`id1`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`id2`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name1`</span> <span class="built_in">text</span>,</span><br><span class="line">  <span class="string">`name2`</span> <span class="built_in">text</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id1`</span>, <span class="string">`id2`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- test02 -- test10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> test_view <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test01</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test02</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test03</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test04</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test05</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test06</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test07</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test08</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test09</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test10</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">view</span> test_view_pk <span class="keyword">as</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test01</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test02</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test03</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test04</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test05</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test06</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test07</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test08</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test09</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> id1, id2 <span class="keyword">from</span> test10</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">for i in &#123;1..1024&#125;</span><br><span class="line">do</span><br><span class="line">    s=""</span><br><span class="line">    for j in &#123;1..1024&#125;</span><br><span class="line">    do</span><br><span class="line">        s+="($i, $j, 'a', 'b')"</span><br><span class="line">        s+=","</span><br><span class="line">    done</span><br><span class="line">    mysql test -e "insert into test01 values$&#123;s%,&#125;" &amp;</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">wait</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test02 <span class="keyword">select</span> * <span class="keyword">from</span> test01;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test10 <span class="keyword">select</span> * <span class="keyword">from</span> test01;</span><br></pre></td></tr></table></figure>

<h3 id="binlog-row-image"><a href="#binlog-row-image" class="headerlink" title="binlog_row_image"></a>binlog_row_image</h3><p>full： before image和after image都为全量字段<br>minimal： before image仅用于区分记录字段(主键等)，after image仅语句指定字段(更新字段)</p>
<h4 id="create-table"><a href="#create-table" class="headerlink" title="create table"></a>create table</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`c1`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c2`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`s1`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`s2`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`c1`</span>,<span class="string">`c2`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br></pre></td></tr></table></figure>

<h4 id="full"><a href="#full" class="headerlink" title="full"></a>full</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="string">'a1'</span>, <span class="string">'b1'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">### INSERT INTO `test`.`test`</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> c1=<span class="number">1</span> <span class="keyword">and</span> c2=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">### DELETE FROM `test`.`test`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> test00 <span class="keyword">set</span> s2=<span class="string">'c123'</span> <span class="keyword">where</span> s1=<span class="string">'a1'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b3' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br></pre></td></tr></table></figure>

<h4 id="minimal"><a href="#minimal" class="headerlink" title="minimal"></a>minimal</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span> <span class="keyword">values</span>(<span class="number">2</span>, <span class="number">2</span>, <span class="string">'a2'</span>, <span class="string">'b2'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">### INSERT INTO `test`.`test`</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @3='a2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> c1=<span class="number">2</span> <span class="keyword">and</span> c2=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">### DELETE FROM `test`.`test`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> test00 <span class="keyword">set</span> s2=<span class="string">'d123'</span> <span class="keyword">where</span> s1=<span class="string">'a2'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="comment">### UPDATE `mysqltt`.`test00`</span></span><br><span class="line"><span class="comment">### WHERE</span></span><br><span class="line"><span class="comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="comment">### SET</span></span><br><span class="line"><span class="comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span></span><br></pre></td></tr></table></figure>

<h3 id="使用备份idb快速恢复历史数据"><a href="#使用备份idb快速恢复历史数据" class="headerlink" title="使用备份idb快速恢复历史数据"></a>使用备份idb快速恢复历史数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> discard <span class="keyword">tablespace</span>;</span><br><span class="line">Query OK, 0 rows affected (45.11 sec)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span>;</span><br><span class="line">ERROR 1814 (HY000): Tablespace has been discarded for table 'test'</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">for</span> <span class="keyword">export</span>;</span><br><span class="line">scp /backup_node/path_to_dat/test.ibd /recover_node/path_to_dat/</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">import</span> <span class="keyword">tablespace</span>;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (18.73 sec)</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>;</span><br><span class="line">+<span class="comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span></span><br><span class="line">| Id | User | Host      | db   | Command | Time | State       | Info                               |</span><br><span class="line">+<span class="comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span></span><br><span class="line">|  8 | root | localhost | test | Query   |   16 | System <span class="keyword">lock</span> | <span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">import</span> <span class="keyword">tablespace</span> |</span><br><span class="line">| <span class="number">12</span> | root | localhost | <span class="literal">NULL</span> | <span class="keyword">Query</span>   |    <span class="number">0</span> | <span class="keyword">starting</span>    | <span class="keyword">show</span> <span class="keyword">full</span> <span class="keyword">processlist</span>              |</span><br><span class="line">+<span class="comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line">+<span class="comment">----+---------------------+-------+</span></span><br><span class="line">| id | date                | name  |</span><br><span class="line">+<span class="comment">----+---------------------+-------+</span></span><br><span class="line">|  1 | 2020-04-01 00:00:00 | aaaaa |</span><br><span class="line">+<span class="comment">----+---------------------+-------+</span></span><br></pre></td></tr></table></figure>

<h3 id="锁等待"><a href="#锁等待" class="headerlink" title="锁等待"></a>锁等待</h3><ul>
<li><code>show engine innodb status</code>看死锁/锁等待</li>
<li><code>information_schema.innodb_locks</code>和<code>information_schema.innodb_lock_waits</code>看锁关系信息</li>
<li><code>performance_schema.events_statements_history</code>和<code>performance_schema.threads</code>看<code>show processlist</code>中pid执行历史语句</li>
<li><code>information_schema.innodb_trx</code>看当前执行中未提交事务</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session1</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test.test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session2</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test.test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">2</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session3</span></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">engine</span> <span class="keyword">innodb</span> <span class="keyword">status</span>\G;</span><br><span class="line"></span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line"><span class="comment">---TRANSACTION 281479529381440, not started</span></span><br><span class="line">0 <span class="keyword">lock</span> <span class="keyword">struct</span>(s), <span class="keyword">heap</span> <span class="keyword">size</span> <span class="number">1136</span>, <span class="number">0</span> <span class="keyword">row</span> <span class="keyword">lock</span>(s)</span><br><span class="line"><span class="comment">---TRANSACTION 160786, ACTIVE 16 sec starting index read</span></span><br><span class="line">mysql <span class="keyword">tables</span> <span class="keyword">in</span> <span class="keyword">use</span> <span class="number">1</span>, <span class="keyword">locked</span> <span class="number">1</span></span><br><span class="line"><span class="keyword">LOCK</span> <span class="keyword">WAIT</span> <span class="number">2</span> <span class="keyword">lock</span> <span class="keyword">struct</span>(s), <span class="keyword">heap</span> <span class="keyword">size</span> <span class="number">1136</span>, <span class="number">1</span> <span class="keyword">row</span> <span class="keyword">lock</span>(s)</span><br><span class="line">MySQL <span class="keyword">thread</span> <span class="keyword">id</span> <span class="number">2</span>, OS <span class="keyword">thread</span> handle <span class="number">123145348661248</span>, <span class="keyword">query</span> <span class="keyword">id</span> <span class="number">74</span> localhost root updating</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">1</span></span><br><span class="line"><span class="comment">------- TRX HAS BEEN WAITING 16 SEC FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="built_in">RECORD</span> LOCKS <span class="keyword">space</span> <span class="keyword">id</span> <span class="number">66</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">552</span> <span class="keyword">index</span> PRIMARY <span class="keyword">of</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`test01`</span> trx <span class="keyword">id</span> <span class="number">160786</span> lock_mode X locks rec but <span class="keyword">not</span> gap waiting</span><br><span class="line"><span class="built_in">Record</span> <span class="keyword">lock</span>, <span class="keyword">heap</span> <span class="keyword">no</span> <span class="number">2</span> <span class="keyword">PHYSICAL</span> <span class="built_in">RECORD</span>: n_fields <span class="number">6</span>; compact format; info bits 32</span><br><span class="line"> 0: len 4; hex 80000001; asc     ;;</span><br><span class="line"> 1: len 4; hex 80000001; asc     ;;</span><br><span class="line"> 2: len 6; hex 000000027411; asc     t ;;</span><br><span class="line"> 3: len 7; hex 310000013f2879; asc 1   ?(y;;</span><br><span class="line"> 4: len 1; hex 61; asc a;;</span><br><span class="line"> 5: len 1; hex 62; asc b;;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session4</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.innodb_lock_waits;</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line">| requesting_trx_id | requested_lock_id | blocking_trx_id | blocking_lock_id |</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line">| 160787            | 160787:66:4:2     | 160785          | 160785:66:4:2    |</span><br><span class="line">+<span class="comment">-------------------+-------------------+-----------------+------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.innodb_locks;</span><br><span class="line">+<span class="comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line">| lock_id       | lock_trx_id | lock_mode | lock_type | lock_table      | lock_index | lock_space | lock_page | lock_rec | lock_data |</span><br><span class="line">+<span class="comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span></span><br><span class="line">| 160787:66:4:2 | 160787      | X         | RECORD    | `test`.`test01` | PRIMARY    |         66 |         4 |        2 | 1, 1      |</span><br><span class="line">| 160785:66:4:2 | 160785      | X         | RECORD    | `test`.`test01` | PRIMARY    |         66 |         4 |        2 | 1, 1      |</span><br><span class="line">+<span class="comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session5</span></span><br><span class="line"><span class="keyword">SELECT</span> THREAD_ID,TIMER_START,TIMER_END,TIMER_WAIT,SQL_TEXT,MESSAGE_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history <span class="keyword">WHERE</span> thread_id = (     <span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">10</span> )\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">36</span></span><br><span class="line"> TIMER_START: <span class="number">2048071080000000</span></span><br><span class="line">   TIMER_END: <span class="number">2048071201000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">121000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">select</span> @@version_comment <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">MESSAGE_TEXT: <span class="literal">NULL</span></span><br><span class="line">*************************** <span class="number">2.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">36</span></span><br><span class="line"> TIMER_START: <span class="number">2049834364000000</span></span><br><span class="line">   TIMER_END: <span class="number">2049834417000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">53000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">begin</span></span><br><span class="line">MESSAGE_TEXT: <span class="literal">NULL</span></span><br><span class="line">*************************** <span class="number">3.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">36</span></span><br><span class="line"> TIMER_START: <span class="number">2055696930000000</span></span><br><span class="line">   TIMER_END: <span class="number">2055730415000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">33485000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">delete</span> <span class="keyword">from</span> test.test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">1</span></span><br><span class="line">MESSAGE_TEXT: <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> THREAD_ID,TIMER_START,TIMER_END,TIMER_WAIT,SQL_TEXT,MESSAGE_TEXT <span class="keyword">FROM</span> performance_schema.events_statements_history <span class="keyword">WHERE</span> thread_id = (     <span class="keyword">SELECT</span> THREAD_ID <span class="keyword">FROM</span> performance_schema.threads <span class="keyword">WHERE</span> PROCESSLIST_ID = <span class="number">12</span> )\G</span><br><span class="line">*************************** <span class="number">1.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">38</span></span><br><span class="line"> TIMER_START: <span class="number">2197004107000000</span></span><br><span class="line">   TIMER_END: <span class="number">2197008105000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">3998000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">select</span> @@version_comment <span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">MESSAGE_TEXT: <span class="literal">NULL</span></span><br><span class="line">*************************** <span class="number">2.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">38</span></span><br><span class="line"> TIMER_START: <span class="number">2198577580000000</span></span><br><span class="line">   TIMER_END: <span class="number">2198577653000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">73000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">begin</span></span><br><span class="line">MESSAGE_TEXT: <span class="literal">NULL</span></span><br><span class="line">*************************** <span class="number">3.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">   THREAD_ID: <span class="number">38</span></span><br><span class="line"> TIMER_START: <span class="number">2200660449000000</span></span><br><span class="line">   TIMER_END: <span class="number">2251869851000000</span></span><br><span class="line">  TIMER_WAIT: <span class="number">51209402000000</span></span><br><span class="line">    SQL_TEXT: <span class="keyword">delete</span> <span class="keyword">from</span> test.test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">1</span></span><br><span class="line">MESSAGE_TEXT: <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># session 6</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.innodb_trx\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                    trx_id: 169733</span><br><span class="line">                 trx_state: <span class="keyword">LOCK</span> <span class="keyword">WAIT</span></span><br><span class="line">               trx_started: <span class="number">2020</span><span class="number">-07</span><span class="number">-08</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">47</span></span><br><span class="line">     trx_requested_lock_id: <span class="number">169733</span>:<span class="number">66</span>:<span class="number">4</span>:<span class="number">3</span></span><br><span class="line">          trx_wait_started: <span class="number">2020</span><span class="number">-07</span><span class="number">-08</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">47</span></span><br><span class="line">                trx_weight: <span class="number">2</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">3</span></span><br><span class="line">                 trx_query: <span class="keyword">delete</span> <span class="keyword">from</span> test.test01 <span class="keyword">where</span> id1=<span class="number">1</span> <span class="keyword">and</span> id2=<span class="number">2</span></span><br><span class="line">       trx_operation_state: <span class="keyword">starting</span> <span class="keyword">index</span> <span class="keyword">read</span></span><br><span class="line">         trx_tables_in_use: <span class="number">1</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">2</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1136</span></span><br><span class="line">           trx_rows_locked: <span class="number">1</span></span><br><span class="line">         trx_rows_modified: <span class="number">0</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: <span class="keyword">READ</span> COMMITTED</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="literal">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br><span class="line">*************************** <span class="number">2.</span> <span class="keyword">row</span> ***************************</span><br><span class="line">                    trx_id: <span class="number">169732</span></span><br><span class="line">                 trx_state: RUNNING</span><br><span class="line">               trx_started: <span class="number">2020</span><span class="number">-07</span><span class="number">-08</span> <span class="number">23</span>:<span class="number">09</span>:<span class="number">32</span></span><br><span class="line">     trx_requested_lock_id: <span class="literal">NULL</span></span><br><span class="line">          trx_wait_started: <span class="literal">NULL</span></span><br><span class="line">                trx_weight: <span class="number">3</span></span><br><span class="line">       trx_mysql_thread_id: <span class="number">2</span></span><br><span class="line">                 trx_query: <span class="literal">NULL</span></span><br><span class="line">       trx_operation_state: <span class="literal">NULL</span></span><br><span class="line">         trx_tables_in_use: <span class="number">0</span></span><br><span class="line">         trx_tables_locked: <span class="number">1</span></span><br><span class="line">          trx_lock_structs: <span class="number">2</span></span><br><span class="line">     trx_lock_memory_bytes: <span class="number">1136</span></span><br><span class="line">           trx_rows_locked: <span class="number">1</span></span><br><span class="line">         trx_rows_modified: <span class="number">1</span></span><br><span class="line">   trx_concurrency_tickets: <span class="number">0</span></span><br><span class="line">       trx_isolation_level: <span class="keyword">READ</span> COMMITTED</span><br><span class="line">         trx_unique_checks: <span class="number">1</span></span><br><span class="line">    trx_foreign_key_checks: <span class="number">1</span></span><br><span class="line">trx_last_foreign_key_error: <span class="literal">NULL</span></span><br><span class="line"> trx_adaptive_hash_latched: <span class="number">0</span></span><br><span class="line"> trx_adaptive_hash_timeout: <span class="number">0</span></span><br><span class="line">          trx_is_read_only: <span class="number">0</span></span><br><span class="line">trx_autocommit_non_locking: <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">test</span>\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: test</span><br><span class="line"><span class="keyword">Create</span> <span class="keyword">Table</span>: <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`date`</span> datetime <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">text</span>,</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`id`</span> (<span class="string">`id`</span>,<span class="string">`date`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`uk1`</span> (<span class="string">`date`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">42990946</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">id</span>), <span class="built_in">date</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">date</span>;</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line">| count(id) | date                |</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line">|   4194304 | 2020-04-01 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-02 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-03 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-04 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-05 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-06 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-07 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-08 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-09 00:00:00 |</span><br><span class="line">|   4194304 | 2020-04-10 00:00:00 |</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line">10 rows in <span class="keyword">set</span> (<span class="number">19.10</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">where</span> <span class="built_in">date</span> &lt; <span class="string">'20200402'</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows     | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | uk1           | NULL | NULL    | NULL | 41849498 |    19.87 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 约束</span></span><br><span class="line">ERROR 1503 (HY000): A PRIMARY KEY must include all columns in the table's partitioning function</span><br><span class="line"></span><br><span class="line">du -sh test.ibd</span><br><span class="line">2.1G   test.ibd</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">range</span> <span class="keyword">columns</span>(<span class="built_in">date</span>)(</span><br><span class="line">  <span class="keyword">partition</span> p20200331 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200401'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200401 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200402'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200402 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200403'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200403 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200404'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200404 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200405'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200405 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200406'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200406 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200407'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200407 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200408'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200408 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200409'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200409 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200410'</span>),</span><br><span class="line">  <span class="keyword">partition</span> p20200410 <span class="keyword">values</span> <span class="keyword">less</span> <span class="keyword">than</span> (<span class="string">'20200411'</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">du -sh test*.ibd</span><br><span class="line">112K	test<span class="comment">#P#p20200331.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200401.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200402.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200403.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200404.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200405.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200406.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200407.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200408.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200409.ibd</span></span><br><span class="line">225M	test<span class="comment">#P#p20200410.ibd</span></span><br><span class="line"> 44M	test01.ibd</span><br><span class="line"> 44M	test02.ibd</span><br><span class="line"> 44M	test03.ibd</span><br><span class="line"> 44M	test04.ibd</span><br><span class="line"> 44M	test05.ibd</span><br><span class="line"> 44M	test06.ibd</span><br><span class="line"> 44M	test07.ibd</span><br><span class="line"> 44M	test08.ibd</span><br><span class="line"> 44M	test09.ibd</span><br><span class="line"> 44M	test10.ibd</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">test</span>(<span class="built_in">date</span>,<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'20200430'</span>, <span class="string">'bbbbb'</span>);</span><br><span class="line">ERROR 1526 (HY000): Table has no partition for value from column_list</span><br></pre></td></tr></table></figure>

<h3 id="partition快速删除分区数据"><a href="#partition快速删除分区数据" class="headerlink" title="partition快速删除分区数据"></a>partition快速删除分区数据</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">id</span>), <span class="built_in">date</span> <span class="keyword">from</span> <span class="keyword">test</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="built_in">date</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="built_in">date</span>;</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line">| count(id) | date                |</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line">|   1048576 | 2020-03-31 00:00:00 |</span><br><span class="line">|   1048576 | 2020-04-01 00:00:00 |</span><br><span class="line">|   1048576 | 2020-04-02 00:00:00 |</span><br><span class="line">|   1048576 | 2020-04-03 00:00:00 |</span><br><span class="line">|   1048576 | 2020-04-04 00:00:00 |</span><br><span class="line">+<span class="comment">-----------+---------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 阻塞DML，备份partition ibd物理文件</span></span><br><span class="line"><span class="keyword">flush</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">for</span> <span class="keyword">export</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- discard</span></span><br><span class="line"><span class="keyword">unlock</span> <span class="keyword">tables</span>;<span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> discard <span class="keyword">tablespace</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 拷贝回保留partition ibd文件，删除需要清理partition</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">drop</span> <span class="keyword">partition</span> p20200331,p20200401;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- import</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">test</span> <span class="keyword">import</span> <span class="keyword">tablespace</span>;</span><br></pre></td></tr></table></figure>

<h3 id="MRR"><a href="#MRR" class="headerlink" title="MRR"></a>MRR</h3><blockquote>
<p>默认mrr_cost为on且代价非常高，直接关闭。<code>set @@optimizer_switch=&#39;mrr=on,mrr_cost_based=off&#39;</code></p>
</blockquote>
<p>2级索引查询对主键排序后回表，磁盘接近顺序IO</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> test01 <span class="keyword">where</span> id2 &gt; <span class="number">10</span> <span class="keyword">and</span> id2 &lt; <span class="number">20</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                            |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | range | idx1          | idx1 | 4       | NULL | 17592 |   100.00 | Using index condition; Using MRR |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="自增变量未持久化"><a href="#自增变量未持久化" class="headerlink" title="自增变量未持久化"></a>自增变量未持久化</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_auto;</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">| id |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test_auto <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_auto <span class="keyword">values</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_auto;</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">| id |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  4 |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> test_auto <span class="keyword">where</span> <span class="keyword">id</span>=<span class="number">4</span>;</span><br><span class="line"><span class="comment">-- restart mysql server</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_auto <span class="keyword">values</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test_auto;</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">| id |</span><br><span class="line">+<span class="comment">----+</span></span><br><span class="line">|  1 |</span><br><span class="line">|  2 |</span><br><span class="line">|  3 |</span><br><span class="line">+<span class="comment">----+</span></span><br></pre></td></tr></table></figure>

<h3 id="DDL非原子"><a href="#DDL非原子" class="headerlink" title="DDL非原子"></a>DDL非原子</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'test1%'</span>;</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| Tables_in_test (test1%) |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| test10                  |</span><br><span class="line">| test11                  |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> test11,test12;</span><br><span class="line">ERROR 1051 (42S02): Unknown table 'test.test12'</span><br><span class="line"></span><br><span class="line"><span class="keyword">show</span> <span class="keyword">tables</span> <span class="keyword">like</span> <span class="string">'test1%'</span>;</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| Tables_in_test (test1%) |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br><span class="line">| test10                  |</span><br><span class="line">+<span class="comment">-------------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="创建降序索引仍为升序"><a href="#创建降序索引仍为升序" class="headerlink" title="创建降序索引仍为升序"></a>创建降序索引仍为升序</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1(c1 <span class="built_in">int</span>,c2 <span class="built_in">int</span>,<span class="keyword">index</span> idx_c1_c2(c1,c2 <span class="keyword">desc</span>));</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> t1;</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------+</span></span><br><span class="line">| Table | <span class="keyword">Create</span> <span class="keyword">Table</span>                                                                         |</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------+</span></span><br><span class="line">| t1    | <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t1`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 |</span><br><span class="line">+<span class="comment">-------+--------------------------------------------------------------------------------------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="keyword">rand</span>()*<span class="number">100000</span>, <span class="keyword">rand</span>()*<span class="number">100000</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="keyword">rand</span>()*<span class="number">100000</span>, <span class="keyword">rand</span>()*<span class="number">100000</span> <span class="keyword">from</span> t1;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> *<span class="keyword">from</span> t1 <span class="keyword">order</span> <span class="keyword">by</span> c1 , c2 <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">5</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows   | filtered | Extra                       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | t1    | NULL       | index | NULL          | idx1 | 10      | NULL | 327519 |   100.00 | Using index; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span></span><br></pre></td></tr></table></figure>

<h3 id="innodb-rollback-on-timeout"><a href="#innodb-rollback-on-timeout" class="headerlink" title="innodb_rollback_on_timeout"></a>innodb_rollback_on_timeout</h3><blockquote>
<p>需重启生效，影响事务原子性，建议设为<code>ON</code></p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--my.cnf</span></span><br><span class="line"><span class="comment">--innodb_rollback_on_timeout = OFF</span></span><br><span class="line"><span class="comment">--innodb_lock_wait_timeout = 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session1</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| c1   | c2   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    1 |    2 |</span><br><span class="line">|    2 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">1</span> <span class="keyword">and</span> c2=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session2</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">2</span> <span class="keyword">and</span> c2=<span class="number">2</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">1</span> <span class="keyword">and</span> c2=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">4</span> <span class="keyword">where</span> c1=<span class="number">2</span> <span class="keyword">and</span> c2=<span class="number">2</span>;</span><br><span class="line">ERROR 1205 (HY000): <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| c1   | c2   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 |    2 |</span><br><span class="line">|    2 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    1 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--my.cnf</span></span><br><span class="line"><span class="comment">--innodb_rollback_on_timeout = ON</span></span><br><span class="line"><span class="comment">--innodb_lock_wait_timeout = 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- session1</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| c1   | c2   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    1 |    2 |</span><br><span class="line">|    2 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">1</span> <span class="keyword">and</span> c2=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session2</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">2</span> <span class="keyword">and</span> c2=<span class="number">2</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">-- session 1</span></span><br><span class="line"><span class="keyword">begin</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">3</span> <span class="keyword">where</span> c1=<span class="number">1</span> <span class="keyword">and</span> c2=<span class="number">1</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> c1=<span class="number">4</span> <span class="keyword">where</span> c1=<span class="number">2</span> <span class="keyword">and</span> c2=<span class="number">2</span>;</span><br><span class="line">ERROR 1205 (HY000): <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction</span><br><span class="line"><span class="keyword">commit</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> t1;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| c1   | c2   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    1 |    2 |</span><br><span class="line">|    2 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">4 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h3 id="delete备库回放"><a href="#delete备库回放" class="headerlink" title="delete备库回放"></a>delete备库回放</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table test_no_primary;</span><br><span class="line">+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table           | Create Table                                                                                                                                          |</span><br><span class="line">+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test_no_primary | CREATE TABLE &#96;test_no_primary&#96; (</span><br><span class="line">  &#96;c1&#96; int(11) DEFAULT NULL,</span><br><span class="line">  &#96;c2&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  KEY &#96;i1&#96; (&#96;c1&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB DEFAULT CHARSET&#x3D;utf8 |</span><br><span class="line">+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test_no_primary;</span><br><span class="line">+------+------+</span><br><span class="line">| c1   | c2   |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | a    |</span><br><span class="line">|    1 | b    |</span><br><span class="line">|    1 | c    |</span><br><span class="line">+------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test_no_primary where c1&#x3D;1;</span><br><span class="line">Query OK, 3 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 主库-&gt;备库日志</span><br><span class="line">#201023 21:44:30 server id 2454784635  end_log_pos 5657 CRC32 0x7b63ea86  Delete_rows: table id 282 flags: STMT_END_F</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_no_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;&#39;a&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_no_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;&#39;b&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_no_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;&#39;c&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line"># at 5657</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; show create table test_with_primary;</span><br><span class="line">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table             | Create Table                                                                                                                                                                                                                            |</span><br><span class="line">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| test_with_primary | CREATE TABLE &#96;test_with_primary&#96; (</span><br><span class="line">  &#96;c0&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;c1&#96; int(11) DEFAULT NULL,</span><br><span class="line">  &#96;c2&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;c0&#96;),</span><br><span class="line">  KEY &#96;i1&#96; (&#96;c1&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;31 DEFAULT CHARSET&#x3D;utf8 |</span><br><span class="line">+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test_with_primary;</span><br><span class="line">+----+------+------+</span><br><span class="line">| c0 | c1   | c2   |</span><br><span class="line">+----+------+------+</span><br><span class="line">|  1 |    1 | a    |</span><br><span class="line">| 11 |    1 | b    |</span><br><span class="line">| 21 |    1 | c    |</span><br><span class="line">+----+------+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; delete from test_with_primary where c1&#x3D;1;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 主库-&gt;备库日志</span><br><span class="line">#201023 21:53:59 server id 2454784635  end_log_pos 7005 CRC32 0xc0c83f05  Delete_rows: table id 284 flags: STMT_END_F</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_with_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;0 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @3&#x3D;&#39;a&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_with_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;11 &#x2F;* INT meta&#x3D;0 nullable&#x3D;0 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @3&#x3D;&#39;b&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">### DELETE FROM &#96;test&#96;.&#96;test_with_primary&#96;</span><br><span class="line">### WHERE</span><br><span class="line">###   @1&#x3D;21 &#x2F;* INT meta&#x3D;0 nullable&#x3D;0 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @2&#x3D;1 &#x2F;* INT meta&#x3D;0 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line">###   @3&#x3D;&#39;c&#39; &#x2F;* VARSTRING(60) meta&#x3D;60 nullable&#x3D;1 is_null&#x3D;0 *&#x2F;</span><br><span class="line"># at 7005</span><br></pre></td></tr></table></figure>

<h3 id="uuid-gt-auto-increment"><a href="#uuid-gt-auto-increment" class="headerlink" title="uuid -&gt; auto_increment"></a>uuid -&gt; auto_increment</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test;</span><br><span class="line">+--------------------------------------+------+</span><br><span class="line">| c1                                   | c2   |</span><br><span class="line">+--------------------------------------+------+</span><br><span class="line">| 17f6ea4e-1ea8-11eb-95f7-b54d65122ba1 | aaa  |</span><br><span class="line">| 1ab073fe-1ea8-11eb-95f7-b54d65122ba1 | bbb  |</span><br><span class="line">| 1c2a32d8-1ea8-11eb-95f7-b54d65122ba1 | ccc  |</span><br><span class="line">+--------------------------------------+------+</span><br><span class="line"></span><br><span class="line">mysql&gt; desc test;</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type        | Null | Key | Default | Extra |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line">| c1    | varchar(36) | NO   | PRI | NULL    |       |</span><br><span class="line">| c2    | varchar(20) | YES  |     | NULL    |       |</span><br><span class="line">+-------+-------------+------+-----+---------+-------+</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table test drop primary key;</span><br><span class="line">mysql&gt; alter table test add column c3 int auto_increment primary key;</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test;</span><br><span class="line">+--------------------------------------+------+----+</span><br><span class="line">| c1                                   | c2   | c3 |</span><br><span class="line">+--------------------------------------+------+----+</span><br><span class="line">| 17f6ea4e-1ea8-11eb-95f7-b54d65122ba1 | aaa  |  1 |</span><br><span class="line">| 1ab073fe-1ea8-11eb-95f7-b54d65122ba1 | bbb  |  2 |</span><br><span class="line">| 1c2a32d8-1ea8-11eb-95f7-b54d65122ba1 | ccc  |  3 |</span><br><span class="line">+--------------------------------------+------+----+</span><br></pre></td></tr></table></figure>

<h3 id="字符串索引数字查询"><a href="#字符串索引数字查询" class="headerlink" title="字符串索引数字查询"></a>字符串索引数字查询</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table test\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: test</span><br><span class="line">Create Table: CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;c1&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;c2&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  &#96;c3&#96; char(36) DEFAULT NULL,</span><br><span class="line">  &#96;c4&#96; char(36) DEFAULT NULL,</span><br><span class="line">  &#96;c5&#96; char(36) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;c1&#96;),</span><br><span class="line">  KEY &#96;i1&#96; (&#96;c2&#96;),</span><br><span class="line">  KEY &#96;i2&#96; (&#96;c2&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;1376221 DEFAULT CHARSET&#x3D;utf8</span><br><span class="line">1 row in set (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from test where c2&#x3D;&#39;1&#39;;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ref  | i1,i2         | i1   | 63      | const |    1 |   100.00 | NULL  |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+</span><br><span class="line"></span><br><span class="line">mysql&gt; explain select * from test where c2&#x3D;1;</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | test  | NULL       | ALL  | i1,i2         | NULL | NULL    | NULL | 1044395 |    10.00 | Using where |</span><br><span class="line">+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+</span><br></pre></td></tr></table></figure>

<p>官方解释：<br>For comparisons of a string column with a number, MySQL cannot use an index on the column to look up the value quickly. If str_col is an indexed string column, the index cannot be used when performing the lookup in the following statement</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM tbl_name WHERE str_col&#x3D;1;</span><br></pre></td></tr></table></figure>

<p>The reason for this is that there are many different strings that may convert to the value 1, such as ‘1’, ‘ 1’, or ‘1a’.</p>
<h3 id="show-status-like-‘handler-read-’"><a href="#show-status-like-‘handler-read-’" class="headerlink" title="show status like ‘handler%read%’"></a>show status like ‘handler%read%’</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show create table test.test\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: test</span><br><span class="line">Create Table: CREATE TABLE &#96;test&#96; (</span><br><span class="line">  &#96;c1&#96; int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">  &#96;c2&#96; varchar(20) DEFAULT NULL,</span><br><span class="line">  &#96;c3&#96; char(36) DEFAULT NULL,</span><br><span class="line">  &#96;c4&#96; char(36) DEFAULT NULL,</span><br><span class="line">  &#96;c5&#96; char(36) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (&#96;c1&#96;),</span><br><span class="line">  KEY &#96;i1&#96; (&#96;c2&#96;),</span><br><span class="line">  KEY &#96;i2&#96; (&#96;c2&#96;)</span><br><span class="line">) ENGINE&#x3D;InnoDB AUTO_INCREMENT&#x3D;1310694 DEFAULT CHARSET&#x3D;utf8</span><br><span class="line"></span><br><span class="line">show status like &#39;handler%read%&#39;;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Handler_read_first    | 0     |</span><br><span class="line">| Handler_read_key      | 0     |</span><br><span class="line">| Handler_read_last     | 0     |</span><br><span class="line">| Handler_read_next     | 0     |</span><br><span class="line">| Handler_read_prev     | 0     |</span><br><span class="line">| Handler_read_rnd      | 0     |</span><br><span class="line">| Handler_read_rnd_next | 0     |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line"></span><br><span class="line">select * from test.test where c2&#x3D;&#39;1&#39;;</span><br><span class="line">+----+------+------+------+------+</span><br><span class="line">| c1 | c2   | c3   | c4   | c5   |</span><br><span class="line">+----+------+------+------+------+</span><br><span class="line">|  1 | 1    | NULL | NULL | NULL |</span><br><span class="line">+----+------+------+------+------+</span><br><span class="line"></span><br><span class="line">show status like &#39;handler%read%&#39;;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Handler_read_first    | 0     |</span><br><span class="line">| Handler_read_key      | 1     |</span><br><span class="line">| Handler_read_last     | 0     |</span><br><span class="line">| Handler_read_next     | 1     |</span><br><span class="line">| Handler_read_prev     | 0     |</span><br><span class="line">| Handler_read_rnd      | 0     |</span><br><span class="line">| Handler_read_rnd_next | 0     |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line"></span><br><span class="line">select * from test.test where c3&#x3D;&#39;1&#39;;</span><br><span class="line">Empty set (0.40 sec)</span><br><span class="line"></span><br><span class="line">show status like &#39;handler%read%&#39;;</span><br><span class="line">+-----------------------+---------+</span><br><span class="line">| Variable_name         | Value   |</span><br><span class="line">+-----------------------+---------+</span><br><span class="line">| Handler_read_first    | 1       |</span><br><span class="line">| Handler_read_key      | 2       |</span><br><span class="line">| Handler_read_last     | 0       |</span><br><span class="line">| Handler_read_next     | 1       |</span><br><span class="line">| Handler_read_prev     | 0       |</span><br><span class="line">| Handler_read_rnd      | 0       |</span><br><span class="line">| Handler_read_rnd_next | 1048577 |</span><br><span class="line">+-----------------------+---------+</span><br></pre></td></tr></table></figure>

<h3 id="ibtmp1-临时表空间"><a href="#ibtmp1-临时表空间" class="headerlink" title="ibtmp1 临时表空间"></a>ibtmp1 临时表空间</h3><p>explain为Using temporary的使用ibtmp1，无法自动释放</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT @@innodb_temp_data_file_path;</span><br><span class="line">+------------------------------+</span><br><span class="line">| @@innodb_temp_data_file_path |</span><br><span class="line">+------------------------------+</span><br><span class="line">| ibtmp1:12M:autoextend        |</span><br><span class="line">+------------------------------+</span><br><span class="line"></span><br><span class="line">mysql&gt; explain insert into test_tmp(c2) select c2 from test_tmp;</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span><br><span class="line">| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra           |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span><br><span class="line">|  1 | INSERT      | test_tmp | NULL       | ALL  | NULL          | NULL | NULL    | NULL | NULL |     NULL | NULL            |</span><br><span class="line">|  1 | SIMPLE      | test_tmp | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    2 |   100.00 | Using temporary |</span><br><span class="line">+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+</span><br><span class="line"></span><br><span class="line">$ du -sh &#x2F;usr&#x2F;local&#x2F;var&#x2F;mysql&#x2F;test&#x2F;test_tmp.ibd </span><br><span class="line">513M	&#x2F;usr&#x2F;local&#x2F;var&#x2F;mysql&#x2F;test&#x2F;test_tmp.ibd</span><br><span class="line">$ du -sh &#x2F;usr&#x2F;local&#x2F;var&#x2F;mysql&#x2F;ibtmp1 </span><br><span class="line">273M	&#x2F;usr&#x2F;local&#x2F;var&#x2F;mysql&#x2F;ibtmp1</span><br></pre></td></tr></table></figure>

<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h3 id=""><a href="#" class="headerlink" title=""></a><a href="https://redis.io/topics/notifications" title="" target="">Notifications</a></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config set notify-keyspace-events KEA</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; psubscribe '*'</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) "psubscribe"</span><br><span class="line">2) "*"</span><br><span class="line">3) (integer) 1</span><br><span class="line"></span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "*"</span><br><span class="line">3) "__keyspace@0__:foo"</span><br><span class="line">4) "set"</span><br><span class="line">1) "pmessage"</span><br><span class="line">2) "*"</span><br><span class="line">3) "__keyevent@0__:set"</span><br><span class="line">4) "foo"</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set foo 1</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/go/goim/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/go/goim/" class="post-title-link" itemprop="url">goim源码</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 20:03:46" itemprop="dateCreated datePublished" datetime="2020-04-29T20:03:46+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>mid: member id<br>key: 绑定mid的会话key, auth时若token里没有, 在logic层使用uuid生成<br>accepts: mid的channel watch accepts, 在ch.NeedPush中check</p>
<h2 id="bufio"><a href="#bufio" class="headerlink" title="bufio"></a>bufio</h2><p>缓冲Reader/Writer, pop()复用peek()前移游标出栈, 读/写包头</p>
<h2 id="comet"><a href="#comet" class="headerlink" title="comet"></a>comet</h2><h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h3><p>p.ReadTCP(rr): 从rr pop一个proto<br>p.WriteTCP(wr): 如果是raw包, 直接用p.Body写wr; 否则写头+p.Body</p>
<h3 id="authTCP"><a href="#authTCP" class="headerlink" title="authTCP()"></a>authTCP()</h3><p>ch.CliProto.<font color=cyan>Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取auth proto<br>调用logic rpc connect进行auth, p.Body为token<br>调用p.WriteTCP(wr), 写authReply</p>
<h2 id="Operate"><a href="#Operate" class="headerlink" title="Operate()"></a>Operate()</h2><ul>
<li>OpChangeRoom: p.Body为rid, 将ch换到room</li>
<li>OpSub: ch.Watch, p.Body为ops</li>
<li>OpUnsub: ch.UnWatch, p.Body为ops</li>
<li>其他: logic rpc Receive, logic侧无处理</li>
</ul>
<h2 id="dispatchTCP"><a href="#dispatchTCP" class="headerlink" title="dispatchTCP()"></a>dispatchTCP()</h2><h3 id="ch-CliProto-Get-读取一个proto"><a href="#ch-CliProto-Get-读取一个proto" class="headerlink" title="ch.CliProto.Get()读取一个proto"></a>ch.CliProto.<font color=red>Get()</font>读取一个proto</h3><ul>
<li>OpHeartbeatReply: 调用p.WriteTCPHeart()写当前ch.room的online数</li>
<li>其他: 调用p.WriteTCP(wr), 写对应reply</li>
</ul>
<h2 id="TCP逻辑"><a href="#TCP逻辑" class="headerlink" title="TCP逻辑"></a>TCP逻辑</h2><p>绑定一个channel的Reader/Writer到conn</p>
<ol>
<li>handshake, 若timout则close conn</li>
<li>调用authTCP()认证, 返回accepts, key, rid, hb<br>2.1 根据accepts得到ch.Watch<br>2.2 根据key得到这个conn对应的Bucket, 使用CityHash32计算, 共32个桶<br>2.3 根据rid将ch放到对应的room里</li>
<li>重置心跳超时</li>
<li>开启go dispatchTCP(), ch.CliProto.<font color=cyan>Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取proto<br>4.1 <em>OpHeartbeat</em>: 调用logic rpc Heartbeat<br>4.2 <em>其他</em>: 调用s.Operate()</li>
<li>处理完proto后触发dispatchTCP()写对应reply</li>
</ol>
<h2 id="RenewOnline逻辑"><a href="#RenewOnline逻辑" class="headerlink" title="RenewOnline逻辑"></a>RenewOnline逻辑</h2><p>comet侧go onlineproc统计所有bucket的所有room的online<br>调用rpc RenewOnline<br>logic侧根据roomId计算hashKey, redis存储格式server -&gt; hashKey:online, hashKey使用CityHash32放64个桶</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Online <span class="keyword">struct</span> &#123;</span><br><span class="line">    Server    <span class="keyword">string</span>           <span class="string">`json:"server"`</span></span><br><span class="line">    RoomCount <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int32</span> <span class="string">`json:"room_count"`</span></span><br><span class="line">    <span class="comment">// logic侧5分钟未更新则DEL server</span></span><br><span class="line">    Updated   <span class="keyword">int64</span>            <span class="string">`json:"updated"`</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Round"><a href="#Round" class="headerlink" title="Round"></a>Round</h2><p>reader/writer/timer资源池, 轮询获取降低高并发资源争用</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Round <span class="keyword">struct</span> &#123;</span><br><span class="line">    readers []bytes.Pool</span><br><span class="line">    writers []bytes.Pool</span><br><span class="line">    timers  []time.Timer</span><br><span class="line">    options RoundOptions</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h2><p>链表栈, 顶出顶入, 若无buf可用, 调用grow, 若入速度小于出速度会有内存溢出</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Buffer <span class="keyword">struct</span> &#123;</span><br><span class="line">    buf  []<span class="keyword">byte</span></span><br><span class="line">    next *Buffer <span class="comment">// next free buffer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Pool <span class="keyword">struct</span> &#123;</span><br><span class="line">    lock sync.Mutex</span><br><span class="line">    free *Buffer</span><br><span class="line">    max  <span class="keyword">int</span></span><br><span class="line">    num  <span class="keyword">int</span></span><br><span class="line">    size <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="ring"><a href="#ring" class="headerlink" title="ring"></a>ring</h2><p>Proto的缓冲池，data数组大小[0:num-1], 游标wp比游标rp快会导致rp脏读</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Ring <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// read</span></span><br><span class="line">    rp   <span class="keyword">uint64</span>   <span class="comment">// rp&amp;mask寻址data</span></span><br><span class="line">    num  <span class="keyword">uint64</span>   <span class="comment">// 2^N</span></span><br><span class="line">    mask <span class="keyword">uint64</span>   <span class="comment">// num-1</span></span><br><span class="line">    <span class="comment">// write</span></span><br><span class="line">    wp   <span class="keyword">uint64</span>   <span class="comment">// wp&amp;mask寻址data</span></span><br><span class="line">    data []grpc.Proto</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><p>memberId绑定的channel, 保存Proto的缓冲池Ring<br>通过Signal()通知有一个proto待处理; 通过开一个goroutin的Ready()通知处理一个proto写wr<br>若proto写wr太慢, rp游标移动比wp慢, 可能导致rp脏读<br>广播/房播/单播 的proto直接写wr</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Channel <span class="keyword">struct</span> &#123;</span><br><span class="line">    Room     *Room</span><br><span class="line">    CliProto Ring</span><br><span class="line">    signal   <span class="keyword">chan</span> *grpc.Proto</span><br><span class="line">    Writer   bufio.Writer</span><br><span class="line">    Reader   bufio.Reader</span><br><span class="line">    Next     *Channel</span><br><span class="line">    Prev     *Channel</span><br><span class="line"></span><br><span class="line">    Mid      <span class="keyword">int64</span></span><br><span class="line">    Key      <span class="keyword">string</span></span><br><span class="line">    IP       <span class="keyword">string</span></span><br><span class="line">    watchOps <span class="keyword">map</span>[<span class="keyword">int32</span>]<span class="keyword">struct</span>&#123;&#125;   <span class="comment">// Watch(ops)添加ops; UnWatch(ops)删除ops; NeedPush(op)检查op in watch</span></span><br><span class="line">    mutex    sync.RWMutex   <span class="comment">// lock for watchOps</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="room"><a href="#room" class="headerlink" title="room"></a>room</h2><p>保存channel链表</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Room <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID        <span class="keyword">string</span></span><br><span class="line">    rLock     sync.RWMutex</span><br><span class="line">    next      *Channel</span><br><span class="line">    drop      <span class="keyword">bool</span>   <span class="comment">// true if Online-- == 0</span></span><br><span class="line">    Online    <span class="keyword">int32</span></span><br><span class="line">    AllOnline <span class="keyword">int32</span>   <span class="comment">// dirty read because Bucket.UpRoomsCount with RLock</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h2><p>存放room和channel, channel可以change/put room, 自动创建new room<br>所有channel广播 或 指定room房播<br>routines处理job kafka rpc</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Bucket <span class="keyword">struct</span> &#123;</span><br><span class="line">    c     *conf.Bucket</span><br><span class="line">    cLock sync.RWMutex          <span class="comment">// lock for chs/rooms</span></span><br><span class="line">    chs   <span class="keyword">map</span>[<span class="keyword">string</span>]*Channel   <span class="comment">// 1024</span></span><br><span class="line">    <span class="comment">// room</span></span><br><span class="line">    rooms       <span class="keyword">map</span>[<span class="keyword">string</span>]*Room   <span class="comment">// 1024</span></span><br><span class="line">    routines    []<span class="keyword">chan</span> *grpc.BroadcastRoomReq   <span class="comment">// 32 (go b.roomproc((chan *grpc.BroadcastRoomReq, 1024)))</span></span><br><span class="line">    routinesNum <span class="keyword">uint64</span>   <span class="comment">// routinesNum % 32</span></span><br><span class="line"></span><br><span class="line">    ipCnts <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">int32</span>   <span class="comment">// ip counter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/2020/04/30/go/goim/%E6%88%BF%E9%97%B4%E4%BF%A1%E6%81%AF%E6%8E%A8%E9%80%81%E6%B5%81%E7%A8%8B.png" class="">

<h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>根据SubKey获取Bucket</p>
<p>Operate:</p>
<ul>
<li>bucket.ChangeRoom</li>
<li>channel.Watch</li>
<li>channel.UnWatch</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span> &#123;</span><br><span class="line">    c         *conf.Config</span><br><span class="line">    round     *Round      <span class="comment">// accept round store</span></span><br><span class="line">    buckets   []*Bucket   <span class="comment">// 32</span></span><br><span class="line">    bucketIdx <span class="keyword">uint32</span>      <span class="comment">// 32</span></span><br><span class="line"></span><br><span class="line">    serverID  <span class="keyword">string</span></span><br><span class="line">    rpcClient logic.LogicClient</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="job"><a href="#job" class="headerlink" title="job"></a>job</h2><p>job从kafka consume, 通过rpc调用comet</p>
<p>根据pushMsg.Type分:</p>
<ul>
<li>单播</li>
<li>房播</li>
<li>广播</li>
</ul>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// clinet</span></span><br><span class="line"><span class="keyword">var</span> XXXRoutineSize <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> XXXChanSize <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> XXXChan = <span class="built_in">make</span>([]<span class="keyword">chan</span> *server.XXXReq, XXXRoutineSize)</span><br><span class="line"><span class="keyword">var</span> XXXChanCursor <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; XXXRoutineSize; i++ &#123;</span><br><span class="line">    XXXChan[i] = <span class="built_in">make</span>(<span class="keyword">chan</span> *server.XXXReq, XXXChanSize)</span><br><span class="line">    <span class="keyword">go</span> process(XXXChan[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *client)</span> <span class="title">process</span><span class="params">(XXXChan <span class="keyword">chan</span> *server.XXXReq)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> XXXArg := &lt;- XXXChan:</span><br><span class="line">            reply, err := c.serverClient.XXX(context.Background(), &amp;server.XXXReq&#123;</span><br><span class="line">                key: XXXArg.value,</span><br><span class="line">            &#125;)</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *client)</span> <span class="title">XXXFunc</span><span class="params">(arg *server.XXXReq)</span></span> &#123;</span><br><span class="line">    idx := atomic.AddUint64(&amp;XXXChanCursor, <span class="number">1</span>) % XXXRoutineSize</span><br><span class="line">    XXXChan[idx] &lt;- arg</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// server</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span> <span class="title">XXX</span><span class="params">(ctx context.Context, req *server.XXXReq)</span> <span class="params">(reply *server.XXXReply, err error)</span></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="job-room-kafka房播msg流程"><a href="#job-room-kafka房播msg流程" class="headerlink" title="job.room kafka房播msg流程"></a>job.room kafka房播msg流程</h2><ol>
<li>根据msg.roomId调用getRoom(), 若没有则NewRoom() -&gt; go pushproc()监听, 然后Push()</li>
<li>pushproc:  SigTime=1S, Batch=20, Idle=15M<br>2.1 循环消费kafka msg, 直到超过1S未收到新msg，或&gt;=20次写<br>2.2 调用rpc房播, 等待最大15M若未收到新msg则退出循环</li>
</ol>
<h2 id="logic"><a href="#logic" class="headerlink" title="logic"></a>logic</h2><p>redis存储格式</p>
<ul>
<li>mid -&gt; key:server</li>
<li>key -&gt; server</li>
<li>server -&gt; hashKey:online<br><code>hashKey使用roomId通过cityHash32算出,共64个桶</code><br><code>将1024个room装进64个桶里</code></li>
</ul>
<h2 id="business-http-push参照doc"><a href="#business-http-push参照doc" class="headerlink" title="business http push参照doc"></a>business http push参照doc</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_db/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_db/" class="post-title-link" itemprop="url">zookeeper源码-6.数据库和日志</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 06:29:01" itemprop="dateCreated datePublished" datetime="2020-04-29T06:29:01+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="数据库格式"><a href="#数据库格式" class="headerlink" title="数据库格式"></a>数据库格式</h2><p>ZKDatabase负责记录节点的数据信息，事务日志以及Snapshot日志，以及watch的管理，相关类图如下:</p>
<img src="/2020/04/29/zk/zkSrc_db/database.png" class="">

<p>主要的类信息如下:</p>
<ul>
<li>ZKDatabase 数据库类的封装</li>
<li>FileTxnSnapLog 日志类封装，包括事务日志和Snapshot日志的管理</li>
<li>SnapShot为Shapshot日志接口，FileSnap为具体实现类。</li>
<li>TxnLog为事务日志接口，FileTxnLog为具体实现类。</li>
<li>DataTree为节点数据管理类，负责保存节点的数据以及管理数据的Watcher。</li>
<li>DataNode保存节点的数据信息，状态信息以及子节点信息。</li>
</ul>
<h2 id="节点数据"><a href="#节点数据" class="headerlink" title="节点数据"></a>节点数据</h2><p>ZooKeeper的节点类似Linux文件目录，根目录为/,每个目录有唯一的路径，同时，在节点上可以绑定用户指定的数据。</p>
<h3 id="节点数据定义"><a href="#节点数据定义" class="headerlink" title="节点数据定义"></a>节点数据定义</h3><p>节点的目录信息存储于DataTree.nodes信息中，为树形结构。<br>节点的状态信息存储于类StatPersisted，具体字段的含义如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> czxid; 节点创建时的zxid</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mzxid; 最后一次修改节点数据的zxid</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> ctime; 创建节点的时间</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mtime; 最后一次修改节点数据的时间</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> version; 节点的版本号，创建时为<span class="number">0</span>，修改时+<span class="number">1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cversion; 孩子节点版本信息，每创建一个孩子节点+<span class="number">1</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> aversion; ACL版本信息</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> ephemeralOwner; 节点的类型信息</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> pzxid;  节点本身和孩子节点的最后一次修改zxid。</span><br></pre></td></tr></table></figure>

<h3 id="节点类型定义"><a href="#节点类型定义" class="headerlink" title="节点类型定义"></a>节点类型定义</h3><p>总共有四种类型的节点，具体定义为enum EphemeralType，每种类型的含义为:</p>
<ul>
<li>VOID 持久化的节点，用户连接关闭后节点会一直存在。</li>
<li>NORMAL 临时节点，用户连接断开后临时节点会被删除。临时节点信息存储在DataTree.ephemerals中。</li>
<li>CONTAINER 和VOID节点一样，但是当该节点的孩子被删除后，该节点会被删除。Container节点信息存储在DataTree.containers中。</li>
<li>TTL 和VOID节点一样，但是当该节点无孩子节点，并且当前时间距离上次修改时间超过ttl时间，该节点会被删除。TTL节点信息存储在DataTree.ttls中。</li>
</ul>
<hr>
<h2 id="特殊节点类型"><a href="#特殊节点类型" class="headerlink" title="特殊节点类型"></a>特殊节点类型</h2><blockquote>
<p>ZooKeeper的节点有两个特殊的目录:</p>
</blockquote>
<h3 id="zookeeper-quota"><a href="#zookeeper-quota" class="headerlink" title="/zookeeper/quota"></a>/zookeeper/quota</h3><p>配置某个节点的配额信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Rather than fight it, let root have an alias */</span></span><br><span class="line"><span class="comment">// "/"</span></span><br><span class="line">nodes.put(<span class="string">""</span>, root);</span><br><span class="line">nodes.putWithoutDigest(rootZookeeper, root);</span><br><span class="line"></span><br><span class="line"><span class="comment">/** add the proc node and quota node */</span></span><br><span class="line"><span class="comment">// "/zookeeper"</span></span><br><span class="line">root.addChild(procChildZookeeper);</span><br><span class="line">nodes.put(procZookeeper, procDataNode);</span><br><span class="line"></span><br><span class="line"><span class="comment">// "/zookeeper/quota"</span></span><br><span class="line">procDataNode.addChild(quotaChildZookeeper);</span><br><span class="line">nodes.put(quotaZookeeper, quotaDataNode);</span><br></pre></td></tr></table></figure>

<ul>
<li>如某个节点的路径为/xx/yy,则对应的配额信息路径为/zookeeper/quota/xx/yy，其中/zookeeper/quota/xx/yy/zookeeper_limits包含管理员设置的配额信息，/zookeeper/quota/xx/yy/zookeeper_stats包含节点当前已使用的信息。</li>
<li>配额信息包含两个参数，分别表示大小(bytes)和节点数量(counts)。</li>
<li>在创建节点时会更新配额的信息，并检查是否超过配额。</li>
<li>配额设置详见cli包下SetQuotaCommand.java。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// also check to update the quotas for this node</span></span><br><span class="line">String lastPrefix = getMaxPrefixWithQuota(path);</span><br><span class="line"><span class="keyword">long</span> bytes = data == <span class="keyword">null</span> ? <span class="number">0</span> : data.length;</span><br><span class="line"><span class="keyword">if</span> (lastPrefix != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// ok we have some match and need to update</span></span><br><span class="line">    updateCountBytes(lastPrefix, bytes, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * update the count/count of bytes of this stat datanode</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> lastPrefix</span></span><br><span class="line"><span class="comment"> *            the path of the node that is quotaed.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bytesDiff</span></span><br><span class="line"><span class="comment"> *            the diff to be added to number of bytes</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> countDiff</span></span><br><span class="line"><span class="comment"> *            the diff to be added to the count</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateCountBytes</span><span class="params">(String lastPrefix, <span class="keyword">long</span> bytesDiff, <span class="keyword">int</span> countDiff)</span> </span>&#123;</span><br></pre></td></tr></table></figure>

<h3 id="zookeeper-config"><a href="#zookeeper-config" class="headerlink" title="/zookeeper/config"></a>/zookeeper/config</h3><p>保存所有节点信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * create a /zookeeper/config node for maintaining the configuration (membership and quorum system) info for</span></span><br><span class="line"><span class="comment"> * zookeeper</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConfigNode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DataNode zookeeperZnode = nodes.get(procZookeeper);</span><br><span class="line">    <span class="keyword">if</span> (zookeeperZnode != <span class="keyword">null</span>) &#123; <span class="comment">// should always be the case</span></span><br><span class="line">        zookeeperZnode.addChild(configChildZookeeper);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">false</span> : <span class="string">"There's no /zookeeper znode - this should never happen."</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nodes.put(configZookeeper, <span class="keyword">new</span> DataNode(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], -<span class="number">1L</span>, <span class="keyword">new</span> StatPersisted()));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Reconfig node is access controlled by default (ZOOKEEPER-2014).</span></span><br><span class="line">        setACL(configZookeeper, ZooDefs.Ids.READ_ACL_UNSAFE, -<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (KeeperException.NoNodeException e) &#123;</span><br><span class="line">        <span class="keyword">assert</span> <span class="keyword">false</span> : <span class="string">"There's no "</span> + configZookeeper + <span class="string">" znode - this should never happen."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>PrepRequestProcessor::run处理request流程中，对<code>OpCode.reconfig</code>会更改config node信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> OpCode.reconfig:</span><br><span class="line">    ...</span><br><span class="line">    nodeRecord = getRecordForPath(ZooDefs.CONFIG_NODE); <span class="comment">// "/zookeeper/config"</span></span><br><span class="line">    zks.checkACL(request.cnxn, nodeRecord.acl, ZooDefs.Perms.WRITE, request.authInfo, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    SetDataTxn setDataTxn = <span class="keyword">new</span> SetDataTxn(ZooDefs.CONFIG_NODE, request.qv.toString().getBytes(), -<span class="number">1</span>);</span><br><span class="line">    ...</span><br><span class="line">    nodeRecord.data = setDataTxn.getData();  <span class="comment">// request.qv.toString().getBytes()</span></span><br><span class="line">    ...</span><br><span class="line">    addChangeRecord(nodeRecord);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>request.qv.toString() 记录QuorumMaj中集群所有成员信息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    StringBuilder sw = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (QuorumServer member : getAllMembers().values()) &#123;</span><br><span class="line">        String key = <span class="string">"server."</span> + member.id;</span><br><span class="line">        String value = member.toString();</span><br><span class="line">        sw.append(key);</span><br><span class="line">        sw.append(<span class="string">'='</span>);</span><br><span class="line">        sw.append(value);</span><br><span class="line">        sw.append(<span class="string">'\n'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    String hexVersion = Long.toHexString(version);</span><br><span class="line">    sw.append(<span class="string">"version="</span>);</span><br><span class="line">    sw.append(hexVersion);</span><br><span class="line">    <span class="keyword">return</span> sw.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="Watcher管理"><a href="#Watcher管理" class="headerlink" title="Watcher管理"></a>Watcher管理</h2><p>有两种类型的Watcher</p>
<ul>
<li>childWatches 新增或者删除孩子节点时触发，可以在getChildren时注册。</li>
<li>dataWatches 在创建，删除，修改时触发。</li>
</ul>
<hr>
<h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><h3 id="TxnLog"><a href="#TxnLog" class="headerlink" title="TxnLog"></a>TxnLog</h3><p>事务日志的文件格式如下所示:</p>
<table>
<thead>
<tr>
<th>文件头(16Byte)</th>
<th>事务列表</th>
<th>0补齐</th>
</tr>
</thead>
</table>
<p>文件头的格式为class FileHeader:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> magic;   <span class="comment">//字符串"ZKLG"</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> version; <span class="comment">//默认为2</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> dbid;</span><br></pre></td></tr></table></figure>

<p>事务列表由多个事务组成，每个事务的格式如下:</p>
<table>
<thead>
<tr>
<th>校验和(8Bye)</th>
<th>数据长度(4Byte)</th>
<th>事务头信息(32Byte)</th>
<th>请求数据</th>
<th>结束符(0x42)</th>
</tr>
</thead>
</table>
<p>事务头的格式为class TxnHeader:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> clientId;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cxid;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> zxid;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> time;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> type;</span><br></pre></td></tr></table></figure>

<p>写事务的详细逻辑见FileTxnLog.append,该函数会先检查日志文件是否存在，若不存在，则先创建文件，再写日志。每个日志文件的命名格式为log.{该文件第一个日志的zxid}。在commit到disk时判断是否需要roll一个新FileTxnLog。<br>日志文件生成后没有固定清理机制，需通过运维方法清理，或设置自动清理参数<code>autopurge.purgeInterval</code>，代码实现见DatadirCleanupManager::PurgeTask</p>
<h3 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h3><p>Snapshot文件格式如下:</p>
<table>
<thead>
<tr>
<th>文件头(16Byte)</th>
<th>session信息</th>
<th>节点信息</th>
</tr>
</thead>
</table>
<p>文件头格式和事务日志一样，只是Magic为“ZKSN”。</p>
<p>Session信息格式如下:</p>
<p>Count(4Byte)|1-id(8Byte)|1-Timeout(4Byte)|…|N-id|N-Timeout</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serializeSnapshot</span><span class="params">(DataTree dt, OutputArchive oa, Map&lt;Long, Integer&gt; sessions)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    HashMap&lt;Long, Integer&gt; sessSnap = <span class="keyword">new</span> HashMap&lt;Long, Integer&gt;(sessions);</span><br><span class="line">    oa.writeInt(sessSnap.size(), <span class="string">"count"</span>);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;Long, Integer&gt; entry : sessSnap.entrySet()) &#123;</span><br><span class="line">        oa.writeLong(entry.getKey().longValue(), <span class="string">"id"</span>);</span><br><span class="line">        oa.writeInt(entry.getValue().intValue(), <span class="string">"timeout"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dt.serialize(oa, <span class="string">"tree"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h3><p>节点信息由类DataTree.serialize实现，该类会先序列化ACL信息，再按节点的树形结构序列化节点以及对应的状态信息，具体格式见代码。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(OutputArchive oa, String tag)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    serializeAcls(oa);</span><br><span class="line">    serializeNodes(oa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_processPacket/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_processPacket/" class="post-title-link" itemprop="url">zookeeper源码-5.客户端响应请求</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 06:23:17" itemprop="dateCreated datePublished" datetime="2020-04-29T06:23:17+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>NIOServerCnxn / NettyServerCnxn 调用ZooKeeperServer.processPacket，内部会调用submitRequest，最后submitRequest会将Request派发到firstProcessor</p>
<hr>
<h2 id="配置Processors"><a href="#配置Processors" class="headerlink" title="配置Processors"></a>配置Processors</h2><h3 id="Follower节点配置Processors"><a href="#Follower节点配置Processors" class="headerlink" title="Follower节点配置Processors"></a>Follower节点配置Processors</h3><p>Follower节点配置Processors详见FollowerZooKeeperServer.setupRequestProcessors, 链表结构如下:</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/follower_processors.png" class="">

<h3 id="Leader节点配置Processors"><a href="#Leader节点配置Processors" class="headerlink" title="Leader节点配置Processors"></a>Leader节点配置Processors</h3><p>Leader节点配置Processors详见LeaderZooKeeperServer.setupRequestProcessors, 链表结构如下:</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/leader_processors.png" class="">

<h3 id="客户端请求处理"><a href="#客户端请求处理" class="headerlink" title="客户端请求处理"></a>客户端请求处理</h3><p>Zookeeper将客户端的请求实际上分为两种类型:</p>
<ul>
<li>第一种类型的请求可以叫做读请求，如getData，getChildren等。<br>这种类型的请求不会修改zookeeper数据库的内容，因为zookeeper每个节点的数据库内容是一致的(不同的节点之间由于同步的时间不一致，可能会导致数据有不一致)，所以读请求只用在本地节点的数据库即可。</li>
<li>第二种节点会修改数据库内容，如create,delete等。<br>非Leader节点接收到此种请求，会先转发到Leader节点，Leader会按照先Proposal，后Commit的方式将请求同步到所有节点。</li>
</ul>
<h2 id="处理请求流程"><a href="#处理请求流程" class="headerlink" title="处理请求流程"></a>处理请求流程</h2><h3 id="Leader处理请求流程"><a href="#Leader处理请求流程" class="headerlink" title="Leader处理请求流程"></a>Leader处理请求流程</h3><h4 id="LeaderRequestProcessor"><a href="#LeaderRequestProcessor" class="headerlink" title="LeaderRequestProcessor"></a>LeaderRequestProcessor</h4><ul>
<li>如果是LocalSession，并且用户请求为创建临时节点（Session关闭时节点会删除），则升级Session到GlobalSession，并且创建一条createSession请求（upgradeRequest）。</li>
<li>如果createSession请求不为null，转发到PrepRequestProcessor。</li>
<li>转发用户请求到PrepRequestProcessor</li>
</ul>
<h4 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h4><p>PrepRequestProcessor设置Request的transcation信息，该Processor运行于独立的线程中。对于会改写zookeeper数据库的操作，该Processor会添加transcation信息，并且增加TxnHeader。对于读操作，则只检查session合法性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">pRequest2Txn</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">long</span> zxid, Request request, Record record, <span class="keyword">boolean</span> deserialize)</span> <span class="keyword">throws</span> KeeperException, IOException, RequestProcessorException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (request.getHdr() == <span class="keyword">null</span>) &#123;</span><br><span class="line">        request.setHdr(<span class="keyword">new</span> TxnHeader(request.sessionId, request.cxid, zxid,</span><br><span class="line">                Time.currentWallTime(), type));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setTxnDigest</span><span class="params">(Request request, PrecalculatedDigest preCalculatedDigest)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (preCalculatedDigest == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    request.setTxnDigest(<span class="keyword">new</span> TxnDigest(digestCalculator.getDigestVersion(), preCalculatedDigest.treeDigest));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="ProposalRequestProcessor"><a href="#ProposalRequestProcessor" class="headerlink" title="ProposalRequestProcessor"></a>ProposalRequestProcessor</h4><ul>
<li>ProposalRequestProcessor会先将请求派发给CommitProcessor</li>
<li>随后ProposalRequestProcessor检查哪些请求被添加了transcation信息，如果被添加了transcation信息，则会发送Proposal包给集群内所有节点。发送Proposal的时序图如下:</li>
</ul>
<img src="/2020/04/29/zk/zkSrc_processPacket/proposal_seq.png" class="">

<ul>
<li>发送完Proposal之后，再将该请求发送到SyncRequestProcessor。</li>
</ul>
<h4 id="SyncRequestProcessor"><a href="#SyncRequestProcessor" class="headerlink" title="SyncRequestProcessor"></a>SyncRequestProcessor</h4><p>SyncRequestProcessor用于存储请求Transcation日志以及数据库的Snapshot日志到文件，存储的逻辑详见run函数：</p>
<ul>
<li>通过snapCount和snapSizeInBytes控制多少次请求或多大log生成一个新的Transcation日志文件和保存Snapshot文件。</li>
<li>为了防止不同的节点都在相同的时间点进行snap，每次生成新的随机数，随机打散每个zk节点的snap时间点</li>
<li>Transcation日志格式以及Snapshot文件格式详见数据库格式。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (zks.getZKDatabase().append(si)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldSnapshot()) &#123;</span><br><span class="line">        resetSnapshotStats();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetSnapshotStats</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    randRoll = ThreadLocalRandom.current().nextInt(snapCount / <span class="number">2</span>);</span><br><span class="line">    randSize = Math.abs(ThreadLocalRandom.current().nextLong() % (snapSizeInBytes / <span class="number">2</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="AckRequestProcessor"><a href="#AckRequestProcessor" class="headerlink" title="AckRequestProcessor"></a>AckRequestProcessor</h4><p>在SyncRequestProcessor flush后，AckRequestProcessor仅仅是发送一个正在处理请求的ACK到Leader自己，用来模拟收到Leader节点的ACK。</p>
<h4 id="Leader-Proposal-ACK管理"><a href="#Leader-Proposal-ACK管理" class="headerlink" title="Leader Proposal ACK管理"></a>Leader Proposal ACK管理</h4><p>LearnerHandler在完成选举之后，会调用startSendingPackets来启动发送Packet的线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start thread that blast packets in the queue to learner</span></span><br><span class="line">startSendingPackets();</span><br></pre></td></tr></table></figure>

<p>同时进入接收该节点返回数据的循环。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">    ia.readRecord(qp, <span class="string">"packet"</span>);</span><br></pre></td></tr></table></figure>

<p>在收到Proposal Packet的ACK后，LearnerHandler处理流程为：</p>
<img src="/2020/04/29/zk/zkSrc_processPacket/proposal_ack.png" class="">

<ul>
<li>接收到节点所发的Proposal ACK数据，调用Leader.processAck</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Leader.ACK:</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.learnerType == LearnerType.OBSERVER) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Received ACK from Observer &#123;&#125;"</span>, <span class="keyword">this</span>.sid);</span><br><span class="line">    &#125;</span><br><span class="line">    syncLimitCheck.updateAck(qp.getZxid());</span><br><span class="line">    learnerMaster.processAck(<span class="keyword">this</span>.sid, qp.getZxid(), sock.getLocalSocketAddress());</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>将ACK的节点id添加到Proposal数据中，调用tryToCommit,尝试Commit该Request。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Proposal p = outstandingProposals.get(zxid);</span><br><span class="line">...</span><br><span class="line">p.addAck(sid);</span><br><span class="line"><span class="keyword">boolean</span> hasCommitted = tryToCommit(p, zxid, followerAddr);</span><br></pre></td></tr></table></figure>

<ul>
<li>调用Proposal.hasAllQuorums检查ACK的节点是否超过集群数量一半(包括Leader本身)，若超过，则向所有Follower发送Commit。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit(zxid);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a commit packet and send it to all the members of the quorum</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> zxid</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        lastCommitted = zxid;</span><br><span class="line">    &#125;</span><br><span class="line">    QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.COMMIT, zxid, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    sendPacket(qp);</span><br><span class="line">    ServerMetrics.getMetrics().COMMIT_COUNT.add(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>向所有Observer节点发送Inform。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inform(p);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create an inform packet and send it to all observers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">inform</span><span class="params">(Proposal proposal)</span> </span>&#123;</span><br><span class="line">    QuorumPacket qp = <span class="keyword">new</span> QuorumPacket(Leader.INFORM, proposal.request.zxid, proposal.packet.getData(), <span class="keyword">null</span>);</span><br><span class="line">    sendObserverPacket(qp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>通知CommitProcessor该请求已Commit。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zk.commitProcessor.commit(p.request);</span><br></pre></td></tr></table></figure>

<h4 id="CommitProcessor"><a href="#CommitProcessor" class="headerlink" title="CommitProcessor"></a>CommitProcessor</h4><p>CommitProcessor用于管理Session需要Commit的请求，该Processor Leader和Follower节点共用，CommitProcessor有自己的运行线程。</p>
<ul>
<li>接收到Request后，若该Request需要Commit，或者该Session中存在pendingRequest,则将该Request添加到对应Session的pendingRequest中。否则，直接将Request发送给下一个Processor。该处理方法能保证同一个Session 处理Request的顺序，例如该Session先发送了一个修改数据库的操作，又发送一个读数据库的操作，读的操作肯定会在写操作之后。</li>
<li>CommitProcessor收到某个Request已经Commit之后，（如上，Leader将Commit发送给Follower之后，或者Follower接收到Leader发送的Commit），将Commit的请求转发给下一个Processor。Follower和Leader都有两种Commit的请求。<ul>
<li>Follower Commit请求类型<ul>
<li>自己节点上的Session发送的修改数据库的请求。此种情况下，该Session对应的pendingReqeust的第一个Request肯定是Commit请求；</li>
<li>或者是Leader发送的其他节点接收到的修改数据库的请求，此种情况无对应的pendingRequest，触发入口来自Follower.processPacket。</li>
</ul>
</li>
<li>Leader Commit请求类型<ul>
<li>自己节点上Session发送的修改数据库请求。</li>
<li>Follower节点转发的，但是处理流程和自己节点上接收到的一样，触发入口来自LearnerHander.run调用LeaderZooKeeperServer.submitLearnerRequest。</li>
</ul>
</li>
</ul>
</li>
<li>CommitProcessor将已经Commit的Request发送给下一个Processor，并且将该Session上pendingRequest随后的读请求转发给下一个Processor。</li>
</ul>
<h4 id="Leader-TobeAppliedRequestProcessor"><a href="#Leader-TobeAppliedRequestProcessor" class="headerlink" title="Leader.TobeAppliedRequestProcessor"></a>Leader.TobeAppliedRequestProcessor</h4><p>在Commit Request之前，Leader会记录已Commit但未修改到数据库的写操作Proposal，该记录用于Follower和Leader选举之后的同步数据。本Processor的作用就是在操作数据库之前清除保存的Proposal信息。</p>
<h4 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h4><p>FinalRequestProcessor是操作数据库来响应对应的读或写操作。</p>
<h3 id="Follower处理请求流程"><a href="#Follower处理请求流程" class="headerlink" title="Follower处理请求流程"></a>Follower处理请求流程</h3><p>CommitProcessor和FinalRequestProcessor前面已说明，所以此处只用介绍FollowerRequestProcessor。</p>
<h4 id="FollowerRequestProcessor"><a href="#FollowerRequestProcessor" class="headerlink" title="FollowerRequestProcessor"></a>FollowerRequestProcessor</h4><p>FollowerRequestProcessor运行于独立的线程中。主要工作如下:</p>
<ul>
<li>提交Request时，如果Request是local session，且创建了临时节点，则升级session到Global类型，并且插入一个createSession request。</li>
<li>将Request转发到CommitProcessor。</li>
<li>如果为写请求，转发到Leader。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_serverCnxn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_serverCnxn/" class="post-title-link" itemprop="url">zookeeper源码-4.客户端连接管理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 06:17:38" itemprop="dateCreated datePublished" datetime="2020-04-29T06:17:38+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>默认使用NIO，可配置为Netty</p>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/client_cnxn_class.png" class="">

<p>configure在QuorumPeerMain中调用，入口在QuorumPeer.startServerCnxnFactory</p>
<p>Factory使用Set&lt;ServerCnxn&gt;保存所有ServerCnxn</p>
<p>NIO Factory 使用一个AcceptThread接受所有连接，按照round-robin分配到Collection&lt;SelectorThread&gt;，每个SelectorThread创建一个NIOServerCnxn，通过WorkerService调度执行<br>Netty Factory 为pipeline添加@Sharable的CnxnChannelHandler处理函数，每个新连接创建NettyServerCnxn处理，</p>
<hr>
<h2 id="Netty实现"><a href="#Netty实现" class="headerlink" title="Netty实现"></a>Netty实现</h2><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><p>客户端的网络事件NettyServerCnxnFactory.CnxnChannelHandler</p>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>有新客户端连接，调用NettyServerCnxnFactory.CnxnChannelHandler.channelActive，新建NettyServerCnxn实例并保存</p>
<h3 id="处理客户端数据"><a href="#处理客户端数据" class="headerlink" title="处理客户端数据"></a>处理客户端数据</h3><p>NettyServerCnxn使用原子变量throttled，表示是否处理用户发送的请求。例如若客户端的连接未建立完成，则不会处理客户端的请求</p>
<h4 id="接收客户端数据"><a href="#接收客户端数据" class="headerlink" title="接收客户端数据"></a>接收客户端数据</h4><p>当服务器接收到数据时，调用NettyServerCnxnFactory.CnxnChannelHandler.processMessage接口。处理流程为</p>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/receive_data_flow.png" class="">

<h4 id="处理数据流程"><a href="#处理数据流程" class="headerlink" title="处理数据流程"></a>处理数据流程</h4><p>处理数据接口为NettyServerCnxn.receiveMessage。有两个ByteBuffer用来保存客户端发送过来的数据。处理流程为</p>
<ul>
<li>bbLen用于保存数据长度，或者判断请求是否是Command。对于普通的请求，前4个字节(Integer型长度)是请求数据长度；而对于Command，使用The Four Letter Words形式，即命令占用4个字节，正好是一个Integer型长度。bbLen固定为4Byte缓冲区。</li>
<li>bb用户保存请求的数据，该缓冲区默认为null。<ul>
<li>!initialized， 调用ZooKeeperServer.processConnectRequest</li>
<li>initialized， 调用ZooKeeperServer.processPacket</li>
</ul>
</li>
</ul>
<img src="/2020/04/29/zk/zkSrc_serverCnxn/process_data_flow.png" class="">

<h4 id="返回数据"><a href="#返回数据" class="headerlink" title="返回数据"></a>返回数据</h4><p>在ZooKeeperServer.processPacket中调用NettyServerCnxn.sendResponse返回结果给客户端。</p>
<h4 id="Watch通知"><a href="#Watch通知" class="headerlink" title="Watch通知"></a>Watch通知</h4><p>zookeeper client可以监听数据的生命周期以及数据变化，client监听数据时，FinalRequestProcessor会调用ZKdatabase.setWatches将ServerCnxn添加到监听列表。当有事件发生时，会调用ServerCnxn.process发送数据回client。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_state/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_state/" class="post-title-link" itemprop="url">zookeeper源码-3.状态转换</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 06:10:33" itemprop="dateCreated datePublished" datetime="2020-04-29T06:10:33+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在选举完成后，进入FOLLOWING或LEADING状态。在其能对外提供服务之前，需要对各个服务器之间状态进行同步，使服务器的数据保持一致。</p>
<hr>
<h2 id="Leader同步"><a href="#Leader同步" class="headerlink" title="Leader同步"></a>Leader同步</h2><img src="/2020/04/29/zk/zkSrc_state/leader_sync.png" class="">

<p>在创建Leader对象时，会创建Leader监听的socket，在LeanerCnxAcceptor中会accept该连接，并且创建LearnerHandler的实例，该实例会新建线程，并处理和该新建的连接通信。</p>
<hr>
<h2 id="Follower同步"><a href="#Follower同步" class="headerlink" title="Follower同步"></a>Follower同步</h2><img src="/2020/04/29/zk/zkSrc_state/follower_sync.png" class="">

<hr>
<h2 id="tcp报文-FastLeaderElection-buildMsg"><a href="#tcp报文-FastLeaderElection-buildMsg" class="headerlink" title="tcp报文 FastLeaderElection::buildMsg"></a>tcp报文 FastLeaderElection::buildMsg</h2><p>length-&gt;ByteBuffer</p>
<p>ByteBuffer[state, leader, zxid, electionEpoch, epoch, version, configDataLength, configData]</p>
<hr>
<h2 id="lastMessageSent-异常重启时重发最后消息，重复消息可正确处理"><a href="#lastMessageSent-异常重启时重发最后消息，重复消息可正确处理" class="headerlink" title="lastMessageSent 异常重启时重发最后消息，重复消息可正确处理"></a>lastMessageSent 异常重启时重发最后消息，重复消息可正确处理</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">BlockingQueue&lt;ByteBuffer&gt; bq = queueSendMap.get(sid);</span><br><span class="line"><span class="keyword">if</span> (bq == <span class="keyword">null</span> || isSendQueueEmpty(bq)) &#123;</span><br><span class="line">    ByteBuffer b = lastMessageSent.get(sid);</span><br><span class="line">    <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.debug(<span class="string">"Attempting to send lastMessage to sid=&#123;&#125;"</span>, sid);</span><br><span class="line">        send(b);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="状态同步"><a href="#状态同步" class="headerlink" title="状态同步"></a>状态同步</h2><img src="/2020/04/29/zk/zkSrc_state/sync_detail.png" class="">

<blockquote>
<h3 id="FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程"><a href="#FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程" class="headerlink" title="FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程"></a>FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程</h3></blockquote>
<ul>
<li>Follower节点在建立到Leader的连接后，立即发送<strong>FollowerInfo</strong>,数据中包括自身节点类型，zxid，协议号(0x10000)，以及节点ID(sid)。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">registerWithLeader</span><span class="params">(<span class="keyword">int</span> pktType)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Send follower info, including last zxid and sid</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> lastLoggedZxid = self.getLastLoggedZxid();</span><br><span class="line">    QuorumPacket qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">    qp.setType(pktType); <span class="comment">// FOLLOWERINFO 或 OBSERVERINFO</span></span><br><span class="line">    qp.setZxid(ZxidUtils.makeZxid(self.getAcceptedEpoch(), <span class="number">0</span>));</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Add sid to payload</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 协议固定0x10000</span></span><br><span class="line">    LearnerInfo li = <span class="keyword">new</span> LearnerInfo(self.getId(), <span class="number">0x10000</span>, self.getQuorumVerifier().getVersion());</span><br><span class="line">    ByteArrayOutputStream bsid = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">    BinaryOutputArchive boa = BinaryOutputArchive.getArchive(bsid);</span><br><span class="line">    boa.writeRecord(li, <span class="string">"LearnerInfo"</span>);</span><br><span class="line">    qp.setData(bsid.toByteArray());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送FollowerInfo 或 OBSERVERINFO</span></span><br><span class="line">    writePacket(qp, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>Leader回复<strong>LeaderInfo</strong>信息，信息包括zxid,以及版本号</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">byte</span>[] ver = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">ByteBuffer.wrap(ver).putInt(<span class="number">0x10000</span>);</span><br><span class="line">QuorumPacket newEpochPacket = <span class="keyword">new</span> QuorumPacket(Leader.LEADERINFO, newLeaderZxid, ver, <span class="keyword">null</span>);</span><br><span class="line">oa.writeRecord(newEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">messageTracker.trackSent(Leader.LEADERINFO);</span><br><span class="line">bufferedOutput.flush();</span><br></pre></td></tr></table></figure>

<ul>
<li>Follower回复<strong>ACKEPOCH</strong>,信息包括lastLoggedZxid，epoch信息。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">readPacket(qp);</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">long</span> newEpoch = ZxidUtils.getEpochFromZxid(qp.getZxid());</span><br><span class="line"><span class="keyword">if</span> (qp.getType() == Leader.LEADERINFO) &#123;</span><br><span class="line">    <span class="comment">// we are connected to a 1.0 server so accept the new epoch and read the next packet</span></span><br><span class="line">    leaderProtocolVersion = ByteBuffer.wrap(qp.getData()).getInt(); <span class="comment">// 0x10000</span></span><br><span class="line">    <span class="keyword">byte</span>[] epochBytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4</span>];</span><br><span class="line">    <span class="keyword">final</span> ByteBuffer wrappedEpochBytes = ByteBuffer.wrap(epochBytes);</span><br><span class="line">    <span class="keyword">if</span> (newEpoch &gt; self.getAcceptedEpoch()) &#123;</span><br><span class="line">        wrappedEpochBytes.putInt((<span class="keyword">int</span>) self.getCurrentEpoch());</span><br><span class="line">        self.setAcceptedEpoch(newEpoch);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newEpoch == self.getAcceptedEpoch()) &#123;</span><br><span class="line">        <span class="comment">// since we have already acked an epoch equal to the leaders, we cannot ack</span></span><br><span class="line">        <span class="comment">// again, but we still need to send our lastZxid to the leader so that we can</span></span><br><span class="line">        <span class="comment">// sync with it if it does assume leadership of the epoch.</span></span><br><span class="line">        <span class="comment">// the -1 indicates that this reply should not count as an ack for the new epoch</span></span><br><span class="line">        wrappedEpochBytes.putInt(-<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Leaders epoch, "</span></span><br><span class="line">                              + newEpoch</span><br><span class="line">                              + <span class="string">" is less than accepted epoch, "</span></span><br><span class="line">                              + self.getAcceptedEpoch());</span><br><span class="line">    &#125;</span><br><span class="line">    QuorumPacket ackNewEpoch = <span class="keyword">new</span> QuorumPacket(Leader.ACKEPOCH, lastLoggedZxid, epochBytes, <span class="keyword">null</span>);</span><br><span class="line">    writePacket(ackNewEpoch, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">return</span> ZxidUtils.makeZxid(newEpoch, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>Leader等待超过半数节点回复的<strong>ACKEPOCH</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">QuorumPacket ackEpochPacket = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">ia.readRecord(ackEpochPacket, <span class="string">"packet"</span>);</span><br><span class="line">messageTracker.trackReceived(ackEpochPacket.getType());</span><br><span class="line"><span class="keyword">if</span> (ackEpochPacket.getType() != Leader.ACKEPOCH) &#123;</span><br><span class="line">    LOG.error(<span class="string">"&#123;&#125; is not ACKEPOCH"</span>, ackEpochPacket.toString());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">ByteBuffer bbepoch = ByteBuffer.wrap(ackEpochPacket.getData());</span><br><span class="line">ss = <span class="keyword">new</span> StateSummary(bbepoch.getInt(), ackEpochPacket.getZxid());</span><br><span class="line">learnerMaster.waitForEpochAck(<span class="keyword">this</span>.getSid(), ss);</span><br></pre></td></tr></table></figure>

<blockquote>
<h3 id="FOLLOW-syncWithLeader-newEpochZxid-状态同步流程"><a href="#FOLLOW-syncWithLeader-newEpochZxid-状态同步流程" class="headerlink" title="FOLLOW syncWithLeader(newEpochZxid) 状态同步流程"></a>FOLLOW syncWithLeader(newEpochZxid) 状态同步流程</h3></blockquote>
<ul>
<li>Leader会根据Follower发送的zxid信息，判断采用何种方式和Follower同步数据，并将同步数据的Request添加到队列。注意，此时消息并未发送，只是添加到队列。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">peerLastZxid = ss.getLastZxid();</span><br><span class="line"><span class="comment">// Take any necessary action if we need to send TRUNC or DIFF</span></span><br><span class="line"><span class="comment">// startForwarding() will be called in all cases</span></span><br><span class="line"><span class="keyword">boolean</span> needSnap = syncFollower(peerLastZxid, learnerMaster);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (db.getCommittedLog().isEmpty()) &#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * It is possible that committedLog is empty. In that case</span></span><br><span class="line"><span class="comment">     * setting these value to the latest txn in learnerMaster db</span></span><br><span class="line"><span class="comment">     * will reduce the case that we need to handle</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Here is how each case handle by the if block below</span></span><br><span class="line"><span class="comment">     * 1. lastProcessZxid == peerZxid -&gt; Handle by (2)</span></span><br><span class="line"><span class="comment">     * 2. lastProcessZxid &lt; peerZxid -&gt; Handle by (3)</span></span><br><span class="line"><span class="comment">     * 3. lastProcessZxid &gt; peerZxid -&gt; Handle by (5)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    minCommittedLog = lastProcessedZxid;</span><br><span class="line">    maxCommittedLog = lastProcessedZxid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Here are the cases that we want to handle</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1. Force sending snapshot (for testing purpose)</span></span><br><span class="line"><span class="comment"> * 2. Peer and learnerMaster is already sync, send empty diff</span></span><br><span class="line"><span class="comment"> * 3. Follower has txn that we haven't seen. This may be old leader</span></span><br><span class="line"><span class="comment"> *    so we need to send TRUNC. However, if peer has newEpochZxid,</span></span><br><span class="line"><span class="comment"> *    we cannot send TRUNC since the follower has no txnlog</span></span><br><span class="line"><span class="comment"> * 4. Follower is within committedLog range or already in-sync.</span></span><br><span class="line"><span class="comment"> *    We may need to send DIFF or TRUNC depending on follower's zxid</span></span><br><span class="line"><span class="comment"> *    We always send empty DIFF if follower is already in-sync</span></span><br><span class="line"><span class="comment"> * 5. Follower missed the committedLog. We will try to use on-disk</span></span><br><span class="line"><span class="comment"> *    txnlog + committedLog to sync with follower. If that fail,</span></span><br><span class="line"><span class="comment"> *    we will send snapshot</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">needSnap = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (forceSnapSync) &#123;</span><br><span class="line">    <span class="comment">// for testing purpose</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastProcessedZxid == peerLastZxid) &#123;</span><br><span class="line">    <span class="comment">// 若Follower的事务id和Leader一样，则发送Leader.DIFF，表示不需要同步数据</span></span><br><span class="line">    queueOpPacket(Leader.DIFF, peerLastZxid);</span><br><span class="line">    needSnap = <span class="keyword">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &gt; maxCommittedLog &amp;&amp; !isPeerNewEpochZxid) &#123;</span><br><span class="line">    <span class="comment">// 若Follower的事务id &gt; Leader事务id，则发送Leader.TRUNC，截断Follower的数据，使其和Leader保持一致</span></span><br><span class="line">    queueOpPacket(Leader.TRUNC, maxCommittedLog);</span><br><span class="line">    needSnap = <span class="keyword">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ((maxCommittedLog &gt;= peerLastZxid) &amp;&amp; (minCommittedLog &lt;= peerLastZxid)) &#123;</span><br><span class="line">    <span class="comment">// 若minCommittedLog &lt;= Follower事务id &lt;= maxCommittedLog, 则从ZKDatabase缓存中获取请求，将需要同步的每条请求先发送一条Proposal，再发送一条Commit。</span></span><br><span class="line">    LOG.info(<span class="string">"Using committedLog for peer sid: &#123;&#125;"</span>, getSid());</span><br><span class="line">    Iterator&lt;Proposal&gt; itr = db.getCommittedLog().iterator();</span><br><span class="line">    currentZxid = queueCommittedProposals(itr, peerLastZxid, <span class="keyword">null</span>, maxCommittedLog);</span><br><span class="line">    needSnap = <span class="keyword">false</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (peerLastZxid &lt; minCommittedLog &amp;&amp; txnLogSyncEnabled) &#123;</span><br><span class="line">    <span class="comment">// 若Follower事务id &lt; minCommittedLog, 则会从事务日志和ZKDatabase缓存中获取请求同步到Follower，每条请求也是先发送一条Proposal，再发送一条Commit。</span></span><br><span class="line">    <span class="comment">// Use txnlog and committedLog to sync</span></span><br><span class="line">    <span class="comment">// Calculate sizeLimit that we allow to retrieve txnlog from disk</span></span><br><span class="line">    <span class="keyword">long</span> sizeLimit = db.calculateTxnLogSizeLimit();</span><br><span class="line">    <span class="comment">// This method can return empty iterator if the requested zxid</span></span><br><span class="line">    <span class="comment">// is older than on-disk txnlog</span></span><br><span class="line">    Iterator&lt;Proposal&gt; txnLogItr = db.getProposalsFromTxnLog(peerLastZxid, sizeLimit);</span><br><span class="line">    <span class="keyword">if</span> (txnLogItr.hasNext()) &#123; <span class="comment">// 非空</span></span><br><span class="line">        LOG.info(<span class="string">"Use txnlog and committedLog for peer sid: &#123;&#125;"</span>, getSid());</span><br><span class="line">        <span class="comment">// 从 disk事务日志 同步</span></span><br><span class="line">        currentZxid = queueCommittedProposals(txnLogItr, peerLastZxid, minCommittedLog, maxCommittedLog);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentZxid &lt; minCommittedLog) &#123;</span><br><span class="line">            LOG.info(</span><br><span class="line">                <span class="string">"Detected gap between end of txnlog: 0x&#123;&#125; and start of committedLog: 0x&#123;&#125;"</span>,</span><br><span class="line">                Long.toHexString(currentZxid),</span><br><span class="line">                Long.toHexString(minCommittedLog));</span><br><span class="line">            currentZxid = peerLastZxid;</span><br><span class="line">            <span class="comment">// 退回为snap</span></span><br><span class="line">            queuedPackets.clear();</span><br><span class="line">            needOpPacket = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            LOG.debug(<span class="string">"Queueing committedLog 0x&#123;&#125;"</span>, Long.toHexString(currentZxid));</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 从 ZKDatabase缓存 同步</span></span><br><span class="line">            Iterator&lt;Proposal&gt; committedLogItr = db.getCommittedLog().iterator();</span><br><span class="line">            currentZxid = queueCommittedProposals(committedLogItr, currentZxid, <span class="keyword">null</span>, maxCommittedLog);</span><br><span class="line">            needSnap = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// closing the resources</span></span><br><span class="line">    <span class="keyword">if</span> (txnLogItr <span class="keyword">instanceof</span> TxnLogProposalIterator) &#123;</span><br><span class="line">        TxnLogProposalIterator txnProposalItr = (TxnLogProposalIterator) txnLogItr;</span><br><span class="line">        txnProposalItr.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如果最后需要snap，发送<strong>snap</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (needSnap) &#123;</span><br><span class="line">    syncThrottler = learnerMaster.getLearnerSnapSyncThrottler();</span><br><span class="line">    syncThrottler.beginSync(exemptFromThrottle);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> zxidToSend = learnerMaster.getZKDatabase().getDataTreeLastProcessedZxid();</span><br><span class="line">        oa.writeRecord(<span class="keyword">new</span> QuorumPacket(Leader.SNAP, zxidToSend, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="string">"packet"</span>);</span><br><span class="line">        messageTracker.trackSent(Leader.SNAP);</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line">        LOG.info(</span><br><span class="line">            <span class="string">"Sending snapshot last zxid of peer is 0x&#123;&#125;, zxid of leader is 0x&#123;&#125;, "</span></span><br><span class="line">                + <span class="string">"send zxid of db as 0x&#123;&#125;, &#123;&#125; concurrent snapshot sync, "</span></span><br><span class="line">                + <span class="string">"snapshot sync was &#123;&#125; from throttle"</span>,</span><br><span class="line">            Long.toHexString(peerLastZxid),</span><br><span class="line">            Long.toHexString(leaderLastZxid),</span><br><span class="line">            Long.toHexString(zxidToSend),</span><br><span class="line">            syncThrottler.getSyncInProgress(),</span><br><span class="line">            exemptFromThrottle ? <span class="string">"exempt"</span> : <span class="string">"not exempt"</span>);</span><br><span class="line">        <span class="comment">// Dump data to peer</span></span><br><span class="line">        learnerMaster.getZKDatabase().serializeSnapshot(oa);</span><br><span class="line">        oa.writeString(<span class="string">"BenWasHere"</span>, <span class="string">"signature"</span>);</span><br><span class="line">        bufferedOutput.flush();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ServerMetrics.getMetrics().SNAP_COUNT.add(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    syncThrottler = learnerMaster.getLearnerDiffSyncThrottler();</span><br><span class="line">    syncThrottler.beginSync(exemptFromThrottle);</span><br><span class="line">    ServerMetrics.getMetrics().DIFF_COUNT.add(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>将<strong>NEWLEADER</strong>添加到队列。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QuorumPacket newLeaderQP = <span class="keyword">new</span> QuorumPacket(Leader.NEWLEADER, newLeaderZxid, learnerMaster.getQuorumVerifierBytes(), <span class="keyword">null</span>);</span><br><span class="line">queuedPackets.add(newLeaderQP);</span><br><span class="line">bufferedOutput.flush();</span><br></pre></td></tr></table></figure>

<ul>
<li>发送队列的消息，因为同步数据的队列在前，<strong>NEWLEADER</strong>在后，所以会先和Follower同步数据，再发送<strong>NEWLEADER</strong>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start thread that blast packets in the queue to learner</span></span><br><span class="line">startSendingPackets();</span><br></pre></td></tr></table></figure>

<ul>
<li>Follower收到<strong>NEWLEADER</strong>后回复<strong>ACK</strong>。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Leader.NEWLEADER:</span><br><span class="line">    writePacket(<span class="keyword">new</span> QuorumPacket(Leader.ACK, newLeaderZxid, <span class="keyword">null</span>, <span class="keyword">null</span>), <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>Leader 等待大部分节点回复<strong>ACK</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Have to wait for the first ACK, wait until</span></span><br><span class="line"><span class="comment"> * the learnerMaster is ready, and only then we can</span></span><br><span class="line"><span class="comment"> * start processing messages.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">qp = <span class="keyword">new</span> QuorumPacket();</span><br><span class="line">ia.readRecord(qp, <span class="string">"packet"</span>);</span><br><span class="line">messageTracker.trackReceived(qp.getType());</span><br><span class="line"><span class="keyword">if</span> (qp.getType() != Leader.ACK) &#123;</span><br><span class="line">    LOG.error(<span class="string">"Next packet was supposed to be an ACK, but received packet: &#123;&#125;"</span>, packetToString(qp));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">LOG.debug(<span class="string">"Received NEWLEADER-ACK message from &#123;&#125;"</span>, sid);</span><br><span class="line"></span><br><span class="line">learnerMaster.waitForNewLeaderAck(getSid(), qp.getZxid());</span><br></pre></td></tr></table></figure>

<ul>
<li>Leader发送<strong>UPTODATE</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">queuedPackets.add(<span class="keyword">new</span> QuorumPacket(Leader.UPTODATE, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>));</span><br></pre></td></tr></table></figure>

<ul>
<li>FOLLOW接收<strong>UPTODATE</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> Leader.UPTODATE:</span><br><span class="line">    self.setZooKeeperServer(zk);</span><br><span class="line">    self.adminServer.setZooKeeperServer(zk);</span><br><span class="line">    <span class="keyword">break</span> outerLoop;</span><br></pre></td></tr></table></figure>

<p>在上述步骤完成后，集群状态已经稳定，可以对外提供服务。<br>心跳检测逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// We ping twice a tick, so we only update the tick every other</span></span><br><span class="line">    <span class="comment">// iteration</span></span><br><span class="line">    <span class="keyword">boolean</span> tickSkip = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// If not null then shutdown this leader</span></span><br><span class="line">    String shutdownMessage = <span class="keyword">null</span>;  </span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> start = Time.currentElapsedTime();</span><br><span class="line">            <span class="keyword">long</span> cur = start;</span><br><span class="line">            <span class="keyword">long</span> end = start + self.tickTime / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">while</span> (cur &lt; end) &#123;</span><br><span class="line">                wait(end - cur);</span><br><span class="line">                cur = Time.currentElapsedTime();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!tickSkip) &#123;</span><br><span class="line">                self.tick.incrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 使用SyncedLearnerTracker来确认自己是否维持着quorum</span></span><br><span class="line">            SyncedLearnerTracker syncedAckSet = <span class="keyword">new</span> SyncedLearnerTracker();</span><br><span class="line">            syncedAckSet.addQuorumVerifier(self.getQuorumVerifier());</span><br><span class="line">            <span class="keyword">if</span> (self.getLastSeenQuorumVerifier() != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; self.getLastSeenQuorumVerifier().getVersion() &gt; self.getQuorumVerifier().getVersion()) &#123;</span><br><span class="line">                syncedAckSet.addQuorumVerifier(self.getLastSeenQuorumVerifier());</span><br><span class="line">            &#125;</span><br><span class="line">            syncedAckSet.addAck(self.getId());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 检测每个追随者</span></span><br><span class="line">            <span class="keyword">for</span> (LearnerHandler f : getLearners()) &#123;</span><br><span class="line">                <span class="comment">// current tick &lt;= tick+syncLimit</span></span><br><span class="line">                <span class="keyword">if</span> (f.synced()) &#123;</span><br><span class="line">                    syncedAckSet.addAck(f.getSid());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// check leader running status</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.isRunning()) &#123;</span><br><span class="line">                <span class="comment">// set shutdown flag</span></span><br><span class="line">                shutdownMessage = <span class="string">"Unexpected internal error"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!tickSkip &amp;&amp; !syncedAckSet.hasAllQuorums()) &#123;</span><br><span class="line">                <span class="comment">// quorum没过半数，退出leader</span></span><br><span class="line">                shutdownMessage = <span class="string">"Not sufficient followers synced, only synced with sids: [ "</span></span><br><span class="line">                                  + syncedAckSet.ackSetsToString()</span><br><span class="line">                                  + <span class="string">" ]"</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            tickSkip = !tickSkip;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1个tick time内ping两次</span></span><br><span class="line">        <span class="keyword">for</span> (LearnerHandler f : getLearners()) &#123;</span><br><span class="line">            f.ping();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">``` java</span><br><span class="line">    <span class="keyword">switch</span> (qp.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> Leader.PING:</span><br><span class="line">        ping(qp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_election/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_election/" class="post-title-link" itemprop="url">zookeeper源码-2.启动和选举</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 05:55:27" itemprop="dateCreated datePublished" datetime="2020-04-29T05:55:27+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><ol>
<li>QuorumPeerMain读取config</li>
<li>调用QuorumPeer.start()<br>2.1 loadDataBase() 载入当前节点的数据库<br>2.2 startServerCnxnFactory() 启动客户端连接监听<br>2.3 startLeaderElection() 开始选举<br>2.4 调用run() 获取选举结果并执行响应</li>
</ol>
<h2 id="载入数据库"><a href="#载入数据库" class="headerlink" title="载入数据库"></a>载入数据库</h2><h2 id="启动客户端连接监听"><a href="#启动客户端连接监听" class="headerlink" title="启动客户端连接监听"></a>启动客户端连接监听</h2><p>监听分为两种模式，默认使用ServerCnxnFactory的NioServerCnxnFactory</p>
<ul>
<li>ServerCnxnFactory cnxnFactory<ul>
<li>NioServerCnxnFactory</li>
<li>NettyServerCnxnFactory</li>
</ul>
</li>
<li>ServerCnxnFactory secureCnxnFactory</li>
</ul>
<h2 id="选举"><a href="#选举" class="headerlink" title="选举"></a>选举</h2><p>节点启动时，节点状态初始化为ServerState.LOOKING，此时ZK会获取当前的Leader或者会发起一个选举。</p>
<img src="/2020/04/29/zk/zkSrc_election/peer_state.png" class="">

<p>ZooKeeper实现了四种选举模式，默认选用FastLeaderElection</p>
<ol>
<li>LeaderElection</li>
<li>AuthFastLeaderElection with authenticate disabled</li>
<li>AuthFastLeaderElection with authenticate enabled</li>
<li>FastLeaderElection</li>
</ol>
<img src="/2020/04/29/zk/zkSrc_election/election_class.png" class="">

<h3 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h3><p>QuorumVerifier用于检查一个服务器列表能否构成一个可用的服务器集群。实现类有</p>
<ul>
<li>QuorumMaj 简单过半投票，默认策略</li>
<li>QuorumHierarchical 基于权重投票策略</li>
</ul>
<p>QuorumMaj 主要接口如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;Long, QuorumServer&gt; allMembers = <span class="keyword">new</span> HashMap&lt;Long, QuorumServer&gt;();</span><br><span class="line"><span class="keyword">private</span> Map&lt;Long, QuorumServer&gt; votingMembers = <span class="keyword">new</span> HashMap&lt;Long, QuorumServer&gt;();</span><br><span class="line"><span class="keyword">private</span> Map&lt;Long, QuorumServer&gt; observingMembers = <span class="keyword">new</span> HashMap&lt;Long, QuorumServer&gt;();</span><br></pre></td></tr></table></figure>

<ul>
<li>containsQuorum 选举的结果是否超过集群半数节点。</li>
<li>getAllMembers 获取集群中所有的节点。</li>
<li>getVotingMembers 获取集群中参与选举的节点。</li>
<li>getObservingMembers 获取集群中Observer节点。</li>
</ul>
<p>SyncedLearnerTracker用于FastLeaderElection中，保存集群和选举的映射关系。主要接口如下:</p>
<ul>
<li>addQuorumVerifier 添加集群信息</li>
<li>addAck 添加选举响应</li>
<li>hasAllQuorums 调用QuorumVerifier.containsQuorum()判断集群中参与选举的节点是否超过集群半数节点。</li>
</ul>
<p>节点中维护了两个QuorumVerifier的实例，分别是QuorumPeer类中的如下两个:</p>
<ul>
<li>quorumVerifier 最后Commit的节点的Verifier</li>
<li>lastSeenQuorumVerifier 最后Proposed节点的Verifier</li>
</ul>
<h3 id="FastLeaderElection实现"><a href="#FastLeaderElection实现" class="headerlink" title="FastLeaderElection实现"></a>FastLeaderElection实现</h3><img src="/2020/04/29/zk/zkSrc_election/fast_election_class.png" class="">

<p>Election为选举基类，lookForLeader()会循环阻塞在LOOKING状态，一直到成功获取Leader节点。</p>
<ol>
<li>节点首先更新Proposed为自己，广播通知，并循环获取<code>recvqueue</code>队列通知</li>
<li>超时，重新广播通知</li>
<li>忽略不在自己members中的通知和OBSERVING的通知</li>
<li>收到LOOKING的通知<br>4.1 选举轮次超过自己，使用<code>选举策略</code>判断若超过<strong>自身</strong>信息，更新Proposed和轮次，清空<code>本轮票数</code>，广播通知<br>4.2 选举轮次落后自己，忽略<br>4.3 相同选举轮次，使用<code>选举策略</code>判断若超过<strong>当前Proposed</strong>信息，Proposed更新为新接受的选举信息，广播通知<br>4.4 如果<code>本轮票数</code>过半，且使用<code>选举策略</code>判断<code>recvqueue</code>中没有剩余超过<strong>当前Proposed</strong>信息的通知，设置LEADER信息(可能为自己)，退出选举；否则返回1</li>
<li>收到FOLLOWING和LEADING的通知<br>5.1 相同选举轮次，如果<code>本轮票数</code>过半，且收到过该Leader的通知(防止有节点选举已crash的非自身节点为Leader)，设置LEADER信息(可能为自己)，退出选举<br>5.2 非相同选举轮次，如果<code>非本轮票数</code>过半，且收到过该Leader的通知，设置LEADER信息，退出选举</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 选举策略</span></span><br><span class="line"><span class="comment"> * We return true if one of the following three cases hold:</span></span><br><span class="line"><span class="comment"> * 1- New epoch is higher</span></span><br><span class="line"><span class="comment"> * 2- New epoch is the same as current epoch, but new zxid is higher</span></span><br><span class="line"><span class="comment"> * 3- New epoch is the same as current epoch, new zxid is the same</span></span><br><span class="line"><span class="comment"> *  as current zxid, but server id is higher.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> ((newEpoch &gt; curEpoch)</span><br><span class="line">        || ((newEpoch == curEpoch)</span><br><span class="line">            &amp;&amp; ((newZxid &gt; curZxid)</span><br><span class="line">                || ((newZxid == curZxid)</span><br><span class="line">                    &amp;&amp; (newId &gt; curId)))));</span><br></pre></td></tr></table></figure>

<p>QuorumCnxManager负责选举中的连接管理，该类包含三个inner class。</p>
<ul>
<li>Listener 负责监接收新连接，并且管理连接，在单独的线程运行。</li>
<li>SendWorker 负责发送数据到其他节点，所发送的数据由FastLeaderElection提供，在单独的线程运行。</li>
<li>RecvWorker 负责从其他节点接收数据，并且将数据发送给FastLeaderElection，在单独的线程运行。</li>
</ul>
<p>FastLeaderElection负责选举的算法处理，该类包含如下主要inner class。</p>
<ul>
<li>Messenger 发送和接收数据的管理类。注意，此处的发送和接收数据更关注的是打包和解包相关的逻辑，而不和网络相关，网络相关的部分由QuorumCnxManager负责。</li>
<li>WorkerSender 负责打包选举数据，发送到其他节点，在单独的线程运行。</li>
<li>WorkerReceiver 负责解析接收到数据，并根据结果反馈对应的ACK，在单独的线程运行。</li>
</ul>
<blockquote>
<p>WorkerSender和WorkerReceiver为守护线程</p>
</blockquote>
<p><strong>选举启动流程:</strong>  </p>
<img src="/2020/04/29/zk/zkSrc_election/fast_election_flow.png" class="">

<p>FastLeader启动后：  </p>
<ul>
<li>创建QuorumCnxManager实例，并且开始监听其他节点新建的连接。</li>
<li>创建FastLeaderElection实例，并且开启发送和接收数据的线程。(Messenger类会启动WorkerSender和WorkReceiver的线程)</li>
</ul>
<p><strong>触发选举:</strong></p>
<p>新启动节点的状态为LOOKING，在节点主线程启动后(QuorumPeer.run)，调用Election的lookForLeader方法获取Leader信息。</p>
<p>发送数据到其他节点的数据流向：</p>
<img src="/2020/04/29/zk/zkSrc_election/send_flow.png" class="">

<p>详细时序图：</p>
<img src="/2020/04/29/zk/zkSrc_election/send_seq.png" class="">

<p>当FastLeaderElection要发送数据时，会通过向sendqueue发送数据来异步调用 WorkerSender.process。<br>在QuorumCnxManager.toSend的实现中，若到发送目标节点的连接不存在，则会主动建立连接。<br>QuorumCnxManager调用connectOne通过将数据添加到发送列表来异步调用SendWorker.send。</p>
<p>在发送端建立连接时，首先会发送一个头信息，包括：</p>
<ul>
<li>版本信息</li>
<li>前节点的server id</li>
<li>ip地址信息</li>
</ul>
<p>详细信息详见QuorumCnxManager.initiateConnection</p>
<p>接收方收到连接的时序图：</p>
<img src="/2020/04/29/zk/zkSrc_election/listen_seq.png" class="">

<p>在接收端收到新连接时，首先会解析发送方发送的头信息。为了保证两个节点之间只有一个连接（即不会出现A建立连接到B，同时B也建立连接到A），zk会检查建立连接的节点的id。若发起连接的节点id小于当前节点，zk会断开这连接，并且主动建立一个到对方节点的连接。</p>
<p>接收数据的流向为:</p>
<img src="/2020/04/29/zk/zkSrc_election/recv_flow.png" class="">

<p>详细时序图：</p>
<img src="/2020/04/29/zk/zkSrc_election/recv_seq.png" class="">

<p>RecvWorker在收到数据后，调用addToRecvQueue将数据添加到队列，WorkerReceiver从队列取数据处理。WorkerReceiver处理逻辑如下:</p>
<ul>
<li>检查对方节点是否参与选举，不参与选举的话直接返回当前节点的结果。</li>
<li>若当前节点也在LOOKING状态，则将对方节点选举的结果添加到接收队列。若对方节点处于LOOKING状态，且electionEpoch落后于当前节点logicalclock，则发送当前节点的proposed选举信息到对方节点。</li>
<li>若当前节点处于选举成功状态(不是LOOKING状态)，则发送当前节点的选举结果到对方节点。</li>
</ul>
<h2 id="zxid以及ElectionEpoch"><a href="#zxid以及ElectionEpoch" class="headerlink" title="zxid以及ElectionEpoch"></a>zxid以及ElectionEpoch</h2><h3 id="zxid"><a href="#zxid" class="headerlink" title="zxid"></a>zxid</h3><p>选举中会使用到数据库中最新的事务id(ZKDatabase.getDataTreeLastProcessedZxid()), 事务id由两部分组成，高32位表示Epoch，每次有新的节点当选会+1(Leader.lead())；后32位为事务id，有新的节点当选，该部分会从0重新开始。当数据库有写操作时，整个事务id会+1（参考ZooKeeperServer.getNextZxid()的引用）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZxidUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getEpochFromZxid</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zxid &gt;&gt; <span class="number">32L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getCounterFromZxid</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> zxid &amp; <span class="number">0xffffffffL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">makeZxid</span><span class="params">(<span class="keyword">long</span> epoch, <span class="keyword">long</span> counter)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 前32位表示Epoch，后32位表示当前Epoch的事务号，新Leader节点lead()函数epoch+1，count从0开始</span></span><br><span class="line">        <span class="keyword">return</span> (epoch &lt;&lt; <span class="number">32L</span>) | (counter &amp; <span class="number">0xffffffffL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">zxidToString</span><span class="params">(<span class="keyword">long</span> zxid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Long.toHexString(zxid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ElectionEpoch"><a href="#ElectionEpoch" class="headerlink" title="ElectionEpoch"></a>ElectionEpoch</h3><p>当前节点的ElectionEpoch定义于FastLeaderElection.logicalclock中，每发起一次新选举，该值会自+1。若其他节点选举信息中的ElectionEpoch大于当前节点，则会设置当前节点的值为接收到的值。</p>
<hr>
<h2 id="ZOOKEEPER-1732"><a href="#ZOOKEEPER-1732" class="headerlink" title="ZOOKEEPER-1732"></a>ZOOKEEPER-1732</h2><p>QuorumPeer.updateElectionVote<br>Vote.equals</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/04/29/zk/zkSrc_arch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/zk/zkSrc_arch/" class="post-title-link" itemprop="url">zookeeper源码-1.架构</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 05:45:16" itemprop="dateCreated datePublished" datetime="2020-04-29T05:45:16+00:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-06-06 14:16:33" itemprop="dateModified" datetime="2020-06-06T14:16:33+00:00">2020-06-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/zookeeper/" itemprop="url" rel="index"><span itemprop="name">zookeeper</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="节点架构"><a href="#节点架构" class="headerlink" title="节点架构"></a>节点架构</h2><img src="/2020/04/29/zk/zkSrc_arch/%E8%8A%82%E7%82%B9%E6%9E%B6%E6%9E%84.png" class="">

<ol>
<li>QuorumPeerMain<br>服务器启动main入口，创建DatadirCleanupManager，按照config启动QuorumPeer  </li>
<li>QuorumPeer<br>节点类，根据节点类型管理和启动对应服务，管理选举算法及客户端连接。</li>
<li>Election<br>QuorumPeer根据配置选取合适的选举算法。</li>
<li>ServerCnxnFactory<br>管理客户端连接，QuorumPeer根据配置选取合适的实现。</li>
<li>ZooKeeperServer<br>zk服务器节点，根据不同类型实现不同方法。</li>
<li>ZKDatabase<br>zk内存数据库，详细数据保存在DataTree类中。</li>
<li>RequestProcessor<br>客户端请求处理类，不同zk节点类型会定义不同的处理类。</li>
</ol>
<hr>
<h2 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h2><ul>
<li>Leader</li>
<li>Follower</li>
<li>Observer</li>
</ul>
<p>Leader和Follower参与新Leader的选举，Observer不参与选举。  </p>
<img src="/2020/04/29/zk/zkSrc_arch/%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B.png" class="">

<h3 id="Leader节点"><a href="#Leader节点" class="headerlink" title="Leader节点"></a>Leader节点</h3><p>Leader负责数据的写操作和各节点数据一致性</p>
<img src="/2020/04/29/zk/zkSrc_arch/leader_class.png" class="">

<h4 id="LeaderZooKeeperServer"><a href="#LeaderZooKeeperServer" class="headerlink" title="LeaderZooKeeperServer"></a>LeaderZooKeeperServer</h4><p>Leader节点对应的设置</p>
<h4 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h4><p>负责管理Leader相关逻辑的类。维护了一组LearnerHandler信息来处理和Learner的交互。</p>
<h4 id="LearnerHandler"><a href="#LearnerHandler" class="headerlink" title="LearnerHandler"></a>LearnerHandler</h4><p>LearnerHandler用来处理Leader和Learner之间的交互，例如发送Packets到Learner，从Learner接收Packet并处理等。</p>
<h4 id="Leader-Processors"><a href="#Leader-Processors" class="headerlink" title="Leader Processors"></a>Leader Processors</h4><p>Processor用来处理客户端的请求，Leader的firstProcessor为LeaderRequestProcessor的一个实例。处理Request使用的是职责链模式，Processor之间的虚线表示的是Request的处理流程。</p>
<h3 id="Follower节点"><a href="#Follower节点" class="headerlink" title="Follower节点"></a>Follower节点</h3><p>Follower节点对外提供服务，同时参与选举Leader。</p>


<h4 id="FollowerZooKeeperServer"><a href="#FollowerZooKeeperServer" class="headerlink" title="FollowerZooKeeperServer"></a>FollowerZooKeeperServer</h4><p>Follower节点对应的设置。</p>
<h4 id="Follower"><a href="#Follower" class="headerlink" title="Follower"></a>Follower</h4><p>负责Follower相关逻辑的类，主要用于管理和Leader节点的交互，如PING，PROPOSAL，COMMIT等Request的处理等。</p>
<h4 id="Follower-Processors"><a href="#Follower-Processors" class="headerlink" title="Follower Processors"></a>Follower Processors</h4><p>Follower的Processors主要用来处理来自客户端的请求，Follower的firstProcessor为FollowerRequestProcessor，也是职责链模式，流程处理由虚线表示。</p>
<h3 id="Observer节点"><a href="#Observer节点" class="headerlink" title="Observer节点"></a>Observer节点</h3><p>TODO</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yiduoyunQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">31</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yiduoyunQ</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
