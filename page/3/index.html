<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yiduoyunq.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="yiduoyunQ">
<meta property="og:url" content="https://yiduoyunq.github.io/page/3/index.html">
<meta property="og:site_name" content="yiduoyunQ">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yiduoyunQ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yiduoyunq.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>yiduoyunQ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yiduoyunQ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/21/mysql/mysqldump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/21/mysql/mysqldump/" class="post-title-link" itemprop="url">mysqldump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-21 00:54:09" itemprop="dateCreated datePublished" datetime="2020-07-21T00:54:09+00:00">2020-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致"><a href="#默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致" class="headerlink" title="默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致"></a>默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致</h2><ol>
<li>获取gtid或file postion</li>
<li>顺序逻辑备份每个库，不同库之间备份时间点不同<br>2.1 同时lock库中所有表READ锁，使库变为只读<br>2.2 show create table + select * from table， 导出<br>2.3 unlock tables</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-01T</span><span class="token time number">16:02:01.441631Z</span>	   <span class="token number">18</span> Query	SHOW CREATE DATABASE IF NOT EXISTS `test`
<span class="token date number">2020-11-01T</span><span class="token time number">16:02:01.441820Z</span>	   <span class="token number">18</span> Query	show tables
<span class="token date number">2020-11-01T</span><span class="token time number">16:02:01.442210Z</span>	   <span class="token number">18</span> Query	LOCK TABLES `employees` READ <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">32311</span> LOCAL <span class="token operator">*</span><span class="token operator">/</span><span class="token punctuation">,</span>`t1` READ <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">32311</span> LOCAL <span class="token operator">*</span><span class="token operator">/</span><span class="token punctuation">,</span>`test` READ <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">32311</span> LOCAL <span class="token operator">*</span><span class="token operator">/</span><span class="token punctuation">,</span>`test_auto` READ <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">32311</span> LOCAL <span class="token operator">*</span><span class="token operator">/</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:02:04.181862Z</span>	   <span class="token number">18</span> Query	UNLOCK TABLES<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="–lock-all-tables-所有库备份点一致"><a href="#–lock-all-tables-所有库备份点一致" class="headerlink" title="–lock-all-tables  所有库备份点一致"></a>–lock-all-tables  所有库备份点一致</h2><p>整个数据库变为只读</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-01T</span><span class="token time number">16:16:57.678240Z</span>	   <span class="token number">21</span> Query	FLUSH TABLES
<span class="token date number">2020-11-01T</span><span class="token time number">16:16:58.204729Z</span>	   <span class="token number">21</span> Query	FLUSH TABLES WITH READ LOCK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="–single-transaction-所有innodb表备份点一致"><a href="#–single-transaction-所有innodb表备份点一致" class="headerlink" title="–single-transaction  所有innodb表备份点一致"></a>–single-transaction  所有innodb表备份点一致</h2><ol>
<li>设置会话隔离级别为RR</li>
<li>开启一个MVCC会话，START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */ ，开启会话时自带一次select保证备份点之后的读一致性</li>
<li>创建SAVEPOINT开始表备份，在ROLLBACK TO SAVEPOINT前对表的DDL阻塞</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.440889Z</span>	   <span class="token number">22</span> Query	SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.441080Z</span>	   <span class="token number">22</span> Query	START TRANSACTION <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">40100</span> WITH CONSISTENT SNAPSHOT <span class="token operator">*</span><span class="token operator">/</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.451846Z</span>	   <span class="token number">22</span> Query	UNLOCK TABLES
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.471418Z</span>	   <span class="token number">22</span> Query	SHOW CREATE DATABASE IF NOT EXISTS `test`
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.471499Z</span>	   <span class="token number">22</span> Query	SAVEPOINT sp
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.478244Z</span>	   <span class="token number">22</span> Query	show tables
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.484877Z</span>	   <span class="token number">22</span> Query	show create table `t1`
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.486464Z</span>	   <span class="token number">22</span> Query	SELECT <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">40001</span> SQL_NO_CACHE <span class="token operator">*</span><span class="token operator">/</span> <span class="token operator">*</span> FROM `t1`
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.488296Z</span>	   <span class="token number">22</span> Query	ROLLBACK TO SAVEPOINT sp
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.489280Z</span>	   <span class="token number">22</span> Query	show create table `test`
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:35.497826Z</span>	   <span class="token number">22</span> Query	SELECT <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">40001</span> SQL_NO_CACHE <span class="token operator">*</span><span class="token operator">/</span> <span class="token operator">*</span> FROM `test`
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:38.400419Z</span>	   <span class="token number">22</span> Query	ROLLBACK TO SAVEPOINT sp
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:20:38.403299Z</span>	   <span class="token number">22</span> Query	RELEASE SAVEPOINT sp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="–single-transaction-–master-data-x3D-2-需2次flush关表"><a href="#–single-transaction-–master-data-x3D-2-需2次flush关表" class="headerlink" title="–single-transaction + –master-data=2    需2次flush关表"></a>–single-transaction + –master-data=2    需2次flush关表</h2><p>–master-data需导出当前binlog位点，因此需FTWRL将数据库数据达到一致</p>
<ol>
<li>flush tables + FTWRL 整个数据库达到一致</li>
<li>设置RR，开启一致读会话</li>
<li>通过show master status获取binlog位点</li>
<li>UNLOCK TABLES</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log"><span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.165353Z</span>	   <span class="token number">23</span> Query	FLUSH <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">40101</span> LOCAL <span class="token operator">*</span><span class="token operator">/</span> TABLES
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.190316Z</span>	   <span class="token number">23</span> Query	FLUSH TABLES WITH READ LOCK
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.190471Z</span>	   <span class="token number">23</span> Query	SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.190537Z</span>	   <span class="token number">23</span> Query	START TRANSACTION <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">!</span><span class="token number">40100</span> WITH CONSISTENT SNAPSHOT <span class="token operator">*</span><span class="token operator">/</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.190744Z</span>	   <span class="token number">23</span> Query	SHOW VARIABLES LIKE <span class="token string">'gtid\_mode'</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.202013Z</span>	   <span class="token number">23</span> Query	SHOW MASTER <span class="token level info keyword">STATUS</span>
<span class="token date number">2020-11-01T</span><span class="token time number">16:47:40.204813Z</span>	   <span class="token number">23</span> Query	UNLOCK TABLES
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>mysql –max-allowed-packet=16MB -BNe “SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME NOT IN (‘mysql’, ‘performance_schema’, ‘information_schema’, ‘sys’)” | tr ‘\n’ ‘ ‘ &gt; dbs.sql<br>mysqldump  –opt –add-drop-database –add-drop-table –complete-insert –default-character-set=utf8 –hex-blob –master-data=2 –quote-names –single-transaction –events –routines –triggers –databases $(cat dbs.sql) &gt; full_dump.sql</p>
<ul>
<li><p>-q, –quick   Don’t buffer query, dump directly to stdout. (Defaults to on; use –skip-quick to disable.)</p>
</li>
<li><p>–opt : Shorthand for –add-drop-table –add-locks –create-options –extended-insert –lock-tables –quick –set-charset</p>
</li>
<li><p>–lock-tables Lock all tables before dumping them</p>
</li>
<li><p>–single-transaction Issue a BEGIN SQL statement before dumping data from server</p>
</li>
<li><p>–hex-blob Dump binary columns using hexadecimal notation (for example, ‘abc’ becomes 0x616263)</p>
</li>
<li><p>–master-data=2 Write the binary log file name and position to the output as an SQL comment</p>
</li>
<li><p>–max-allowed-packet Maximum packet length to send to or receive from server</p>
</li>
<li><p>–events</p>
</li>
<li><p>–routines</p>
</li>
<li><p>–triggers</p>
</li>
<li><p>–complete-insert Use complete INSERT statements that include column names</p>
</li>
<li><p>–set-charset Add SET NAMES default_character_set to output</p>
</li>
<li><p>–add-drop-database</p>
</li>
<li><p>–add-drop-table</p>
</li>
<li><p>–add-locks</p>
</li>
<li><p>–default-character-set=utf8</p>
</li>
<li><p>–quick 流式取数据，非单次填充整个结果集到内存</p>
</li>
<li><p>–extended-insert Use multiple-row INSERT syntax</p>
</li>
<li><p>–create-options Include all MySQL-specific table options in CREATE TABLE statements</p>
</li>
<li><p>–flush-logs Flush MySQL server log files before starting dump</p>
</li>
<li><p>–lock-all-tables Lock all tables across all databases</p>
</li>
<li><p>–set-gtid-purged Whether to add SET @@GLOBAL.GTID_PURGED to output</p>
</li>
<li><p>–databases</p>
</li>
<li><p>–tables</p>
</li>
<li><p>–no-create-db</p>
</li>
<li><p>–no-create-info</p>
</li>
<li><p>–no-data</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/19/sys/tcpdump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/19/sys/tcpdump/" class="post-title-link" itemprop="url">tcpdump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-19 20:44:37" itemprop="dateCreated datePublished" datetime="2020-07-19T20:44:37+00:00">2020-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token shebang important">#!/usr/bin/sh</span>
<span class="token builtin class-name">set</span> <span class="token parameter variable">-o</span> errexit
<span class="token function">nohup</span> tcpdump <span class="token parameter variable">-i</span> eth0 <span class="token parameter variable">-C</span> <span class="token number">512</span> <span class="token parameter variable">-W</span> <span class="token number">4</span> <span class="token parameter variable">-w</span> /tmp/tcpdump.cap <span class="token operator">&amp;</span>
<span class="token function">sleep</span> <span class="token number">3</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>client &amp; server 互相确认对方receive和send</p>
<img src="/2020/07/19/sys/tcpdump/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg" class="">

<ul>
<li>第一次握手 server： client send ok，server receive ok</li>
<li>第二次握手 client： client receive&amp;send ok， server receive&amp;send ok</li>
<li>第三次握手 server： client receive&amp;send ok， server receive&amp;send ok</li>
</ul>
<h3 id="两次握手问题"><a href="#两次握手问题" class="headerlink" title="两次握手问题"></a>两次握手问题</h3><ol>
<li>client first SYNC delayed</li>
<li>client second SYNC</li>
<li>server receive second SYNC &amp; ACK， conn established</li>
<li>client and server normally close conn</li>
<li>server receive delayed first SYNC &amp; ACK， conn established</li>
<li>client refuse first SYNC &amp; ACK， conn on server side will never close</li>
</ol>
<h3 id="半队列和全队列"><a href="#半队列和全队列" class="headerlink" title="半队列和全队列"></a>半队列和全队列</h3><ul>
<li>内核层队列默认参数net.core.somaxconn = 128</li>
<li>server端SYNC-RCVD状态连接存入半队列，不能大于内核somaxconn<ul>
<li>半队列默认参数net.ipv4.tcp_max_syn_backlog = 1024，当net.ipv4.tcp_syncookies = 1时半连接队列逻辑上无上限，该参数无效。</li>
<li>取min(backlog, tcp_max_syn_backlog, somaxconn)</li>
</ul>
</li>
<li>server端ESTABLISHED状态连接存入全队列，不能大于内核somaxconn<ul>
<li>全队列backlog参数由应用调用系统底层API: int listen(int sockfd, int backlog)时传入</li>
</ul>
</li>
</ul>
<h3 id="sync攻击"><a href="#sync攻击" class="headerlink" title="sync攻击"></a>sync攻击</h3><p>client短时间内伪造大量不存在ip来源sync包，server端ack由于ip不存在不断重发直至超时，占用半队列。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">netstat</span> <span class="token parameter variable">-n</span> <span class="token parameter variable">-p</span> TCP <span class="token operator">|</span> <span class="token function">grep</span> SYN_RECV<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="系统message打印kernel：-TCP-request-sock-TCP-Possible-SYN-flooding-on-port-xxx-Sending-cookies"><a href="#系统message打印kernel：-TCP-request-sock-TCP-Possible-SYN-flooding-on-port-xxx-Sending-cookies" class="headerlink" title="系统message打印kernel： TCP request_sock_TCP: Possible SYN flooding on port xxx. Sending cookies."></a>系统message打印<code>kernel： TCP request_sock_TCP: Possible SYN flooding on port xxx. Sending cookies.</code></h3><p>client短时间大量SYN包，半队列无法及时处理，服务器自动启用net.ipv4.tcp_syncookies = 1</p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><img src="/2020/07/19/sys/tcpdump/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg" class="">

<ul>
<li>第一次挥手： client发送FIN，处于FIN_WAIT1</li>
<li>第二次挥手：<ul>
<li>server收到FIN，发送ACK，处于CLOSE_WAIT</li>
<li>client收到ACK，进入FIN_WAIT2，等待server</li>
</ul>
</li>
<li>第三次挥手： server发送FIN，进入LAST_ACK</li>
<li>第四次挥手：<ul>
<li>client收到FIN，发送ACK，进入TIME_WAIT(2MSL)</li>
<li>server收到ACK，进入CLOSED</li>
</ul>
</li>
</ul>
<h3 id="为什么四次挥手"><a href="#为什么四次挥手" class="headerlink" title="为什么四次挥手"></a>为什么四次挥手</h3><p>第一次+第二次： client主动发送FIN要求断开conn，server ACK确认收到FIN<br>第三次+第四次： server完成必要动作后，发送FIN确认可断开conn，client ACK确认</p>
<h3 id="TIME-WAIT（2MSL）"><a href="#TIME-WAIT（2MSL）" class="headerlink" title="TIME_WAIT（2MSL）"></a>TIME_WAIT（2MSL）</h3><p>client ACK后若不等待2MSL而直接close conn，假设ACK丢失，server FIN超时重发，由于client已close conn会响应RST，server收到RST后无法正常close conn。</p>
<h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><ul>
<li>property(displayed/caputured)</li>
<li>filter<ul>
<li>frame.time</li>
<li>ip.src/dst</li>
<li>tcp.port/srcport/dstport</li>
</ul>
</li>
<li>ayalyze<ul>
<li>expert information</li>
</ul>
</li>
<li>statistic<ul>
<li>protocol hierarchy</li>
<li>conversation<ul>
<li>endpoint</li>
</ul>
</li>
<li>io graph</li>
<li>flow graph</li>
</ul>
</li>
</ul>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><blockquote>
<p>结构数据小<br>无需建立连接，直接发送接收数据<br>TCP保证数据顺序有效，UDP不保证顺序且可能丢包</p>
</blockquote>
<h2 id="http2-wireshark"><a href="#http2-wireshark" class="headerlink" title="http2 wireshark"></a>http2 wireshark</h2><p>analyze -&gt; enabled protocols -&gt; 选中HTTP2<br>analyze -&gt; decode as -&gt; tcp port 的[current] 设置为HTTP2</p>
<img src="/2020/07/19/sys/tcpdump/http2_req.png" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res.png" class="">

<img src="/2020/07/19/sys/tcpdump/http2_req_head.jpeg" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res_head_false.jpeg" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res_head_true.jpeg" class="">

<h2 id="How-to-get-tcpdump-for-containers-inside-Kubernetes-pods-How-to-get-tcpdump-for-containers-inside-Kubernetes-pods"><a href="#How-to-get-tcpdump-for-containers-inside-Kubernetes-pods-How-to-get-tcpdump-for-containers-inside-Kubernetes-pods" class="headerlink" title="[How to get tcpdump for containers inside Kubernetes pods](How to get tcpdump for containers inside Kubernetes pods)"></a>[How to get tcpdump for containers inside Kubernetes pods](<a target="_blank" rel="noopener" href="https://pvtl.force.com/s/article/How-to-get-tcpdump-for-containers-inside-Kubernetes-pods?language=en_US">How to get tcpdump for containers inside Kubernetes pods</a>)</h2><p>kubectl -n ns exec -it pod – sh<br>cat /sys/class/net/eth0/iflink<br>ip link |grep ^xx</p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><a href="https://mp.weixin.qq.com/s/-Q1AkxUr9xzGKwUMV-FQhQ" title="" target="">云网络丢包故障定位</a>
<a href="https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables" title="" target="">why-is-the-kernel-community-replacing-iptables</a>


<p>TODO SSL</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">docker命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-17 00:28:00" itemprop="dateCreated datePublished" datetime="2020-07-17T00:28:00+00:00">2020-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>docker rm<br>docker rmi<br>docker pull<br>docker push<br>docker run</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token parameter variable">-a</span>
<span class="token function">docker</span> inspect <span class="token variable">$id</span>
<span class="token function">docker</span> stats <span class="token variable">$id</span>
<span class="token function">docker</span> <span class="token function">top</span> <span class="token variable">$id</span>

<span class="token function">docker</span> start <span class="token variable">$id</span>
<span class="token function">docker</span> stop <span class="token variable">$id</span>

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token variable">$id</span> <span class="token function">bash</span>

<span class="token function">docker</span> <span class="token function">kill</span> <span class="token parameter variable">--signal</span><span class="token operator">=</span><span class="token number">1</span> <span class="token variable">$id</span>
<span class="token function">docker</span> <span class="token function">rename</span> <span class="token variable">$id</span> <span class="token punctuation">{</span>new_name<span class="token punctuation">}</span>
<span class="token function">docker</span> update --cpuset-cpus<span class="token operator">=</span><span class="token number">0</span>-3 <span class="token variable">$id</span>

<span class="token function">docker</span> tag SOURCE_IMAGE<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span> TARGET_IMAGE<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span>
<span class="token function">docker</span> save <span class="token parameter variable">-o</span> target_image.tag.tar TARGET_IMAGE<span class="token punctuation">[</span>:TAG<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/02/sys/inode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/02/sys/inode/" class="post-title-link" itemprop="url">文件系统</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-02 21:00:00" itemprop="dateCreated datePublished" datetime="2020-07-02T21:00:00+00:00">2020-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="文件名和文件系统"><a href="#文件名和文件系统" class="headerlink" title="文件名和文件系统"></a>文件名和文件系统</h2><img src="/2020/07/02/sys/inode/inode.jpeg" class="">

<ul>
<li><strong>inode</strong> 和 <strong>文件名</strong> 映射关系保存在 <code>文件名目录</code> 中，<strong>文件名</strong> 的变动不会修改文件inode信息</li>
<li>通过 <strong>inode table</strong> 找到文件 <code>元数据</code> 和 <code>文件内容</code>， 包含 <strong>引用计数</strong> 等信息</li>
<li><code>i_count</code> 是文件被进程引用计数，<code>i_nlink</code> 是硬链接(磁盘)引用计数， <strong>rm</strong> 命令减少 <code>i_nlink</code>， 当 <code>i_count</code> 和 <code>i_nlink</code> 均为0时，文件才被删除(<strong>inode</strong> 和 <strong>文件名</strong> 的映射被删除，实际磁盘上block数据块未删除)。</li>
</ul>
<blockquote>
<p>请注意，如果使用 rm 来删除文件，通常仍可以将该文件恢复原状。如果想保证该文件的内容无法还原，请考虑使用shred</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/23/git/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/23/git/" class="post-title-link" itemprop="url">git</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-23 13:40:07" itemprop="dateCreated datePublished" datetime="2020-06-23T13:40:07+00:00">2020-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/git/" itemprop="url" rel="index"><span itemprop="name">git</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>git commit –amend –no-edit</p>
<p>git tag<br>git tag v1.4<br>git tag -a v1.4 -m “my version 1.4” {commit_id}<br>git show v1.4<br>git push origin –delete <tagname></tagname></p>
<p>git log // 查找要删除的前一次提交的 commit_id<br>git rebase -i commit_id // 将 commit_id 替换成复制的值<br>git push origin HEAD –force // 强制推送到远端</p>
<h2 id="stash"><a href="#stash" class="headerlink" title="stash"></a>stash</h2><p>git stash<br>git stash list<br>git stash pop</p>
<h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><p><code>git diff v2.1.29 v2.1.29-updrdb --name-only | wc -l</code></p>
<h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><p><code>master$ git merge dev</code></p>
<ul>
<li>fast forward 不会创建新的commit</li>
<li>no fast forward 会创建新的commit</li>
<li>merge冲突 手动修改后commit</li>
</ul>
<h2 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h2><p><code>dev$ git rebase master</code></p>
<p>获取master最新修改，而不提交。rabase后未提交区内容基于最新master代码。</p>
<h2 id="交互rebase"><a href="#交互rebase" class="headerlink" title="交互rebase"></a>交互rebase</h2><p><code>master$ git rebase -i HEAD~3</code></p>
<p>默认pick。<br>修改为drop后移除对应commit，最后可push到仓库修改历史commit。<br>修改为squash将两个commit合并。</p>
<h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><p><code>dev$ git reset --soft HEAD~3</code></p>
<h3 id="soft"><a href="#soft" class="headerlink" title="soft"></a>soft</h3><p><code>master$ git reset --soft HEAD~3</code><br><code>master$ git status</code></p>
<p>HEAD指向HEAD~3，期间的提交保留在未commit区</p>
<h3 id="hard"><a href="#hard" class="headerlink" title="hard"></a>hard</h3><p><code>master$ git reset --soft HEAD~3</code><br><code>master$ git status</code></p>
<p>HEAD指向HEAD~3，期间的提交被回退</p>
<h2 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h2><p><code>dev$ git revert ec5be</code></p>
<p>将<strong>ec5be</strong>的修改还原，并创建新的未提交commit</p>
<h2 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h2><p><code>master$ git cherry-pick 76d12</code></p>
<p>从其他分支中整合某一次commit修改内容到当前分支</p>
<h2 id="reflog"><a href="#reflog" class="headerlink" title="reflog"></a>reflog</h2><p><code>master$ git reflog</code><br><code>master$ git reset HEAD@{1}</code><br><code>master$ git reflog</code></p>
<p>展示所有已执行git动作</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/132573100" title="" target="">动图展示10大Git命令</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">k8s基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-19 23:18:47" itemprop="dateCreated datePublished" datetime="2020-06-19T23:18:47+00:00">2020-06-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO-apiserver"><a href="#TODO-apiserver" class="headerlink" title="TODO apiserver"></a>TODO apiserver</h2><img src="/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/API-server-flow.png" class="">
<img src="/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/API-server-storage-flow.png" class="">

<p><a target="_blank" rel="noopener" href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-1">https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-1</a></p>
<h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><p>有三种方式指定 Pod 只运行在指定的 Node 节点上</p>
<ul>
<li>nodeSelector：只调度到匹配指定 label 的 Node 上</li>
<li>nodeAffinity：功能更丰富的 Node 选择器，比如支持集合操作</li>
<li>podAffinity：调度到满足条件的 Pod 所在的 Node 上</li>
<li>Taints 和 tolerations：Taints 和 tolerations 用于保证 Pod 不被调度到不合适的 Node 上，其中 Taint 应用于 Node 上，而 toleration 则应用于 Pod 上</li>
<li>优先级调度</li>
</ul>
<h3 id="调度工作原理"><a href="#调度工作原理" class="headerlink" title="调度工作原理"></a>调度工作原理</h3><p>kube-scheduler 调度分为两个阶段，predicate 和 priority</p>
<ul>
<li>predicate：过滤不符合条件的节点</li>
<li>priority：优先级排序，选择优先级最高的节点</li>
</ul>
<p>代码入口：pkg/scheduler，cmd/kube-scheduler</p>
<h3 id="滚动扩容升级-TODO"><a href="#滚动扩容升级-TODO" class="headerlink" title="滚动扩容升级 TODO"></a>滚动扩容升级 TODO</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl scale <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">3</span> deployment/nginx-app
kubectl rolling-update frontend-v1 frontend-v2 <span class="token parameter variable">--image</span><span class="token operator">=</span>image:v2
kubectl rolling-update frontend-v1 frontend-v2 <span class="token parameter variable">--rollback</span>
kubectl <span class="token builtin class-name">set</span> image deployment/nginx-app nginx-app<span class="token operator">=</span>nginx:1.9.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="Etcd，Zookeeper，Consul-比较"><a href="#Etcd，Zookeeper，Consul-比较" class="headerlink" title="Etcd，Zookeeper，Consul 比较"></a>Etcd，Zookeeper，Consul 比较</h2><p>Etcd 和 Zookeeper 提供的是分布式一致性存储能力，具体的业务场景需要用户自己实现，比如服务发现，比如配置变更。而 Consul 则以服务发现和配置变更为主要目标，同时附带了 kv 存储。</p>
<hr>
<h2 id="阿里云镜像加速"><a href="#阿里云镜像加速" class="headerlink" title="阿里云镜像加速"></a>阿里云镜像加速</h2><p><a target="_blank" rel="noopener" href="https://cr.console.aliyun.com/cn/instances/images">https://cr.console.aliyun.com/cn/instances/images</a></p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul>
<li>node</li>
<li>pod</li>
<li>service<ul>
<li>NodePort</li>
</ul>
</li>
<li>Volume</li>
<li>Label</li>
<li>RC</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><ul>
<li>etcd</li>
<li>APIServer</li>
<li>ControllerManager</li>
<li>Scheduler</li>
<li>Kubelet</li>
<li>Proxy</li>
</ul>
<h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ul>
<li>申明式操作，分布式重复操作结果等幂，API接口命名描述期望如Service、Volume</li>
<li>互补可组合，高内聚松耦合</li>
<li>操作复杂度不应高于O(N)，满足水平伸缩性</li>
</ul>
<h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl config set-credentials myself <span class="token parameter variable">--username</span><span class="token operator">=</span>admin <span class="token parameter variable">--password</span><span class="token operator">=</span>secret
kubectl config set-cluster local-server <span class="token parameter variable">--server</span><span class="token operator">=</span>http://localhost:8080
kubectl config set-context default-context <span class="token parameter variable">--cluster</span><span class="token operator">=</span>local-server <span class="token parameter variable">--user</span><span class="token operator">=</span>myself <span class="token parameter variable">--namespace</span><span class="token operator">=</span>default
kubectl config use-context default-context
kubectl config view<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><ul>
<li><code>journalctl -f -u kubelet.service</code></li>
<li>可用api: <code>kubectl api-resources</code></li>
<li>创建：<code>kubectl run &lt;name&gt; --image=&lt;image&gt;</code> 或者 <code>kubectl create -f manifest.yaml</code></li>
<li>查询：<code>kubectl get &lt;resource&gt;</code></li>
<li>更新 <code>kubectl set 或者 kubectl patch</code></li>
<li>删除：<code>kubectl delete &lt;resource&gt; &lt;name&gt;</code> 或者 <code>kubectl delete -f manifest.yaml</code></li>
<li>查询 <code>Pod IP：kubectl get pod &lt;pod-name&gt; -o jsonpath='{.status.podIP}'</code></li>
<li>容器内执行命令：<code>kubectl exec -ti &lt;pod-name&gt; sh</code></li>
<li>容器日志：<code>kubectl logs [-f] &lt;pod-name&gt;</code></li>
<li>导出服务：<code>kubectl expose deploy &lt;name&gt; --port=80</code></li>
<li>查看描述: <code>kubectl describe</code></li>
</ul>
<h3 id="命令自动补全"><a href="#命令自动补全" class="headerlink" title="命令自动补全"></a>命令自动补全</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">source</span> /usr/share/bash-completion/bash_completion
<span class="token builtin class-name">source</span> <span class="token operator">&lt;</span><span class="token punctuation">(</span>kubectl completion <span class="token function">bash</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="自定义输出列"><a href="#自定义输出列" class="headerlink" title="自定义输出列"></a>自定义输出列</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get pods --all-namespaces <span class="token parameter variable">-o</span> custom-columns<span class="token operator">=</span>NS:.metadata.namespace,NAME:.metadata.name,<span class="token string">"CPU(requests)"</span>:.spec.containers<span class="token punctuation">[</span>*<span class="token punctuation">]</span>.resources.requests.cpu,<span class="token string">"CPU(limits)"</span>:.spec.containers<span class="token punctuation">[</span>*<span class="token punctuation">]</span>.resources.limits.cpu,<span class="token string">"MEMORY(requests)"</span>:.spec.containers<span class="token punctuation">[</span>*<span class="token punctuation">]</span>.resources.requests.memory,<span class="token string">"MEMORY(limits)"</span>:.spec.containers<span class="token punctuation">[</span>*<span class="token punctuation">]</span>.resources.limits.memory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p>kubectl port-forward</p>
<h2 id="Autoscaling"><a href="#Autoscaling" class="headerlink" title="Autoscaling"></a>Autoscaling</h2><p>kubectl run php-apache –image={阿里云镜像加速}/hpa-example –requests=cpu=200m –expose –port=80<br>kubectl autoscale deployment php-apache –cpu-percent=50 –min=1 –max=10<br>kubectl describe pod php-apach</p>
<p>kubectl delete svc php-apache<br>kubectl delete pod php-apache</p>
<ul>
<li><a href="https://kubernetes.feisky.xyz/concepts/objects/autoscaling" title="" target="">HPA</a></li>
</ul>
<h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><ul>
<li>设置环境变量</li>
<li>设置容器命令行参数</li>
<li>Volume中直接挂载文件或目录</li>
</ul>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">special.how</span><span class="token punctuation">:</span> very
  <span class="token key atrule">special.type</span><span class="token punctuation">:</span> charm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">log_level</span><span class="token punctuation">:</span> INFO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container
      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
      <span class="token comment">#command: ["/bin/sh", "-c", "env"]</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)"</span> <span class="token punctuation">]</span>
      <span class="token comment">#command: ["/bin/sh", "-c", "cat /etc/config/special.how"]</span>
      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
        <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/config
      <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_LEVEL_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config
              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.how
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_TYPE_KEY
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config
              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.type
      <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
            <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
      <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create <span class="token parameter variable">-f</span> special-config.yaml
kubectl create <span class="token parameter variable">-f</span> env-config.yaml
kubectl create <span class="token parameter variable">-f</span> pod.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h2 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl create <span class="token parameter variable">-f</span> cronjob.yaml

kubectl get cronjob
kubectl get <span class="token function">jobs</span>
kubectl logs hello-1593447840-ns2z7

kubectl delete cronjob hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="CustomResourceDefinition"><a href="#CustomResourceDefinition" class="headerlink" title="CustomResourceDefinition"></a>CustomResourceDefinition</h2><p>Kubernetes API扩展</p>
<h3 id="Finalizer"><a href="#Finalizer" class="headerlink" title="Finalizer"></a>Finalizer</h3><h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><h3 id="Subresources"><a href="#Subresources" class="headerlink" title="Subresources"></a>Subresources</h3><h3 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h3><h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><ul>
<li>OnDelete：默认策略，更新模板后，只有手动删除了旧的 Pod 后才会创建新的 Pod</li>
<li>RollingUpdate：更新 DaemonSet 模版后，自动删除旧的 Pod 并创建新的 Pod</li>
</ul>
<h3 id="指定Node节点"><a href="#指定Node节点" class="headerlink" title="指定Node节点"></a>指定Node节点</h3><ul>
<li>nodeSelector</li>
<li>nodeAffinity</li>
<li>podAffinity</li>
</ul>
<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>Pod和Replica Set的声明式定义</p>
<h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>kubectl scale deployment nginx-deployment –replicas 10</p>
<h3 id="自动扩展"><a href="#自动扩展" class="headerlink" title="自动扩展"></a>自动扩展</h3><p>kubectl autoscale deployment nginx-deployment –min=10 –max=15 –cpu-percent=80</p>
<h3 id="更新镜像"><a href="#更新镜像" class="headerlink" title="更新镜像"></a>更新镜像</h3><p>kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</p>
<h3 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h3><p>kubectl rollout undo deployment/nginx-deployment</p>
<h3 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ul>
<li>定义Deployment来创建 Pod 和 ReplicaSet</li>
<li>滚动升级和回滚应用</li>
<li>扩容和缩容</li>
<li>暂停和继续Deployment</li>
</ul>
<blockquote>
<p>rs名字总是 <code>&lt;Deployment 的名字&gt;-&lt;pod template 的 hash 值 &gt;</code></p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get deploy
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment   <span class="token number">1</span>/1     <span class="token number">1</span>            <span class="token number">1</span>           10d

kubectl get rs
NAME                          DESIRED   CURRENT   READY   AGE
nginx-deployment-678645bf77   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">1</span>       24h

kubectl get pods
NAME                                READY   STATUS    RESTARTS   AGE
nginx-deployment-678645bf77-zxbdq   <span class="token number">1</span>/1     Running   <span class="token number">1</span>          24h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>更新</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl <span class="token builtin class-name">set</span> image deployment/nginx-deployment <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.1
kubectl rollout status/history deployment/nginx-deployment
kubectl rollout undo deployment/nginx-deployment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>扩容</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl scale deployment nginx-deployment <span class="token parameter variable">--replicas</span> <span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>暂停更新恢复</p>
</blockquote>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl rollout pause deployment/nginx-deployment
kubectl <span class="token builtin class-name">set</span> image deploy/nginx <span class="token assign-left variable">nginx</span><span class="token operator">=</span>nginx:1.9.0
kubectl rollout <span class="token function">history</span> deployment/nginx-deployment
kubectl rollout resume deployment/nginx-deployment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/15/k8s/kubeadm%E4%B8%8A%E6%89%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/15/k8s/kubeadm%E4%B8%8A%E6%89%8B/" class="post-title-link" itemprop="url">kubeadm上手</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-15 23:29:56" itemprop="dateCreated datePublished" datetime="2020-06-15T23:29:56+00:00">2020-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="组件安装"><a href="#组件安装" class="headerlink" title="组件安装"></a>组件安装</h2><h3 id="阿里yum源设置"><a href="#阿里yum源设置" class="headerlink" title="阿里yum源设置"></a>阿里yum源设置</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">mv</span> /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
<span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="docker-ce安装"><a href="#docker-ce安装" class="headerlink" title="docker-ce安装"></a>docker-ce安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum list docker-ce.x86_64 <span class="token parameter variable">--showduplicates</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token parameter variable">-r</span>
<span class="token comment">#yum -y install docker-ce-[VERSION]</span>
<span class="token function">wget</span> https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> containerd.io-1.2.13-3.2.el7.x86_64.rpm
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> docker-ce.x86_64
systemctl start docker.service
<span class="token function">docker</span> version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="设置cgroup-driver为systemd"><a href="#设置cgroup-driver为systemd" class="headerlink" title="设置cgroup driver为systemd"></a>设置cgroup driver为systemd</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/docker/daemon.json</span>
{
  "exec-opts": ["native.cgroupdriver=systemd"]
}
EOF</span>
systemctl restart <span class="token function">docker</span>
<span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> Cgroup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubernetes安装"><a href="#kubernetes安装" class="headerlink" title="kubernetes安装"></a>kubernetes安装</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> /etc/yum.repos.d/kubernetes.repo</span>
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 使用flannel网络必须设置cidr，网段自定</span>
<span class="token comment"># --ignore-preflight-errors all 跳过之前已安装部分（出问题时，问题解决后加上继续运行）</span>
kubeadm init --image-repository<span class="token operator">=</span>registry.aliyuncs.com/google_containers --apiserver-advertise-address<span class="token operator">=</span><span class="token number">172.19</span>.191.191 --service-cidr<span class="token operator">=</span><span class="token number">10.1</span>.0.0/16 --pod-network-cidr<span class="token operator">=</span><span class="token number">10.96</span>.0.0/16 --kubernetes-version<span class="token operator">=</span>v1.18.3
<span class="token comment"># 根据init提示执行</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="安装网络组件flannel"><a href="#安装网络组件flannel" class="headerlink" title="安装网络组件flannel"></a>安装网络组件flannel</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl apply <span class="token parameter variable">-f</span> https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
<span class="token comment">#安装完flannel，将配置拷到node节点，否则添加节点之后状态不对</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /etc/cni root@<span class="token punctuation">{</span>node<span class="token punctuation">}</span>:/etc
<span class="token comment">#这一步也要拷贝，否则节点看着正常，但是pod由于网络原因无法创建</span>
<span class="token function">scp</span> <span class="token parameter variable">-r</span> /run/flannel/ root@<span class="token punctuation">{</span>node<span class="token punctuation">}</span>:/run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="nginx部署"><a href="#nginx部署" class="headerlink" title="nginx部署"></a>nginx部署</h2><p>nginx-deployment.yaml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># for versions before 1.9.0 use apps/v1beta2</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># tells deployment to run 2 pods matching the template</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># create pods using pod definition in this template</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token comment"># unlike pod-nginx.yaml, the name is not included in the meta data as a unique name is</span>
      <span class="token comment"># generated from the deployment name</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#或者使用Never，默认Always</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>nginx-svc.yml</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># expose node port，不指定随机分配</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token comment"># svc端口</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">docker</span> pull nginx
kubectl create <span class="token parameter variable">-f</span> nginx-deployment.yaml
kubectl apply <span class="token parameter variable">-f</span> nginx-svc.yaml

kubectl get pods <span class="token parameter variable">-o</span> wide
NAME                                READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATES
nginx-deployment-558fc78868-fh5hg   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m   <span class="token number">10.96</span>.0.15   izuf6h1cr4n27ctdyzruy1z   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>
nginx-deployment-558fc78868-wrskf   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10m   <span class="token number">10.96</span>.0.16   izuf6h1cr4n27ctdyzruy1z   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP   <span class="token number">10.1</span>.0.1     <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP          23h
nginx-svc    NodePort    <span class="token number">10.1</span>.22.28   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">8080</span>:30765/TCP   37m

<span class="token function">curl</span> <span class="token number">10.96</span>.0.15:80 <span class="token comment"># pod</span>
<span class="token function">curl</span> <span class="token number">10.96</span>.0.16:80 <span class="token comment"># pod</span>
<span class="token function">curl</span> <span class="token number">10.1</span>.22.28:8080 <span class="token comment"># 集群内</span>
<span class="token function">curl</span> <span class="token number">139.196</span>.224.165:30765 <span class="token comment"># 集群外</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><h3 id="master节点不允许部署pod"><a href="#master节点不允许部署pod" class="headerlink" title="master节点不允许部署pod"></a>master节点不允许部署pod</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl describe pod nginx <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> <span class="token number">3</span>
  Type     Reason            Age                  From               Message
  ----     ------            ----                 ----               -------
  Warning  FailedScheduling  24s <span class="token punctuation">(</span>x8 over 8m56s<span class="token punctuation">)</span>  default-scheduler  <span class="token number">0</span>/1 nodes are available: <span class="token number">1</span> node<span class="token punctuation">(</span>s<span class="token punctuation">)</span> had taint <span class="token punctuation">{</span>node-role.kubernetes.io/master: <span class="token punctuation">}</span>, that the pod didn't tolerate.

<span class="token comment"># k8s默认master node不允许部署pod，取消该限制</span>
kubectl taint nodes <span class="token parameter variable">--all</span> node-role.kubernetes.io/master-
<span class="token comment"># 还原命令</span>
<span class="token comment"># kubectl taint nodes k8s node-role.kubernetes.io/master=true:NoSchedule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="cni0网卡已分配ip段与当前不一致"><a href="#cni0网卡已分配ip段与当前不一致" class="headerlink" title="cni0网卡已分配ip段与当前不一致"></a>cni0网卡已分配ip段与当前不一致</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">kubectl get pods
NAME    READY   STATUS              RESTARTS   AGE
nginx   <span class="token number">0</span>/1     ContainerCreating   <span class="token number">0</span>          11m

kubectl describe pod nginx <span class="token operator">|</span> <span class="token function">tail</span> <span class="token parameter variable">-n</span> <span class="token number">1</span>
  Warning  FailedCreatePodSandBox  22s <span class="token punctuation">(</span>x280 over 5m13s<span class="token punctuation">)</span>   kubelet, izuf6h1cr4n27ctdyzruy1z  <span class="token punctuation">(</span>combined from similar events<span class="token punctuation">)</span>: Failed to create pod sandbox: rpc error: code <span class="token operator">=</span> Unknown desc <span class="token operator">=</span> failed to <span class="token builtin class-name">set</span> up sandbox container <span class="token string">"053ca6b0dcd9801ddd6cbc6384e56e5b435ae6bacfeb96fe67f9347ca7d1aa38"</span> network <span class="token keyword">for</span> pod <span class="token string">"nginx"</span><span class="token builtin class-name">:</span> networkPlugin cni failed to <span class="token builtin class-name">set</span> up pod <span class="token string">"nginx_default"</span> network: failed to <span class="token builtin class-name">set</span> bridge addr: <span class="token string">"cni0"</span> already has an IP address different from <span class="token number">10.96</span>.0.1/24

<span class="token function">ifconfig</span> cni0
cni0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1450</span>
        inet <span class="token number">10.244</span>.0.1  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">0.0</span>.0.0

<span class="token comment"># 确认无人使用，删除网卡，由pod自动重建</span>
<span class="token function">ifconfig</span> cni0 down
<span class="token function">ip</span> <span class="token function">link</span> delete cni0
<span class="token function">ifconfig</span> cni0
cni0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1450</span>
        inet <span class="token number">10.96</span>.0.1  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">0.0</span>.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="外网无法访问阿里云ECS，端口不通"><a href="#外网无法访问阿里云ECS，端口不通" class="headerlink" title="外网无法访问阿里云ECS，端口不通"></a>外网无法访问阿里云ECS，端口不通</h3>


<p>阿里云ECS默认安全组对入流量端口做限制，需手工添加端口策略</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/10/go/hashmap/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/10/go/hashmap/" class="post-title-link" itemprop="url">go hashmap</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-10 23:27:42" itemprop="dateCreated datePublished" datetime="2020-06-10T23:27:42+00:00">2020-06-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <ul>
<li>hash0保存1个随机hash种子</li>
<li>每个桶保存8个k/v对</li>
<li>每个桶内存最后8位为指向下一个桶的指针</li>
<li>map创建时，若桶数量&gt;2^4，在extra中创建备用的溢出桶，与正常桶内存连续</li>
<li>插入时，若所有正常桶和溢出桶已满，使用extra中备用的next溢出桶插入key，并加到正常桶末尾的overflow指针中，调用typedmemmove内存拷贝key到桶内地址</li>
<li>扩容因子超过6.5，翻倍扩容</li>
<li>扩容因子未超过6.5，已有太多溢出桶，通常是不断插入元素后，一次delete删除所有元素，此时存在缓慢内存泄漏，采用等量扩容</li>
<li>扩容期间，使用oldbuckets提供查询，插入和删除操作会触发旧桶到新桶的分流，所有分流完成后清空旧桶</li>
</ul>
<img src="/2020/06/10/go/hashmap/hmap-and-buckets.png" class="">
<img src="/2020/06/10/go/hashmap/overflow.jpg" class="">

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    count     <span class="token builtin">int</span> <span class="token comment">// 元素数量</span>
    flags     <span class="token builtin">uint8</span>  <span class="token comment">// 用于基本并发检测，抛出并发异常</span>
    B         <span class="token builtin">uint8</span>  <span class="token comment">// len(buckets) == 2^B</span>
    noverflow <span class="token builtin">uint16</span>
    hash0     <span class="token builtin">uint32</span> <span class="token comment">// hash seed，fastrand()</span>

    buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 当前buckets指针</span>
    oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 扩容时保存旧buckets指针</span>
    nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// progress counter for evacuation (buckets less than this have been evacuated)</span>

    extra <span class="token operator">*</span>mapextra <span class="token comment">// optional fields</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mapextra <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap
    oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap

    <span class="token comment">// nextOverflow holds a pointer to a free overflow bucket.</span>
    nextOverflow <span class="token operator">*</span>bmap
<span class="token punctuation">}</span>

<span class="token comment">// 1个桶保存8个k/v键值对</span>
<span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
    <span class="token comment">// Maximum number of key/elem pairs a bucket can hold.</span>
    bucketCntBits <span class="token operator">=</span> <span class="token number">3</span>
    bucketCnt     <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bucketCntBits
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="冲突解决"><a href="#冲突解决" class="headerlink" title="冲突解决"></a>冲突解决</h2><ul>
<li>开放寻址法： 发生冲突时写入下一个不为空的位置，hash查询不匹配时顺序查找后面位置元素</li>
<li>链表/红黑树法： hash定位桶，每个桶为链表/红黑树</li>
</ul>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><blockquote>
<p>cmd/compile/internal/gc.maplit</p>
</blockquote>
<ul>
<li>字面变量</li>
<li>运行时make</li>
</ul>
<p>make流程：</p>
<ol>
<li>计算哈希占用的内存是否溢出或者超出能分配的最大值</li>
<li>调用 <strong>fastrand</strong> 获取一个随机的哈希种子</li>
<li>根据传入 hint 计算最小需要的桶的数量</li>
<li>创建用于保存桶的数组<br>  4.1 桶数量&lt;2^4，不使用溢出桶，避免过度计算<br>  4.2 桶数量&gt;=2^4，额外创建2^4-B个溢出桶，和正常buckets在内存中连续</li>
</ol>
<h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go">v     <span class="token operator">:=</span> hash<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// =&gt; v     := *mapaccess1(maptype, hash, &amp;key)</span>
v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> hash<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// =&gt; v, ok := mapaccess2(maptype, hash, &amp;key)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<blockquote>
<p>NOTE: The returned pointer may keep the whole map live, so don’t hold onto it for very long.</p>
</blockquote>
<p>mapaccess1流程：</p>
<ol>
<li>高8位计算hash，与bmap的8个桶比较</li>
<li>循环遍历正常桶和溢出桶(内存连续)</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// overflow指针指向下一个bmap</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>bmap<span class="token punctuation">)</span> <span class="token function">overflow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">)</span> <span class="token operator">*</span>bmap <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token operator">-</span>sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>mapaccess2: 略</p>
<h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p>m[k] = v，在compile阶段编译为runtime.mapassign获得v指针进行赋值</p>
<p>mapassign流程：</p>
<ol>
<li>根据key计算hash和桶</li>
<li>遍历正常桶和溢出桶，依次判断tophash和完整key<br>  2.1 如果找到相同key，返回对应val地址<br>  2.2 如果遍历到空key，说明没有相同key，在空key位置new新k/v对，返回val地址<br>  2.3 如果所有桶已满，仍没找到相同key，从extra中取一个备用溢出桶加入正常桶末尾overflow指针。若所有备用溢出桶也用满，分配一个新bmap使用。</li>
</ol>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>逻辑同插入，将key设为emptyOne，略</p>
<h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><img src="/2020/06/10/go/hashmap/hashtable-evacuate-destination.png" class="">

<p>扩容判断条件：</p>
<ol>
<li>装在因子超过6.5，翻倍扩容，通过mask将旧桶数据分流到2个新桶上</li>
<li>有太多溢出桶，等量扩容，evacDst结构体只会初始化1个，旧桶和新桶一对一</li>
</ol>
<p>扩容期间oldbuckets保存旧桶，查询使用oldbuckets，插入和删除会触发分流，在所有旧桶分流到新桶后，清空oldbuckets和oldoverflow</p>
<h2 id="JAVA-hashmap"><a href="#JAVA-hashmap" class="headerlink" title="JAVA hashmap"></a>JAVA hashmap</h2><p>TODO</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/09/go/channel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/09/go/channel/" class="post-title-link" itemprop="url">go channel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-09 00:50:29" itemprop="dateCreated datePublished" datetime="2020-06-09T00:50:29+00:00">2020-06-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>channel底层使用ring buffer实现，通过sendx、recvx移动实现带缓存的chan，数据FIFO先入先出</p>
</blockquote>
<ul>
<li>dataqsiz=0表示同步chan，dataqsiz&gt;0表示异步chan</li>
<li>recvq / sendq其中之一必定为空，或两者都为空</li>
<li>qcount &gt; 0表示recvq为空</li>
<li>qcount &lt; dataqsiz表示sendq为空</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    qcount   <span class="token builtin">uint</span>           <span class="token comment">// buffer中元素数量</span>
    dataqsiz <span class="token builtin">uint</span>           <span class="token comment">// make chan时候指定的buf大小</span>
    buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// buffer</span>
    elemsize <span class="token builtin">uint16</span>         <span class="token comment">// 每个元素大小</span>
    elemtype <span class="token operator">*</span>_type         <span class="token comment">// 元素类型</span>
    closed   <span class="token builtin">uint32</span>         <span class="token comment">// chan是否已关闭，=0表示未关闭</span>
    sendx    <span class="token builtin">uint</span>           <span class="token comment">// send索引下标</span>
    recvx    <span class="token builtin">uint</span>           <span class="token comment">// recv索引下标</span>
    recvq    waitq          <span class="token comment">// 接受等待队列，双向链表</span>
    sendq    waitq          <span class="token comment">// 发送等待队列，双向链表</span>

    lock mutex
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>chansend流程：</p>
<ol>
<li>若recvq不为空，表示有等待的recv sudog，调用memmove进行数据拷贝，然后调用goready唤醒该recv sudug</li>
<li>若recvq为空<br>  2.1 若qcount &lt; dataqsiz，表示当前chan还有缓存空间，调用memmove进行数据拷贝<br>  2.2 若缓存空间满，将当前gp封装成sudog放入sendq队列，并进入休眠(在recv函数中进行数据拷贝，然后调用goready被唤醒)，唤醒后数据已被拷贝走，release释放sudog</li>
</ol>
<p>chanrecv流程：</p>
<ol>
<li>若sendq不为空，表示有等待的send sudog。若是同步chan，将send sudo拷贝到recv sudo；若是带缓存的chan，将缓存head元素传给recv sudo，将sendq取出元素传给缓存队尾，然后调用goready唤醒send sudug</li>
<li>若sendq为空<br>  2.1 若创建时指定的buf大小&gt;0，且缓存中有数据，从缓存中取第一个元素传给recv sudo<br>  2.2 若都不满足，进入recvq队列</li>
</ol>
<p>close流程：</p>
<ol>
<li>设置closed = 1</li>
<li>取出所有sendq和recvq中sudog，调用goready唤醒所有g</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/" class="post-title-link" itemprop="url">go 内存分配和对齐</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-02 11:04:35" itemprop="dateCreated datePublished" datetime="2020-06-02T11:04:35+00:00">2020-06-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="栈内存"><a href="#栈内存" class="headerlink" title="栈内存"></a>栈内存</h2><ul>
<li><a href="https://www.bilibili.com/video/BV1WZ4y1p7JT" title="" target="">栈帧布局与函数跳转</a></li>
<li><a href="https://www.bilibili.com/video/BV1tZ4y1p7Rv" title="" target="">函数调用栈</a></li>
</ul>
<h2 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h2><ul>
<li>32位对齐：4</li>
<li>64位对齐：8</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> T1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    a <span class="token builtin">bool</span>  <span class="token comment">// 占1B</span>
    b <span class="token builtin">int32</span> <span class="token comment">// 对齐为4，a后面需要3B padding，从第5B开始占4B</span>
    c <span class="token builtin">int8</span>
    d <span class="token builtin">int64</span>
    e <span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> T2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    e <span class="token builtin">byte</span> <span class="token comment">// 占1B</span>
    c <span class="token builtin">int8</span> <span class="token comment">// 占1B</span>
    a <span class="token builtin">bool</span> <span class="token comment">// 占1B</span>
    b <span class="token builtin">int32</span> <span class="token comment">// 对齐为4，a后面需1B padding，从第5B开始占4B</span>
    d <span class="token builtin">int64</span> <span class="token comment">// 对齐为8，无需padding，占8B</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"bool size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int32 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int8 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int64 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"byte size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"string size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token string">"EDDYCJY"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token string">"ABCD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    t1 <span class="token operator">:=</span> T1<span class="token punctuation">{</span><span class="token punctuation">}</span>
    t2 <span class="token operator">:=</span> T2<span class="token punctuation">{</span><span class="token punctuation">}</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"T size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"T size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">bool size: 1, align: 1
int32 size: 4, align: 4
int8 size: 1, align: 1
int64 size: 8, align: 8
byte size: 1, align: 1
string size: 16, align: 8
T size: 32, align: 8
T size: 16, align: 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="gctrace"><a href="#gctrace" class="headerlink" title="gctrace"></a>gctrace</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ <span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span>gctrace<span class="token operator">=</span><span class="token number">1</span> go run <span class="token builtin class-name">test</span>
package <span class="token builtin class-name">test</span> is not <span class="token keyword">in</span> GOROOT <span class="token punctuation">(</span>/usr/local/Cellar/go/1.14/libexec/src/test<span class="token punctuation">)</span>
qiujirongdeMacBook-Air:test qiujirong$ <span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span>gctrace<span class="token operator">=</span><span class="token number">1</span> go run test.go 
gc <span class="token number">1</span> @0.044s <span class="token number">5</span>%: <span class="token number">0.020</span>+3.8+0.070 ms clock, <span class="token number">0.083</span>+7.0/3.6/0+0.28 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">2</span> @0.112s <span class="token number">2</span>%: <span class="token number">0.070</span>+0.49+0.034 ms clock, <span class="token number">0.28</span>+0.21/0.38/0.38+0.13 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">3</span> @0.201s <span class="token number">1</span>%: <span class="token number">0.026</span>+1.0+0.038 ms clock, <span class="token number">0.10</span>+0/0.42/1.7+0.15 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">4</span> @0.311s <span class="token number">1</span>%: <span class="token number">0.050</span>+0.47+0.003 ms clock, <span class="token number">0.20</span>+0.17/0.28/0.77+0.013 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">5</span> @0.455s <span class="token number">0</span>%: <span class="token number">0.070</span>+4.2+0.009 ms clock, <span class="token number">0.28</span>+0.85/3.6/1.3+0.036 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">1</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">6</span> @0.496s <span class="token number">0</span>%: <span class="token number">0.030</span>+0.85+0.005 ms clock, <span class="token number">0.12</span>+0/0.64/0.85+0.020 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">7</span> @0.571s <span class="token number">0</span>%: <span class="token number">0.025</span>+0.87+0.022 ms clock, <span class="token number">0.10</span>+0.86/0.62/0.58+0.091 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">8</span> @0.590s <span class="token number">0</span>%: <span class="token number">0.047</span>+0.67+0.004 ms clock, <span class="token number">0.18</span>+0.28/0.46/1.1+0.016 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">0</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
<span class="token comment"># command-line-arguments</span>
gc <span class="token number">1</span> @0.031s <span class="token number">4</span>%: <span class="token number">0.035</span>+12+0.29 ms clock, <span class="token number">0.14</span>+0.44/5.4/19+1.1 ms cpu, <span class="token number">4</span>-<span class="token operator">&gt;</span><span class="token number">5</span>-<span class="token operator">&gt;</span><span class="token number">4</span> MB, <span class="token number">5</span> MB goal, <span class="token number">4</span> P
<span class="token comment"># command-line-arguments</span>
gc <span class="token number">1</span> @0.002s <span class="token number">15</span>%: <span class="token number">0.009</span>+8.3+0.013 ms clock, <span class="token number">0.039</span>+1.5/4.9/0.53+0.052 ms cpu, <span class="token number">5</span>-<span class="token operator">&gt;</span><span class="token number">6</span>-<span class="token operator">&gt;</span><span class="token number">6</span> MB, <span class="token number">6</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">2</span> @0.199s <span class="token number">1</span>%: <span class="token number">0.007</span>+8.6+0.039 ms clock, <span class="token number">0.029</span>+0/6.8/13+0.15 ms cpu, <span class="token number">11</span>-<span class="token operator">&gt;</span><span class="token number">11</span>-<span class="token operator">&gt;</span><span class="token number">10</span> MB, <span class="token number">12</span> MB goal, <span class="token number">4</span> P
gc <span class="token number">3</span> @0.447s <span class="token number">1</span>%: <span class="token number">0.007</span>+12+0.023 ms clock, <span class="token number">0.028</span>+1.9/11/25+0.093 ms cpu, <span class="token number">22</span>-<span class="token operator">&gt;</span><span class="token number">22</span>-<span class="token operator">&gt;</span><span class="token number">20</span> MB, <span class="token number">23</span> MB goal, <span class="token number">4</span> P
bool size: <span class="token number">1</span>, align: <span class="token number">1</span>
int32 size: <span class="token number">4</span>, align: <span class="token number">4</span>
int8 size: <span class="token number">1</span>, align: <span class="token number">1</span>
int64 size: <span class="token number">8</span>, align: <span class="token number">8</span>
byte size: <span class="token number">1</span>, align: <span class="token number">1</span>
string size: <span class="token number">16</span>, align: <span class="token number">8</span>
T size: <span class="token number">32</span>, align: <span class="token number">8</span>
T size: <span class="token number">16</span>, align: <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><h3 id="总线寻址"><a href="#总线寻址" class="headerlink" title="总线寻址"></a>总线寻址</h3><p>32位总线寻址范围最大 = 2的32次方 = 支持最大4G内存寻址<br>64为总线寻址范围最大 = 2的64次方</p>
<p>虚拟内存VMA(virtual memory address) -&gt; 物理地址(liner address)<br>虚拟内存划分为page，一般为4KB</p>
<p>内存碎片示例：</p>
<img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%A4%BA%E4%BE%8B.png" class="">
<p>即使有足够内存页，由于不连续，无法满足p4内存分配，导致内存碎片</p>
<h3 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h3><p>go基于TCMalloc，将页划分为67个等级，页最小单位8K，定义在sizeclasses.go，大小从0～32K。通过定义常量数组，将内存分配时大小转换的时间复杂度降为O(1)<br>mspan是某个class页的集合，包含页起始地址、页数、页等级、已分配对象数等。mspan是一个双向链表。<br>每个P保存本地mcache，mcache是由2*67个mspan组成的数组，每个等级分为scan和noscan两种类型。为0～32K大小对象分配内存直接使用mcache池。<br>noscan类型的mspan上分配不包含指针的对象，在GC时这些对象无需遍历确认，可以直接释放回收。<br>mcentral是mspan的包装，每个mcentral包含1个mspan双向空链表和1个mspan双向非空链表，不同P请求同一个mcentral需要竞争锁。空链表包含没有空闲对象的mspan或缓存在mcache中的mspan，当mspan被释放时放进非空链表，非空链表包含至少有1个空闲对象的mspan。通过mcentral请求新mspan时，从非空链表取出mspan放入空链表。<br>arena结构是mspan的位图，目的是高效分配内存。1个arean大小为heapArenaBytes=64MB<br>mheap是全局内存对象，保存67个页等级的mcentral数组，每个级别的mcentral有自己的锁，因此P1申请2K的mspan和P2申请16K的mspan可以并行执行。</p>
<img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/go-memory-detail.png" class="">

<p>每个class的mspan含有的page数不同，具体见sizeclasses.go，比如：</p>
<ul>
<li>class 43的mspan用来分配4K大小的对象，含有1个8K page，共可以分配2个对象，全分配后内存可以全部用完</li>
<li>class 44的mspan用来分配4864B大小的对象，含有3个8K page，共可以分配5个对象，全分配后尾部有256B浪费</li>
</ul>
<p>mspan和mheap中的sweepgen用于标示span状态 TODO</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// sweep generation:</span>
<span class="token comment">// if sweepgen == h-&gt;sweepgen - 2, the span needs sweeping</span>
<span class="token comment">// if sweepgen == h-&gt;sweepgen - 1, the span is currently being swept</span>
<span class="token comment">// if sweepgen == h-&gt;sweepgen, the span is swept and ready to use</span>
<span class="token comment">// if sweepgen == h-&gt;sweepgen + 1, the span was cached before sweep began and is still cached, and needs sweeping</span>
<span class="token comment">// if sweepgen == h-&gt;sweepgen + 3, the span was swept and then cached and is still cached</span>
<span class="token comment">// h-&gt;sweepgen is incremented by 2 after every GC</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mSpanList <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    first <span class="token operator">*</span>mspan <span class="token comment">// first span in list, or nil if none</span>
    last  <span class="token operator">*</span>mspan <span class="token comment">// last span in list, or nil if none</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    next <span class="token operator">*</span>mspan     <span class="token comment">// next span in list, or nil if none</span>
    prev <span class="token operator">*</span>mspan     <span class="token comment">// previous span in list, or nil if none</span>
    startAddr <span class="token builtin">uintptr</span> <span class="token comment">// address of first byte of span aka s.base()</span>
    npages    <span class="token builtin">uintptr</span> <span class="token comment">// number of pages in span</span>
    allocCount  <span class="token builtin">uint16</span>        <span class="token comment">// number of allocated objects</span>
    sweepgen    <span class="token builtin">uint32</span>
    spanclass   spanClass     <span class="token comment">// size class and noscan (uint8)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    lock      mutex
    spanclass spanClass
    nonempty  mSpanList <span class="token comment">// list of spans with a free object, ie a nonempty free list</span>
    empty     mSpanList <span class="token comment">// list of spans with no free objects (or cached in an mcache)</span>

    nmalloc <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    lock      mutex
    pages     pageAlloc <span class="token comment">// page allocation data structure</span>
    sweepgen  <span class="token builtin">uint32</span>
    allspans <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// 所有2*67个mspan对象，通过锁实现并发</span>
    <span class="token comment">// 67个mcentral</span>
    central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
        mcentral mcentral
        pad      <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="对象分配流程"><a href="#对象分配流程" class="headerlink" title="对象分配流程"></a>对象分配流程</h3><p>0值对象返回zerobase指针<br>小对象分配顺序：per-P本地mcache -&gt; mcentral -&gt; mheap -&gt; OS底层调用mmp<br>tiny对象优先从mspan.tiny分配<br>大对象直接从mheap分配</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>
    <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zerobase<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    c <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>mcache
    noscan <span class="token operator">:=</span> typ <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> typ<span class="token punctuation">.</span>ptrdata <span class="token operator">==</span> <span class="token number">0</span>
    <span class="token keyword">var</span> x unsafe<span class="token punctuation">.</span>Pointer
    <span class="token keyword">if</span> size <span class="token operator">&lt;=</span> maxSmallSize <span class="token punctuation">{</span>
        <span class="token keyword">if</span> noscan <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> maxTinySize <span class="token punctuation">{</span>
            <span class="token comment">// &lt;16B，Tiny allocator</span>
            <span class="token keyword">if</span> off<span class="token operator">+</span>size <span class="token operator">&lt;=</span> maxTinySize <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>tiny <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                <span class="token comment">// The object fits into existing tiny block.</span>
                x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>tiny <span class="token operator">+</span> off<span class="token punctuation">)</span><span class="token punctuation">]</span>
                <span class="token keyword">return</span> x
            <span class="token punctuation">}</span>
            span <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>tinySpanClass<span class="token punctuation">]</span>
            v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>
            <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>tinySpanClass<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
            <span class="token keyword">if</span> size <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>tinyoffset <span class="token operator">||</span> c<span class="token punctuation">.</span>tiny <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                c<span class="token punctuation">.</span>tiny <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 16B~32K之间</span>
            spc <span class="token operator">:=</span> <span class="token function">makeSpanClass</span><span class="token punctuation">(</span>sizeclass<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>
            span <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>
            v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>
            <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
                v<span class="token punctuation">,</span> span<span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// &gt; 32K，大对象</span>
        <span class="token keyword">var</span> s <span class="token operator">*</span>mspan
        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            s <span class="token operator">=</span> <span class="token function">largeAlloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> needzero<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> x
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol>
<li>从per-P的本地mcache，根据class和是否有指针分配对象</li>
<li>若本地相应class的mcache对象已满，调用mspan.refill从mheap相应class的central申请，需加解锁<br>  2.1 从非空链表(至少有一个空闲对象)取出mspan，插入空链表，若该mspan需要sweep执行sweep<br>  2.2 从空链表(没有空闲对象或在mcache中)取出状态为需sweep的mspan并执行sweep</li>
<li>若相应class的central满，调用central.grow从mheap获取mspan，放入空链表，从中分配对象</li>
<li>若mheap内存满，调用mheap.grow，从os申请内存，底层调用mmp</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">nextFree</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">(</span>v gclinkptr<span class="token punctuation">,</span> s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> shouldhelpgc <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>
    freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> freeIndex <span class="token operator">==</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
        <span class="token comment">// The span is full.</span>
        c<span class="token punctuation">.</span><span class="token function">refill</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>
        s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    s<span class="token punctuation">.</span>allocCount<span class="token operator">++</span>
    <span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">refill</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    s <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>

    <span class="token keyword">if</span> s <span class="token operator">!=</span> <span class="token operator">&amp;</span>emptymspan <span class="token punctuation">{</span>
        <span class="token comment">// Mark this span as no longer cached.</span>
        atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Get a new cached span from the central lists.</span>
    s <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"out of memory"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Indicate that this span is cached and prevent asynchronous</span>
    <span class="token comment">// sweeping in the next sweep phase.</span>
    s<span class="token punctuation">.</span>sweepgen <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>sweepgen <span class="token operator">+</span> <span class="token number">3</span>

    c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span> <span class="token operator">=</span> s
<span class="token punctuation">}</span>

<span class="token comment">// Allocate a span to use in an mcache.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    sg <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span>sweepgen
retry<span class="token punctuation">:</span>
    <span class="token keyword">var</span> s <span class="token operator">*</span>mspan
    <span class="token keyword">for</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span>first<span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span>next <span class="token punctuation">{</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> havespan
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token comment">// the span is being swept by background sweeper, skip</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// we have a nonempty span that does not require sweeping, allocate from it</span>
        c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> havespan
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span>first<span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span>next <span class="token punctuation">{</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// we have an empty span that requires sweeping,</span>
            <span class="token comment">// sweep it and see if we can free some space in it</span>
            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token comment">// swept spans are at the end of the list</span>
            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> freeIndex <span class="token operator">!=</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>
                s<span class="token punctuation">.</span>freeindex <span class="token operator">=</span> freeIndex
                <span class="token keyword">goto</span> havespan
            <span class="token punctuation">}</span>
            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            <span class="token comment">// the span is still empty after sweep</span>
            <span class="token comment">// it is already in the empty list, so just retry</span>
            <span class="token keyword">goto</span> retry
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
            <span class="token comment">// the span is being swept by background sweeper, skip</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// already swept empty span,</span>
        <span class="token comment">// all subsequent ones must also be either swept or in process of sweeping</span>
        <span class="token keyword">break</span>
    <span class="token punctuation">}</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    <span class="token comment">// Replenish central list if empty.</span>
    s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    <span class="token comment">// At this point s is a non-empty span, queued at the end of the empty list,</span>
havespan<span class="token punctuation">:</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">return</span> s
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="对象回收流程"><a href="#对象回收流程" class="headerlink" title="对象回收流程"></a>对象回收流程</h3><ol>
<li>大对象的mspan中对象全部释放时，mspan归还给mheap</li>
<li>小对象的mspan从空链表移到非空链表，供mcentral.cacheSpan中获取mspan；如果mspan中对象全部释放，直接归还到mheap</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> <span class="token function">sweep</span><span class="token punctuation">(</span>preserve <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token comment">// 有对象释放&amp;&amp;小对象</span>
    <span class="token keyword">if</span> nfreed <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> spc<span class="token punctuation">.</span><span class="token function">sizeclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        res <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> preserve<span class="token punctuation">,</span> wasempty<span class="token punctuation">)</span>
        <span class="token comment">// 大对象&amp;&amp;全部释放</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> freeToHeap <span class="token punctuation">{</span>
        <span class="token comment">// Free large span to heap</span>
        mheap_<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        res <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>
        <span class="token comment">// The span has been swept and is still in-use, so put it on the swept in-use list.</span>
        mheap_<span class="token punctuation">.</span>sweepSpans<span class="token punctuation">[</span>sweepgen<span class="token operator">/</span><span class="token number">2</span><span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">freeSpan</span><span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> preserve <span class="token builtin">bool</span><span class="token punctuation">,</span> wasempty <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    <span class="token keyword">if</span> wasempty <span class="token punctuation">{</span>
        c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
        c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>

    <span class="token keyword">if</span> s<span class="token punctuation">.</span>allocCount <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
    mheap_<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p><strong>gcpercent</strong>通过环境变量<code>GOGC</code>设置，用于控制GC速度，若无环境变量默认100%，若环境变量为”off”，会关闭2分钟1次的强制GC<br>函数<code>gcSetTriggerRatio</code>根据当次GC的速度调整下一次GC的速度，初始速度7/8，最小0.6，最大0.95。计算方式如下：</p>
<blockquote>
<p>mark phase阈值： float64(memstats.heap_marked) * (1 + triggerRatio)，如果有p正在sweep需求更大内存，自动上调<br>next GC阈值： memstats.heap_marked + memstats.heap_marked*uint64(gcpercent)/100，内存扩大一倍启动GC，若小于mark phase阈值自动上调</p>
</blockquote>
<p>GC通过以下逻辑触发：</p>
<ol>
<li>heap上涨触发了GC，每次分配对象需要新申请mspan，触发sweep后，最后会调用<strong>test</strong>判断是到达heap阈值否需要GC</li>
<li>在sysmon的每一次调度中，都会调用<strong>test</strong>判断距离上一次GC是否超过2分钟达到强制GC阈值</li>
<li><code>gcTriggerCycle</code>为runtime.GC()手动调用GC case</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t gcTrigger<span class="token punctuation">)</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>memstats<span class="token punctuation">.</span>enablegc <span class="token operator">||</span> panicking <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> gcphase <span class="token operator">!=</span> _GCoff <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">switch</span> t<span class="token punctuation">.</span>kind <span class="token punctuation">{</span>
    <span class="token keyword">case</span> gcTriggerHeap<span class="token punctuation">:</span>
        <span class="token keyword">return</span> memstats<span class="token punctuation">.</span>heap_live <span class="token operator">&gt;=</span> memstats<span class="token punctuation">.</span>gc_trigger
    <span class="token keyword">case</span> gcTriggerTime<span class="token punctuation">:</span>
        <span class="token keyword">if</span> gcpercent <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        lastgc <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>last_gc_nanotime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> lastgc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>now<span class="token operator">-</span>lastgc <span class="token operator">&gt;</span> forcegcperiod
    <span class="token keyword">case</span> gcTriggerCycle<span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>n<span class="token operator">-</span>work<span class="token punctuation">.</span>cycles<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>三色标记法：</p>
<ul>
<li>灰色：对象已标记，但这个对象包含的子对象未标记</li>
<li>黑色：对象已标记，且这个对象包含的子对象也已标记，gcmarkBits对应的位为1（该对象不会在本次GC中被清理）</li>
<li>白色：对象未标记，gcmarkBits对应的位为0（该对象将会在本次GC中被清理）</li>
</ul>
<img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/mspan_gc.jpg" class="">

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    allocBits  <span class="token operator">*</span>gcBits
    gcmarkBits <span class="token operator">*</span>gcBits
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一阶段：</p>
<ol>
<li>每个P启动一个goroutine，进入park，用于第二阶段调用gcDrain消费gcw</li>
<li>初始reset为白色，stop the world，完成未完成的sweep</li>
<li>启动gc write barriers，初始化root节点的扫描工作任务，在第二阶段中循环所有root节点执行<code>markroot</code></li>
<li>对p.mcache和p.tiny标记灰色</li>
<li>start the world</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 每个P启动一个goroutine，进入park，用于第二阶段调用gcDrain消费gcw</span>

    <span class="token function">systemstack</span><span class="token punctuation">(</span>gcResetMarkState<span class="token punctuation">)</span> <span class="token comment">// 初始reset为白色</span>

    <span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span> <span class="token comment">// stop the world</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">finishsweep_m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">setGCPhase</span><span class="token punctuation">(</span>_GCmark<span class="token punctuation">)</span> <span class="token comment">// 启动gc write barriers</span>

    <span class="token function">gcBgMarkPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Must happen before assist enable.</span>
    <span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 计算work.markrootJobs</span>

    <span class="token function">gcMarkTinyAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 对p.mcache和p.tiny标记灰色</span>

    <span class="token comment">// Concurrent mark.</span>
    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        now <span class="token operator">=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>enabled<span class="token punctuation">)</span> <span class="token comment">// start the world</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第二阶段：</p>
<ol>
<li><code>markroot</code>对所有root节点做标记，包含几个特殊任务随机分配给p执行，比如：释放全局<code>sched.gFree.stack</code>的栈，该队列保存有栈的dead G，释放栈后放入全局<code>sched.gFree.noStack</code><br>  1.1 默认每个p扫描自己的栈上引用对象，包括栈上的defer链表。若为noscan对象直接标记黑色，否则根据对象引用进行标记。</li>
</ol>
<p>第三阶段：</p>
<p><code>gcMarkDone</code>先stop the world，将写屏障记录的所有修改的指针加入到标记队列，完成后start the world</p>
<p>第四阶段：</p>
<p><code>gcSweep</code>释放内存</p>
<p>GC停顿时间主要在第一阶段和第三阶段，第二阶段为和用户代码并行执行。第一次停顿用于扫描root节点，第二次停顿用于追加写屏障中记录。GC停顿时间主要消耗为root节点数量，和heap总大小无直接关系。</p>
<p>举个栗子：</p>
<img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0.jpg" class="">

<ol>
<li>初始状态下所有对象都是白色的。</li>
<li>接着开始扫描根对象a、b; 由于根对象引用了对象A、B,那么A、B变为灰色对象，接下来就开始分析灰色对象，分析A时，A没有引用其他对象很快就转入黑色，B引用了D，则B转入黑色的同时还需要将D转为灰色，进行接下来的分析。</li>
<li>灰色对象只有D，由于D没有引用其他对象，所以D转入黑色。标记过程结束</li>
<li>最终，黑色的对象会被保留下来，白色对象会被回收掉。</li>
</ol>
<p>每个p有写屏障buf，用于避免第二阶段中用户代码修改引用导致gc漏标记。</p>
<h2 id="TODO-版本差异"><a href="#TODO-版本差异" class="headerlink" title="TODO 版本差异"></a>TODO 版本差异</h2><h2 id="TODO-JAVA"><a href="#TODO-JAVA" class="headerlink" title="TODO JAVA"></a>TODO JAVA</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://tonybai.com/2020/02/20/a-visual-guide-to-golang-memory-allocator-from-ground-up/" title="" target="">图解Go内存分配器</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/27/go/mutex/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/27/go/mutex/" class="post-title-link" itemprop="url">go mutex</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-27 22:14:59" itemprop="dateCreated datePublished" datetime="2020-05-27T22:14:59+00:00">2020-05-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mutex"><a href="#mutex" class="headerlink" title="mutex"></a>mutex</h2><ul>
<li>并发模型中，可能存在N个g同时竞争1个锁对象</li>
<li>mutexWaiterShift用于计数锁等待g数量，使用sudog结构保存在semaRoot的平衡树的叶子中</li>
<li>semaRoot平衡树的叶子保存每一个unique sema，一个mutex对象的sema只保存在一个叶子中，使用<strong>单向FIFO链表</strong>形式保存竞争该sema的所有sudog</li>
<li>若没有spin机制，锁一旦释放，当前运行g会更大概率得到锁。若锁的时间很短，没有spin机制的情况下得不到锁的g都需要休眠park，会增加调度开销，存在长尾</li>
<li>在默认模式下，所有g都会先spin，waiter计数，然后插入链表尾并进入休眠，底层调用park函数</li>
<li>解锁后从FIFO链表头唤醒1个g，若该g等待时间&gt;1ms会尝试进入饥饿模式，此时仍可能有新g竞争锁。每次循环都会尝试CAS state到饥饿模式，若CAS失败会直接插入链表头，下次第一个被唤醒。</li>
<li>进入饥饿模式后，所有新g竞争时不会spin也不会尝试加锁，直接插入链表尾。每次解锁后从链表头唤醒1个g消费锁，若该g等待时间不超过1ms，退出饥饿模式。</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">int32</span>
	sema  <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token punctuation">(</span>
	mutexLocked <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token boolean">iota</span> <span class="token comment">// 0001</span>
	mutexWoken              <span class="token comment">// 0010</span>
	mutexStarving           <span class="token comment">// 0100</span>
	mutexWaiterShift <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0011</span>

	starvationThresholdNs <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token comment">// 超过1ms进入饥饿模式</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mutexLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	m<span class="token punctuation">.</span><span class="token function">lockSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">lockSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> waitStartTime <span class="token builtin">int64</span>
	starving <span class="token operator">:=</span> <span class="token boolean">false</span>
	awoke <span class="token operator">:=</span> <span class="token boolean">false</span>
	iter <span class="token operator">:=</span> <span class="token number">0</span>
	old <span class="token operator">:=</span> m<span class="token punctuation">.</span>state
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token comment">// 判断是否为饥饿模式</span>
		<span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">==</span> mutexLocked <span class="token operator">&amp;&amp;</span> <span class="token function">runtime_canSpin</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果未设置awoke且waiter计数&gt;0，说明其他m在等待锁，cas设置awoke</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>awoke <span class="token operator">&amp;&amp;</span> old<span class="token operator">&amp;</span>mutexWoken <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> old<span class="token operator">&gt;&gt;</span>mutexWaiterShift <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
				atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> old<span class="token operator">|</span>mutexWoken<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				awoke <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token punctuation">}</span>
			<span class="token function">runtime_doSpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 自旋30次</span>
			iter<span class="token operator">++</span>
			old <span class="token operator">=</span> m<span class="token punctuation">.</span>state
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		<span class="token builtin">new</span> <span class="token operator">:=</span> old
		<span class="token comment">// 非starving模式，设置new的locked</span>
		<span class="token keyword">if</span> old<span class="token operator">&amp;</span>mutexStarving <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token builtin">new</span> <span class="token operator">|=</span> mutexLocked
		<span class="token punctuation">}</span>
		<span class="token comment">// 已上锁或饥饿状态，waiter计数+1</span>
		<span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token builtin">new</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> mutexWaiterShift
		<span class="token punctuation">}</span>
		<span class="token comment">// 处于饥饿模式并且已上锁，将starving置1</span>
		<span class="token keyword">if</span> starving <span class="token operator">&amp;&amp;</span> old<span class="token operator">&amp;</span>mutexLocked <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token builtin">new</span> <span class="token operator">|=</span> mutexStarving
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> awoke <span class="token punctuation">{</span>
			<span class="token builtin">new</span> <span class="token operator">&amp;^=</span> mutexWoken <span class="token comment">// 如果当前g是被唤醒的，清除woken</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 如果state!=old，说明有其他g抢锁，重新进入for循环</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token builtin">new</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 如果old没上锁且是普通模式，抢锁成功，退出</span>
			<span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
			queueLifo <span class="token operator">:=</span> waitStartTime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment">// 第一次循环固定false</span>
			<span class="token keyword">if</span> waitStartTime <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				waitStartTime <span class="token operator">=</span> <span class="token function">runtime_nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>sema<span class="token punctuation">,</span> queueLifo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			starving <span class="token operator">=</span> starving <span class="token operator">||</span> <span class="token function">runtime_nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>waitStartTime <span class="token operator">&gt;</span> starvationThresholdNs
			old <span class="token operator">=</span> m<span class="token punctuation">.</span>state
			<span class="token keyword">if</span> old<span class="token operator">&amp;</span>mutexStarving <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				delta <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span>mutexLocked <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>mutexWaiterShift<span class="token punctuation">)</span>
				<span class="token comment">// 如果在饥饿模式并且自己是最后一个，清除starving标示</span>
				<span class="token keyword">if</span> <span class="token operator">!</span>starving <span class="token operator">||</span> old<span class="token operator">&gt;&gt;</span>mutexWaiterShift <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
					delta <span class="token operator">-=</span> mutexStarving
				<span class="token punctuation">}</span>
				atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
			awoke <span class="token operator">=</span> <span class="token boolean">true</span>
			iter <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			old <span class="token operator">=</span> m<span class="token punctuation">.</span>state
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>是否自旋判断逻辑：</p>
<ol>
<li>未超过4次for循环</li>
<li>多核且有其他running p</li>
<li>本地g队列为空</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">sync_runtime_canSpin</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> i <span class="token operator">&gt;=</span> active_spin <span class="token operator">||</span> ncpu <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">||</span> gomaxprocs <span class="token operator">&lt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span>sched<span class="token punctuation">.</span>npidle<span class="token operator">+</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> p <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token function">runqempty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="sema"><a href="#sema" class="headerlink" title="sema"></a>sema</h3><p>略</p>
<h2 id="rwmutex"><a href="#rwmutex" class="headerlink" title="rwmutex"></a>rwmutex</h2><ul>
<li>Mutex： w之间加解锁</li>
<li>writerSem： w叶的FIFO链表</li>
<li>readerSem： r叶的FIFO链表</li>
<li>readerCount： r计数，w加锁时给r设置大负数阻塞r</li>
<li>readerWait： w加锁时已有r的计数，在最后一个r解锁后FIFO唤醒w</li>
</ul>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RWMutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	w           Mutex  <span class="token comment">// held if there are pending writers</span>
	writerSem   <span class="token builtin">uint32</span> <span class="token comment">// semaphore for writers to wait for completing readers</span>
	readerSem   <span class="token builtin">uint32</span> <span class="token comment">// semaphore for readers to wait for completing writers</span>
	readerCount <span class="token builtin">int32</span>  <span class="token comment">// number of pending readers</span>
	readerWait  <span class="token builtin">int32</span>  <span class="token comment">// number of departing readers</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> rwmutexMaxReaders <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// readerSem叶链表尾=当前g</span>
		<span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// 有w在等锁</span>
		rw<span class="token punctuation">.</span><span class="token function">rUnlockSlow</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">rUnlockSlow</span><span class="token punctuation">(</span>r <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerWait<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// 最后一个r锁释放，从writerSem叶链表头唤醒等待的w锁</span>
		<span class="token function">runtime_Semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span>rwmutexMaxReaders<span class="token punctuation">)</span> <span class="token operator">+</span> rwmutexMaxReaders <span class="token comment">// readerCount设一个大负数</span>
	<span class="token comment">// Wait for active readers.</span>
	<span class="token keyword">if</span> r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerWait<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> rwmutexMaxReaders<span class="token punctuation">)</span> <span class="token comment">// 还原readerCount设置的大负数</span>
	<span class="token comment">// readerSem叶链表头-&gt;尾循环唤醒等待的r</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">runtime_Semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="runtime-mutex"><a href="#runtime-mutex" class="headerlink" title="runtime.mutex"></a>runtime.mutex</h2><ul>
<li>lock流程</li>
</ul>
<ol>
<li>m.lock++</li>
<li>原子load key，如果没锁，尝试原子cas key-&gt;locked，cas成功则返回，否则自旋30次，多核下一共尝试4遍</li>
<li>其他m占着锁，此时key=locked，设置m.nextwaitm = muintptr(0)，for循环不断load key并尝试原子cas key-&gt;g.m，将自己设为等待锁的m<br>  3.1 如果cas失败，可能还有其他m已将key cas为自己，继续循环；也可能是锁已释放，跳到1.重新判断锁<br>  3.2 如果cas成功，m进入等待</li>
</ol>
<ul>
<li>unlock流程</li>
</ul>
<ol>
<li>如果key=locked，尝试原子cas key-&gt;0解锁，成功则返回</li>
<li>如果key!=locked，有其他m在等待锁，获取等待的m,尝试原子cas key-&gt;m.nextwaitm并唤醒等待的m</li>
<li>当前m.lock–，如果lock=0并且可抢占，设置抢占标记</li>
</ol>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	key <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>
	locked <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">1</span>

	active_spin     <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// 多核loop 4次</span>
	active_spin_cnt <span class="token operator">=</span> <span class="token number">30</span> <span class="token comment">// 每次loop自旋30次</span>
	passive_spin    <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">lock</span><span class="token punctuation">(</span>l <span class="token operator">*</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">++</span>

	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token function">semacreate</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>m<span class="token punctuation">)</span> <span class="token comment">// 创建OS信号量</span>

	spin <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">if</span> ncpu <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		spin <span class="token operator">=</span> active_spin <span class="token comment">// 多核loop 4次</span>
	<span class="token punctuation">}</span>
Loop<span class="token punctuation">:</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token comment">// Unlocked. Try to lock.</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token operator">|</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
			i <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> spin <span class="token punctuation">{</span>
			<span class="token function">procyield</span><span class="token punctuation">(</span>active_spin_cnt<span class="token punctuation">)</span> <span class="token comment">// 自旋30次</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> i <span class="token operator">&lt;</span> spin<span class="token operator">+</span>passive_spin <span class="token punctuation">{</span>
			<span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 其他g已获得lock，gp.m.nextwaitm-&gt;muintptr(0)，l.key-&gt;gp.m</span>
			<span class="token keyword">for</span> <span class="token punctuation">{</span>
				gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>nextwaitm <span class="token operator">=</span> <span class="token function">muintptr</span><span class="token punctuation">(</span>v <span class="token operator">&amp;^</span> locked<span class="token punctuation">)</span>
				<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">|</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">break</span>
				<span class="token punctuation">}</span>
				v <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
				<span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					<span class="token keyword">continue</span> Loop
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token comment">// Queued. Wait.</span>
				<span class="token function">semasleep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
				i <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">unlock</span><span class="token punctuation">(</span>l <span class="token operator">*</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> mp <span class="token operator">*</span>m
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
		<span class="token keyword">if</span> v <span class="token operator">==</span> locked <span class="token punctuation">{</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> locked<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
            <span class="token punctuation">}</span>
        <span class="token comment">// l.key是其他等待m</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment">// 获取等待m</span>
            mp <span class="token operator">=</span> <span class="token function">muintptr</span><span class="token punctuation">(</span>v <span class="token operator">&amp;^</span> locked<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token comment">// key换为等待m.nextwaitm</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>nextwaitm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Dequeued an M.  Wake it.</span>
				<span class="token function">semawakeup</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">--</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>preempt <span class="token punctuation">{</span> <span class="token comment">// 重置抢占标示，在newstack栈分配中判断</span>
		gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> stackPreempt
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><p><code>procyield</code>通过pause自旋</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">TEXT runtime·<span class="token function">procyield</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>
	MOVL	cycles<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AX
again<span class="token punctuation">:</span>
	PAUSE
	SUBL	$<span class="token number">1</span><span class="token punctuation">,</span> AX
	JNZ	again
    RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>osyield</code>调用系统<strong>sched_yield</strong></p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go">TEXT runtime·<span class="token function">osyield</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>
	MOVL	$SYS_sched_yield<span class="token punctuation">,</span> AX
	SYSCALL
    RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="TODO-java"><a href="#TODO-java" class="headerlink" title="TODO java"></a>TODO java</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/05/13/go/pprof/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/13/go/pprof/" class="post-title-link" itemprop="url">pprof</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-05-13 22:02:19" itemprop="dateCreated datePublished" datetime="2020-05-13T22:02:19+00:00">2020-05-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2025-03-03 01:05:36" itemprop="dateModified" datetime="2025-03-03T01:05:36+00:00">2025-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"encoding/json"</span>
	<span class="token string">"net/http"</span>
	<span class="token boolean">_</span> <span class="token string">"net/http/pprof"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>

	<span class="token string">"github.com/gorilla/mux"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	router <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">NewRouter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	router<span class="token punctuation">.</span><span class="token function">PathPrefix</span><span class="token punctuation">(</span><span class="token string">"/debug/"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>DefaultServeMux<span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">"localhost:9999"</span><span class="token punctuation">,</span> router<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">go tool pprof http://localhost:9999/debug/pprof/profile
go tool pprof http://localhost:9999/debug/pprof/heap
pprof <span class="token parameter variable">-http</span><span class="token operator">=</span><span class="token string">":8081"</span> http://localhost:9999/debug/pprof/profile
pprof <span class="token parameter variable">-http</span><span class="token operator">=</span><span class="token string">":8081"</span> http://localhost:9999/debug/pprof/heap<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>


<p>TODO</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yiduoyunQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">51</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yiduoyunQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
