<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yiduoyunq.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="yiduoyunQ">
<meta property="og:url" content="https://yiduoyunq.github.io/page/2/index.html">
<meta property="og:site_name" content="yiduoyunQ">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="yiduoyunQ">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://yiduoyunq.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>yiduoyunQ</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>


<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">yiduoyunQ</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/11/23/go/net/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/23/go/net/" class="post-title-link" itemprop="url">net poll</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-23 22:53:19" itemprop="dateCreated datePublished" datetime="2020-11-23T22:53:19+00:00">2020-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="select-poll-epoll"><a href="#select-poll-epoll" class="headerlink" title="select / poll / epoll"></a>select / poll / epoll</h2><img src="/2020/11/23/go/net/select_poll_epoll.png" class="">

<h2 id="net-Listen"><a href="#net-Listen" class="headerlink" title="net.Listen"></a>net.Listen</h2><img src="/2020/11/23/go/net/net_Listen.jpeg" class="">

<ol>
<li><code>net.Listen</code>通过 <code>netFD.init</code> -&gt; <code>FD.Init</code> -&gt; <code>pollDesc.init</code> -&gt; 最终调用 <code>epollcreate1</code> 创建全局唯一 <strong>epfd</strong>，然后调用 <code>epollctl</code> 将 <strong>listener fd</strong>注册到epoll实例的事件队列</li>
<li>通过 <code>var serverInit sync.Once</code> 保证epollcreate1只在Listen时执行一次，后续Accept调用复用 <code>FD.Init</code> 时不会执行</li>
</ol>
<h2 id="net-Accept"><a href="#net-Accept" class="headerlink" title="net.Accept"></a>net.Accept</h2><img src="/2020/11/23/go/net/net_Accept.jpeg" class="">

<ol>
<li><code>pollDesc.waitRead</code> 循环检测上层netFD的FD是否有 <strong>pdReady</strong> I/O事件，如果有I/O发生则返回，否则park当前goroutine直到对应FD可读或可写后返回。</li>
<li><code>FD.Accept</code> 返回后，调用 <code>newFD</code> 创建这个新的socket对应的 <strong>netFD</strong>， 然后调用 <code>netFD.init</code> 完成初始化，调用链同Listen，最终将 <strong>socket fd</strong> 注册到 <strong>listener fd</strong> 的epoll实例的事件队列中</li>
<li>被park的goroutine在 <code>func netpoll(delay int64) gList</code> 中调用 <code>epollwait</code> 处理可读/可写的事件fd，生成g链表返回。 <code>netpoll</code> 函数在proc的GPM逻辑中被调用</li>
</ol>
<h2 id="Conn-Read-Conn-Write"><a href="#Conn-Read-Conn-Write" class="headerlink" title="Conn.Read/Conn.Write"></a>Conn.Read/Conn.Write</h2><h2 id="net-flow"><a href="#net-flow" class="headerlink" title="net flow"></a>net flow</h2><ul>
<li>Listen创建epoll实例</li>
<li>client连接server，Listener调用Accept接收conn，每个conn开启一个goroutine处理，所有信息注册到epoll实例的事件队列</li>
<li>conn调用Read/Write时被park当前goroutine，在GPM逻辑中调用netpoll唤醒goroutine响应I/O事件</li>
</ul>
<p>epoll本质为系统内核顺序I/O，通过结合goroutine的GPM框架，解耦内核I/O和用户I/O，达到高并发I/O的设计</p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/299047984">Go netpoller 网络模型之源码全面解析</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/11/23/go/version/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/23/go/version/" class="post-title-link" itemprop="url">go版本</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-23 22:53:19" itemprop="dateCreated datePublished" datetime="2020-11-23T22:53:19+00:00">2020-11-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-14"><a href="#1-14" class="headerlink" title="1.14"></a>1.14</h2><h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3><p>编译期间确定defer优化为 <code>OpenDefer</code>， 省去栈堆操作和递归调用</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编译时确定defer</span>
    ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>

    <span class="token comment">// 运行时确定defer</span>
    <span class="token keyword">if</span> createTime <span class="token operator">&gt;</span> Now <span class="token punctuation">{</span>
      <span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 运行期确认defer</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// runtime/panic.go</span>
<span class="token keyword">func</span> <span class="token function">deferreturn</span><span class="token punctuation">(</span>arg0 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">if</span> d<span class="token punctuation">.</span>openDefer <span class="token punctuation">{</span>
		done <span class="token operator">:=</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unfinished open-coded defers in deferreturn"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link
		<span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> d <span class="token operator">*</span>_defer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    fd <span class="token operator">:=</span> d<span class="token punctuation">.</span>fd <span class="token comment">// funcdata地址保存所有defer信息地址</span>

    <span class="token comment">// 计算</span>
    <span class="token comment">// deferBitsOffset 偏移量</span>
    <span class="token comment">// nDefers defer数量</span>
    <span class="token comment">// deferBits 当前执行的defer</span>

    <span class="token comment">// for nDefers</span>
    <span class="token comment">//   for defer的参数</span>
    <span class="token comment">//     memmove拷贝参数内存</span>
    <span class="token comment">//   执行defer函数</span>
    <span class="token comment">//   通过指针根据deferBits位移到下一defer</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>deferBits</code>类型为 <strong>uint8</strong>， <code>OpenDefer</code> 中defer数量最大不超过8个(编译阶段超过8个defer退化为普通递归调用)</p>
<h3 id="内存分配优化"><a href="#内存分配优化" class="headerlink" title="内存分配优化"></a>内存分配优化</h3><p>go内存模型： mcache、mcentral、mheap<br>mcache绑定per-P，无锁<br>mcentral按照size class细分，每个claas的mcentral有自己的锁<br>mheap的锁全局唯一，alloc函数成为内存分配瓶颈</p>
<ul>
<li>优化前：</li>
</ul>
<p>使用 <strong>free</strong>，二叉树粗旷管理内存</p>
<p>优化后：</p>
<p>去除 <strong>free</strong>，使使用 <strong>pages</strong> 基数树+位图高效管理内存<br>针对小内存申请，使用per-P的 <strong>pageCache</strong></p>
<h3 id="抢占式调度"><a href="#抢占式调度" class="headerlink" title="抢占式调度"></a>抢占式调度</h3><p>增加 <code>preempt</code> 信号量抢占式调度</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/runtime/runtime2.go</span>
	<span class="token comment">// _Gpreempted means this goroutine stopped itself for a</span>
	<span class="token comment">// suspendG preemption. It is like _Gwaiting, but nothing is</span>
	<span class="token comment">// yet responsible for ready()ing it. Some suspendG must CAS</span>
	<span class="token comment">// the status to _Gwaiting to take responsibility for</span>
	<span class="token comment">// ready()ing this G.</span>
	_Gpreempted <span class="token comment">// 9</span>

<span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// preempt is set to indicate that this P should be enter the</span>
	<span class="token comment">// scheduler ASAP (regardless of what G is running on it).</span>
	preempt <span class="token builtin">bool</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">preemptone</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

	<span class="token comment">// Request an async preemption of this P.</span>
	<span class="token keyword">if</span> preemptMSupported <span class="token operator">&amp;&amp;</span> debug<span class="token punctuation">.</span>asyncpreemptoff <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		_p_<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">true</span>
		<span class="token function">preemptM</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>

<span class="token comment">// src/runtime/os_linux.go</span>
<span class="token comment">// signalM sends a signal to mp.</span>
<span class="token keyword">func</span> <span class="token function">signalM</span><span class="token punctuation">(</span>mp <span class="token operator">*</span>m<span class="token punctuation">,</span> sig <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>touchStackBeforeSignal<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uint32</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>gsignal<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>hi<span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">tgkill</span><span class="token punctuation">(</span><span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">int</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>procid<span class="token punctuation">)</span><span class="token punctuation">,</span> sig<span class="token punctuation">)</span>
<span class="token punctuation">}</span>


<span class="token comment">// src/runtime/signal_unix.go</span>
<span class="token keyword">const</span> sigPreempt <span class="token operator">=</span> _SIGURG

<span class="token keyword">func</span> <span class="token function">preemptM</span><span class="token punctuation">(</span>mp <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token function">signalM</span><span class="token punctuation">(</span>mp<span class="token punctuation">,</span> sigPreempt<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">sighandler</span><span class="token punctuation">(</span>sig <span class="token builtin">uint32</span><span class="token punctuation">,</span> info <span class="token operator">*</span>siginfo<span class="token punctuation">,</span> ctxt unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>

    <span class="token keyword">if</span> sig <span class="token operator">==</span> sigPreempt <span class="token operator">&amp;&amp;</span> debug<span class="token punctuation">.</span>asyncpreemptoff <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Might be a preemption signal.</span>
		
        <span class="token function">doSigPreempt</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// doSigPreempt handles a preemption signal on gp.</span>
<span class="token keyword">func</span> <span class="token function">doSigPreempt</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> ctxt <span class="token operator">*</span>sigctxt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">wantAsyncPreempt</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> ok<span class="token punctuation">,</span> newpc <span class="token operator">:=</span> <span class="token function">isAsyncSafePoint</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">sigsp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ctxt<span class="token punctuation">.</span><span class="token function">siglr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token comment">// Adjust the PC and inject a call to asyncPreempt.</span>
			ctxt<span class="token punctuation">.</span><span class="token function">pushCall</span><span class="token punctuation">(</span><span class="token function">funcPC</span><span class="token punctuation">(</span>asyncPreempt<span class="token punctuation">)</span><span class="token punctuation">,</span> newpc<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>


<span class="token comment">// src/runtime/preempt.go</span>
<span class="token keyword">func</span> <span class="token function">asyncPreempt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">asyncPreempt2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>preemptStop <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>preemptPark<span class="token punctuation">)</span> <span class="token comment">// 增加抢占式park</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">mcall</span><span class="token punctuation">(</span>gopreempt_m<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	gp<span class="token punctuation">.</span>asyncSafePoint <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>


<span class="token comment">// sys/runtime/proc.go</span>
<span class="token comment">// preemptPark parks gp and puts it in _Gpreempted.</span>
<span class="token keyword">func</span> <span class="token function">preemptPark</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

	<span class="token function">casGToPreemptScan</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Gscan<span class="token operator">|</span>_Gpreempted<span class="token punctuation">)</span>
	<span class="token function">dropg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">casfrom_Gscanstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gscan<span class="token operator">|</span>_Gpreempted<span class="token punctuation">,</span> _Gpreempted<span class="token punctuation">)</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="timer优化"><a href="#timer优化" class="headerlink" title="timer优化"></a>timer优化</h3><p>优化前使用64个 <strong>bucket</strong> 并通过 <code>go timerproc</code> 实现，需频繁操作M和P</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// The current value is a compromise between memory usage and performance</span>
<span class="token comment">// that should cover the majority of GOMAXPROCS values used in the wild.</span>
<span class="token keyword">const</span> timersLen <span class="token operator">=</span> <span class="token number">64</span>

<span class="token keyword">var</span> timers <span class="token punctuation">[</span>timersLen<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
	timersBucket
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">timeSleep</span><span class="token punctuation">(</span>ns <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	t <span class="token operator">:=</span> gp<span class="token punctuation">.</span>timer
    tb <span class="token operator">:=</span> t<span class="token punctuation">.</span><span class="token function">assignBucket</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    tb<span class="token punctuation">.</span><span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token function">addtimerLocked</span><span class="token punctuation">(</span>t <span class="token operator">*</span>timer<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">go</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb<span class="token punctuation">)</span>

    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// Timerproc runs the time-driven events.</span>
<span class="token comment">// It sleeps until the next event in the tb heap.</span>
<span class="token comment">// If addtimer inserts a new earlier event, it wakes timerproc early.</span>
<span class="token keyword">func</span> <span class="token function">timerproc</span><span class="token punctuation">(</span>tb <span class="token operator">*</span>timersBucket<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>优化后 <strong>timer</strong> 放在P结构体中，使用顶堆维护，通过netpoll模拟</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// src/runtime/runtime2.go</span>
<span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// 本地P操作timers时加锁</span>
	<span class="token comment">// schedule调度中执行steal timer时也会加该锁</span>
	timersLock mutex

	<span class="token comment">// timer直接放到P中，通过顶堆维护</span>
	timers <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>timer
<span class="token punctuation">}</span>

<span class="token comment">// src/runtime/proc.go</span>
<span class="token keyword">func</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
top<span class="token punctuation">:</span>
	<span class="token operator">...</span>

	now<span class="token punctuation">,</span> pollUntil<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token operator">...</span>

    从其他P steal g
        从其他P steal timer
    
    delta <span class="token operator">=</span> pollUntil <span class="token operator">-</span> now

    <span class="token comment">// 模拟 poll network</span>
    list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span> <span class="token comment">// block until new work is available</span>
	<span class="token keyword">if</span> faketime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> list<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Using fake time and nothing is ready; stop M.</span>
		<span class="token comment">// When all M's stop, checkdead will call timejump.</span>
		<span class="token function">stopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> top
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">checkTimers</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从顶堆返回P的timer</span>
<span class="token keyword">func</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>pp <span class="token operator">*</span>p<span class="token punctuation">,</span> now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>rnow<span class="token punctuation">,</span> pollUntil <span class="token builtin">int64</span><span class="token punctuation">,</span> ran <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="减少锁竞争"><a href="#减少锁竞争" class="headerlink" title="减少锁竞争"></a>减少锁竞争</h3><p>yield to the waiter when unlocking a starving mutex<br>当mutex进入 <code>Starving mod</code> 调用 <code>semrelease</code>，通过 <code>yield()</code> 将g加入P本地队列，随后调度</p>
<pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">semrelease</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">uint32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">semrelease1</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">semrelease1</span><span class="token punctuation">(</span>addr <span class="token operator">*</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> handoff <span class="token builtin">bool</span><span class="token punctuation">,</span> skipframes <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> s<span class="token punctuation">.</span>ticket <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">goyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">goyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">mcall</span><span class="token punctuation">(</span>goyield_m<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">goyield_m</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunning<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>
	<span class="token function">dropg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">runqput</span><span class="token punctuation">(</span>pp<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 加入本地队列然后调度本地g</span>
	<span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="1-16"><a href="#1-16" class="headerlink" title="1.16"></a>1.16</h2><h3 id="embed"><a href="#embed" class="headerlink" title="embed"></a>embed</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token boolean">_</span> <span class="token string">"embed"</span>

<span class="token comment">//go:embed hello.txt</span>
<span class="token keyword">var</span> s <span class="token builtin">string</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">print</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="io-fs"><a href="#io-fs" class="headerlink" title="io/fs"></a>io/fs</h3>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/11/18/k8s/cgroup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/k8s/cgroup/" class="post-title-link" itemprop="url">cgroup</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-18 15:00:34" itemprop="dateCreated datePublished" datetime="2020-11-18T15:00:34+00:00">2020-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="V1"><a href="#V1" class="headerlink" title="V1"></a>V1</h2><img src="/2020/11/18/k8s/cgroup/cgroupV1.jpg" class="">

<h2 id="V2"><a href="#V2" class="headerlink" title="V2"></a>V2</h2><img src="/2020/11/18/k8s/cgroup/cgroupV2.jpg" class="">

<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># ls /sys/fs/cgroup/ |grep cpu
cpu
cpuacct
cpu,cpuacct
cpuset

# cat /sys/fs/cgroup/cpu/user.slice/tasks
4872
21893
21896
21907
21913
21914
# ps -ef | grep 21896 | grep -v grep
root     21896     1  0 14:15 ?        00:00:00 /usr/lib/systemd/systemd --user
root     21907 21896  0 14:15 ?        00:00:00 (sd-pam)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<blockquote>
<p>tasks中记录cgroup内pid</p>
</blockquote>
<h2 id="cgroup-amp-namespace-amp-unionFS"><a href="#cgroup-amp-namespace-amp-unionFS" class="headerlink" title="cgroup &amp; namespace &amp; unionFS"></a>cgroup &amp; namespace &amp; unionFS</h2><ol>
<li>cgroup用于隔离物理资源： cpu，mem等</li>
<li>namespace用于隔离pid间资源：<br> pid namespace用于模拟容器内root用户<br> mount namespace用于模拟容器内所属目录</li>
<li>unionFS用于分层搭建容器FS，参见overlay2</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/11/18/go/wgb/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/18/go/wgb/" class="post-title-link" itemprop="url">三色标记清除法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-11-18 12:37:20" itemprop="dateCreated datePublished" datetime="2020-11-18T12:37:20+00:00">2020-11-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/go/" itemprop="url" rel="index"><span itemprop="name">go</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="原始标记清除法"><a href="#原始标记清除法" class="headerlink" title="原始标记清除法"></a>原始标记清除法</h2><img src="/2020/11/18/go/wgb/mark_and_sweep.jpg" class="">

<ol>
<li>从root开始循环遍历对象，mark</li>
<li>对未mark对象，sweep</li>
</ol>
<h2 id="三色标记清除法"><a href="#三色标记清除法" class="headerlink" title="三色标记清除法"></a>三色标记清除法</h2><blockquote>
<p>白： 未标记，本次GC被sweep对象<br>灰： 待标记，最终转黑<br>黑： 标记，本次GC保留对象</p>
</blockquote>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ol>
<li>初始所有对象为**<em>白**</em></li>
<li>从root开始遍历一次对象，标记为**<em>灰**</em></li>
<li>遍历一次*<strong>灰**<em>，标记本对象为</em></strong>黑*<strong>，标记引用对象为**<em>灰</em></strong>，重复本操作</li>
<li>剩余**<em>白**</em>即为待sweep对象</li>
</ol>
<h3 id="若不使用STW的问题"><a href="#若不使用STW的问题" class="headerlink" title="若不使用STW的问题"></a>若不使用STW的问题</h3><ol>
<li>白的(灰)引用被破坏</li>
<li>白被黑引用</li>
</ol>
<blockquote>
<p>满足以上2个条件，产生错误sweep</p>
</blockquote>
<h3 id="强三色不变式"><a href="#强三色不变式" class="headerlink" title="强三色不变式"></a>强三色不变式</h3><p>不允许白被黑引用</p>
<h3 id="若三色不变式"><a href="#若三色不变式" class="headerlink" title="若三色不变式"></a>若三色不变式</h3><p>允许白被黑引用的前提：白的上游链路存在灰</p>
<h3 id="插入写屏障"><a href="#插入写屏障" class="headerlink" title="插入写屏障"></a>插入写屏障</h3><blockquote>
<p>对象被引用时触发<br>满足强三色不变式</p>
</blockquote>
<p>对象被引用时，设为**<em>灰**</em></p>
<h4 id="插入写屏障问题"><a href="#插入写屏障问题" class="headerlink" title="插入写屏障问题"></a>插入写屏障问题</h4><p>为提高GC效率，<font color="red">栈内存</font>不执行插入写屏障</p>
<p>解决：</p>
<ol>
<li>三色标记完成后，栈对象统一变**<em>白**</em></li>
<li>启动STW</li>
<li>三色标记处理栈对象</li>
<li>停止STW</li>
</ol>
<blockquote>
<p>STW扫描栈对象耗时10-100ms</p>
</blockquote>
<h3 id="删除屏障"><a href="#删除屏障" class="headerlink" title="删除屏障"></a>删除屏障</h3><blockquote>
<p>对象被删除时触发<br>满足弱三色不变式</p>
</blockquote>
<p>标记下游引用对象为**<em>灰**</em></p>
<h4 id="删除屏障问题"><a href="#删除屏障问题" class="headerlink" title="删除屏障问题"></a>删除屏障问题</h4><p>删除对象下游对象最终会被标记为**<em>黑**</em>，可能无其他引用，本轮GC保留一轮，在下轮GC清除</p>
<h3 id="混合写屏障-结合写屏障和删除屏障"><a href="#混合写屏障-结合写屏障和删除屏障" class="headerlink" title="混合写屏障 (结合写屏障和删除屏障)"></a>混合写屏障 (结合写屏障和删除屏障)</h3><ol>
<li>初始扫描<font color="red">栈可达对象</font>标记为*<strong>黑**<em>，GC期间新创建的栈对象直接标记为</em></strong>黑*** (解决写屏障问题)</li>
<li>被删除对象为**<em>灰**</em> (删除屏障)</li>
<li>被添加对象为**<em>灰**</em> (写屏障)</li>
</ol>
<h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/10/22/k8s/overlay2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/22/k8s/overlay2/" class="post-title-link" itemprop="url">overlay2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-22 22:35:45" itemprop="dateCreated datePublished" datetime="2020-10-22T22:35:45+00:00">2020-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <img src="/2020/10/22/k8s/overlay2/unionFS.png" class="">

<blockquote>
<p>所有image层之上是<font color="red">容器层</font>，容器内修改操作仅发生在容器层<br>可通过docker外挂方式将物理机目录挂在进容器</p>
</blockquote>
<pre><code class="shell"># docker info | grep -E "Storage Driver|Root"
 Storage Driver: overlay2
 Docker Root Dir: /var/lib/docker

# pwd
/var/lib/docker/image
# ll
总用量 0
drwx------ 5 root root 81 6月  30 23:40 overlay2

# docker images | grep nginx |grep 1.9.1
nginx                                                             1.9.1               94ec7e53edfc        5 years ago         133MB
# pwd
/var/lib/docker/image/overlay2/imagedb/content/sha256
# ll |grep 94ec7e53edfc
-rw------- 1 root root 4520 6月  21 22:39 94ec7e53edfc793d6d8412b4748cd84270da290ce9256730eb428574f98f7c95
# cat 94ec7e53edfc793d6d8412b4748cd84270da290ce9256730eb428574f98f7c95 | jq . |grep -A 20 rootfs
  "rootfs": {
    "type": "layers",
    "diff_ids": [
      "sha256:d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5",
      "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",
      "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",
      ......
    ]
  }
}

# pwd
/var/lib/docker/image/overlay2/layerdb/sha256

# layer1 = diff_ids[0]
# ll |grep d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5
drwx------ 2 root root 71 6月  21 22:39 d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5

# layer2 = layer1 + diff_ids[1]
# echo -n "sha256:d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5 sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef" | sha256sum
c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843  -
# ll |grep c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843
drwx------ 2 root root 85 6月  21 22:39 c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843

# layer3 = layer2 + diff_ids[2]
# echo -n "sha256:c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843 sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef" | sha256sum
8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8  -
# ll |grep 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8
drwx------ 2 root root 85 6月  21 22:39 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8

# layer -&gt; rootfs cache-id
# cat 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8/cache-id
86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1e
# pwd
/var/lib/docker/overlay2
# ll | grep 86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1e
drwx------ 4 root root     72 6月  21 22:39 86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1e
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/10/14/mysql/latch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/14/mysql/latch/" class="post-title-link" itemprop="url">innodb btree latch 学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-10-14 22:38:45" itemprop="dateCreated datePublished" datetime="2020-10-14T22:38:45+00:00">2020-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysql5-6-modify-leaf"><a href="#mysql5-6-modify-leaf" class="headerlink" title="mysql5.6 modify leaf"></a>mysql5.6 modify leaf</h2><img src="/2020/10/14/mysql/latch/5.6modifyleaf.jpg" class="">

<h2 id="mysql5-6-modify-tree"><a href="#mysql5-6-modify-tree" class="headerlink" title="mysql5.6 modify tree"></a>mysql5.6 modify tree</h2><img src="/2020/10/14/mysql/latch/5.6modifytree.jpg" class="">

<h2 id="mysql5-7-select-amp-modify-leaf"><a href="#mysql5-7-select-amp-modify-leaf" class="headerlink" title="mysql5.7 select &amp; modify leaf"></a>mysql5.7 select &amp; modify leaf</h2><img src="/2020/10/14/mysql/latch/5.7select_modifyleaf.jpg" class="">

<h2 id="mysql5-7-modify-tree"><a href="#mysql5-7-modify-tree" class="headerlink" title="mysql5.7 modify tree"></a>mysql5.7 modify tree</h2><img src="/2020/10/14/mysql/latch/5.7modifytree.jpg" class="">

<h2 id="5-6-gt-5-7"><a href="#5-6-gt-5-7" class="headerlink" title="5.6 -> 5.7"></a>5.6 -&gt; 5.7</h2><ul>
<li>sx lock</li>
<li>non-leaf page lock</li>
</ul>
<h2 id="锁兼容"><a href="#锁兼容" class="headerlink" title="锁兼容"></a>锁兼容</h2><table>
<thead>
<tr>
<th>锁</th>
<th>IS</th>
<th>IX</th>
<th>S</th>
<th>X</th>
</tr>
</thead>
<tbody><tr>
<td>IS</td>
<td>兼容</td>
<td>兼容</td>
<td>兼容</td>
<td>互斥</td>
</tr>
<tr>
<td>IX</td>
<td>兼容</td>
<td>兼容</td>
<td>互斥</td>
<td>互斥</td>
</tr>
</tbody></table>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><ul>
<li><a href="https://zhuanlan.zhihu.com/p/151397269" title="" target="">InnoDB btree latch 优化历程</a>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/31/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/31/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">分布式学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-31 00:59:32" itemprop="dateCreated datePublished" datetime="2020-07-31T00:59:32+00:00">2020-07-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="2PC-数据库server层"><a href="#2PC-数据库server层" class="headerlink" title="2PC (数据库server层)"></a>2PC (数据库server层)</h2><blockquote>
<p>prepare/commit/rollback</p>
</blockquote>
<ul>
<li>Prepare 阶段(事务协调者向所有参与者发起prepare): 回滚段设置为prepare；写redolog并刷盘</li>
<li>Commit 阶段(所有参与者回复待提交，向所有参与者发起commit，否则发起rollback)： 写binlog；刷盘；InnoDB commit</li>
</ul>
<h3 id="2PC崩溃恢复"><a href="#2PC崩溃恢复" class="headerlink" title="2PC崩溃恢复"></a>2PC崩溃恢复</h3><ul>
<li>Prepare 阶段崩溃: 已写redolog，commit阶段前崩溃，回滚</li>
<li>commit 阶段： 写binlog前崩溃，回滚</li>
<li>已写binlog： InnoDB commit前崩溃，重新执行commit完成提交</li>
</ul>
<h3 id="崩溃恢复过程"><a href="#崩溃恢复过程" class="headerlink" title="崩溃恢复过程"></a>崩溃恢复过程</h3><blockquote>
<p>binlog日志每次rotate时，保证没有正在提交事务，并将redolog刷盘，保证rotate时旧的binlog事务为已提交状态</p>
</blockquote>
<p>通过index找到最后一个binlog日志，遍历并解析日志中每个XID-event，判断事务是否需要回滚</p>
<h3 id="2PC问题"><a href="#2PC问题" class="headerlink" title="2PC问题"></a>2PC问题</h3><p>commit阶段某个参与者失败或超时，其他参与者是commit还是rollback</p>
<h3 id="组提交"><a href="#组提交" class="headerlink" title="组提交"></a>组提交</h3><blockquote>
<p>5.6以前对整个2PC阶段加锁，因此每个事务需刷3次盘（写 redolog，写 binlog，写 commit），性能较低</p>
</blockquote>
<ol>
<li>prepare阶段：回滚段设置为prepare</li>
<li>commit阶段</li>
<li>1 flush stage：写redolog并刷盘，多个线程按进入的顺序将 binlog 从 cache 写入文件（不刷盘）</li>
<li>2 sync stage：对 binlog 文件做 fsync 操作（多个线程的 binlog 合并一次刷盘）</li>
<li>3 commit stage：各个线程按顺序做 InnoDB commit 操作</li>
</ol>
<ul>
<li>每个stage为一个队列，有锁保护，第一个进入队列的线程为leader，后续进入队列为follower，队列满员后，leader领导队列全员执行stage并进入下个stage。若下个stage非空，leader注册为下个stage的follower并加入。</li>
<li>将redo操作加入组提交，提升性能</li>
<li>通过将锁粒度细化，3个阶段可并行执行，提升性能</li>
</ul>
<h3 id="XA"><a href="#XA" class="headerlink" title="XA"></a>XA</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; XA START 'abc','def',2;
Query OK, 0 rows affected (0.01 sec)

mysql&gt; insert into t1 values(1,1);
Query OK, 1 row affected (0.00 sec)

mysql&gt; XA END 'abc','def',2;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; XA PREPARE 'abc','def',2;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; XA RECOVER;
+----------+--------------+--------------+--------+
| formatID | gtrid_length | bqual_length | data   |
+----------+--------------+--------------+--------+
|        2 |            3 |            3 | abcdef |
+----------+--------------+--------------+--------+
1 row in set (0.00 sec)

mysql&gt; XA COMMIT 'abc','def',2;
Query OK, 0 rows affected (0.02 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; XA START 'xatest';
Query OK, 0 rows affected (0.01 sec)

mysql&gt; insert into t1 values(2,2);
Query OK, 1 row affected (0.00 sec)

mysql&gt; XA END 'xatest';
Query OK, 0 rows affected (0.00 sec)

mysql&gt; XA RECOVER;
Empty set (0.00 sec)

mysql&gt; XA COMMIT 'xatest' one phase;
Query OK, 0 rows affected (0.02 sec)

mysql&gt; XA RECOVER;
Empty set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="最终一致性-应用层"><a href="#最终一致性-应用层" class="headerlink" title="最终一致性 (应用层)"></a>最终一致性 (应用层)</h2><p>A系统扣钱，发送信息给中间件，B系统接收信息加钱</p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>A先update DB，后发送消息，若发送失败，B无法加钱<br>A先发送消息，后update DB，若update DB失败，已发送消息无法撤回</p>
<p>将网络和DB事务放在同一个事务中，导致DB长事务</p>
<h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h2><p>应用层2PC事务最终一致性</p>
<blockquote>
<p>Try/Confirm/Cancel</p>
</blockquote>
<ul>
<li>阶段1： 协调者调用所有参与者的Try</li>
<li>阶段2:  所有Try成功后调用Confirm，否则调用Cancel</li>
</ul>
<h3 id="TCC问题"><a href="#TCC问题" class="headerlink" title="TCC问题"></a>TCC问题</h3><p>Confirm/Cancel若失败不断重试，必须等幂操作</p>
<h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><p>A、B、C转账，A给C转30，B给C转50，最终C +80，A -30，B -50</p>
<ul>
<li>阶段1： A锁定30，B锁定50，检查C是否可以转钱</li>
<li>阶段2: ABC开始转钱，任意一个失败不断重试</li>
</ul>
<h3 id="事务状态表-日志流水表"><a href="#事务状态表-日志流水表" class="headerlink" title="事务状态表/日志流水表"></a>事务状态表/日志流水表</h3><p>A给C转30，如何保证AC同时转账成功</p>
<p>调用方维护事务状态表，每次调用前记录流水，调用成功后更新流水状态，流水事务ID全局唯一<br>后台任务不断检查流水表，若存在长时间未成功流水，尝试重试该流水事务ID的转账，根据TCC幂等性最终保证一致性</p>
<ol>
<li>若多次重试失败，状态置未错误，需人工干预</li>
<li>若调用方调用部分成功，此时客户端可返回未知需稍后确认，等待人工处理</li>
</ol>
<h3 id="弱一致性-状态补偿"><a href="#弱一致性-状态补偿" class="headerlink" title="弱一致性 + 状态补偿"></a>弱一致性 + 状态补偿</h3><p>电商网站下单，库存库扣减，订单库累加，如何保证2个操作的原子性</p>
<ul>
<li>最终一致性方案，容易导致超卖</li>
<li>TCC强同步方案，性能不足</li>
<li>弱一致性（允许少卖，不许超卖）</li>
</ul>
<p>先扣库存再提交订单例：</p>
<ol>
<li>扣库存失败，不提交订单，返回失败，调用方重试（多扣库存）</li>
<li>扣库存成功，提交订单失败，返回失败，调用方重试（多扣库存）</li>
<li>扣库存成功，提交订单成功，返回成功。</li>
</ol>
<p>先提交订单再扣库存同理，保证库存可以多扣不能少扣</p>
<p>多扣库存补偿机制：<br>每次扣库存生成流水日志，通过关联订单系统中未支付订单和流水日志，可以回收对应库存</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/29/sys/dns/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/29/sys/dns/" class="post-title-link" itemprop="url">dns</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-29 00:02:57" itemprop="dateCreated datePublished" datetime="2020-07-29T00:02:57+00:00">2020-07-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="dig"><a href="#dig" class="headerlink" title="dig"></a>dig</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dig www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2020/07/29/sys/dns/dig.png" class="">

<blockquote>
<p>第一段是查询参数和统计</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig1.png" class="">

<blockquote>
<p>第二段是查询内容，<code>A</code>是address的缩写，<code>CNAME</code>是域名的别名拥有相同ip</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig2.png" class="">

<blockquote>
<p>第三段是DNS服务器的答复，300为TTL，表示缓存时间，300秒内不用重复查询</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig3.png" class="">

<blockquote>
<p>第四段是NS(Name Server)名称和对应ip</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig4.png" class="">

<blockquote>
<p>第五段是DNS服务器的一些传输信息，192.168.31.1为本机DNS，查询端口53(DNS默认端口)，回应长度104字节</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig5.png" class="">

<h2 id="DNS服务器"><a href="#DNS服务器" class="headerlink" title="DNS服务器"></a>DNS服务器</h2><p>windows中dns服务器由网关自动分配成为<code>DHCP</code>，也可手动设置dns<br>linux系统dns配置文件为<code>/etc/resolv.conf</code><br><code>192.168.31.1</code>是内网DNS服务器，也可使用公网DNS服务器，如GOOGLE的<code>8.8.8.8</code></p>
<blockquote>
<p>dig指定DNS服务器查询</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dig @8.8.8.8 www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h2 id="分级查询"><a href="#分级查询" class="headerlink" title="分级查询"></a>分级查询</h2><h3 id="域名层级"><a href="#域名层级" class="headerlink" title="域名层级"></a>域名层级</h3><pre class="line-numbers language-text" data-language="text"><code class="language-text">主机名.次级域名.顶级域名.根域名<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="根域名"><a href="#根域名" class="headerlink" title="根域名"></a>根域名</h3><p>全世界<code>A.ROOT-SERVERS.NET</code>到<code>M.ROOT-SERVERS.NET</code>共十三组</p>
<h3 id="逐级查询"><a href="#逐级查询" class="headerlink" title="逐级查询"></a>逐级查询</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">dig +trace www.baidu.com<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<blockquote>
<p>根域名-&gt;顶级域名-&gt;次级域名-&gt;name server-&gt;服务器内网主机</p>
</blockquote>
<img src="/2020/07/29/sys/dns/dig_trace1.png" class="">
<img src="/2020/07/29/sys/dns/dig_trace2.png" class="">

<h2 id="nslookup"><a href="#nslookup" class="headerlink" title="nslookup"></a>nslookup</h2><blockquote>
<p>交互式dns查询</p>
</blockquote>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">nslookup<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<img src="/2020/07/29/sys/dns/nslookup.png" class="">

<h2 id="linux-dns配置"><a href="#linux-dns配置" class="headerlink" title="linux dns配置"></a>linux dns配置</h2><h3 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="/etc/hosts"></a>/etc/hosts</h3><blockquote>
<p>配置地址和域名的映射</p>
</blockquote>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">1.1.1.1 www.baidu.com
2.2.2.2 www.qq.com<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h3 id="etc-resolv-conf"><a href="#etc-resolv-conf" class="headerlink" title="/etc/resolv.conf"></a>/etc/resolv.conf</h3><blockquote>
<p>除了nameserver以外皆为可选设置</p>
</blockquote>
<pre class="line-numbers language-yml" data-language="yml"><code class="language-yml">domain abc
search x.y.z qqq
nameserver 1.1.1.1
nameserver 2.2.2.2

<span class="token key atrule">options timeout</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">options attempts</span><span class="token punctuation">:</span> <span class="token number">2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="domain"><a href="#domain" class="headerlink" title="domain"></a>domain</h4><p>定义本地域名</p>
<h4 id="search"><a href="#search" class="headerlink" title="search"></a>search</h4><p>定义域名搜索列表</p>
<h4 id="nameserver"><a href="#nameserver" class="headerlink" title="nameserver"></a>nameserver</h4><ul>
<li>最多配置3个</li>
<li>顺序轮询，前一个超时后轮询下一个</li>
</ul>
<h4 id="options"><a href="#options" class="headerlink" title="options"></a>options</h4><p>默认<code>timeout 5, attempts 2</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/21/mysql/backup/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/21/mysql/backup/" class="post-title-link" itemprop="url">backp</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-21 00:54:09" itemprop="dateCreated datePublished" datetime="2020-07-21T00:54:09+00:00">2020-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="mysqlbackup-MBE-amp-xtrabackup"><a href="#mysqlbackup-MBE-amp-xtrabackup" class="headerlink" title="mysqlbackup(MBE) &amp; xtrabackup"></a>mysqlbackup(MBE) &amp; xtrabackup</h2><p>利用mysql crash recover使用redo log恢复机制<br>FTWRL复制获取binlog点或gtid</p>
<h3 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h3><p>get LSN checkpoint &amp; backup undo file &amp; innoDB tables and files<br>Executing FLUSH NO_WRITE_TO_BINLOG TABLES<br>Executing FLUSH TABLES WITH READ LOCK<br>backup non-InnoDB tables and files<br>Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS<br>The latest check point (for incremental): ‘68809340’<br>Executing UNLOCK TABLES<br>backup bufferpool dump<br>xtrabackup: Transaction log of lsn (68809340) to (68809349) was copied</p>
<h4 id="Executing-FLUSH-NO-WRITE-TO-BINLOG-ENGINE-LOGS"><a href="#Executing-FLUSH-NO-WRITE-TO-BINLOG-ENGINE-LOGS" class="headerlink" title="Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS"></a>Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS</h4><p>通过切换binlog并拷贝最后一个binlog，恢复时使用最后一个binlog恢复至一致点<br>若存在大事务可能无法切换binlog(flush被长时间阻塞)</p>
<h3 id="MBE"><a href="#MBE" class="headerlink" title="MBE"></a>MBE</h3><p>Starting log scan from lsn = 68824576 at offset = 66322432 and checkpoint = 68824590 in file /DBAASLOG/RED/ib_logfile0<br>backup innoDB tables and files &amp; undo file<br>backup bufferpool<br>FTWRL<br>backup non-innodb tables and files<br>Scanned log up to lsn 68824890<br>All tables unlocked</p>
<h2 id="二级备份技术"><a href="#二级备份技术" class="headerlink" title="二级备份技术"></a>二级备份技术</h2><blockquote>
<p>RTO: 灾难恢复时长<br>RPO: 灾难丢失数据时长</p>
</blockquote>
<table>
<thead>
<tr>
<th>技术点</th>
<th>RTO</th>
<th>RPO</th>
<th>消耗资源</th>
</tr>
</thead>
<tbody><tr>
<td>逻辑全量</td>
<td>小时级</td>
<td>天级</td>
<td>高</td>
</tr>
<tr>
<td>逻辑全量+逻辑日志</td>
<td>小时级</td>
<td>秒级</td>
<td>高</td>
</tr>
<tr>
<td>物理全量</td>
<td>小时级</td>
<td>天级</td>
<td>中</td>
</tr>
<tr>
<td>物理全量+物理增量</td>
<td>小时级</td>
<td>小时级</td>
<td>低</td>
</tr>
<tr>
<td>物理全量+物理增量+逻辑日志</td>
<td>小时级</td>
<td>秒级</td>
<td>低</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/21/mysql/mysqldump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/21/mysql/mysqldump/" class="post-title-link" itemprop="url">mysqldump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-21 00:54:09" itemprop="dateCreated datePublished" datetime="2020-07-21T00:54:09+00:00">2020-07-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致"><a href="#默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致" class="headerlink" title="默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致"></a>默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致</h2><ol>
<li>获取gtid或file postion</li>
<li>顺序逻辑备份每个库，不同库之间备份时间点不同</li>
<li>1 同时lock库中所有表READ锁，使库变为只读</li>
<li>2 show create table + select * from table， 导出</li>
<li>3 unlock tables</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:02:01.441631Z	   18 Query	SHOW CREATE DATABASE IF NOT EXISTS `test`
2020-11-01T16:02:01.441820Z	   18 Query	show tables
2020-11-01T16:02:01.442210Z	   18 Query	LOCK TABLES `employees` READ /*!32311 LOCAL */,`t1` READ /*!32311 LOCAL */,`test` READ /*!32311 LOCAL */,`test_auto` READ /*!32311 LOCAL */
...
2020-11-01T16:02:04.181862Z	   18 Query	UNLOCK TABLES<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="–lock-all-tables-所有库备份点一致"><a href="#–lock-all-tables-所有库备份点一致" class="headerlink" title="–lock-all-tables  所有库备份点一致"></a>–lock-all-tables  所有库备份点一致</h2><p>整个数据库变为只读</p>
<pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:16:57.678240Z	   21 Query	FLUSH TABLES
2020-11-01T16:16:58.204729Z	   21 Query	FLUSH TABLES WITH READ LOCK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<h2 id="–single-transaction-所有innodb表备份点一致"><a href="#–single-transaction-所有innodb表备份点一致" class="headerlink" title="–single-transaction  所有innodb表备份点一致"></a>–single-transaction  所有innodb表备份点一致</h2><ol>
<li>设置会话隔离级别为RR</li>
<li>开启一个MVCC会话，START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */ ，开启会话时自带一次select保证备份点之后的读一致性</li>
<li>创建SAVEPOINT开始表备份，在ROLLBACK TO SAVEPOINT前对表的DDL阻塞</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:20:35.440889Z	   22 Query	SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-11-01T16:20:35.441080Z	   22 Query	START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */
...
2020-11-01T16:20:35.451846Z	   22 Query	UNLOCK TABLES
...
2020-11-01T16:20:35.471418Z	   22 Query	SHOW CREATE DATABASE IF NOT EXISTS `test`
2020-11-01T16:20:35.471499Z	   22 Query	SAVEPOINT sp
2020-11-01T16:20:35.478244Z	   22 Query	show tables
...
2020-11-01T16:20:35.484877Z	   22 Query	show create table `t1`
2020-11-01T16:20:35.486464Z	   22 Query	SELECT /*!40001 SQL_NO_CACHE */ * FROM `t1`
2020-11-01T16:20:35.488296Z	   22 Query	ROLLBACK TO SAVEPOINT sp
...
2020-11-01T16:20:35.489280Z	   22 Query	show create table `test`
2020-11-01T16:20:35.497826Z	   22 Query	SELECT /*!40001 SQL_NO_CACHE */ * FROM `test`
2020-11-01T16:20:38.400419Z	   22 Query	ROLLBACK TO SAVEPOINT sp
...
2020-11-01T16:20:38.403299Z	   22 Query	RELEASE SAVEPOINT sp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="–single-transaction-–master-data-2-需2次flush关表"><a href="#–single-transaction-–master-data-2-需2次flush关表" class="headerlink" title="–single-transaction + –master-data=2    需2次flush关表"></a>–single-transaction + –master-data=2    需2次flush关表</h2><p>–master-data需导出当前binlog位点，因此需FTWRL将数据库数据达到一致</p>
<ol>
<li>flush tables + FTWRL 整个数据库达到一致</li>
<li>设置RR，开启一致读会话</li>
<li>通过show master status获取binlog位点</li>
<li>UNLOCK TABLES</li>
</ol>
<pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:47:40.165353Z	   23 Query	FLUSH /*!40101 LOCAL */ TABLES
2020-11-01T16:47:40.190316Z	   23 Query	FLUSH TABLES WITH READ LOCK
2020-11-01T16:47:40.190471Z	   23 Query	SET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ
2020-11-01T16:47:40.190537Z	   23 Query	START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */
2020-11-01T16:47:40.190744Z	   23 Query	SHOW VARIABLES LIKE 'gtid\_mode'
2020-11-01T16:47:40.202013Z	   23 Query	SHOW MASTER STATUS
2020-11-01T16:47:40.204813Z	   23 Query	UNLOCK TABLES
...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>mysql –max-allowed-packet=16MB -BNe “SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME NOT IN (‘mysql’, ‘performance_schema’, ‘information_schema’, ‘sys’)” | tr ‘\n’ ‘ ‘ &gt; dbs.sql<br>mysqldump  –opt –add-drop-database –add-drop-table –complete-insert –default-character-set=utf8 –hex-blob –master-data=2 –quote-names –single-transaction –events –routines –triggers –databases $(cat dbs.sql) &gt; full_dump.sql</p>
<ul>
<li><p>-q, –quick   Don’t buffer query, dump directly to stdout. (Defaults to on; use –skip-quick to disable.)</p>
</li>
<li><p>–opt : Shorthand for –add-drop-table –add-locks –create-options –extended-insert –lock-tables –quick –set-charset</p>
</li>
<li><p>–lock-tables Lock all tables before dumping them</p>
</li>
<li><p>–single-transaction Issue a BEGIN SQL statement before dumping data from server</p>
</li>
<li><p>–hex-blob Dump binary columns using hexadecimal notation (for example, ‘abc’ becomes 0x616263)</p>
</li>
<li><p>–master-data=2 Write the binary log file name and position to the output as an SQL comment</p>
</li>
<li><p>–max-allowed-packet Maximum packet length to send to or receive from server</p>
</li>
<li><p>–events</p>
</li>
<li><p>–routines</p>
</li>
<li><p>–triggers</p>
</li>
<li><p>–complete-insert Use complete INSERT statements that include column names</p>
</li>
<li><p>–set-charset Add SET NAMES default_character_set to output</p>
</li>
<li><p>–add-drop-database</p>
</li>
<li><p>–add-drop-table</p>
</li>
<li><p>–add-locks</p>
</li>
<li><p>–default-character-set=utf8</p>
</li>
<li><p>–quick 流式取数据，非单次填充整个结果集到内存</p>
</li>
<li><p>–extended-insert Use multiple-row INSERT syntax</p>
</li>
<li><p>–create-options Include all MySQL-specific table options in CREATE TABLE statements</p>
</li>
<li><p>–flush-logs Flush MySQL server log files before starting dump</p>
</li>
<li><p>–lock-all-tables Lock all tables across all databases</p>
</li>
<li><p>–set-gtid-purged Whether to add SET @@GLOBAL.GTID_PURGED to output</p>
</li>
<li><p>–databases</p>
</li>
<li><p>–tables</p>
</li>
<li><p>–no-create-db</p>
</li>
<li><p>–no-create-info</p>
</li>
<li><p>–no-data</p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/19/sys/tcpdump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/19/sys/tcpdump/" class="post-title-link" itemprop="url">tcpdump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-19 20:44:37" itemprop="dateCreated datePublished" datetime="2020-07-19T20:44:37+00:00">2020-07-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!/usr/bin/sh
set -o errexit
nohup tcpdump -i eth0 -C 512 -W 4 -w /tmp/tcpdump.cap &amp;
sleep 3<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>client &amp; server 互相确认对方receive和send</p>
<img src="/2020/07/19/sys/tcpdump/%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg" class="">

<ul>
<li>第一次握手 server： client send ok，server receive ok</li>
<li>第二次握手 client： client receive&amp;send ok， server receive&amp;send ok</li>
<li>第三次握手 server： client receive&amp;send ok， server receive&amp;send ok</li>
</ul>
<h3 id="两次握手问题"><a href="#两次握手问题" class="headerlink" title="两次握手问题"></a>两次握手问题</h3><ol>
<li>client first SYNC delayed</li>
<li>client second SYNC</li>
<li>server receive second SYNC &amp; ACK， conn established</li>
<li>client and server normally close conn</li>
<li>server receive delayed first SYNC &amp; ACK， conn established</li>
<li>client refuse first SYNC &amp; ACK， conn on server side will never close</li>
</ol>
<h3 id="半队列和全队列"><a href="#半队列和全队列" class="headerlink" title="半队列和全队列"></a>半队列和全队列</h3><ul>
<li>内核层队列默认参数net.core.somaxconn = 128</li>
<li>server端SYNC-RCVD状态连接存入半队列，不能大于内核somaxconn<ul>
<li>半队列默认参数net.ipv4.tcp_max_syn_backlog = 1024，当net.ipv4.tcp_syncookies = 1时半连接队列逻辑上无上限，该参数无效。</li>
<li>取min(backlog, tcp_max_syn_backlog, somaxconn)</li>
</ul>
</li>
<li>server端ESTABLISHED状态连接存入全队列，不能大于内核somaxconn<ul>
<li>全队列backlog参数由应用调用系统底层API: int listen(int sockfd, int backlog)时传入</li>
</ul>
</li>
</ul>
<h3 id="sync攻击"><a href="#sync攻击" class="headerlink" title="sync攻击"></a>sync攻击</h3><p>client短时间内伪造大量不存在ip来源sync包，server端ack由于ip不存在不断重发直至超时，占用半队列。</p>
<pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">netstat -n -p TCP | grep SYN_RECV<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<h3 id="系统message打印kernel：-TCP-request-sock-TCP-Possible-SYN-flooding-on-port-xxx-Sending-cookies"><a href="#系统message打印kernel：-TCP-request-sock-TCP-Possible-SYN-flooding-on-port-xxx-Sending-cookies" class="headerlink" title="系统message打印kernel： TCP request_sock_TCP: Possible SYN flooding on port xxx. Sending cookies."></a>系统message打印<code>kernel： TCP request_sock_TCP: Possible SYN flooding on port xxx. Sending cookies.</code></h3><p>client短时间大量SYN包，半队列无法及时处理，服务器自动启用net.ipv4.tcp_syncookies = 1</p>
<h2 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h2><img src="/2020/07/19/sys/tcpdump/%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg" class="">

<ul>
<li>第一次挥手： client发送FIN，处于FIN_WAIT1</li>
<li>第二次挥手：<ul>
<li>server收到FIN，发送ACK，处于CLOSE_WAIT</li>
<li>client收到ACK，进入FIN_WAIT2，等待server</li>
</ul>
</li>
<li>第三次挥手： server发送FIN，进入LAST_ACK</li>
<li>第四次挥手：<ul>
<li>client收到FIN，发送ACK，进入TIME_WAIT(2MSL)</li>
<li>server收到ACK，进入CLOSED</li>
</ul>
</li>
</ul>
<h3 id="为什么四次挥手"><a href="#为什么四次挥手" class="headerlink" title="为什么四次挥手"></a>为什么四次挥手</h3><p>第一次+第二次： client主动发送FIN要求断开conn，server ACK确认收到FIN<br>第三次+第四次： server完成必要动作后，发送FIN确认可断开conn，client ACK确认</p>
<h3 id="TIME-WAIT（2MSL）"><a href="#TIME-WAIT（2MSL）" class="headerlink" title="TIME_WAIT（2MSL）"></a>TIME_WAIT（2MSL）</h3><p>client ACK后若不等待2MSL而直接close conn，假设ACK丢失，server FIN超时重发，由于client已close conn会响应RST，server收到RST后无法正常close conn。</p>
<h2 id="wireshark"><a href="#wireshark" class="headerlink" title="wireshark"></a>wireshark</h2><ul>
<li>property(displayed/caputured)</li>
<li>filter<ul>
<li>frame.time</li>
<li>ip.src/dst</li>
<li>tcp.port/srcport/dstport</li>
</ul>
</li>
<li>ayalyze<ul>
<li>expert information</li>
</ul>
</li>
<li>statistic<ul>
<li>protocol hierarchy</li>
<li>conversation<ul>
<li>endpoint</li>
</ul>
</li>
<li>io graph</li>
<li>flow graph</li>
</ul>
</li>
</ul>
<h2 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h2><blockquote>
<p>结构数据小<br>无需建立连接，直接发送接收数据<br>TCP保证数据顺序有效，UDP不保证顺序且可能丢包</p>
</blockquote>
<h2 id="http2-wireshark"><a href="#http2-wireshark" class="headerlink" title="http2 wireshark"></a>http2 wireshark</h2><p>analyze -&gt; enabled protocols -&gt; 选中HTTP2<br>analyze -&gt; decode as -&gt; tcp port 的[current] 设置为HTTP2</p>
<img src="/2020/07/19/sys/tcpdump/http2_req.png" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res.png" class="">

<img src="/2020/07/19/sys/tcpdump/http2_req_head.jpeg" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res_head_false.jpeg" class="">
<img src="/2020/07/19/sys/tcpdump/http2_res_head_true.jpeg" class="">

<h2 id="How-to-get-tcpdump-for-containers-inside-Kubernetes-pods-How-to-get-tcpdump-for-containers-inside-Kubernetes-pods"><a href="#How-to-get-tcpdump-for-containers-inside-Kubernetes-pods-How-to-get-tcpdump-for-containers-inside-Kubernetes-pods" class="headerlink" title="[How to get tcpdump for containers inside Kubernetes pods](How to get tcpdump for containers inside Kubernetes pods)"></a>[How to get tcpdump for containers inside Kubernetes pods](<a target="_blank" rel="noopener" href="https://pvtl.force.com/s/article/How-to-get-tcpdump-for-containers-inside-Kubernetes-pods?language=en_US">How to get tcpdump for containers inside Kubernetes pods</a>)</h2><p>kubectl -n ns exec -it pod – sh<br>cat /sys/class/net/eth0/iflink<br>ip link |grep ^xx</p>
<h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><a href="https://mp.weixin.qq.com/s/-Q1AkxUr9xzGKwUMV-FQhQ" title="" target="">云网络丢包故障定位</a>
<a href="https://cilium.io/blog/2018/04/17/why-is-the-kernel-community-replacing-iptables" title="" target="">why-is-the-kernel-community-replacing-iptables</a>


<p>TODO SSL</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://yiduoyunq.github.io/2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yiduoyunQ">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yiduoyunQ">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">docker命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-07-17 00:28:00" itemprop="dateCreated datePublished" datetime="2020-07-17T00:28:00+00:00">2020-07-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-11-29 12:36:34" itemprop="dateModified" datetime="2021-11-29T12:36:34+00:00">2021-11-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/k8s/" itemprop="url" rel="index"><span itemprop="name">k8s</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>docker rm<br>docker rmi<br>docker pull<br>docker push<br>docker run</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker ps -a
docker inspect $id
docker stats $id
docker top $id

docker start $id
docker stop $id

docker exec -it $id bash

docker kill --signal=1 $id
docker rename $id {new_name}
docker update --cpuset-cpus=0-3 $id

docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
docker save -o target_image.tag.tar TARGET_IMAGE[:TAG]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">yiduoyunQ</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">48</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yiduoyunQ</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
