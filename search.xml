<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Tidb chunk</title>
      <link href="2021/02/02/yuque/Tidb%20chunk/"/>
      <url>2021/02/02/yuque/Tidb%20chunk/</url>
      
        <content type="html"><![CDATA[<h2 id="Chunk"><a href="#Chunk" class="headerlink" title="Chunk"></a>Chunk</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Chunk <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment">// 此 chunk 选择的行号</span>    <span class="token comment">// for example, if the Sel is [1, 5, 6], then</span>  <span class="token comment">//logical 0 -&gt; physical 1,</span>  <span class="token comment">//logical 1 -&gt; physical 5,</span>  <span class="token comment">//logical 2 -&gt; physical 6.</span>    <span class="token comment">//  GetRow(1) will return physical row 5</span>  sel <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>  columns <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Column <span class="token comment">// chunk 包含的列</span>  numVirtualRows <span class="token builtin">int</span>  capacity <span class="token builtin">int</span>  <span class="token comment">// requiredRows indicates how many rows the parent executor want.</span>  requiredRows <span class="token builtin">int</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Next is a wrapper function on e.Next(), it handles some common codes.</span><span class="token keyword">func</span> <span class="token function">Next</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> e Executor<span class="token punctuation">,</span> req <span class="token operator">*</span>chunk<span class="token punctuation">.</span>Chunk<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  <span class="token operator">...</span>    err <span class="token operator">:=</span> e<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> req<span class="token punctuation">)</span>    <span class="token operator">...</span>  <span class="token keyword">return</span> err<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="Delete-Executor"><a href="#Delete-Executor" class="headerlink" title="Delete Executor"></a>Delete Executor</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Next implements the Executor Next interface.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>DeleteExec<span class="token punctuation">)</span> <span class="token function">Next</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> req <span class="token operator">*</span>chunk<span class="token punctuation">.</span>Chunk<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  req<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> e<span class="token punctuation">.</span><span class="token function">deleteSingleTableByChunk</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// DeleteExec 以 chunk 为单位删除数据</span><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>DeleteExec<span class="token punctuation">)</span> <span class="token function">deleteSingleTableByChunk</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token comment">// newFirstChunk creates a new chunk to buffer current executor's result</span>    chk <span class="token operator">:=</span> <span class="token function">newFirstChunk</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>    iter <span class="token operator">:=</span> chunk<span class="token punctuation">.</span><span class="token function">NewIterator4Chunk</span><span class="token punctuation">(</span>chk<span class="token punctuation">)</span>        <span class="token comment">// Delete Executor 的 children 为 selection executor，结果赋值给 chk</span>    err <span class="token operator">:=</span> <span class="token function">Next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> e<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> chk<span class="token punctuation">)</span>    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> err    <span class="token punctuation">}</span>    <span class="token keyword">if</span> chk<span class="token punctuation">.</span><span class="token function">NumRows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>      <span class="token keyword">break</span>    <span class="token punctuation">}</span>        <span class="token comment">// chunkRow 代表一行 row</span>    <span class="token keyword">for</span> chunkRow <span class="token operator">:=</span> iter<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> chunkRow <span class="token operator">!=</span> iter<span class="token punctuation">.</span><span class="token function">End</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> chunkRow <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// 遍历 row 中的 column， 根据 fields 转换为一行 datum</span>            datumRow <span class="token operator">:=</span> chunkRow<span class="token punctuation">.</span><span class="token function">GetDatumRow</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span>      err <span class="token operator">=</span> e<span class="token punctuation">.</span><span class="token function">deleteOneRow</span><span class="token punctuation">(</span>tbl<span class="token punctuation">,</span> handleCols<span class="token punctuation">,</span> isExtrahandle<span class="token punctuation">,</span> datumRow<span class="token punctuation">)</span>      <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> err      <span class="token punctuation">}</span>      rowCount<span class="token operator">++</span>    <span class="token punctuation">}</span>    chk <span class="token operator">=</span> chunk<span class="token punctuation">.</span><span class="token function">Renew</span><span class="token punctuation">(</span>chk<span class="token punctuation">,</span> e<span class="token punctuation">.</span>maxChunkSize<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Chunk 通过 Executor 的 <code>Next</code> 由上至下传递<br><img src="https://cdn.nlark.com/yuque/0/2021/png/12555729/1612283535832-be830be4-4745-4fb7-b49b-d6f5d2510d44.png#align=left&amp;display=inline&amp;height=308&amp;margin=%5Bobject%20Object%5D&amp;name=executor.png&amp;originHeight=308&amp;originWidth=121&amp;size=10352&amp;status=done&amp;style=none&amp;width=121" alt="executor.png"></p><h2 id="Column"><a href="#Column" class="headerlink" title="Column"></a>Column</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Column <span class="token keyword">struct</span> <span class="token punctuation">{</span>  length     <span class="token builtin">int</span> <span class="token comment">// Column 有多少行数据</span>    nullBitmap <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// Column 中每个元素是否为null，bit 0 is null, 1 is not null</span>  offsets    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int64</span> <span class="token comment">// 变长 Column 使用，存储每个数据在data中的偏移量</span>  data       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// 整个 Column 的数据字节数组</span>  elemBuf    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span> <span class="token comment">// 定长 Column 使用，辅助encode和decode</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="定长字段"><a href="#定长字段" class="headerlink" title="定长字段"></a>定长字段</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12555729/1612254906352-d7762d7a-e78b-4f06-b029-a750fe0fc818.png#align=left&amp;display=inline&amp;height=281&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%AE%9A%E9%95%BF%E5%AD%97%E6%AE%B5.png&amp;originHeight=281&amp;originWidth=641&amp;size=18616&amp;status=done&amp;style=none&amp;width=641" alt="定长字段.png"><br>AppendXXX 流程</p><ol><li>使用 <code>unsafe.Pointer</code> 将数据赋值给 <strong>elemBuf</strong></li><li>将 <strong>elemBuf</strong> 数据 append 到 <strong>data</strong> 中</li><li><strong>nullBitmap</strong> append 1</li><li><strong>length</strong>++</li></ol><p>AppendNull 流程</p><ol><li>将 <strong>elemBuf</strong> 数据 append 到 <strong>data</strong> 中 （占位）</li><li><strong>nullBitmap</strong> append 0</li><li><strong>length</strong>++</li></ol><h3 id="变长字段"><a href="#变长字段" class="headerlink" title="变长字段"></a>变长字段</h3><p><img src="https://cdn.nlark.com/yuque/0/2021/png/12555729/1612255501961-ef77db64-2624-4475-9bac-19c6eba66836.png#align=left&amp;display=inline&amp;height=281&amp;margin=%5Bobject%20Object%5D&amp;name=%E5%8F%98%E9%95%BF%E5%AD%97%E6%AE%B5.png&amp;originHeight=281&amp;originWidth=761&amp;size=21203&amp;status=done&amp;style=none&amp;width=761" alt="变长字段.png"><br>AppendXXX 流程</p><ol><li>将数据 append 到 <strong>data</strong> 中</li><li><strong>nullBitmap</strong> append 1</li><li><strong>offsets</strong> append 当前 <strong>data</strong> 的 size 作为下一个元素在 <strong>data</strong> 中的起始位置</li><li><strong>length</strong>++</li></ol><p>AppendNull 流程</p><ol><li>跳过 append <strong>data</strong>，在 <strong>offsets</strong> 中 append 位置信息</li><li><strong>nullBitmap</strong> append 0</li><li><strong>length</strong>++</li></ol><h2 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h2><p><img src="https://cdn.nlark.com/yuque/0/2021/jpeg/12555729/1612256305916-d99797fa-a528-4e97-a7f3-7cbd6c0539d1.jpeg#align=left&amp;display=inline&amp;height=347&amp;margin=%5Bobject%20Object%5D&amp;name=Row.jpeg&amp;originHeight=347&amp;originWidth=301&amp;size=9329&amp;status=done&amp;style=none&amp;width=301" alt="Row.jpeg"><br>Chunk 中的 Row 是不同逻辑内存映射的数据，同一行 Row 数据在内存中不连续，获取单个 Column 的 Row 对象无需内存拷贝，使用 <code>unsafe.Pointer</code> 直接获取内存段</p><h2 id="Datum"><a href="#Datum" class="headerlink" title="Datum"></a>Datum</h2><p>每个元素最终转换为 <strong>Datum</strong> 结构体</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// Datum is a data box holds different kind of data.</span><span class="token comment">// It has better performance and is easier to use than `interface{}`.</span><span class="token keyword">type</span> Datum <span class="token keyword">struct</span> <span class="token punctuation">{</span>  k         <span class="token builtin">byte</span>        <span class="token comment">// datum kind.</span>  decimal   <span class="token builtin">uint16</span>      <span class="token comment">// decimal can hold uint16 values.</span>  length    <span class="token builtin">uint32</span>      <span class="token comment">// length can hold uint32 values.</span>  i         <span class="token builtin">int64</span>       <span class="token comment">// i can hold int64 uint64 float64 values.</span>  collation <span class="token builtin">string</span>      <span class="token comment">// collation hold the collation information for string value.</span>  b         <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>      <span class="token comment">// b can hold string or []byte values.</span>  x         <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// x hold all other types.</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="对比"><a href="#对比" class="headerlink" title="对比"></a>对比</h2><h3 id="老框架行取问题（Row-结构体不同）"><a href="#老框架行取问题（Row-结构体不同）" class="headerlink" title="老框架行取问题（Row 结构体不同）"></a>老框架行取问题（Row 结构体不同）</h3><ul><li>数据量多时，循环调用函数开销过大</li><li>Datum 占用过多无效内存，没有重用增加 GC 压力</li><li>每次循环输出一行，数据量过少，无法充分利用 CPU 的 pipeline，要进行更加缓存友好的计算</li><li>interface 类型数据，统计内存使用量较困难</li></ul><h3 id="Column-Row"><a href="#Column-Row" class="headerlink" title="Column + Row"></a>Column + Row</h3><ul><li>每次调用返回 <code>tidb_max_chunk_size</code> 数据，默认 1024 行，减少调用函数开销</li><li>采用 Chunk 列存，内存紧凑，没有额外内存开销</li><li>每次通过 Chunk 的 reset 方法清空内存并复用，减轻 GC 压力</li><li>查询执行过程更加缓存友好，在计算过程中尽量按列计算，增加 CPU Cache 命中率，充分利用 CPU 的 pipeline</li><li>Chunk 中没有 interface 结构体，内存监控和控制更方便</li><li>Child 负责将产出数据写入 Parent 传入的 Chunk</li></ul>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> Tidb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>语雀+Github Pages</title>
      <link href="2021/01/30/yuque/%E8%AF%AD%E9%9B%80+Github%20Pages/"/>
      <url>2021/01/30/yuque/%E8%AF%AD%E9%9B%80+Github%20Pages/</url>
      
        <content type="html"><![CDATA[<h2 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h2><ol><li>部署仓库(private) - Hexo + yuque-hexo + Github Actions</li><li>发布仓库(public) - Github Pages</li><li>腾讯云函数 - 语雀 URL 暂不支持 Http Head，添加明文 Github Token</li><li>语雀知识库(非公开)</li></ol><h2 id="调用流程"><a href="#调用流程" class="headerlink" title="调用流程"></a>调用流程</h2><p><img src="https://cdn.nlark.com/yuque/__mermaid_v3/da3688c4623b6d58858e1c4f627ad3c8.svg#lake_card_v2=eyJjb2RlIjoiZ3JhcGggTFJcbiAgaWQxKOivrembgCktLXdlYiBob29rLS0-aWQyKOiFvuiur-S6keWHveaVsClcblx0aWQyLS1yZXBvc2l0b3J5X2Rpc3BhdGNoLS0-aWQzKEdpdGh1YiBBY3Rpb25zKVxuXHRpZDMtLi0-aWQxXG5cdGlkMy0tPmlkNChHaXRodWIgUGFnZXMpIiwidHlwZSI6Im1lcm1haWQiLCJtYXJnaW4iOnRydWUsImlkIjoiR2ZVNGgiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19tZXJtYWlkX3YzL2RhMzY4OGM0NjIzYjZkNTg4NThlMWM0ZjYyN2FkM2M4LnN2ZyIsImhlaWdodCI6MTMzLCJjYXJkIjoiZGlhZ3JhbSJ9"></p><h2 id="token-关系"><a href="#token-关系" class="headerlink" title="token 关系"></a>token 关系</h2><p><img src="https://cdn.nlark.com/yuque/__mermaid_v3/22850a44af7dbba618d3ddef4566d7b9.svg#lake_card_v2=eyJjb2RlIjoiZ3JhcGggTFJcbiAgaWQxKOivrembgCktLXdlYiBob29rLS0-aWQyKOiFvuiur-S6keWHveaVsClcblx0aWQyLS3mmI7mlodHSVRIVUJfVE9LRU4tLT5pZDMoR2l0aHViIEFjdGlvbnMpXG5cdGlkMy0uc2VjcmV0cy5ZVVFVRV9UT0tFTi4tPmlkMVxuXHRpZDMtLXNlY3JldHMuR0lUSFVCX1RPS0VOLS0-aWQ0KEdpdGh1YiBQYWdlcykiLCJ0eXBlIjoibWVybWFpZCIsIm1hcmdpbiI6dHJ1ZSwiaWQiOiJwTWZqUiIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX21lcm1haWRfdjMvMjI4NTBhNDRhZjdkYmJhNjE4ZDNkZGVmNDU2NmQ3Yjkuc3ZnIiwiY2FyZCI6ImRpYWdyYW0ifQ=="></p><h2 id="Github-Actions-repository-dispatch"><a href="#Github-Actions-repository-dispatch" class="headerlink" title="Github Actions repository_dispatch"></a>Github Actions repository_dispatch</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">curl -X POST https://api.github.com/repos/yiduoyunQ/部署仓库/dispatches \    -H 'Accept: application/vnd.github.everest-preview+json' \    -H "Authorization: token 明文token" \    -d '{"event_type":"事件名"}'<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.zhwei.cn/hexo-github-actions-yuque/?utm_source=wechat_session&amp;utm_medium=social&amp;utm_oi=561094526920343552">Hexo：语雀云端写作 Github Actions 持续集成</a></p>]]></content>
      
      
      
        <tags>
            
            <tag> 语雀 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tidb parser test</title>
      <link href="2021/01/30/yuque/Tidb%20parser%20test/"/>
      <url>2021/01/30/yuque/Tidb%20parser%20test/</url>
      
        <content type="html"><![CDATA[<h2 id="Import-Dependencies"><a href="#Import-Dependencies" class="headerlink" title="Import Dependencies"></a>Import Dependencies</h2><blockquote><p>go get -v github.com/pingcap/tidb/types/parser_driver@328b6d0</p></blockquote><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>  <span class="token string">"fmt"</span>  <span class="token string">"github.com/pingcap/parser"</span>  <span class="token string">"github.com/pingcap/parser/ast"</span>  <span class="token boolean">_</span> <span class="token string">"github.com/pingcap/tidb/types/parser_driver"</span><span class="token punctuation">)</span><span class="token keyword">type</span> colX <span class="token keyword">struct</span> <span class="token punctuation">{</span>  colNames <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>colX<span class="token punctuation">)</span> <span class="token function">Enter</span><span class="token punctuation">(</span>in ast<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> name<span class="token punctuation">,</span> ok <span class="token operator">:=</span> in<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>ast<span class="token punctuation">.</span>ColumnName<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>    v<span class="token punctuation">.</span>colNames <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>colNames<span class="token punctuation">,</span> name<span class="token punctuation">.</span>Name<span class="token punctuation">.</span>O<span class="token punctuation">)</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> in<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>colX<span class="token punctuation">)</span> <span class="token function">Leave</span><span class="token punctuation">(</span>in ast<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">(</span>ast<span class="token punctuation">.</span>Node<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> in<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">extractColumnName</span><span class="token punctuation">(</span>rootNode <span class="token operator">*</span>ast<span class="token punctuation">.</span>StmtNode<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>  v <span class="token operator">:=</span> <span class="token operator">&amp;</span>colX<span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token punctuation">(</span><span class="token operator">*</span>rootNode<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>  <span class="token keyword">return</span> v<span class="token punctuation">.</span>colNames<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">parse</span><span class="token punctuation">(</span>sql <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  p <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  stmtNodes<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"parse error: %v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v\n"</span><span class="token punctuation">,</span> <span class="token function">extractColumnName</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stmtNodes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">normalize</span><span class="token punctuation">(</span>sql <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%v\n"</span><span class="token punctuation">,</span> parser<span class="token punctuation">.</span><span class="token function">Normalize</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  sql <span class="token operator">:=</span> <span class="token string">`SELECT a, b from t where c1=1 and c2='a' and c3='2021/01/30 0:00:00'`</span>  <span class="token function">parse</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span>     <span class="token comment">// a b c1 c2 c3 c c4</span>  <span class="token function">normalize</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span> <span class="token comment">// select a , b from t where c1 = ? and c2 = ? and c3 = ?</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p><a href="https://github.com/pingcap/parser/blob/master/docs/quickstart.md">pingcap/parser/docs/quickstart.md</a></p>]]></content>
      
      
      <categories>
          
          <category> Go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> Tidb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>反射</title>
      <link href="2021/01/25/go/reflect/"/>
      <url>2021/01/25/go/reflect/</url>
      
        <content type="html"><![CDATA[<h2 id="byte到string转换需要拷贝内存"><a href="#byte到string转换需要拷贝内存" class="headerlink" title="[]byte到string转换需要拷贝内存"></a>[]byte到string转换需要拷贝内存</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go">b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span>s <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>pbyte <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>SliceHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span>pstring <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>pbyte<span class="token punctuation">.</span>Data <span class="token operator">==</span> pstring<span class="token punctuation">.</span>Data<span class="token punctuation">)</span> <span class="token comment">// false</span>b <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token string">"ttt"</span><span class="token punctuation">)</span>pstring<span class="token punctuation">.</span>Data <span class="token operator">=</span> pbyte<span class="token punctuation">.</span>Datafmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// t</span>pstring<span class="token punctuation">.</span>Len <span class="token operator">=</span> pbyte<span class="token punctuation">.</span>Lenfmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token comment">// ttt</span>ss <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>psstring <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>reflect<span class="token punctuation">.</span>StringHeader<span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ss<span class="token punctuation">)</span><span class="token punctuation">)</span>fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>psstring<span class="token punctuation">.</span>Data <span class="token operator">==</span> pbyte<span class="token punctuation">.</span>Data<span class="token punctuation">)</span> <span class="token comment">// true</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>net poll</title>
      <link href="2020/11/23/go/net/"/>
      <url>2020/11/23/go/net/</url>
      
        <content type="html"><![CDATA[<h2 id="select-poll-epoll"><a href="#select-poll-epoll" class="headerlink" title="select / poll / epoll"></a>select / poll / epoll</h2><img src="/2020/11/23/go/net/select_poll_epoll.png" class=""><h2 id="net-Listen"><a href="#net-Listen" class="headerlink" title="net.Listen"></a>net.Listen</h2><img src="/2020/11/23/go/net/net_Listen.jpeg" class=""><ol><li><code>net.Listen</code>通过 <code>netFD.init</code> -&gt; <code>FD.Init</code> -&gt; <code>pollDesc.init</code> -&gt; 最终调用 <code>epollcreate1</code> 创建全局唯一 <strong>epfd</strong>，然后调用 <code>epollctl</code> 将 <strong>listener fd</strong>注册到epoll实例的事件队列</li><li>通过 <code>var serverInit sync.Once</code> 保证epollcreate1只在Listen时执行一次，后续Accept调用复用 <code>FD.Init</code> 时不会执行</li></ol><h2 id="net-Accept"><a href="#net-Accept" class="headerlink" title="net.Accept"></a>net.Accept</h2><img src="/2020/11/23/go/net/net_Accept.jpeg" class=""><ol><li><code>pollDesc.waitRead</code> 循环检测上层netFD的FD是否有 <strong>pdReady</strong> I/O事件，如果有I/O发生则返回，否则park当前goroutine直到对应FD可读或可写后返回。</li><li><code>FD.Accept</code> 返回后，调用 <code>newFD</code> 创建这个新的socket对应的 <strong>netFD</strong>， 然后调用 <code>netFD.init</code> 完成初始化，调用链同Listen，最终将 <strong>socket fd</strong> 注册到 <strong>listener fd</strong> 的epoll实例的事件队列中</li><li>被park的goroutine在 <code>func netpoll(delay int64) gList</code> 中调用 <code>epollwait</code> 处理可读/可写的事件fd，生成g链表返回。 <code>netpoll</code> 函数在proc的GPM逻辑中被调用</li></ol><h2 id="Conn-Read-Conn-Write"><a href="#Conn-Read-Conn-Write" class="headerlink" title="Conn.Read/Conn.Write"></a>Conn.Read/Conn.Write</h2><h2 id="net-flow"><a href="#net-flow" class="headerlink" title="net flow"></a>net flow</h2><ul><li>Listen创建epoll实例</li><li>client连接server，Listener调用Accept接收conn，每个conn开启一个goroutine处理，所有信息注册到epoll实例的事件队列</li><li>conn调用Read/Write时被park当前goroutine，在GPM逻辑中调用netpoll唤醒goroutine响应I/O事件</li></ul><p>epoll本质为系统内核顺序I/O，通过结合goroutine的GPM框架，解耦内核I/O和用户I/O，达到高并发I/O的设计</p><h2 id="ref"><a href="#ref" class="headerlink" title="ref"></a>ref</h2><p><a href="https://zhuanlan.zhihu.com/p/299047984">Go netpoller 网络模型之源码全面解析</a></p>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cgroup</title>
      <link href="2020/11/18/k8s/cgroup/"/>
      <url>2020/11/18/k8s/cgroup/</url>
      
        <content type="html"><![CDATA[<h2 id="V1"><a href="#V1" class="headerlink" title="V1"></a>V1</h2><img src="/2020/11/18/k8s/cgroup/cgroupV1.jpg" class=""><h2 id="V2"><a href="#V2" class="headerlink" title="V2"></a>V2</h2><img src="/2020/11/18/k8s/cgroup/cgroupV2.jpg" class=""><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># ls /sys/fs/cgroup/ |grep cpucpucpuacctcpu,cpuacctcpuset# cat /sys/fs/cgroup/cpu/user.slice/tasks48722189321896219072191321914# ps -ef | grep 21896 | grep -v greproot     21896     1  0 14:15 ?        00:00:00 /usr/lib/systemd/systemd --userroot     21907 21896  0 14:15 ?        00:00:00 (sd-pam)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>tasks中记录cgroup内pid</p></blockquote><h2 id="cgroup-amp-namespace-amp-unionFS"><a href="#cgroup-amp-namespace-amp-unionFS" class="headerlink" title="cgroup &amp; namespace &amp; unionFS"></a>cgroup &amp; namespace &amp; unionFS</h2><ol><li>cgroup用于隔离物理资源： cpu，mem等</li><li>namespace用于隔离pid间资源：<br> pid namespace用于模拟容器内root用户<br> mount namespace用于模拟容器内所属目录</li><li>unionFS用于分层搭建容器FS，参见overlay2</li></ol>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>三色标记清除法</title>
      <link href="2020/11/18/go/wgb/"/>
      <url>2020/11/18/go/wgb/</url>
      
        <content type="html"><![CDATA[<h2 id="原始标记清除法"><a href="#原始标记清除法" class="headerlink" title="原始标记清除法"></a>原始标记清除法</h2><img src="/2020/11/18/go/wgb/mark_and_sweep.jpg" class=""><ol><li>从root开始循环遍历对象，mark</li><li>对未mark对象，sweep</li></ol><h2 id="三色标记清除法"><a href="#三色标记清除法" class="headerlink" title="三色标记清除法"></a>三色标记清除法</h2><blockquote><p>白： 未标记，本次GC被sweep对象<br>灰： 待标记，最终转黑<br>黑： 标记，本次GC保留对象</p></blockquote><h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><ol><li>初始所有对象为**<em>白**</em></li><li>从root开始遍历一次对象，标记为**<em>灰**</em></li><li>遍历一次*<strong>灰**<em>，标记本对象为</em></strong>黑*<strong>，标记引用对象为**<em>灰</em></strong>，重复本操作</li><li>剩余**<em>白**</em>即为待sweep对象</li></ol><h3 id="若不使用STW的问题"><a href="#若不使用STW的问题" class="headerlink" title="若不使用STW的问题"></a>若不使用STW的问题</h3><ol><li>白的(灰)引用被破坏</li><li>白被黑引用</li></ol><blockquote><p>满足以上2个条件，产生错误sweep</p></blockquote><h3 id="强三色不变式"><a href="#强三色不变式" class="headerlink" title="强三色不变式"></a>强三色不变式</h3><p>不允许白被黑引用</p><h3 id="若三色不变式"><a href="#若三色不变式" class="headerlink" title="若三色不变式"></a>若三色不变式</h3><p>允许白被黑引用的前提：白的上游链路存在灰</p><h3 id="插入写屏障"><a href="#插入写屏障" class="headerlink" title="插入写屏障"></a>插入写屏障</h3><blockquote><p>对象被引用时触发<br>满足强三色不变式</p></blockquote><p>对象被引用时，设为**<em>灰**</em></p><h4 id="插入写屏障问题"><a href="#插入写屏障问题" class="headerlink" title="插入写屏障问题"></a>插入写屏障问题</h4><p>为提高GC效率，<font color="red">栈内存</font>不执行插入写屏障</p><p>解决：</p><ol><li>三色标记完成后，栈对象统一变**<em>白**</em></li><li>启动STW</li><li>三色标记处理栈对象</li><li>停止STW</li></ol><blockquote><p>STW扫描栈对象耗时10-100ms</p></blockquote><h3 id="删除屏障"><a href="#删除屏障" class="headerlink" title="删除屏障"></a>删除屏障</h3><blockquote><p>对象被删除时触发<br>满足弱三色不变式</p></blockquote><p>标记下游引用对象为**<em>灰**</em></p><h4 id="删除屏障问题"><a href="#删除屏障问题" class="headerlink" title="删除屏障问题"></a>删除屏障问题</h4><p>删除对象下游对象最终会被标记为**<em>黑**</em>，可能无其他引用，本轮GC保留一轮，在下轮GC清除</p><h3 id="混合写屏障-结合写屏障和删除屏障"><a href="#混合写屏障-结合写屏障和删除屏障" class="headerlink" title="混合写屏障 (结合写屏障和删除屏障)"></a>混合写屏障 (结合写屏障和删除屏障)</h3><ol><li>初始扫描<font color="red">栈可达对象</font>标记为*<strong>黑**<em>，GC期间新创建的栈对象直接标记为</em></strong>黑*** (解决写屏障问题)</li><li>被删除对象为**<em>灰**</em> (删除屏障)</li><li>被添加对象为**<em>灰**</em> (写屏障)</li></ol><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>overlay2</title>
      <link href="2020/10/22/k8s/overlay2/"/>
      <url>2020/10/22/k8s/overlay2/</url>
      
        <content type="html"><![CDATA[<img src="/2020/10/22/k8s/overlay2/unionFS.png" class=""><blockquote><p>所有image层之上是<font color="red">容器层</font>，容器内修改操作仅发生在容器层<br>可通过docker外挂方式将物理机目录挂在进容器</p></blockquote><pre><code class="shell"># docker info | grep -E "Storage Driver|Root" Storage Driver: overlay2 Docker Root Dir: /var/lib/docker# pwd/var/lib/docker/image# ll总用量 0drwx------ 5 root root 81 6月  30 23:40 overlay2# docker images | grep nginx |grep 1.9.1nginx                                                             1.9.1               94ec7e53edfc        5 years ago         133MB# pwd/var/lib/docker/image/overlay2/imagedb/content/sha256# ll |grep 94ec7e53edfc-rw------- 1 root root 4520 6月  21 22:39 94ec7e53edfc793d6d8412b4748cd84270da290ce9256730eb428574f98f7c95# cat 94ec7e53edfc793d6d8412b4748cd84270da290ce9256730eb428574f98f7c95 | jq . |grep -A 20 rootfs  "rootfs": {    "type": "layers",    "diff_ids": [      "sha256:d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5",      "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",      "sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef",      ......    ]  }}# pwd/var/lib/docker/image/overlay2/layerdb/sha256# layer1 = diff_ids[0]# ll |grep d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5drwx------ 2 root root 71 6月  21 22:39 d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5# layer2 = layer1 + diff_ids[1]# echo -n "sha256:d55f823e63e3bd76ed8a77582f6701fe86bbceb674e953fc218df06d10f99da5 sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef" | sha256sumc79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843  -# ll |grep c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843drwx------ 2 root root 85 6月  21 22:39 c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843# layer3 = layer2 + diff_ids[2]# echo -n "sha256:c79ce3b23816801c1c2f5a1eebd4e70b513c971670053bd0269689cb6c4c7843 sha256:5f70bf18a086007016e948b04aed3b82103a36bea41755b6cddfaf10ace3c6ef" | sha256sum8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8  -# ll |grep 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8drwx------ 2 root root 85 6月  21 22:39 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8# layer -&gt; rootfs cache-id# cat 8f5776356fae028caf803b96e16158934f12612836f99e273eab24c60465d5b8/cache-id86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1e# pwd/var/lib/docker/overlay2# ll | grep 86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1edrwx------ 4 root root     72 6月  21 22:39 86ee0049958014c13786026f642b9874a679f9c32ec12bfb5f7101747e43ec1e</code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>innodb btree latch</title>
      <link href="2020/10/14/mysql/latch/"/>
      <url>2020/10/14/mysql/latch/</url>
      
        <content type="html"><![CDATA[<h2 id="mysql5-6-modify-leaf"><a href="#mysql5-6-modify-leaf" class="headerlink" title="mysql5.6 modify leaf"></a>mysql5.6 modify leaf</h2><img src="/2020/10/14/mysql/latch/5.6modifyleaf.jpg" class=""><h2 id="mysql5-6-modify-tree"><a href="#mysql5-6-modify-tree" class="headerlink" title="mysql5.6 modify tree"></a>mysql5.6 modify tree</h2><img src="/2020/10/14/mysql/latch/5.6modifytree.jpg" class=""><h2 id="mysql5-7-select-amp-modify-leaf"><a href="#mysql5-7-select-amp-modify-leaf" class="headerlink" title="mysql5.7 select &amp; modify leaf"></a>mysql5.7 select &amp; modify leaf</h2><img src="/2020/10/14/mysql/latch/5.7select_modifyleaf.jpg" class=""><h2 id="mysql5-7-modify-tree"><a href="#mysql5-7-modify-tree" class="headerlink" title="mysql5.7 modify tree"></a>mysql5.7 modify tree</h2><img src="/2020/10/14/mysql/latch/5.7modifytree.jpg" class=""><h2 id="5-6-gt-5-7"><a href="#5-6-gt-5-7" class="headerlink" title="5.6 -> 5.7"></a>5.6 -&gt; 5.7</h2><ul><li>引入sx lock</li><li>引入non-leaf page lock</li></ul>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 锁 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>分布式学习</title>
      <link href="2020/07/31/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%A6%E4%B9%A0/"/>
      <url>2020/07/31/mysql/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<h2 id="2PC-数据库server层"><a href="#2PC-数据库server层" class="headerlink" title="2PC (数据库server层)"></a>2PC (数据库server层)</h2><blockquote><p>prepare/commit/rollback</p></blockquote><ul><li>Prepare 阶段(事务协调者向所有参与者发起prepare): 回滚段设置为prepare；写redolog并刷盘</li><li>Commit 阶段(所有参与者回复待提交，向所有参与者发起commit，否则发起rollback)： 写binlog；刷盘；InnoDB commit</li></ul><h3 id="2PC崩溃恢复"><a href="#2PC崩溃恢复" class="headerlink" title="2PC崩溃恢复"></a>2PC崩溃恢复</h3><ul><li>Prepare 阶段崩溃: 已写redolog，commit阶段前崩溃，回滚</li><li>commit 阶段： 写binlog前崩溃，回滚</li><li>已写binlog： InnoDB commit前崩溃，重新执行commit完成提交</li></ul><h3 id="崩溃恢复过程"><a href="#崩溃恢复过程" class="headerlink" title="崩溃恢复过程"></a>崩溃恢复过程</h3><blockquote><p>binlog日志每次rotate时，保证没有正在提交事务，并将redolog刷盘，保证rotate时旧的binlog事务为已提交状态</p></blockquote><p>通过index找到最后一个binlog日志，遍历并解析日志中每个XID-event，判断事务是否需要回滚</p><h3 id="2PC问题"><a href="#2PC问题" class="headerlink" title="2PC问题"></a>2PC问题</h3><p>commit阶段某个参与者失败或超时，其他参与者是commit还是rollback</p><h3 id="组提交"><a href="#组提交" class="headerlink" title="组提交"></a>组提交</h3><blockquote><p>5.6以前对整个2PC阶段加锁，因此每个事务需刷3次盘（写 redolog，写 binlog，写 commit），性能较低</p></blockquote><ol><li>prepare阶段：回滚段设置为prepare</li><li>commit阶段</li><li>1 flush stage：写redolog并刷盘，多个线程按进入的顺序将 binlog 从 cache 写入文件（不刷盘）</li><li>2 sync stage：对 binlog 文件做 fsync 操作（多个线程的 binlog 合并一次刷盘）</li><li>3 commit stage：各个线程按顺序做 InnoDB commit 操作</li></ol><ul><li>每个stage为一个队列，有锁保护，第一个进入队列的线程为leader，后续进入队列为follower，队列满员后，leader领导队列全员执行stage并进入下个stage。若下个stage非空，leader注册为下个stage的follower并加入。</li><li>将redo操作加入组提交，提升性能</li><li>通过将锁粒度细化，3个阶段可并行执行，提升性能</li></ul><h3 id="XA"><a href="#XA" class="headerlink" title="XA"></a>XA</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; XA START 'abc','def',2;Query OK, 0 rows affected (0.01 sec)mysql&gt; insert into t1 values(1,1);Query OK, 1 row affected (0.00 sec)mysql&gt; XA END 'abc','def',2;Query OK, 0 rows affected (0.00 sec)mysql&gt; XA PREPARE 'abc','def',2;Query OK, 0 rows affected (0.02 sec)mysql&gt; XA RECOVER;+----------+--------------+--------------+--------+| formatID | gtrid_length | bqual_length | data   |+----------+--------------+--------------+--------+|        2 |            3 |            3 | abcdef |+----------+--------------+--------------+--------+1 row in set (0.00 sec)mysql&gt; XA COMMIT 'abc','def',2;Query OK, 0 rows affected (0.02 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; XA START 'xatest';Query OK, 0 rows affected (0.01 sec)mysql&gt; insert into t1 values(2,2);Query OK, 1 row affected (0.00 sec)mysql&gt; XA END 'xatest';Query OK, 0 rows affected (0.00 sec)mysql&gt; XA RECOVER;Empty set (0.00 sec)mysql&gt; XA COMMIT 'xatest' one phase;Query OK, 0 rows affected (0.02 sec)mysql&gt; XA RECOVER;Empty set (0.00 sec)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="最终一致性-应用层"><a href="#最终一致性-应用层" class="headerlink" title="最终一致性 (应用层)"></a>最终一致性 (应用层)</h2><p>A系统扣钱，发送信息给中间件，B系统接收信息加钱</p><h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>A先update DB，后发送消息，若发送失败，B无法加钱<br>A先发送消息，后update DB，若update DB失败，已发送消息无法撤回</p><p>将网络和DB事务放在同一个事务中，导致DB长事务</p><h2 id="TCC"><a href="#TCC" class="headerlink" title="TCC"></a>TCC</h2><p>应用层2PC事务最终一致性</p><blockquote><p>Try/Confirm/Cancel</p></blockquote><ul><li>阶段1： 协调者调用所有参与者的Try</li><li>阶段2:  所有Try成功后调用Confirm，否则调用Cancel</li></ul><h3 id="TCC问题"><a href="#TCC问题" class="headerlink" title="TCC问题"></a>TCC问题</h3><p>Confirm/Cancel若失败不断重试，必须等幂操作</p><h3 id="例"><a href="#例" class="headerlink" title="例"></a>例</h3><p>A、B、C转账，A给C转30，B给C转50，最终C +80，A -30，B -50</p><ul><li>阶段1： A锁定30，B锁定50，检查C是否可以转钱</li><li>阶段2: ABC开始转钱，任意一个失败不断重试</li></ul><h3 id="事务状态表-日志流水表"><a href="#事务状态表-日志流水表" class="headerlink" title="事务状态表/日志流水表"></a>事务状态表/日志流水表</h3><p>A给C转30，如何保证AC同时转账成功</p><p>调用方维护事务状态表，每次调用前记录流水，调用成功后更新流水状态，流水事务ID全局唯一<br>后台任务不断检查流水表，若存在长时间未成功流水，尝试重试该流水事务ID的转账，根据TCC幂等性最终保证一致性</p><ol><li>若多次重试失败，状态置未错误，需人工干预</li><li>若调用方调用部分成功，此时客户端可返回未知需稍后确认，等待人工处理</li></ol><h3 id="弱一致性-状态补偿"><a href="#弱一致性-状态补偿" class="headerlink" title="弱一致性 + 状态补偿"></a>弱一致性 + 状态补偿</h3><p>电商网站下单，库存库扣减，订单库累加，如何保证2个操作的原子性</p><ul><li>最终一致性方案，容易导致超卖</li><li>TCC强同步方案，性能不足</li><li>弱一致性（允许少卖，不许超卖）</li></ul><p>先扣库存再提交订单例：</p><ol><li>扣库存失败，不提交订单，返回失败，调用方重试（多扣库存）</li><li>扣库存成功，提交订单失败，返回失败，调用方重试（多扣库存）</li><li>扣库存成功，提交订单成功，返回成功。</li></ol><p>先提交订单再扣库存同理，保证库存可以多扣不能少扣</p><p>多扣库存补偿机制：<br>每次扣库存生成流水日志，通过关联订单系统中未支付订单和流水日志，可以回收对应库存</p>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>backp</title>
      <link href="2020/07/21/mysql/backup/"/>
      <url>2020/07/21/mysql/backup/</url>
      
        <content type="html"><![CDATA[<h2 id="mysqlbackup-MBE-amp-xtrabackup"><a href="#mysqlbackup-MBE-amp-xtrabackup" class="headerlink" title="mysqlbackup(MBE) &amp; xtrabackup"></a>mysqlbackup(MBE) &amp; xtrabackup</h2><p>利用mysql crash recover使用redo log恢复机制<br>FTWRL复制获取binlog点或gtid</p><h3 id="xtrabackup"><a href="#xtrabackup" class="headerlink" title="xtrabackup"></a>xtrabackup</h3><p>backup innoDB tables and files &amp; undo file<br>Executing FLUSH NO_WRITE_TO_BINLOG TABLES<br>Executing FLUSH TABLES WITH READ LOCK<br>backup non-InnoDB tables and files<br>Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS<br>The latest check point (for incremental): ‘68809340’<br>Executing UNLOCK TABLES<br>backup bufferpool<br>xtrabackup: Transaction log of lsn (68809340) to (68809349) was copied</p><h4 id="Executing-FLUSH-NO-WRITE-TO-BINLOG-ENGINE-LOGS"><a href="#Executing-FLUSH-NO-WRITE-TO-BINLOG-ENGINE-LOGS" class="headerlink" title="Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS"></a>Executing FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS</h4><p>通过切换binlog并拷贝最后一个binlog，恢复时使用最后一个binlog恢复至一致点<br>若存在大事务可能无法切换binlog(flush被长时间阻塞)</p><h3 id="MBE"><a href="#MBE" class="headerlink" title="MBE"></a>MBE</h3><p>Starting log scan from lsn = 68824576 at offset = 66322432 and checkpoint = 68824590 in file /DBAASLOG/RED/ib_logfile0<br>backup innoDB tables and files &amp; undo file<br>backup bufferpool<br>FTWRL<br>backup non-innodb tables and files<br>Scanned log up to lsn 68824890<br>All tables unlocked</p><h2 id="二级备份技术"><a href="#二级备份技术" class="headerlink" title="二级备份技术"></a>二级备份技术</h2><blockquote><p>RTO: 灾难恢复时长<br>RPO: 灾难丢失数据时长</p></blockquote><table><thead><tr><th>技术点</th><th>RTO</th><th>RPO</th><th>消耗资源</th></tr></thead><tbody><tr><td>逻辑全量</td><td>小时级</td><td>天级</td><td>高</td></tr><tr><td>逻辑全量+逻辑日志</td><td>小时级</td><td>秒级</td><td>高</td></tr><tr><td>物理全量</td><td>小时级</td><td>天级</td><td>中</td></tr><tr><td>物理全量+物理增量</td><td>小时级</td><td>小时级</td><td>低</td></tr><tr><td>物理全量+物理增量+逻辑日志</td><td>小时级</td><td>秒级</td><td>低</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mysqldump</title>
      <link href="2020/07/21/mysql/mysqldump/"/>
      <url>2020/07/21/mysql/mysqldump/</url>
      
        <content type="html"><![CDATA[<h2 id="默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致"><a href="#默认-–lock-tables-库中不同表备份点一致，不同库备份点不一致" class="headerlink" title="默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致"></a>默认 –lock-tables  库中不同表备份点一致，不同库备份点不一致</h2><ol><li>获取gtid或file postion</li><li>顺序逻辑备份每个库，不同库之间备份时间点不同</li><li>1 同时lock库中所有表READ锁，使库变为只读</li><li>2 show create table + select * from table， 导出</li><li>3 unlock tables</li></ol><pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:02:01.441631Z   18 QuerySHOW CREATE DATABASE IF NOT EXISTS `test`2020-11-01T16:02:01.441820Z   18 Queryshow tables2020-11-01T16:02:01.442210Z   18 QueryLOCK TABLES `employees` READ /*!32311 LOCAL */,`t1` READ /*!32311 LOCAL */,`test` READ /*!32311 LOCAL */,`test_auto` READ /*!32311 LOCAL */...2020-11-01T16:02:04.181862Z   18 QueryUNLOCK TABLES<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="–lock-all-tables-所有库备份点一致"><a href="#–lock-all-tables-所有库备份点一致" class="headerlink" title="–lock-all-tables  所有库备份点一致"></a>–lock-all-tables  所有库备份点一致</h2><p>整个数据库变为只读</p><pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:16:57.678240Z   21 QueryFLUSH TABLES2020-11-01T16:16:58.204729Z   21 QueryFLUSH TABLES WITH READ LOCK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="–single-transaction-所有innodb表备份点一致"><a href="#–single-transaction-所有innodb表备份点一致" class="headerlink" title="–single-transaction  所有innodb表备份点一致"></a>–single-transaction  所有innodb表备份点一致</h2><ol><li>设置会话隔离级别为RR</li><li>开启一个MVCC会话，START TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */ ，开启会话时自带一次select保证备份点之后的读一致性</li><li>创建SAVEPOINT开始表备份，在ROLLBACK TO SAVEPOINT前对表的DDL阻塞</li></ol><pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:20:35.440889Z   22 QuerySET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ2020-11-01T16:20:35.441080Z   22 QuerySTART TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */...2020-11-01T16:20:35.451846Z   22 QueryUNLOCK TABLES...2020-11-01T16:20:35.471418Z   22 QuerySHOW CREATE DATABASE IF NOT EXISTS `test`2020-11-01T16:20:35.471499Z   22 QuerySAVEPOINT sp2020-11-01T16:20:35.478244Z   22 Queryshow tables...2020-11-01T16:20:35.484877Z   22 Queryshow create table `t1`2020-11-01T16:20:35.486464Z   22 QuerySELECT /*!40001 SQL_NO_CACHE */ * FROM `t1`2020-11-01T16:20:35.488296Z   22 QueryROLLBACK TO SAVEPOINT sp...2020-11-01T16:20:35.489280Z   22 Queryshow create table `test`2020-11-01T16:20:35.497826Z   22 QuerySELECT /*!40001 SQL_NO_CACHE */ * FROM `test`2020-11-01T16:20:38.400419Z   22 QueryROLLBACK TO SAVEPOINT sp...2020-11-01T16:20:38.403299Z   22 QueryRELEASE SAVEPOINT sp<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="–single-transaction-–master-data-2-需2次flush关表"><a href="#–single-transaction-–master-data-2-需2次flush关表" class="headerlink" title="–single-transaction + –master-data=2    需2次flush关表"></a>–single-transaction + –master-data=2    需2次flush关表</h2><p>–master-data需导出当前binlog位点，因此需FTWRL将数据库数据达到一致</p><ol><li>flush tables + FTWRL 整个数据库达到一致</li><li>设置RR，开启一致读会话</li><li>通过show master status获取binlog位点</li><li>UNLOCK TABLES</li></ol><pre class="line-numbers language-log" data-language="log"><code class="language-log">2020-11-01T16:47:40.165353Z   23 QueryFLUSH /*!40101 LOCAL */ TABLES2020-11-01T16:47:40.190316Z   23 QueryFLUSH TABLES WITH READ LOCK2020-11-01T16:47:40.190471Z   23 QuerySET SESSION TRANSACTION ISOLATION LEVEL REPEATABLE READ2020-11-01T16:47:40.190537Z   23 QuerySTART TRANSACTION /*!40100 WITH CONSISTENT SNAPSHOT */2020-11-01T16:47:40.190744Z   23 QuerySHOW VARIABLES LIKE 'gtid\_mode'2020-11-01T16:47:40.202013Z   23 QuerySHOW MASTER STATUS2020-11-01T16:47:40.204813Z   23 QueryUNLOCK TABLES...<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>mysql –max-allowed-packet=16MB -BNe “SELECT SCHEMA_NAME FROM INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME NOT IN (‘mysql’, ‘performance_schema’, ‘information_schema’, ‘sys’)” | tr ‘\n’ ‘ ‘ &gt; dbs.sql<br>mysqldump  –opt –add-drop-database –add-drop-table –complete-insert –default-character-set=utf8 –hex-blob –master-data=2 –quote-names –single-transaction –events –routines –triggers –databases $(cat dbs.sql) &gt; full_dump.sql</p><ul><li><p>-q, –quick   Don’t buffer query, dump directly to stdout. (Defaults to on; use –skip-quick to disable.)</p></li><li><p>–opt : Shorthand for –add-drop-table –add-locks –create-options –extended-insert –lock-tables –quick –set-charset</p></li><li><p>–lock-tables Lock all tables before dumping them</p></li><li><p>–single-transaction Issue a BEGIN SQL statement before dumping data from server</p></li><li><p>–hex-blob Dump binary columns using hexadecimal notation (for example, ‘abc’ becomes 0x616263)</p></li><li><p>–master-data=2 Write the binary log file name and position to the output as an SQL comment</p></li><li><p>–max-allowed-packet Maximum packet length to send to or receive from server</p></li><li><p>–events</p></li><li><p>–routines</p></li><li><p>–triggers</p></li><li><p>–complete-insert Use complete INSERT statements that include column names</p></li><li><p>–set-charset Add SET NAMES default_character_set to output</p></li><li><p>–add-drop-database</p></li><li><p>–add-drop-table</p></li><li><p>–add-locks</p></li><li><p>–default-character-set=utf8</p></li><li><p>–quick 流式取数据，非单次填充整个结果集到内存</p></li><li><p>–extended-insert Use multiple-row INSERT syntax</p></li><li><p>–create-options Include all MySQL-specific table options in CREATE TABLE statements</p></li><li><p>–flush-logs Flush MySQL server log files before starting dump</p></li><li><p>–lock-all-tables Lock all tables across all databases</p></li><li><p>–set-gtid-purged Whether to add SET @@GLOBAL.GTID_PURGED to output</p></li><li><p>–databases</p></li><li><p>–tables</p></li><li><p>–no-create-db</p></li><li><p>–no-create-info</p></li><li><p>–no-data</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>docker命令</title>
      <link href="2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/"/>
      <url>2020/07/17/k8s/docker%E5%91%BD%E4%BB%A4/</url>
      
        <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>docker rm<br>docker rmi<br>docker pull<br>docker push<br>docker run</p><h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker ps -adocker inspect $iddocker stats $iddocker top $iddocker start $iddocker stop $iddocker exec -it $id bashdocker kill --signal=1 $iddocker rename $id {new_name}docker update --cpuset-cpus=0-3 $iddocker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]docker save -o target_image.tag.tar TARGET_IMAGE[:TAG]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>git</title>
      <link href="2020/06/23/git/"/>
      <url>2020/06/23/git/</url>
      
        <content type="html"><![CDATA[<h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><p>git commit –amend –no-edit</p><p>git tag<br>git tag v1.4<br>git tag -a v1.4 -m “my version 1.4” {commit_id}<br>git show v1.4<br>git push origin –delete <tagname></tagname></p><p>git log // 查找要删除的前一次提交的 commit_id<br>git rebase -i commit_id // 将 commit_id 替换成复制的值<br>git push origin HEAD –force // 强制推送到远端</p><h2 id="diff"><a href="#diff" class="headerlink" title="diff"></a>diff</h2><p><code>git diff v2.1.29 v2.1.29-updrdb --name-only | wc -l</code></p><h2 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h2><p><code>master$ git merge dev</code></p><ul><li>fast forward 不会创建新的commit</li><li>no fast forward 会创建新的commit</li><li>merge冲突 手动修改后commit</li></ul><h2 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h2><p><code>dev$ git rebase master</code></p><p>获取master最新修改，而不提交。rabase后未提交区内容基于最新master代码。</p><h2 id="交互rebase"><a href="#交互rebase" class="headerlink" title="交互rebase"></a>交互rebase</h2><p><code>master$ git rebase -i HEAD~3</code></p><p>默认pick。<br>修改为drop后移除对应commit，最后可push到仓库修改历史commit。<br>修改为squash将两个commit合并。</p><h2 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h2><p><code>dev$ git reset --soft HEAD~3</code></p><h3 id="soft"><a href="#soft" class="headerlink" title="soft"></a>soft</h3><p><code>master$ git reset --soft HEAD~3</code><br><code>master$ git status</code></p><p>HEAD指向HEAD~3，期间的提交保留在未commit区</p><h3 id="hard"><a href="#hard" class="headerlink" title="hard"></a>hard</h3><p><code>master$ git reset --soft HEAD~3</code><br><code>master$ git status</code></p><p>HEAD指向HEAD~3，期间的提交被回退</p><h2 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h2><p><code>dev$ git revert ec5be</code></p><p>将<strong>ec5be</strong>的修改还原，并创建新的未提交commit</p><h2 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h2><p><code>master$ git cherry-pick 76d12</code></p><p>从其他分支中整合某一次commit修改内容到当前分支</p><h2 id="reflog"><a href="#reflog" class="headerlink" title="reflog"></a>reflog</h2><p><code>master$ git reflog</code><br><code>master$ git reset HEAD@{1}</code><br><code>master$ git reflog</code></p><p>展示所有已执行git动作</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/132573100" title="" target="">动图展示10大Git命令</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> git </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>k8s基础</title>
      <link href="2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/"/>
      <url>2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/</url>
      
        <content type="html"><![CDATA[<h2 id="TODO-apiserver"><a href="#TODO-apiserver" class="headerlink" title="TODO apiserver"></a>TODO apiserver</h2><img src="/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/API-server-flow.png" class=""><img src="/2020/06/19/k8s/k8s%E5%9F%BA%E7%A1%80/API-server-storage-flow.png" class=""><p><a href="https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-1">https://www.openshift.com/blog/kubernetes-deep-dive-api-server-part-1</a></p><h2 id="调度"><a href="#调度" class="headerlink" title="调度"></a>调度</h2><p>有三种方式指定 Pod 只运行在指定的 Node 节点上</p><ul><li>nodeSelector：只调度到匹配指定 label 的 Node 上</li><li>nodeAffinity：功能更丰富的 Node 选择器，比如支持集合操作</li><li>podAffinity：调度到满足条件的 Pod 所在的 Node 上</li><li>Taints 和 tolerations：Taints 和 tolerations 用于保证 Pod 不被调度到不合适的 Node 上，其中 Taint 应用于 Node 上，而 toleration 则应用于 Pod 上</li><li>优先级调度</li></ul><h3 id="调度工作原理"><a href="#调度工作原理" class="headerlink" title="调度工作原理"></a>调度工作原理</h3><p>kube-scheduler 调度分为两个阶段，predicate 和 priority</p><ul><li>predicate：过滤不符合条件的节点</li><li>priority：优先级排序，选择优先级最高的节点</li></ul><p>代码入口：pkg/scheduler，cmd/kube-scheduler</p><h3 id="滚动扩容升级-TODO"><a href="#滚动扩容升级-TODO" class="headerlink" title="滚动扩容升级 TODO"></a>滚动扩容升级 TODO</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl scale --replicas=3 deployment/nginx-appkubectl rolling-update frontend-v1 frontend-v2 --image=image:v2kubectl rolling-update frontend-v1 frontend-v2 --rollbackkubectl set image deployment/nginx-app nginx-app=nginx:1.9.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Etcd，Zookeeper，Consul-比较"><a href="#Etcd，Zookeeper，Consul-比较" class="headerlink" title="Etcd，Zookeeper，Consul 比较"></a>Etcd，Zookeeper，Consul 比较</h2><p>Etcd 和 Zookeeper 提供的是分布式一致性存储能力，具体的业务场景需要用户自己实现，比如服务发现，比如配置变更。而 Consul 则以服务发现和配置变更为主要目标，同时附带了 kv 存储。</p><hr><h2 id="阿里云镜像加速"><a href="#阿里云镜像加速" class="headerlink" title="阿里云镜像加速"></a>阿里云镜像加速</h2><p><a href="https://cr.console.aliyun.com/cn/instances/images">https://cr.console.aliyun.com/cn/instances/images</a></p><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><ul><li>node</li><li>pod</li><li>service<ul><li>NodePort</li></ul></li><li>Volume</li><li>Label</li><li>RC</li></ul><h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><ul><li>etcd</li><li>APIServer</li><li>ControllerManager</li><li>Scheduler</li><li>Kubelet</li><li>Proxy</li></ul><h2 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h2><ul><li>申明式操作，分布式重复操作结果等幂，API接口命名描述期望如Service、Volume</li><li>互补可组合，高内聚松耦合</li><li>操作复杂度不应高于O(N)，满足水平伸缩性</li></ul><h2 id="kubectl"><a href="#kubectl" class="headerlink" title="kubectl"></a>kubectl</h2><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl config set-credentials myself --username=admin --password=secretkubectl config set-cluster local-server --server=http://localhost:8080kubectl config set-context default-context --cluster=local-server --user=myself --namespace=defaultkubectl config use-context default-contextkubectl config view<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><ul><li><code>journalctl -f -u kubelet.service</code></li><li>可用api: <code>kubectl api-resources</code></li><li>创建：<code>kubectl run &lt;name&gt; --image=&lt;image&gt;</code> 或者 <code>kubectl create -f manifest.yaml</code></li><li>查询：<code>kubectl get &lt;resource&gt;</code></li><li>更新 <code>kubectl set 或者 kubectl patch</code></li><li>删除：<code>kubectl delete &lt;resource&gt; &lt;name&gt;</code> 或者 <code>kubectl delete -f manifest.yaml</code></li><li>查询 <code>Pod IP：kubectl get pod &lt;pod-name&gt; -o jsonpath='{.status.podIP}'</code></li><li>容器内执行命令：<code>kubectl exec -ti &lt;pod-name&gt; sh</code></li><li>容器日志：<code>kubectl logs [-f] &lt;pod-name&gt;</code></li><li>导出服务：<code>kubectl expose deploy &lt;name&gt; --port=80</code></li><li>查看描述: <code>kubectl describe</code></li></ul><h3 id="命令自动补全"><a href="#命令自动补全" class="headerlink" title="命令自动补全"></a>命令自动补全</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">source /usr/share/bash-completion/bash_completionsource &lt;(kubectl completion bash)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="自定义输出列"><a href="#自定义输出列" class="headerlink" title="自定义输出列"></a>自定义输出列</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl get pods --all-namespaces -o custom-columns=NS:.metadata.namespace,NAME:.metadata.name,"CPU(requests)":.spec.containers[*].resources.requests.cpu,"CPU(limits)":.spec.containers[*].resources.limits.cpu,"MEMORY(requests)":.spec.containers[*].resources.requests.memory,"MEMORY(limits)":.spec.containers[*].resources.limits.memory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="端口转发"><a href="#端口转发" class="headerlink" title="端口转发"></a>端口转发</h3><p>kubectl port-forward</p><h2 id="Autoscaling"><a href="#Autoscaling" class="headerlink" title="Autoscaling"></a>Autoscaling</h2><p>kubectl run php-apache –image={阿里云镜像加速}/hpa-example –requests=cpu=200m –expose –port=80<br>kubectl autoscale deployment php-apache –cpu-percent=50 –min=1 –max=10<br>kubectl describe pod php-apach</p><p>kubectl delete svc php-apache<br>kubectl delete pod php-apache</p><ul><li><a href="https://kubernetes.feisky.xyz/concepts/objects/autoscaling" title="" target="">HPA</a></li></ul><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><ul><li>设置环境变量</li><li>设置容器命令行参数</li><li>Volume中直接挂载文件或目录</li></ul><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">special.how</span><span class="token punctuation">:</span> very  <span class="token key atrule">special.type</span><span class="token punctuation">:</span> charm<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default<span class="token key atrule">data</span><span class="token punctuation">:</span>  <span class="token key atrule">log_level</span><span class="token punctuation">:</span> INFO<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>pod<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">containers</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container      <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox      <span class="token comment">#command: ["/bin/sh", "-c", "env"]</span>      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)"</span> <span class="token punctuation">]</span>      <span class="token comment">#command: ["/bin/sh", "-c", "cat /etc/config/special.how"]</span>      <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume        <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/config      <span class="token key atrule">env</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_LEVEL_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.how        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_TYPE_KEY          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>            <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>              <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config              <span class="token key atrule">key</span><span class="token punctuation">:</span> special.type      <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>            <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume      <span class="token key atrule">configMap</span><span class="token punctuation">:</span>        <span class="token key atrule">name</span><span class="token punctuation">:</span> special<span class="token punctuation">-</span>config  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl create -f special-config.yamlkubectl create -f env-config.yamlkubectl create -f pod.yaml<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="CronJob"><a href="#CronJob" class="headerlink" title="CronJob"></a>CronJob</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/1 * * * *"</span>  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">template</span><span class="token punctuation">:</span>        <span class="token key atrule">spec</span><span class="token punctuation">:</span>          <span class="token key atrule">containers</span><span class="token punctuation">:</span>          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox            <span class="token key atrule">args</span><span class="token punctuation">:</span>            <span class="token punctuation">-</span> /bin/sh            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl create -f cronjob.yamlkubectl get cronjobkubectl get jobskubectl logs hello-1593447840-ns2z7kubectl delete cronjob hello<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="CustomResourceDefinition"><a href="#CustomResourceDefinition" class="headerlink" title="CustomResourceDefinition"></a>CustomResourceDefinition</h2><p>Kubernetes API扩展</p><h3 id="Finalizer"><a href="#Finalizer" class="headerlink" title="Finalizer"></a>Finalizer</h3><h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><h3 id="Subresources"><a href="#Subresources" class="headerlink" title="Subresources"></a>Subresources</h3><h3 id="Categories"><a href="#Categories" class="headerlink" title="Categories"></a>Categories</h3><h2 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h2><h3 id="滚动更新"><a href="#滚动更新" class="headerlink" title="滚动更新"></a>滚动更新</h3><ul><li>OnDelete：默认策略，更新模板后，只有手动删除了旧的 Pod 后才会创建新的 Pod</li><li>RollingUpdate：更新 DaemonSet 模版后，自动删除旧的 Pod 并创建新的 Pod</li></ul><h3 id="指定Node节点"><a href="#指定Node节点" class="headerlink" title="指定Node节点"></a>指定Node节点</h3><ul><li>nodeSelector</li><li>nodeAffinity</li><li>podAffinity</li></ul><h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>Pod和Replica Set的声明式定义</p><h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><p>kubectl scale deployment nginx-deployment –replicas 10</p><h3 id="自动扩展"><a href="#自动扩展" class="headerlink" title="自动扩展"></a>自动扩展</h3><p>kubectl autoscale deployment nginx-deployment –min=10 –max=15 –cpu-percent=80</p><h3 id="更新镜像"><a href="#更新镜像" class="headerlink" title="更新镜像"></a>更新镜像</h3><p>kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</p><h3 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h3><p>kubectl rollout undo deployment/nginx-deployment</p><h3 id="典型应用场景"><a href="#典型应用场景" class="headerlink" title="典型应用场景"></a>典型应用场景</h3><ul><li>定义Deployment来创建 Pod 和 ReplicaSet</li><li>滚动升级和回滚应用</li><li>扩容和缩容</li><li>暂停和继续Deployment</li></ul><blockquote><p>rs名字总是 <code>&lt;Deployment 的名字&gt;-&lt;pod template 的 hash 值 &gt;</code></p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl get deployNAME               READY   UP-TO-DATE   AVAILABLE   AGEnginx-deployment   1/1     1            1           10dkubectl get rsNAME                          DESIRED   CURRENT   READY   AGEnginx-deployment-678645bf77   1         1         1       24hkubectl get podsNAME                                READY   STATUS    RESTARTS   AGEnginx-deployment-678645bf77-zxbdq   1/1     Running   1          24h<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>更新</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1kubectl rollout status/history deployment/nginx-deploymentkubectl rollout undo deployment/nginx-deployment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>扩容</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl scale deployment nginx-deployment --replicas 10<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>暂停更新恢复</p></blockquote><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl rollout pause deployment/nginx-deploymentkubectl set image deploy/nginx nginx=nginx:1.9.0kubectl rollout history deployment/nginx-deploymentkubectl rollout resume deployment/nginx-deployment<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kubeadm上手</title>
      <link href="2020/06/15/k8s/kubeadm%E4%B8%8A%E6%89%8B/"/>
      <url>2020/06/15/k8s/kubeadm%E4%B8%8A%E6%89%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="组件安装"><a href="#组件安装" class="headerlink" title="组件安装"></a>组件安装</h2><h3 id="阿里yum源设置"><a href="#阿里yum源设置" class="headerlink" title="阿里yum源设置"></a>阿里yum源设置</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backupwget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h3 id="docker-ce安装"><a href="#docker-ce安装" class="headerlink" title="docker-ce安装"></a>docker-ce安装</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">yum install -y yum-utils device-mapper-persistent-data lvm2yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repoyum list docker-ce.x86_64 --showduplicates | sort -r#yum -y install docker-ce-[VERSION]wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpmyum install -y containerd.io-1.2.13-3.2.el7.x86_64.rpmyum install -y docker-ce.x86_64systemctl start docker.servicedocker version<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="设置cgroup-driver为systemd"><a href="#设置cgroup-driver为systemd" class="headerlink" title="设置cgroup driver为systemd"></a>设置cgroup driver为systemd</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &lt;&lt;EOF &gt; /etc/docker/daemon.json{  "exec-opts": ["native.cgroupdriver=systemd"]}EOFsystemctl restart dockerdocker info | grep Cgroup<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="kubernetes安装"><a href="#kubernetes安装" class="headerlink" title="kubernetes安装"></a>kubernetes安装</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo[kubernetes]name=Kubernetesbaseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/enabled=1gpgcheck=1repo_gpgcheck=1gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpgEOFyum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="kubeadm-init"><a href="#kubeadm-init" class="headerlink" title="kubeadm init"></a>kubeadm init</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># 使用flannel网络必须设置cidr，网段自定# --ignore-preflight-errors all 跳过之前已安装部分（出问题时，问题解决后加上继续运行）kubeadm init --image-repository=registry.aliyuncs.com/google_containers --apiserver-advertise-address=172.19.191.191 --service-cidr=10.1.0.0/16 --pod-network-cidr=10.96.0.0/16 --kubernetes-version=v1.18.3# 根据init提示执行mkdir -p $HOME/.kubesudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/configsudo chown $(id -u):$(id -g) $HOME/.kube/config<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="安装网络组件flannel"><a href="#安装网络组件flannel" class="headerlink" title="安装网络组件flannel"></a>安装网络组件flannel</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml#安装完flannel，将配置拷到node节点，否则添加节点之后状态不对scp -r /etc/cni root@{node}:/etc#这一步也要拷贝，否则节点看着正常，但是pod由于网络原因无法创建scp -r /run/flannel/ root@{node}:/run<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nginx部署"><a href="#nginx部署" class="headerlink" title="nginx部署"></a>nginx部署</h2><p>nginx-deployment.yaml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1 <span class="token comment"># for versions before 1.9.0 use apps/v1beta2</span><span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># tells deployment to run 2 pods matching the template</span>  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment"># create pods using pod definition in this template</span>    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>      <span class="token comment"># unlike pod-nginx.yaml, the name is not included in the meta data as a unique name is</span>      <span class="token comment"># generated from the deployment name</span>      <span class="token key atrule">labels</span><span class="token punctuation">:</span>        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx    <span class="token key atrule">spec</span><span class="token punctuation">:</span>      <span class="token key atrule">containers</span><span class="token punctuation">:</span>      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent <span class="token comment">#或者使用Never，默认Always</span>        <span class="token key atrule">ports</span><span class="token punctuation">:</span>        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>nginx-svc.yml</p><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service<span class="token key atrule">metadata</span><span class="token punctuation">:</span>  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token key atrule">spec</span><span class="token punctuation">:</span>  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort <span class="token comment"># expose node port，不指定随机分配</span>  <span class="token key atrule">selector</span><span class="token punctuation">:</span>    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx  <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>  <span class="token comment"># svc端口</span>    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">docker pull nginxkubectl create -f nginx-deployment.yamlkubectl apply -f nginx-svc.yamlkubectl get pods -o wideNAME                                READY   STATUS    RESTARTS   AGE   IP           NODE                      NOMINATED NODE   READINESS GATESnginx-deployment-558fc78868-fh5hg   1/1     Running   0          10m   10.96.0.15   izuf6h1cr4n27ctdyzruy1z   &lt;none&gt;           &lt;none&gt;nginx-deployment-558fc78868-wrskf   1/1     Running   0          10m   10.96.0.16   izuf6h1cr4n27ctdyzruy1z   &lt;none&gt;           &lt;none&gt;kubectl get svcNAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)          AGEkubernetes   ClusterIP   10.1.0.1     &lt;none&gt;        443/TCP          23hnginx-svc    NodePort    10.1.22.28   &lt;none&gt;        8080:30765/TCP   37mcurl 10.96.0.15:80 # podcurl 10.96.0.16:80 # podcurl 10.1.22.28:8080 # 集群内curl 139.196.224.165:30765 # 集群外<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h2><h3 id="master节点不允许部署pod"><a href="#master节点不允许部署pod" class="headerlink" title="master节点不允许部署pod"></a>master节点不允许部署pod</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl describe pod nginx | tail -n 3  Type     Reason            Age                  From               Message  ----     ------            ----                 ----               -------  Warning  FailedScheduling  24s (x8 over 8m56s)  default-scheduler  0/1 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/master: }, that the pod didn't tolerate.# k8s默认master node不允许部署pod，取消该限制kubectl taint nodes --all node-role.kubernetes.io/master-# 还原命令# kubectl taint nodes k8s node-role.kubernetes.io/master=true:NoSchedule<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="cni0网卡已分配ip段与当前不一致"><a href="#cni0网卡已分配ip段与当前不一致" class="headerlink" title="cni0网卡已分配ip段与当前不一致"></a>cni0网卡已分配ip段与当前不一致</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">kubectl get podsNAME    READY   STATUS              RESTARTS   AGEnginx   0/1     ContainerCreating   0          11mkubectl describe pod nginx | tail -n 1  Warning  FailedCreatePodSandBox  22s (x280 over 5m13s)   kubelet, izuf6h1cr4n27ctdyzruy1z  (combined from similar events): Failed to create pod sandbox: rpc error: code = Unknown desc = failed to set up sandbox container "053ca6b0dcd9801ddd6cbc6384e56e5b435ae6bacfeb96fe67f9347ca7d1aa38" network for pod "nginx": networkPlugin cni failed to set up pod "nginx_default" network: failed to set bridge addr: "cni0" already has an IP address different from 10.96.0.1/24ifconfig cni0cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450        inet 10.244.0.1  netmask 255.255.255.0  broadcast 0.0.0.0# 确认无人使用，删除网卡，由pod自动重建ifconfig cni0 downip link delete cni0ifconfig cni0cni0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450        inet 10.96.0.1  netmask 255.255.255.0  broadcast 0.0.0.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="外网无法访问阿里云ECS，端口不通"><a href="#外网无法访问阿里云ECS，端口不通" class="headerlink" title="外网无法访问阿里云ECS，端口不通"></a>外网无法访问阿里云ECS，端口不通</h3><p>阿里云ECS默认安全组对入流量端口做限制，需手工添加端口策略</p>]]></content>
      
      
      <categories>
          
          <category> k8s </category>
          
      </categories>
      
      
        <tags>
            
            <tag> k8s </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go hashmap</title>
      <link href="2020/06/10/go/hashmap/"/>
      <url>2020/06/10/go/hashmap/</url>
      
        <content type="html"><![CDATA[<ul><li>hash0保存1个随机hash种子</li><li>每个桶保存8个k/v对</li><li>每个桶内存最后8位为指向下一个桶的指针</li><li>map创建时，若桶数量&gt;2^4，在extra中创建备用的溢出桶，与正常桶内存连续</li><li>插入时，若所有正常桶和溢出桶已满，使用extra中备用的next溢出桶插入key，并加到正常桶末尾的overflow指针中，调用typedmemmove内存拷贝key到桶内地址</li><li>扩容因子超过6.5，翻倍扩容</li><li>扩容因子未超过6.5，已有太多溢出桶，通常是不断插入元素后，一次delete删除所有元素，此时存在缓慢内存泄漏，采用等量扩容</li><li>扩容期间，使用oldbuckets提供查询，插入和删除操作会触发旧桶到新桶的分流，所有分流完成后清空旧桶</li></ul><img src="/2020/06/10/go/hashmap/hmap-and-buckets.png" class=""><img src="/2020/06/10/go/hashmap/overflow.jpg" class=""><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> hmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>    count     <span class="token builtin">int</span> <span class="token comment">// 元素数量</span>    flags     <span class="token builtin">uint8</span>  <span class="token comment">// 用于基本并发检测，抛出并发异常</span>    B         <span class="token builtin">uint8</span>  <span class="token comment">// len(buckets) == 2^B</span>    noverflow <span class="token builtin">uint16</span>    hash0     <span class="token builtin">uint32</span> <span class="token comment">// hash seed，fastrand()</span>    buckets    unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 当前buckets指针</span>    oldbuckets unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 扩容时保存旧buckets指针</span>    nevacuate  <span class="token builtin">uintptr</span>        <span class="token comment">// progress counter for evacuation (buckets less than this have been evacuated)</span>    extra <span class="token operator">*</span>mapextra <span class="token comment">// optional fields</span><span class="token punctuation">}</span><span class="token keyword">type</span> mapextra <span class="token keyword">struct</span> <span class="token punctuation">{</span>    overflow    <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap    oldoverflow <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>bmap    <span class="token comment">// nextOverflow holds a pointer to a free overflow bucket.</span>    nextOverflow <span class="token operator">*</span>bmap<span class="token punctuation">}</span><span class="token comment">// 1个桶保存8个k/v键值对</span><span class="token keyword">type</span> bmap <span class="token keyword">struct</span> <span class="token punctuation">{</span>    tophash <span class="token punctuation">[</span>bucketCnt<span class="token punctuation">]</span><span class="token builtin">uint8</span><span class="token punctuation">}</span><span class="token keyword">const</span> <span class="token punctuation">(</span>    <span class="token comment">// Maximum number of key/elem pairs a bucket can hold.</span>    bucketCntBits <span class="token operator">=</span> <span class="token number">3</span>    bucketCnt     <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> bucketCntBits<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="冲突解决"><a href="#冲突解决" class="headerlink" title="冲突解决"></a>冲突解决</h2><ul><li>开放寻址法： 发生冲突时写入下一个不为空的位置，hash查询不匹配时顺序查找后面位置元素</li><li>链表/红黑树法： hash定位桶，每个桶为链表/红黑树</li></ul><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><blockquote><p>cmd/compile/internal/gc.maplit</p></blockquote><ul><li>字面变量</li><li>运行时make</li></ul><p>make流程：</p><ol><li>计算哈希占用的内存是否溢出或者超出能分配的最大值</li><li>调用 <strong>fastrand</strong> 获取一个随机的哈希种子</li><li>根据传入 hint 计算最小需要的桶的数量</li><li>创建用于保存桶的数组</li><li>1 桶数量&lt;2^4，不使用溢出桶，避免过度计算</li><li>2 桶数量&gt;=2^4，额外创建2^4-B个溢出桶，和正常buckets在内存中连续</li></ol><h2 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go">v     <span class="token operator">:=</span> hash<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// =&gt; v     := *mapaccess1(maptype, hash, &amp;key)</span>v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> hash<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token comment">// =&gt; v, ok := mapaccess2(maptype, hash, &amp;key)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><blockquote><p>NOTE: The returned pointer may keep the whole map live, so don’t hold onto it for very long.</p></blockquote><p>mapaccess1流程：</p><ol><li>高8位计算hash，与bmap的8个桶比较</li><li>循环遍历正常桶和溢出桶(内存连续)</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// overflow指针指向下一个bmap</span><span class="token keyword">func</span> <span class="token punctuation">(</span>b <span class="token operator">*</span>bmap<span class="token punctuation">)</span> <span class="token function">overflow</span><span class="token punctuation">(</span>t <span class="token operator">*</span>maptype<span class="token punctuation">)</span> <span class="token operator">*</span>bmap <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token operator">*</span>bmap<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>bucketsize<span class="token punctuation">)</span><span class="token operator">-</span>sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>mapaccess2: 略</p><h2 id="插入"><a href="#插入" class="headerlink" title="插入"></a>插入</h2><p>m[k] = v，在compile阶段编译为runtime.mapassign获得v指针进行赋值</p><p>mapassign流程：</p><ol><li>根据key计算hash和桶</li><li>遍历正常桶和溢出桶，依次判断tophash和完整key</li><li>1 如果找到相同key，返回对应val地址</li><li>2 如果遍历到空key，说明没有相同key，在空key位置new新k/v对，返回val地址</li><li>3 如果所有桶已满，仍没找到相同key，从extra中取一个备用溢出桶加入正常桶末尾overflow指针。若所有备用溢出桶也用满，分配一个新bmap使用。</li></ol><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>逻辑同插入，将key设为emptyOne，略</p><h2 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h2><img src="/2020/06/10/go/hashmap/hashtable-evacuate-destination.png" class=""><p>扩容判断条件：</p><ol><li>装在因子超过6.5，翻倍扩容，通过mask将旧桶数据分流到2个新桶上</li><li>有太多溢出桶，等量扩容，evacDst结构体只会初始化1个，旧桶和新桶一对一</li></ol><p>扩容期间oldbuckets保存旧桶，查询使用oldbuckets，插入和删除会触发分流，在所有旧桶分流到新桶后，清空oldbuckets和oldoverflow</p><h2 id="JAVA-hashmap"><a href="#JAVA-hashmap" class="headerlink" title="JAVA hashmap"></a>JAVA hashmap</h2><p>TODO</p>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go channel</title>
      <link href="2020/06/09/go/channel/"/>
      <url>2020/06/09/go/channel/</url>
      
        <content type="html"><![CDATA[<blockquote><p>channel底层使用ring buffer实现，通过sendx、recvx移动实现带缓存的chan，数据FIFO先入先出</p></blockquote><ul><li>dataqsiz=0表示同步chan，dataqsiz&gt;0表示异步chan</li><li>recvq / sendq其中之一必定为空，或两者都为空</li><li>qcount &gt; 0表示recvq为空</li><li>qcount &lt; dataqsiz表示sendq为空</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{</span>    qcount   <span class="token builtin">uint</span>           <span class="token comment">// buffer中元素数量</span>    dataqsiz <span class="token builtin">uint</span>           <span class="token comment">// make chan时候指定的buf大小</span>    buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// buffer</span>    elemsize <span class="token builtin">uint16</span>         <span class="token comment">// 每个元素大小</span>    elemtype <span class="token operator">*</span>_type         <span class="token comment">// 元素类型</span>    closed   <span class="token builtin">uint32</span>         <span class="token comment">// chan是否已关闭，=0表示未关闭</span>    sendx    <span class="token builtin">uint</span>           <span class="token comment">// send索引下标</span>    recvx    <span class="token builtin">uint</span>           <span class="token comment">// recv索引下标</span>    recvq    waitq          <span class="token comment">// 接受等待队列，双向链表</span>    sendq    waitq          <span class="token comment">// 发送等待队列，双向链表</span>    lock mutex<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>chansend流程：</p><ol><li>若recvq不为空，表示有等待的recv sudog，调用memmove进行数据拷贝，然后调用goready唤醒该recv sudug</li><li>若recvq为空</li><li>1 若qcount &lt; dataqsiz，表示当前chan还有缓存空间，调用memmove进行数据拷贝</li><li>2 若缓存空间满，将当前gp封装成sudog放入sendq队列，并进入休眠(在recv函数中进行数据拷贝，然后调用goready被唤醒)，唤醒后数据已被拷贝走，release释放sudog</li></ol><p>chanrecv流程：</p><ol><li>若sendq不为空，表示有等待的send sudog。若是同步chan，将send sudo拷贝到recv sudo；若是带缓存的chan，将缓存head元素传给recv sudo，将sendq取出元素传给缓存队尾，然后调用goready唤醒send sudug</li><li>若sendq为空</li><li>1 若创建时指定的buf大小&gt;0，且缓存中有数据，从缓存中取第一个元素传给recv sudo</li><li>2 若都不满足，进入recvq队列</li></ol><p>close流程：</p><ol><li>设置closed = 1</li><li>取出所有sendq和recvq中sudog，调用goready唤醒所有g</li></ol>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go 内存分配和对齐</title>
      <link href="2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/"/>
      <url>2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/</url>
      
        <content type="html"><![CDATA[<h2 id="栈内存"><a href="#栈内存" class="headerlink" title="栈内存"></a>栈内存</h2><ul><li><a href="https://www.bilibili.com/video/BV1WZ4y1p7JT" title="" target="">栈帧布局与函数跳转</a></li><li><a href="https://www.bilibili.com/video/BV1tZ4y1p7Rv" title="" target="">函数调用栈</a></li></ul><h2 id="内存对齐"><a href="#内存对齐" class="headerlink" title="内存对齐"></a>内存对齐</h2><ul><li>32位对齐：4</li><li>64位对齐：8</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> T1 <span class="token keyword">struct</span> <span class="token punctuation">{</span>    a <span class="token builtin">bool</span>  <span class="token comment">// 占1B</span>    b <span class="token builtin">int32</span> <span class="token comment">// 对齐为4，a后面需要3B padding，从第5B开始占4B</span>    c <span class="token builtin">int8</span>    d <span class="token builtin">int64</span>    e <span class="token builtin">byte</span><span class="token punctuation">}</span><span class="token keyword">type</span> T2 <span class="token keyword">struct</span> <span class="token punctuation">{</span>    e <span class="token builtin">byte</span> <span class="token comment">// 占1B</span>    c <span class="token builtin">int8</span> <span class="token comment">// 占1B</span>    a <span class="token builtin">bool</span> <span class="token comment">// 占1B</span>    b <span class="token builtin">int32</span> <span class="token comment">// 对齐为4，a后面需1B padding，从第5B开始占4B</span>    d <span class="token builtin">int64</span> <span class="token comment">// 对齐为8，无需padding，占8B</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"bool size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">bool</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int32 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int8 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int8</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"int64 size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"byte size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"string size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span><span class="token string">"EDDYCJY"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span><span class="token string">"ABCD"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    t1 <span class="token operator">:=</span> T1<span class="token punctuation">{</span><span class="token punctuation">}</span>    t2 <span class="token operator">:=</span> T2<span class="token punctuation">{</span><span class="token punctuation">}</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"T size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"T size: %d, align: %d\n"</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Alignof</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-txt" data-language="txt"><code class="language-txt">bool size: 1, align: 1int32 size: 4, align: 4int8 size: 1, align: 1int64 size: 8, align: 8byte size: 1, align: 1string size: 16, align: 8T size: 32, align: 8T size: 16, align: 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="gctrace"><a href="#gctrace" class="headerlink" title="gctrace"></a>gctrace</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ GODEBUG=gctrace=1 go run testpackage test is not in GOROOT (/usr/local/Cellar/go/1.14/libexec/src/test)qiujirongdeMacBook-Air:test qiujirong$ GODEBUG=gctrace=1 go run test.go gc 1 @0.044s 5%: 0.020+3.8+0.070 ms clock, 0.083+7.0/3.6/0+0.28 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 2 @0.112s 2%: 0.070+0.49+0.034 ms clock, 0.28+0.21/0.38/0.38+0.13 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 3 @0.201s 1%: 0.026+1.0+0.038 ms clock, 0.10+0/0.42/1.7+0.15 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 4 @0.311s 1%: 0.050+0.47+0.003 ms clock, 0.20+0.17/0.28/0.77+0.013 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 5 @0.455s 0%: 0.070+4.2+0.009 ms clock, 0.28+0.85/3.6/1.3+0.036 ms cpu, 4-&gt;4-&gt;1 MB, 5 MB goal, 4 Pgc 6 @0.496s 0%: 0.030+0.85+0.005 ms clock, 0.12+0/0.64/0.85+0.020 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 7 @0.571s 0%: 0.025+0.87+0.022 ms clock, 0.10+0.86/0.62/0.58+0.091 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 Pgc 8 @0.590s 0%: 0.047+0.67+0.004 ms clock, 0.18+0.28/0.46/1.1+0.016 ms cpu, 4-&gt;4-&gt;0 MB, 5 MB goal, 4 P# command-line-argumentsgc 1 @0.031s 4%: 0.035+12+0.29 ms clock, 0.14+0.44/5.4/19+1.1 ms cpu, 4-&gt;5-&gt;4 MB, 5 MB goal, 4 P# command-line-argumentsgc 1 @0.002s 15%: 0.009+8.3+0.013 ms clock, 0.039+1.5/4.9/0.53+0.052 ms cpu, 5-&gt;6-&gt;6 MB, 6 MB goal, 4 Pgc 2 @0.199s 1%: 0.007+8.6+0.039 ms clock, 0.029+0/6.8/13+0.15 ms cpu, 11-&gt;11-&gt;10 MB, 12 MB goal, 4 Pgc 3 @0.447s 1%: 0.007+12+0.023 ms clock, 0.028+1.9/11/25+0.093 ms cpu, 22-&gt;22-&gt;20 MB, 23 MB goal, 4 Pbool size: 1, align: 1int32 size: 4, align: 4int8 size: 1, align: 1int64 size: 8, align: 8byte size: 1, align: 1string size: 16, align: 8T size: 32, align: 8T size: 16, align: 8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="内存分配"><a href="#内存分配" class="headerlink" title="内存分配"></a>内存分配</h2><h3 id="总线寻址"><a href="#总线寻址" class="headerlink" title="总线寻址"></a>总线寻址</h3><p>32位总线寻址范围最大 = 2的32次方 = 支持最大4G内存寻址<br>64为总线寻址范围最大 = 2的64次方</p><p>虚拟内存VMA(virtual memory address) -&gt; 物理地址(liner address)<br>虚拟内存划分为page，一般为4KB</p><p>内存碎片示例：</p><img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%E7%A4%BA%E4%BE%8B.png" class=""><p>即使有足够内存页，由于不连续，无法满足p4内存分配，导致内存碎片</p><h3 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h3><p>go基于TCMalloc，将页划分为67个等级，页最小单位8K，定义在sizeclasses.go，大小从0～32K。通过定义常量数组，将内存分配时大小转换的时间复杂度降为O(1)<br>mspan是某个class页的集合，包含页起始地址、页数、页等级、已分配对象数等。mspan是一个双向链表。<br>每个P保存本地mcache，mcache是由2*67个mspan组成的数组，每个等级分为scan和noscan两种类型。为0～32K大小对象分配内存直接使用mcache池。<br>noscan类型的mspan上分配不包含指针的对象，在GC时这些对象无需遍历确认，可以直接释放回收。<br>mcentral是mspan的包装，每个mcentral包含1个mspan双向空链表和1个mspan双向非空链表，不同P请求同一个mcentral需要竞争锁。空链表包含没有空闲对象的mspan或缓存在mcache中的mspan，当mspan被释放时放进非空链表，非空链表包含至少有1个空闲对象的mspan。通过mcentral请求新mspan时，从非空链表取出mspan放入空链表。<br>arena结构是mspan的位图，目的是高效分配内存。1个arean大小为heapArenaBytes=64MB<br>mheap是全局内存对象，保存67个页等级的mcentral数组，每个级别的mcentral有自己的锁，因此P1申请2K的mspan和P2申请16K的mspan可以并行执行。</p><img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/go-memory-detail.png" class=""><p>每个class的mspan含有的page数不同，具体见sizeclasses.go，比如：</p><ul><li>class 43的mspan用来分配4K大小的对象，含有1个8K page，共可以分配2个对象，全分配后内存可以全部用完</li><li>class 44的mspan用来分配4864B大小的对象，含有3个8K page，共可以分配5个对象，全分配后尾部有256B浪费</li></ul><p>mspan和mheap中的sweepgen用于标示span状态 TODO</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// sweep generation:</span><span class="token comment">// if sweepgen == h-&gt;sweepgen - 2, the span needs sweeping</span><span class="token comment">// if sweepgen == h-&gt;sweepgen - 1, the span is currently being swept</span><span class="token comment">// if sweepgen == h-&gt;sweepgen, the span is swept and ready to use</span><span class="token comment">// if sweepgen == h-&gt;sweepgen + 1, the span was cached before sweep began and is still cached, and needs sweeping</span><span class="token comment">// if sweepgen == h-&gt;sweepgen + 3, the span was swept and then cached and is still cached</span><span class="token comment">// h-&gt;sweepgen is incremented by 2 after every GC</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mSpanList <span class="token keyword">struct</span> <span class="token punctuation">{</span>    first <span class="token operator">*</span>mspan <span class="token comment">// first span in list, or nil if none</span>    last  <span class="token operator">*</span>mspan <span class="token comment">// last span in list, or nil if none</span><span class="token punctuation">}</span><span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>    next <span class="token operator">*</span>mspan     <span class="token comment">// next span in list, or nil if none</span>    prev <span class="token operator">*</span>mspan     <span class="token comment">// previous span in list, or nil if none</span>    startAddr <span class="token builtin">uintptr</span> <span class="token comment">// address of first byte of span aka s.base()</span>    npages    <span class="token builtin">uintptr</span> <span class="token comment">// number of pages in span</span>    allocCount  <span class="token builtin">uint16</span>        <span class="token comment">// number of allocated objects</span>    sweepgen    <span class="token builtin">uint32</span>    spanclass   spanClass     <span class="token comment">// size class and noscan (uint8)</span><span class="token punctuation">}</span><span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>    lock      mutex    spanclass spanClass    nonempty  mSpanList <span class="token comment">// list of spans with a free object, ie a nonempty free list</span>    empty     mSpanList <span class="token comment">// list of spans with no free objects (or cached in an mcache)</span>    nmalloc <span class="token builtin">uint64</span><span class="token punctuation">}</span><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>    lock      mutex    pages     pageAlloc <span class="token comment">// page allocation data structure</span>    sweepgen  <span class="token builtin">uint32</span>    allspans <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// 所有2*67个mspan对象，通过锁实现并发</span>    <span class="token comment">// 67个mcentral</span>    central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>        mcentral mcentral        pad      <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="对象分配流程"><a href="#对象分配流程" class="headerlink" title="对象分配流程"></a>对象分配流程</h3><p>0值对象返回zerobase指针<br>小对象分配顺序：per-P本地mcache -&gt; mcentral -&gt; mheap -&gt; OS底层调用mmp<br>tiny对象优先从mspan.tiny分配<br>大对象直接从mheap分配</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{</span>    <span class="token keyword">if</span> size <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zerobase<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    c <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>mcache    noscan <span class="token operator">:=</span> typ <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> typ<span class="token punctuation">.</span>ptrdata <span class="token operator">==</span> <span class="token number">0</span>    <span class="token keyword">var</span> x unsafe<span class="token punctuation">.</span>Pointer    <span class="token keyword">if</span> size <span class="token operator">&lt;=</span> maxSmallSize <span class="token punctuation">{</span>        <span class="token keyword">if</span> noscan <span class="token operator">&amp;&amp;</span> size <span class="token operator">&lt;</span> maxTinySize <span class="token punctuation">{</span>            <span class="token comment">// &lt;16B，Tiny allocator</span>            <span class="token keyword">if</span> off<span class="token operator">+</span>size <span class="token operator">&lt;=</span> maxTinySize <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>tiny <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token comment">// The object fits into existing tiny block.</span>                x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>tiny <span class="token operator">+</span> off<span class="token punctuation">)</span><span class="token punctuation">]</span>                <span class="token keyword">return</span> x            <span class="token punctuation">}</span>            span <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>tinySpanClass<span class="token punctuation">]</span>            v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>            <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                v<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>tinySpanClass<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>            <span class="token keyword">if</span> size <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>tinyoffset <span class="token operator">||</span> c<span class="token punctuation">.</span>tiny <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                c<span class="token punctuation">.</span>tiny <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 16B~32K之间</span>            spc <span class="token operator">:=</span> <span class="token function">makeSpanClass</span><span class="token punctuation">(</span>sizeclass<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>            span <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>            v <span class="token operator">:=</span> <span class="token function">nextFreeFast</span><span class="token punctuation">(</span>span<span class="token punctuation">)</span>            <span class="token keyword">if</span> v <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>                v<span class="token punctuation">,</span> span<span class="token punctuation">,</span> shouldhelpgc <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">nextFree</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>            <span class="token punctuation">}</span>            x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token comment">// &gt; 32K，大对象</span>        <span class="token keyword">var</span> s <span class="token operator">*</span>mspan        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            s <span class="token operator">=</span> <span class="token function">largeAlloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> needzero<span class="token punctuation">,</span> noscan<span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>        x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> x<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>从per-P的本地mcache，根据class和是否有指针分配对象</li><li>若本地相应class的mcache对象已满，调用mspan.refill从mheap相应class的central申请，需加解锁</li><li>1 从非空链表(至少有一个空闲对象)取出mspan，插入空链表，若该mspan需要sweep执行sweep</li><li>2 从空链表(没有空闲对象或在mcache中)取出状态为需sweep的mspan并执行sweep</li><li>若相应class的central满，调用central.grow从mheap获取mspan，放入空链表，从中分配对象</li><li>若mheap内存满，调用mheap.grow，从os申请内存，底层调用mmp</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">nextFree</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">(</span>v gclinkptr<span class="token punctuation">,</span> s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> shouldhelpgc <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>    freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> freeIndex <span class="token operator">==</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>        <span class="token comment">// The span is full.</span>        c<span class="token punctuation">.</span><span class="token function">refill</span><span class="token punctuation">(</span>spc<span class="token punctuation">)</span>        s <span class="token operator">=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>    <span class="token punctuation">}</span>    s<span class="token punctuation">.</span>allocCount<span class="token operator">++</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcache<span class="token punctuation">)</span> <span class="token function">refill</span><span class="token punctuation">(</span>spc spanClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>    s <span class="token operator">:=</span> c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span>    <span class="token keyword">if</span> s <span class="token operator">!=</span> <span class="token operator">&amp;</span>emptymspan <span class="token punctuation">{</span>        <span class="token comment">// Mark this span as no longer cached.</span>        atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// Get a new cached span from the central lists.</span>    s <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"out of memory"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// Indicate that this span is cached and prevent asynchronous</span>    <span class="token comment">// sweeping in the next sweep phase.</span>    s<span class="token punctuation">.</span>sweepgen <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>sweepgen <span class="token operator">+</span> <span class="token number">3</span>    c<span class="token punctuation">.</span>alloc<span class="token punctuation">[</span>spc<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">}</span><span class="token comment">// Allocate a span to use in an mcache.</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">cacheSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>mspan <span class="token punctuation">{</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    sg <span class="token operator">:=</span> mheap_<span class="token punctuation">.</span>sweepgenretry<span class="token punctuation">:</span>    <span class="token keyword">var</span> s <span class="token operator">*</span>mspan    <span class="token keyword">for</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span>first<span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span>next <span class="token punctuation">{</span>        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>            <span class="token keyword">goto</span> havespan        <span class="token punctuation">}</span>        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>            <span class="token comment">// the span is being swept by background sweeper, skip</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token comment">// we have a nonempty span that does not require sweeping, allocate from it</span>        c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token keyword">goto</span> havespan    <span class="token punctuation">}</span>    <span class="token keyword">for</span> s <span class="token operator">=</span> c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span>first<span class="token punctuation">;</span> s <span class="token operator">!=</span> <span class="token boolean">nil</span><span class="token punctuation">;</span> s <span class="token operator">=</span> s<span class="token punctuation">.</span>next <span class="token punctuation">{</span>        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">2</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Cas</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> sg<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// we have an empty span that requires sweeping,</span>            <span class="token comment">// sweep it and see if we can free some space in it</span>            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token comment">// swept spans are at the end of the list</span>            c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            s<span class="token punctuation">.</span><span class="token function">sweep</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>            freeIndex <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">nextFreeIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> freeIndex <span class="token operator">!=</span> s<span class="token punctuation">.</span>nelems <span class="token punctuation">{</span>                s<span class="token punctuation">.</span>freeindex <span class="token operator">=</span> freeIndex                <span class="token keyword">goto</span> havespan            <span class="token punctuation">}</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            <span class="token comment">// the span is still empty after sweep</span>            <span class="token comment">// it is already in the empty list, so just retry</span>            <span class="token keyword">goto</span> retry        <span class="token punctuation">}</span>        <span class="token keyword">if</span> s<span class="token punctuation">.</span>sweepgen <span class="token operator">==</span> sg<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>            <span class="token comment">// the span is being swept by background sweeper, skip</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        <span class="token comment">// already swept empty span,</span>        <span class="token comment">// all subsequent ones must also be either swept or in process of sweeping</span>        <span class="token keyword">break</span>    <span class="token punctuation">}</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    <span class="token comment">// Replenish central list if empty.</span>    s <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">grow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> s <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">insertBack</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    <span class="token comment">// At this point s is a non-empty span, queued at the end of the empty list,</span>havespan<span class="token punctuation">:</span>    <span class="token comment">// ...</span>    <span class="token keyword">return</span> s<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="对象回收流程"><a href="#对象回收流程" class="headerlink" title="对象回收流程"></a>对象回收流程</h3><ol><li>大对象的mspan中对象全部释放时，mspan归还给mheap</li><li>小对象的mspan从空链表移到非空链表，供mcentral.cacheSpan中获取mspan；如果mspan中对象全部释放，直接归还到mheap</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">)</span> <span class="token function">sweep</span><span class="token punctuation">(</span>preserve <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token comment">// 有对象释放&amp;&amp;小对象</span>    <span class="token keyword">if</span> nfreed <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> spc<span class="token punctuation">.</span><span class="token function">sizeclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        res <span class="token operator">=</span> mheap_<span class="token punctuation">.</span>central<span class="token punctuation">[</span>spc<span class="token punctuation">]</span><span class="token punctuation">.</span>mcentral<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> preserve<span class="token punctuation">,</span> wasempty<span class="token punctuation">)</span>        <span class="token comment">// 大对象&amp;&amp;全部释放</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> freeToHeap <span class="token punctuation">{</span>        <span class="token comment">// Free large span to heap</span>        mheap_<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        res <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token operator">!</span>res <span class="token punctuation">{</span>        <span class="token comment">// The span has been swept and is still in-use, so put it on the swept in-use list.</span>        mheap_<span class="token punctuation">.</span>sweepSpans<span class="token punctuation">[</span>sweepgen<span class="token operator">/</span><span class="token number">2</span><span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> res<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>mcentral<span class="token punctuation">)</span> <span class="token function">freeSpan</span><span class="token punctuation">(</span>s <span class="token operator">*</span>mspan<span class="token punctuation">,</span> preserve <span class="token builtin">bool</span><span class="token punctuation">,</span> wasempty <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    <span class="token keyword">if</span> wasempty <span class="token punctuation">{</span>        c<span class="token punctuation">.</span>empty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>        c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">.</span>sweepgen<span class="token punctuation">,</span> mheap_<span class="token punctuation">.</span>sweepgen<span class="token punctuation">)</span>    <span class="token keyword">if</span> s<span class="token punctuation">.</span>allocCount <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    c<span class="token punctuation">.</span>nonempty<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    mheap_<span class="token punctuation">.</span><span class="token function">freeSpan</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="GC"><a href="#GC" class="headerlink" title="GC"></a>GC</h3><p><strong>gcpercent</strong>通过环境变量<code>GOGC</code>设置，用于控制GC速度，若无环境变量默认100%，若环境变量为”off”，会关闭2分钟1次的强制GC<br>函数<code>gcSetTriggerRatio</code>根据当次GC的速度调整下一次GC的速度，初始速度7/8，最小0.6，最大0.95。计算方式如下：</p><blockquote><p>mark phase阈值： float64(memstats.heap_marked) * (1 + triggerRatio)，如果有p正在sweep需求更大内存，自动上调<br>next GC阈值： memstats.heap_marked + memstats.heap_marked*uint64(gcpercent)/100，内存扩大一倍启动GC，若小于mark phase阈值自动上调</p></blockquote><p>GC通过以下逻辑触发：</p><ol><li>heap上涨触发了GC，每次分配对象需要新申请mspan，触发sweep后，最后会调用<strong>test</strong>判断是到达heap阈值否需要GC</li><li>在sysmon的每一次调度中，都会调用<strong>test</strong>判断距离上一次GC是否超过2分钟达到强制GC阈值</li><li><code>gcTriggerCycle</code>为runtime.GC()手动调用GC case</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>t gcTrigger<span class="token punctuation">)</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token operator">!</span>memstats<span class="token punctuation">.</span>enablegc <span class="token operator">||</span> panicking <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> gcphase <span class="token operator">!=</span> _GCoff <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token keyword">switch</span> t<span class="token punctuation">.</span>kind <span class="token punctuation">{</span>    <span class="token keyword">case</span> gcTriggerHeap<span class="token punctuation">:</span>        <span class="token keyword">return</span> memstats<span class="token punctuation">.</span>heap_live <span class="token operator">&gt;=</span> memstats<span class="token punctuation">.</span>gc_trigger    <span class="token keyword">case</span> gcTriggerTime<span class="token punctuation">:</span>        <span class="token keyword">if</span> gcpercent <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>        lastgc <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>last_gc_nanotime<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> lastgc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> t<span class="token punctuation">.</span>now<span class="token operator">-</span>lastgc <span class="token operator">&gt;</span> forcegcperiod    <span class="token keyword">case</span> gcTriggerCycle<span class="token punctuation">:</span>        <span class="token keyword">return</span> <span class="token function">int32</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>n<span class="token operator">-</span>work<span class="token punctuation">.</span>cycles<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>三色标记法：</p><ul><li>灰色：对象已标记，但这个对象包含的子对象未标记</li><li>黑色：对象已标记，且这个对象包含的子对象也已标记，gcmarkBits对应的位为1（该对象不会在本次GC中被清理）</li><li>白色：对象未标记，gcmarkBits对应的位为0（该对象将会在本次GC中被清理）</li></ul><img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/mspan_gc.jpg" class=""><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>    allocBits  <span class="token operator">*</span>gcBits    gcmarkBits <span class="token operator">*</span>gcBits<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>第一阶段：</p><ol><li>每个P启动一个goroutine，进入park，用于第二阶段调用gcDrain消费gcw</li><li>初始reset为白色，stop the world，完成未完成的sweep</li><li>启动gc write barriers，初始化root节点的扫描工作任务，在第二阶段中循环所有root节点执行<code>markroot</code></li><li>对p.mcache和p.tiny标记灰色</li><li>start the world</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">gcStart</span><span class="token punctuation">(</span>trigger gcTrigger<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">gcBgMarkStartWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 每个P启动一个goroutine，进入park，用于第二阶段调用gcDrain消费gcw</span>    <span class="token function">systemstack</span><span class="token punctuation">(</span>gcResetMarkState<span class="token punctuation">)</span> <span class="token comment">// 初始reset为白色</span>    <span class="token function">systemstack</span><span class="token punctuation">(</span>stopTheWorldWithSema<span class="token punctuation">)</span> <span class="token comment">// stop the world</span>    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">finishsweep_m</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token function">setGCPhase</span><span class="token punctuation">(</span>_GCmark<span class="token punctuation">)</span> <span class="token comment">// 启动gc write barriers</span>    <span class="token function">gcBgMarkPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Must happen before assist enable.</span>    <span class="token function">gcMarkRootPrepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 计算work.markrootJobs</span>    <span class="token function">gcMarkTinyAllocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 对p.mcache和p.tiny标记灰色</span>    <span class="token comment">// Concurrent mark.</span>    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        now <span class="token operator">=</span> <span class="token function">startTheWorldWithSema</span><span class="token punctuation">(</span>trace<span class="token punctuation">.</span>enabled<span class="token punctuation">)</span> <span class="token comment">// start the world</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>第二阶段：</p><ol><li><code>markroot</code>对所有root节点做标记，包含几个特殊任务随机分配给p执行，比如：释放全局<code>sched.gFree.stack</code>的栈，该队列保存有栈的dead G，释放栈后放入全局<code>sched.gFree.noStack</code></li><li>1 默认每个p扫描自己的栈上引用对象，包括栈上的defer链表。若为noscan对象直接标记黑色，否则根据对象引用进行标记。</li></ol><p>第三阶段：</p><p><code>gcMarkDone</code>先stop the world，将写屏障记录的所有修改的指针加入到标记队列，完成后start the world</p><p>第四阶段：</p><p><code>gcSweep</code>释放内存</p><p>GC停顿时间主要在第一阶段和第三阶段，第二阶段为和用户代码并行执行。第一次停顿用于扫描root节点，第二次停顿用于追加写屏障中记录。GC停顿时间主要消耗为root节点数量，和heap总大小无直接关系。</p><p>举个栗子：</p><img src="/2020/06/02/go/%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D%E5%92%8C%E5%AF%B9%E9%BD%90/%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0.jpg" class=""><ol><li>初始状态下所有对象都是白色的。</li><li>接着开始扫描根对象a、b; 由于根对象引用了对象A、B,那么A、B变为灰色对象，接下来就开始分析灰色对象，分析A时，A没有引用其他对象很快就转入黑色，B引用了D，则B转入黑色的同时还需要将D转为灰色，进行接下来的分析。</li><li>灰色对象只有D，由于D没有引用其他对象，所以D转入黑色。标记过程结束</li><li>最终，黑色的对象会被保留下来，白色对象会被回收掉。</li></ol><p>每个p有写屏障buf，用于避免第二阶段中用户代码修改引用导致gc漏标记。</p><h2 id="TODO-版本差异"><a href="#TODO-版本差异" class="headerlink" title="TODO 版本差异"></a>TODO 版本差异</h2><h2 id="TODO-JAVA"><a href="#TODO-JAVA" class="headerlink" title="TODO JAVA"></a>TODO JAVA</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://tonybai.com/2020/02/20/a-visual-guide-to-golang-memory-allocator-from-ground-up/" title="" target="">图解Go内存分配器</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go mutex</title>
      <link href="2020/05/27/go/mutex/"/>
      <url>2020/05/27/go/mutex/</url>
      
        <content type="html"><![CDATA[<h2 id="mutex"><a href="#mutex" class="headerlink" title="mutex"></a>mutex</h2><ul><li>并发模型中，可能存在N个g同时竞争1个锁对象</li><li>mutexWaiterShift用于计数锁等待g数量，使用sudog结构保存在semaRoot的平衡树的叶子中</li><li>semaRoot平衡树的叶子保存每一个unique sema，一个mutex对象的sema只保存在一个叶子中，使用<strong>单向FIFO链表</strong>形式保存竞争该sema的所有sudog</li><li>若没有spin机制，锁一旦释放，当前运行g会更大概率得到锁。若锁的时间很短，没有spin机制的情况下得不到锁的g都需要休眠park，会增加调度开销，存在长尾</li><li>在默认模式下，所有g都会先spin，waiter计数，然后插入链表尾并进入休眠，底层调用park函数</li><li>解锁后从FIFO链表头唤醒1个g，若该g等待时间&gt;1ms会尝试进入饥饿模式，此时仍可能有新g竞争锁。每次循环都会尝试CAS state到饥饿模式，若CAS失败会直接插入链表头，下次第一个被唤醒。</li><li>进入饥饿模式后，所有新g竞争时不会spin也不会尝试加锁，直接插入链表尾。每次解锁后从链表头唤醒1个g消费锁，若该g等待时间不超过1ms，退出饥饿模式。</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>  state <span class="token builtin">int32</span>  sema  <span class="token builtin">uint32</span><span class="token punctuation">}</span><span class="token keyword">const</span> <span class="token punctuation">(</span>  mutexLocked <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token boolean">iota</span> <span class="token comment">// 0001</span>  mutexWoken              <span class="token comment">// 0010</span>  mutexStarving           <span class="token comment">// 0100</span>  mutexWaiterShift <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0011</span>  starvationThresholdNs <span class="token operator">=</span> <span class="token number">1e6</span> <span class="token comment">// 超过1ms进入饥饿模式</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mutexLocked<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  m<span class="token punctuation">.</span><span class="token function">lockSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Mutex<span class="token punctuation">)</span> <span class="token function">lockSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> waitStartTime <span class="token builtin">int64</span>  starving <span class="token operator">:=</span> <span class="token boolean">false</span>  awoke <span class="token operator">:=</span> <span class="token boolean">false</span>  iter <span class="token operator">:=</span> <span class="token number">0</span>  old <span class="token operator">:=</span> m<span class="token punctuation">.</span>state  <span class="token keyword">for</span> <span class="token punctuation">{</span>    <span class="token comment">// 判断是否为饥饿模式</span>    <span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">==</span> mutexLocked <span class="token operator">&amp;&amp;</span> <span class="token function">runtime_canSpin</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// 如果未设置awoke且waiter计数&gt;0，说明其他m在等待锁，cas设置awoke</span>      <span class="token keyword">if</span> <span class="token operator">!</span>awoke <span class="token operator">&amp;&amp;</span> old<span class="token operator">&amp;</span>mutexWoken <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> old<span class="token operator">&gt;&gt;</span>mutexWaiterShift <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>        atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> old<span class="token operator">|</span>mutexWoken<span class="token punctuation">)</span> <span class="token punctuation">{</span>        awoke <span class="token operator">=</span> <span class="token boolean">true</span>      <span class="token punctuation">}</span>      <span class="token function">runtime_doSpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 自旋30次</span>      iter<span class="token operator">++</span>      old <span class="token operator">=</span> m<span class="token punctuation">.</span>state      <span class="token keyword">continue</span>    <span class="token punctuation">}</span>    <span class="token builtin">new</span> <span class="token operator">:=</span> old    <span class="token comment">// 非starving模式，设置new的locked</span>    <span class="token keyword">if</span> old<span class="token operator">&amp;</span>mutexStarving <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>      <span class="token builtin">new</span> <span class="token operator">|=</span> mutexLocked    <span class="token punctuation">}</span>    <span class="token comment">// 已上锁或饥饿状态，waiter计数+1</span>    <span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>      <span class="token builtin">new</span> <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> mutexWaiterShift    <span class="token punctuation">}</span>    <span class="token comment">// 处于饥饿模式并且已上锁，将starving置1</span>    <span class="token keyword">if</span> starving <span class="token operator">&amp;&amp;</span> old<span class="token operator">&amp;</span>mutexLocked <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>      <span class="token builtin">new</span> <span class="token operator">|=</span> mutexStarving    <span class="token punctuation">}</span>    <span class="token keyword">if</span> awoke <span class="token punctuation">{</span>      <span class="token builtin">new</span> <span class="token operator">&amp;^=</span> mutexWoken <span class="token comment">// 如果当前g是被唤醒的，清除woken</span>    <span class="token punctuation">}</span>    <span class="token comment">// 如果state!=old，说明有其他g抢锁，重新进入for循环</span>    <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> old<span class="token punctuation">,</span> <span class="token builtin">new</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// 如果old没上锁且是普通模式，抢锁成功，退出</span>      <span class="token keyword">if</span> old<span class="token operator">&amp;</span><span class="token punctuation">(</span>mutexLocked<span class="token operator">|</span>mutexStarving<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span>      <span class="token punctuation">}</span>      queueLifo <span class="token operator">:=</span> waitStartTime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token comment">// 第一次循环固定false</span>      <span class="token keyword">if</span> waitStartTime <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        waitStartTime <span class="token operator">=</span> <span class="token function">runtime_nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">}</span>      <span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>sema<span class="token punctuation">,</span> queueLifo<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>      starving <span class="token operator">=</span> starving <span class="token operator">||</span> <span class="token function">runtime_nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>waitStartTime <span class="token operator">&gt;</span> starvationThresholdNs      old <span class="token operator">=</span> m<span class="token punctuation">.</span>state      <span class="token keyword">if</span> old<span class="token operator">&amp;</span>mutexStarving <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        delta <span class="token operator">:=</span> <span class="token function">int32</span><span class="token punctuation">(</span>mutexLocked <span class="token operator">-</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>mutexWaiterShift<span class="token punctuation">)</span>        <span class="token comment">// 如果在饥饿模式并且自己是最后一个，清除starving标示</span>        <span class="token keyword">if</span> <span class="token operator">!</span>starving <span class="token operator">||</span> old<span class="token operator">&gt;&gt;</span>mutexWaiterShift <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>          delta <span class="token operator">-=</span> mutexStarving        <span class="token punctuation">}</span>        atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>m<span class="token punctuation">.</span>state<span class="token punctuation">,</span> delta<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token punctuation">}</span>      awoke <span class="token operator">=</span> <span class="token boolean">true</span>      iter <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      old <span class="token operator">=</span> m<span class="token punctuation">.</span>state    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>是否自旋判断逻辑：</p><ol><li>未超过4次for循环</li><li>多核且有其他running p</li><li>本地g队列为空</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">sync_runtime_canSpin</span><span class="token punctuation">(</span>i <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> i <span class="token operator">&gt;=</span> active_spin <span class="token operator">||</span> ncpu <span class="token operator">&lt;=</span> <span class="token number">1</span> <span class="token operator">||</span> gomaxprocs <span class="token operator">&lt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span>sched<span class="token punctuation">.</span>npidle<span class="token operator">+</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">if</span> p <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span><span class="token function">runqempty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token boolean">false</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="sema"><a href="#sema" class="headerlink" title="sema"></a>sema</h3><p>略</p><h2 id="rwmutex"><a href="#rwmutex" class="headerlink" title="rwmutex"></a>rwmutex</h2><ul><li>Mutex： w之间加解锁</li><li>writerSem： w叶的FIFO链表</li><li>readerSem： r叶的FIFO链表</li><li>readerCount： r计数，w加锁时给r设置大负数阻塞r</li><li>readerWait： w加锁时已有r的计数，在最后一个r解锁后FIFO唤醒w</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> RWMutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>  w           Mutex  <span class="token comment">// held if there are pending writers</span>  writerSem   <span class="token builtin">uint32</span> <span class="token comment">// semaphore for writers to wait for completing readers</span>  readerSem   <span class="token builtin">uint32</span> <span class="token comment">// semaphore for readers to wait for completing writers</span>  readerCount <span class="token builtin">int32</span>  <span class="token comment">// number of pending readers</span>  readerWait  <span class="token builtin">int32</span>  <span class="token comment">// number of departing readers</span><span class="token punctuation">}</span><span class="token keyword">const</span> rwmutexMaxReaders <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>    <span class="token comment">// readerSem叶链表尾=当前g</span>    <span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>    <span class="token comment">// 有w在等锁</span>    rw<span class="token punctuation">.</span><span class="token function">rUnlockSlow</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">rUnlockSlow</span><span class="token punctuation">(</span>r <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerWait<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>    <span class="token comment">// 最后一个r锁释放，从writerSem叶链表头唤醒等待的w锁</span>    <span class="token function">runtime_Semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span>rwmutexMaxReaders<span class="token punctuation">)</span> <span class="token operator">+</span> rwmutexMaxReaders <span class="token comment">// readerCount设一个大负数</span>  <span class="token comment">// Wait for active readers.</span>  <span class="token keyword">if</span> r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerWait<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>    <span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> rwmutexMaxReaders<span class="token punctuation">)</span> <span class="token comment">// 还原readerCount设置的大负数</span>  <span class="token comment">// readerSem叶链表头-&gt;尾循环唤醒等待的r</span>  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>    <span class="token function">runtime_Semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span>  rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="runtime-mutex"><a href="#runtime-mutex" class="headerlink" title="runtime.mutex"></a>runtime.mutex</h2><ul><li>lock流程</li></ul><ol><li>m.lock++</li><li>原子load key，如果没锁，尝试原子cas key-&gt;locked，cas成功则返回，否则自旋30次，多核下一共尝试4遍</li><li>其他m占着锁，此时key=locked，设置m.nextwaitm = muintptr(0)，for循环不断load key并尝试原子cas key-&gt;g.m，将自己设为等待锁的m</li><li>1 如果cas失败，可能还有其他m已将key cas为自己，继续循环；也可能是锁已释放，跳到1.重新判断锁</li><li>2 如果cas成功，m进入等待</li></ol><ul><li>unlock流程</li></ul><ol><li>如果key=locked，尝试原子cas key-&gt;0解锁，成功则返回</li><li>如果key!=locked，有其他m在等待锁，获取等待的m,尝试原子cas key-&gt;m.nextwaitm并唤醒等待的m</li><li>当前m.lock–，如果lock=0并且可抢占，设置抢占标记</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>  key <span class="token builtin">uintptr</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>  locked <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">1</span>  active_spin     <span class="token operator">=</span> <span class="token number">4</span> <span class="token comment">// 多核loop 4次</span>  active_spin_cnt <span class="token operator">=</span> <span class="token number">30</span> <span class="token comment">// 每次loop自旋30次</span>  passive_spin    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">lock</span><span class="token punctuation">(</span>l <span class="token operator">*</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>  gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">++</span>  <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span>  <span class="token punctuation">}</span>  <span class="token function">semacreate</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>m<span class="token punctuation">)</span> <span class="token comment">// 创建OS信号量</span>  spin <span class="token operator">:=</span> <span class="token number">0</span>  <span class="token keyword">if</span> ncpu <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>    spin <span class="token operator">=</span> active_spin <span class="token comment">// 多核loop 4次</span>  <span class="token punctuation">}</span>Loop<span class="token punctuation">:</span>  <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>    v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>    <span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>      <span class="token comment">// Unlocked. Try to lock.</span>      <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token operator">|</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>      <span class="token punctuation">}</span>      i <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> i <span class="token operator">&lt;</span> spin <span class="token punctuation">{</span>      <span class="token function">procyield</span><span class="token punctuation">(</span>active_spin_cnt<span class="token punctuation">)</span> <span class="token comment">// 自旋30次</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> i <span class="token operator">&lt;</span> spin<span class="token operator">+</span>passive_spin <span class="token punctuation">{</span>      <span class="token function">osyield</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 其他g已获得lock，gp.m.nextwaitm-&gt;muintptr(0)，l.key-&gt;gp.m</span>      <span class="token keyword">for</span> <span class="token punctuation">{</span>        gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>nextwaitm <span class="token operator">=</span> <span class="token function">muintptr</span><span class="token punctuation">(</span>v <span class="token operator">&amp;^</span> locked<span class="token punctuation">)</span>        <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">|</span>locked<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">break</span>        <span class="token punctuation">}</span>        v <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>        <span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>          <span class="token keyword">continue</span> Loop        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> v<span class="token operator">&amp;</span>locked <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token comment">// Queued. Wait.</span>        <span class="token function">semasleep</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>        i <span class="token operator">=</span> <span class="token number">0</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">unlock</span><span class="token punctuation">(</span>l <span class="token operator">*</span>mutex<span class="token punctuation">)</span> <span class="token punctuation">{</span>  gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token keyword">var</span> mp <span class="token operator">*</span>m  <span class="token keyword">for</span> <span class="token punctuation">{</span>    v <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">)</span>    <span class="token keyword">if</span> v <span class="token operator">==</span> locked <span class="token punctuation">{</span>      <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> locked<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">break</span>            <span class="token punctuation">}</span>        <span class="token comment">// l.key是其他等待m</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token comment">// 获取等待m</span>            mp <span class="token operator">=</span> <span class="token function">muintptr</span><span class="token punctuation">(</span>v <span class="token operator">&amp;^</span> locked<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment">// key换为等待m.nextwaitm</span>      <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Casuintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>l<span class="token punctuation">.</span>key<span class="token punctuation">,</span> v<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>nextwaitm<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// Dequeued an M.  Wake it.</span>        <span class="token function">semawakeup</span><span class="token punctuation">(</span>mp<span class="token punctuation">)</span>        <span class="token keyword">break</span>      <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">--</span>  <span class="token keyword">if</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>preempt <span class="token punctuation">{</span> <span class="token comment">// 重置抢占标示，在newstack栈分配中判断</span>    gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> stackPreempt  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h3><p><code>procyield</code>通过pause自旋</p><pre class="line-numbers language-go" data-language="go"><code class="language-go">TEXT runtime·<span class="token function">procyield</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>  MOVLcycles<span class="token operator">+</span><span class="token function">0</span><span class="token punctuation">(</span>FP<span class="token punctuation">)</span><span class="token punctuation">,</span> AXagain<span class="token punctuation">:</span>  PAUSE  SUBL$<span class="token number">1</span><span class="token punctuation">,</span> AX  JNZagain    RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>osyield</code>调用系统<strong>sched_yield</strong></p><pre class="line-numbers language-go" data-language="go"><code class="language-go">TEXT runtime·<span class="token function">osyield</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>  MOVL$SYS_sched_yield<span class="token punctuation">,</span> AX  SYSCALL    RET<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="TODO-java"><a href="#TODO-java" class="headerlink" title="TODO java"></a>TODO java</h2>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go sync.pool</title>
      <link href="2020/05/11/go/sync.pool/"/>
      <url>2020/05/11/go/sync.pool/</url>
      
        <content type="html"><![CDATA[<p>sync.pool是用于临时取还对象的池子，对于需要频繁分配和回收的对象使用sync.pool降低GC压力<br>sync.pool是线程安全的，一般设置new函数，在pool中没有对象时创建新对象<br>fmt、encoding/json等都用到sync.pool</p><h2 id="fmt用例"><a href="#fmt用例" class="headerlink" title="fmt用例"></a>fmt用例</h2><p>fmt包print类函数使用sync.pool</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">Printf</span><span class="token punctuation">(</span>format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">Fprintf</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stdout<span class="token punctuation">,</span> format<span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">Fprintf</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">,</span> format <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">,</span> err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    p <span class="token operator">:=</span> <span class="token function">newPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    p<span class="token punctuation">.</span><span class="token function">doPrintf</span><span class="token punctuation">(</span>format<span class="token punctuation">,</span> a<span class="token punctuation">)</span>    n<span class="token punctuation">,</span> err <span class="token operator">=</span> w<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>    p<span class="token punctuation">.</span><span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">newPrinter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>pp <span class="token punctuation">{</span>    p <span class="token operator">:=</span> ppFree<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>pp<span class="token punctuation">)</span>    p<span class="token punctuation">.</span>panicking <span class="token operator">=</span> <span class="token boolean">false</span>    p<span class="token punctuation">.</span>erroring <span class="token operator">=</span> <span class="token boolean">false</span>    p<span class="token punctuation">.</span>wrapErrs <span class="token operator">=</span> <span class="token boolean">false</span>    p<span class="token punctuation">.</span>fmt<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span>    <span class="token keyword">return</span> p<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>pp<span class="token punctuation">)</span> <span class="token function">free</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 初始put的大对象可能经过多个GC后才被回收，避免放回大对象</span>    <span class="token comment">// See https://golang.org/issue/23199</span>    <span class="token keyword">if</span> <span class="token function">cap</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>buf<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">64</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    p<span class="token punctuation">.</span>buf <span class="token operator">=</span> p<span class="token punctuation">.</span>buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>    p<span class="token punctuation">.</span>arg <span class="token operator">=</span> <span class="token boolean">nil</span>    p<span class="token punctuation">.</span>value <span class="token operator">=</span> reflect<span class="token punctuation">.</span>Value<span class="token punctuation">{</span><span class="token punctuation">}</span>    p<span class="token punctuation">.</span>wrappedErr <span class="token operator">=</span> <span class="token boolean">nil</span>    ppFree<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">var</span> ppFree <span class="token operator">=</span> sync<span class="token punctuation">.</span>Pool<span class="token punctuation">{</span>    New<span class="token punctuation">:</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">new</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pool-test"><a href="#pool-test" class="headerlink" title="pool test"></a>pool test</h2><p>略</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">defer</span> debug<span class="token punctuation">.</span><span class="token function">SetGCPercent</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span><span class="token function">SetGCPercent</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">runtime<span class="token punctuation">.</span><span class="token function">SetFinalizer</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span>vv <span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    atomic<span class="token punctuation">.</span><span class="token function">AddUint32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fin<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="pool结构"><a href="#pool结构" class="headerlink" title="pool结构"></a>pool结构</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// poolDequeue是单生产多消费的ring，方法pushHead/popHead/popTail</span><span class="token keyword">type</span> poolDequeue <span class="token keyword">struct</span> <span class="token punctuation">{</span>    <span class="token comment">// head = index of next slot to fill</span>    <span class="token comment">// tail = index of oldest data in queue</span>    headTail <span class="token builtin">uint64</span>    <span class="token comment">// 固定大小的ring，通过head/tail索引</span>    vals <span class="token punctuation">[</span><span class="token punctuation">]</span>eface<span class="token punctuation">}</span><span class="token keyword">type</span> eface <span class="token keyword">struct</span> <span class="token punctuation">{</span>    typ<span class="token punctuation">,</span> val unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// poolChain是双向链表的poolDequeue，方法pushHead/popHead/popTail</span><span class="token comment">// 第一次pushHead创建poolDequeue初始大小8</span><span class="token comment">// 每次pushHead若已用满，新建poolDequeue大小翻倍</span><span class="token comment">// popHead从头到尾遍历链表，对每个poolDequeue执行popHead尝试pop</span><span class="token comment">// popTail从尾到头遍历链表，对每个poolDequeue执行popTail尝试pop</span><span class="token keyword">type</span> poolChain <span class="token keyword">struct</span> <span class="token punctuation">{</span>    head <span class="token operator">*</span>poolChainElt    tail <span class="token operator">*</span>poolChainElt<span class="token punctuation">}</span><span class="token keyword">type</span> poolChainElt <span class="token keyword">struct</span> <span class="token punctuation">{</span>    poolDequeue    next<span class="token punctuation">,</span> prev <span class="token operator">*</span>poolChainElt<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> Pool <span class="token keyword">struct</span> <span class="token punctuation">{</span>    noCopy noCopy    local     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 每个P的本地队列，实际类型为[P]poolLocal</span>    localSize <span class="token builtin">uintptr</span>    victim     unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// local from previous cycle</span>    victimSize <span class="token builtin">uintptr</span>        <span class="token comment">// size of victims array</span>    <span class="token comment">// pool无可用对象时调用</span>    New <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">type</span> poolLocalInternal <span class="token keyword">struct</span> <span class="token punctuation">{</span>    private <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// 每个P的私有共享，使用时无需加锁</span>    shared  poolChain   <span class="token comment">// poolChain对象，本地P可以pushHead/popHead，其他P仅能popTail</span><span class="token punctuation">}</span><span class="token keyword">type</span> poolLocal <span class="token keyword">struct</span> <span class="token punctuation">{</span>    poolLocalInternal    <span class="token comment">// 伪共享，仅占位用，防止在cache line上分配多个poolLocalInternal</span>    pad <span class="token punctuation">[</span><span class="token number">128</span> <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>poolLocalInternal<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 1. 优先放poolLocal.private</span><span class="token comment">// 2. 其次放poolLocal.shared</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Put</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token comment">// Randomly drop x on floor.</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        race<span class="token punctuation">.</span><span class="token function">ReleaseMerge</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    l<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> l<span class="token punctuation">.</span>private <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        l<span class="token punctuation">.</span>private <span class="token operator">=</span> x        x <span class="token operator">=</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">pushHead</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>        race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 根据p获取poolLocal和pid</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 在runtime_procUnpin前当前G和P不会被抢占，防止下面pid发生改变</span>    s <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span>    l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local    <span class="token comment">// pid &lt; p.local数组长度时，在p.local里查找poolLocal对象</span>    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid    <span class="token punctuation">}</span>    <span class="token comment">// 否则调用pinSlow创建新poolLocal</span>    <span class="token keyword">return</span> p<span class="token punctuation">.</span><span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// pid在pool中没有对应poolLocal对象时，创建新对象</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">pinSlow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>poolLocal<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 先解除抢占再lock</span>    allPoolsMu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> allPoolsMu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    pid <span class="token operator">:=</span> <span class="token function">runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    s <span class="token operator">:=</span> p<span class="token punctuation">.</span>localSize    l <span class="token operator">:=</span> p<span class="token punctuation">.</span>local    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> s <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">,</span> pid <span class="token comment">// 解除抢期间可能p.local已发生变化</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> p<span class="token punctuation">.</span>local <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        allPools <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>allPools<span class="token punctuation">,</span> p<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 创建新poolLocal数组，旧数组进入gc</span>    size <span class="token operator">:=</span> runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    local <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>poolLocal<span class="token punctuation">,</span> size<span class="token punctuation">)</span>    atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>local<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    atomic<span class="token punctuation">.</span><span class="token function">StoreUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token operator">&amp;</span>local<span class="token punctuation">[</span>pid<span class="token punctuation">]</span><span class="token punctuation">,</span> pid<span class="token punctuation">}</span><span class="token comment">// 1。调用pin获取poolLocal和pid</span><span class="token comment">// 2. poolLocal.private为空，依次尝试以下方式</span><span class="token comment">// 2.1 从poolLocal.shared队列中获取对象</span><span class="token comment">// 2.2 调用getSlow从其他P偷取对象</span><span class="token comment">// 2.3 调用new创建对象</span><span class="token comment">// 3. poolLocal.private不为空，直接复用对象返回</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>        race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    l<span class="token punctuation">,</span> pid <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">pin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private <span class="token comment">// poolLocal.private不为空时，复用对象返回</span>    l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment">// poolLocal.private为空，从poolLocal.shared队列中获取对象</span>        x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popHead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">getSlow</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>        race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span><span class="token function">poolRaceAddr</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> x <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> p<span class="token punctuation">.</span>New <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        x <span class="token operator">=</span> p<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 用new()函数创建对象</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> x<span class="token punctuation">}</span><span class="token comment">// 当本地P无可用对象，从其他P偷取对象</span><span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>Pool<span class="token punctuation">)</span> <span class="token function">getSlow</span><span class="token punctuation">(</span>pid <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>    size <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span>    locals <span class="token operator">:=</span> p<span class="token punctuation">.</span>local    <span class="token comment">// 循环尝试从其他P偷取对象，popTail从链表尾获取</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> x        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    size <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>pid<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> size <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    locals <span class="token operator">=</span> p<span class="token punctuation">.</span>victim    l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> pid<span class="token punctuation">)</span>    <span class="token keyword">if</span> x <span class="token operator">:=</span> l<span class="token punctuation">.</span>private<span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>        <span class="token keyword">return</span> x    <span class="token punctuation">}</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>locals<span class="token punctuation">,</span> <span class="token punctuation">(</span>pid<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token operator">%</span><span class="token function">int</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> x<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> l<span class="token punctuation">.</span>shared<span class="token punctuation">.</span><span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> x        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// Mark the victim cache as empty for future gets don't bother</span>    <span class="token comment">// with it.</span>    atomic<span class="token punctuation">.</span><span class="token function">StoreUintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">.</span>victimSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="nocopy"><a href="#nocopy" class="headerlink" title="nocopy"></a>nocopy</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// noCopy 用于嵌入一个结构体中来保证其第一次使用后不会被复制</span><span class="token comment">// https://golang.org/issues/8005#issuecomment-190753527</span><span class="token keyword">type</span> noCopy <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// Lock 是一个空操作用来给 `go vet` 的 -copylocks 静态分析</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>noCopy<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pad"><a href="#pad" class="headerlink" title="pad"></a>pad</h2><ul><li><a href="https://www.jianshu.com/p/dc4b5562aad2" title="" target="">什么是cpu cache</a></li></ul><h2 id="pin-unpin"><a href="#pin-unpin" class="headerlink" title="pin/unpin"></a>pin/unpin</h2><p><code>sync.runtime_procPin</code>和<code>sync.runtime_procUnpin</code>通过go:linkname关联到<code>runtime.procPin</code>和<code>runtime.procUnpin</code><br>pin/unpin抢占方式为对m的locks增减，实际GPM调度判断M是否能被抢占的判断就包含<code>mp.locks == 0</code></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">//go:nosplit</span><span class="token keyword">func</span> <span class="token function">procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    mp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m    mp<span class="token punctuation">.</span>locks<span class="token operator">++</span>    <span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>mp<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//go:nosplit</span><span class="token keyword">func</span> <span class="token function">procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>locks<span class="token operator">--</span><span class="token punctuation">}</span><span class="token comment">//go:linkname sync_runtime_procPin sync.runtime_procPin</span><span class="token comment">//go:nosplit</span><span class="token keyword">func</span> <span class="token function">sync_runtime_procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token function">procPin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//go:linkname sync_runtime_procUnpin sync.runtime_procUnpin</span><span class="token comment">//go:nosplit</span><span class="token keyword">func</span> <span class="token function">sync_runtime_procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">procUnpin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">// preempt.go</span><span class="token comment">// canPreemptM reports whether mp is in a state that is safe to preempt.</span><span class="token comment">//</span><span class="token comment">// It is nosplit because it has nosplit callers.</span><span class="token comment">//</span><span class="token comment">//go:nosplit</span><span class="token keyword">func</span> <span class="token function">canPreemptM</span><span class="token punctuation">(</span>mp <span class="token operator">*</span>m<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>  <span class="token keyword">return</span> mp<span class="token punctuation">.</span>locks <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>mallocing <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>preemptoff <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">&amp;&amp;</span> mp<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status <span class="token operator">==</span> _Prunning<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="go-linkname用例"><a href="#go-linkname用例" class="headerlink" title="go:linkname用例"></a>go:linkname用例</h3><p>go:linkname让私有方法可以跨包访问，甚至导出为公开方法</p><p>目录结构：</p><img src="/2020/05/11/go/sync.pool/go_linkname.png" class=""><p>go build 默认使用<code>-complete</code>检查方法完整性，直接build会报错：</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">go build# github.com/yiduoyunQ/test/bb/b.go:10:6: missing function body<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>通过在b包中添加一个汇编文件，让go build编译器突破方法完整性限制，汇编文件名称任意<br>参考： - <a href="http://sitano.github.io/2016/04/28/golang-private/" title="" target="">How to call private functions (bind to hidden symbols) in GoLang</a></p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// a.go</span><span class="token keyword">package</span> a<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span>    <span class="token boolean">_</span> <span class="token string">"unsafe"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"private func_a in package a"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token comment">//go:linkname b_func_a github.com/yiduoyunQ/test/b.Func_b</span><span class="token keyword">func</span> <span class="token function">b_func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">func_a</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// b.go</span><span class="token keyword">package</span> b<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token boolean">_</span> <span class="token string">"unsafe"</span>    <span class="token boolean">_</span> <span class="token string">"github.com/yiduoyunQ/test/a"</span><span class="token punctuation">)</span><span class="token comment">// 仅有方法名，方法体通过go:linkname在a包中关联</span><span class="token keyword">func</span> <span class="token function">Func_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// test.go</span><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"github.com/yiduoyunQ/test/b"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 使用b的公开方法，在b中仅有方法名的申明</span>    b<span class="token punctuation">.</span><span class="token function">Func_b</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>输出： <code>private func_a in package a</code></p><h2 id="锁竞争"><a href="#锁竞争" class="headerlink" title="锁竞争"></a>锁竞争</h2><p><code>pushHead</code>先取slot再判断是否可插入最后修改</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">pushHead</span><span class="token punctuation">(</span>val <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>    head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>tail<span class="token operator">+</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> head <span class="token punctuation">{</span>        <span class="token comment">// Queue is full.</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    slot <span class="token operator">:=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>head<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    <span class="token comment">// Check if the head slot has been released by popTail.</span>    typ <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadPointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">)</span>    <span class="token keyword">if</span> typ <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment">// Another goroutine is still cleaning up the tail, so</span>        <span class="token comment">// the queue is actually still full.</span>        <span class="token keyword">return</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token comment">// The head slot is free, so we own it.</span>    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> val    <span class="token comment">// Increment head. This passes ownership of slot to popTail</span>    <span class="token comment">// and acts as a store barrier for writing the slot.</span>    atomic<span class="token punctuation">.</span><span class="token function">AddUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span>dequeueBits<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>popTail</code>先修改headTail再取slot然后重置slot</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>d <span class="token operator">*</span>poolDequeue<span class="token punctuation">)</span> <span class="token function">popTail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> slot <span class="token operator">*</span>eface    <span class="token keyword">for</span> <span class="token punctuation">{</span>        ptrs <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">LoadUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">)</span>        head<span class="token punctuation">,</span> tail <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">unpack</span><span class="token punctuation">(</span>ptrs<span class="token punctuation">)</span>        <span class="token keyword">if</span> tail <span class="token operator">==</span> head <span class="token punctuation">{</span>            <span class="token comment">// Queue is empty.</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>        <span class="token comment">// Confirm head and tail (for our speculative check</span>        <span class="token comment">// above) and increment tail. If this succeeds, then</span>        <span class="token comment">// we own the slot at tail.</span>        ptrs2 <span class="token operator">:=</span> d<span class="token punctuation">.</span><span class="token function">pack</span><span class="token punctuation">(</span>head<span class="token punctuation">,</span> tail<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">CompareAndSwapUint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>d<span class="token punctuation">.</span>headTail<span class="token punctuation">,</span> ptrs<span class="token punctuation">,</span> ptrs2<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// Success.</span>            slot <span class="token operator">=</span> <span class="token operator">&amp;</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">[</span>tail<span class="token operator">&amp;</span><span class="token function">uint32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>vals<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// We now own slot.</span>    val <span class="token operator">:=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token function">dequeueNil</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        val <span class="token operator">=</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment">// Tell pushHead that we're done with this slot. Zeroing the</span>    <span class="token comment">// slot is also important so we don't leave behind references</span>    <span class="token comment">// that could keep this object live longer than necessary.</span>    <span class="token comment">//</span>    <span class="token comment">// We write to val first and then publish that we're done with</span>    <span class="token comment">// this slot by atomically writing to typ.</span>    slot<span class="token punctuation">.</span>val <span class="token operator">=</span> <span class="token boolean">nil</span>    atomic<span class="token punctuation">.</span><span class="token function">StorePointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>slot<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>    <span class="token comment">// At this point pushHead owns the slot.</span>    <span class="token keyword">return</span> val<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>考虑正常push/pop情况，head和tail指向slot不会有交集，仅需原子获取修改<strong>headTail</strong></p><img src="/2020/05/11/go/sync.pool/poolDequeue_1.png" class=""><p>考虑当发生写溢出，pop速度跟不上push速度时</p><img src="/2020/05/11/go/sync.pool/poolDequeue_2.png" class=""><ul><li>若<code>pushHead</code>先执行，在第一次计算队列时发现队列满，false退出</li><li>若<code>popTail</code>先执行，tail成功+1<ul><li>此时<code>pushHead</code>执行，在第一次计算队列时发现队列没满，接着原子判断slot.typ<ul><li>若在判断前，<code>popTail</code>先执行原子设置slot.typ为空，则<code>pushHead</code>能获得slot正常插入，pop+push后队列仍满</li><li>若<code>pushHead</code>先执行原子判断slot.typ，此时typ非空，push失败</li></ul></li></ul></li></ul><p>poolChain使用双向链表存储poolDequeue，对poolChain执行<code>popTail</code>如图</p><img src="/2020/05/11/go/sync.pool/poolDequeue_3.png" class=""><p>若pop速度很快，当前队列已空且无next队列，则保留当前队列用于下一次pushHead<br>若push速度大于pop，pool使用内存会不断扩展，不加入victime和gc机制的话会导致内存溢出</p><h2 id="oldPools-allPools，victim，gc"><a href="#oldPools-allPools，victim，gc" class="headerlink" title="oldPools, allPools，victim，gc"></a>oldPools, allPools，victim，gc</h2><p>victime作为二级缓存，用来降低GC压力并提高命中率。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// This function is called with the world stopped, at the beginning of a garbage collection.</span><span class="token keyword">func</span> <span class="token function">poolCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// Drop victim caches from all pools.</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> oldPools <span class="token punctuation">{</span>        p<span class="token punctuation">.</span>victim <span class="token operator">=</span> <span class="token boolean">nil</span>        p<span class="token punctuation">.</span>victimSize <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span>    <span class="token comment">// Move primary cache to victim cache.</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allPools <span class="token punctuation">{</span>        p<span class="token punctuation">.</span>victim <span class="token operator">=</span> p<span class="token punctuation">.</span>local        p<span class="token punctuation">.</span>victimSize <span class="token operator">=</span> p<span class="token punctuation">.</span>localSize        p<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token boolean">nil</span>        p<span class="token punctuation">.</span>localSize <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span>    <span class="token comment">// The pools with non-empty primary caches now have non-empty</span>    <span class="token comment">// victim caches and no pools have primary caches.</span>    oldPools<span class="token punctuation">,</span> allPools <span class="token operator">=</span> allPools<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token comment">// 在pool的init中注册gc时的清理函数</span><span class="token keyword">func</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">runtime_registerPoolCleanup</span><span class="token punctuation">(</span>poolCleanup<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol><li>初始状态，oldPools和allPools均为nil</li><li>第1次调用<code>Get</code>，由于p.local为nil，将会在pinSlow中创建p.local，然后将p放入allPools，此时allPools长度为1，oldPools为nil</li><li>对象使用完毕，第1次调用<code>Put</code>放回对象</li><li>第1次GC STW阶段，allPools中所有p.local将值赋值给victim并置为nil，最后allPools为nil，oldPools长度为1</li><li>第2次调用<code>Get</code>，由于p.local为nil，此时会从p.victim里面尝试取对象</li><li>对象使用完毕，第2次调用<code>Put</code>放回对象，但由于p.local为nil，重新创建p.local，并将对象放回，此时allPools长度为1，oldPools长度为1</li><li>第2次GC STW阶段，oldPools中所有p.victim置nil，前一次的cache在本次GC时被回收，allPools所有p.local将值赋值给victim并置为nil，最后allPools为&nbsp;nil，oldPools长度为1</li></ol><p>Go 1.13以前poolCleanup的实现：<br>3层循环清空，时间复杂度为总长度O(n)</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">poolCleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">for</span> i<span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> allPools <span class="token punctuation">{</span>        allPools<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>        <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>localSize<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>            l <span class="token operator">:=</span> <span class="token function">indexLocal</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>local<span class="token punctuation">,</span> i<span class="token punctuation">)</span>            l<span class="token punctuation">.</span>private <span class="token operator">=</span> <span class="token boolean">nil</span>            <span class="token keyword">for</span> j <span class="token operator">:=</span> <span class="token keyword">range</span> l<span class="token punctuation">.</span>shared <span class="token punctuation">{</span>                l<span class="token punctuation">.</span>shared<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>            <span class="token punctuation">}</span>            l<span class="token punctuation">.</span>shared <span class="token operator">=</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        p<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token boolean">nil</span>        p<span class="token punctuation">.</span>localSize <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span>    allPools <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Pool<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>Go 1.13以前每次GC遍历allPools清空所有字段，新版相比Go 1.13以前，通过引入<strong>victim</strong>拉大了GC的粒度，且减小了GC的开销。<br><strong>victim</strong>在GC时将当前对象放入其中，在下一次GC前仍可作为二级缓存获取数据，直到下一次GC时回收，即GC的粒度从原来每次GC回收空对象变为2次GC才回收空对象。同时由于从<strong>victim</strong>中获取的数据没有再次放回<strong>victim</strong>中，相应GC的开销也减小了。<br>Go 1.13通过增加缓存方式，每次对allPools对象一次性清空，相比以前使用循环遍历，GC时间复杂度由原来的O(n)变为O(1)</p><p>gc调用链：<br>在runtime包mgc.go中创建函数钩子，通过go:linkname链接到sync包pool.go中，进行注册</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// pool.go</span><span class="token comment">// Implemented in runtime.</span><span class="token keyword">func</span> <span class="token function">runtime_registerPoolCleanup</span><span class="token punctuation">(</span>cleanup <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// mgc.go</span><span class="token comment">// Hooks for other packages</span><span class="token keyword">var</span> poolcleanup <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//go:linkname sync_runtime_registerPoolCleanup sync.runtime_registerPoolCleanup</span><span class="token keyword">func</span> <span class="token function">sync_runtime_registerPoolCleanup</span><span class="token punctuation">(</span>f <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  poolcleanup <span class="token operator">=</span> f<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="无锁化"><a href="#无锁化" class="headerlink" title="无锁化"></a>无锁化</h2><h3 id="原子操作代替锁"><a href="#原子操作代替锁" class="headerlink" title="原子操作代替锁"></a>原子操作代替锁</h3><p>通过<strong>headTail</strong>和<strong>slot.type</strong>的CAS原子操作代替锁，保证并发的前提下降低开销</p><h3 id="操作行为隔离"><a href="#操作行为隔离" class="headerlink" title="操作行为隔离"></a>操作行为隔离</h3><p>通过双向链表将<code>pushHead</code>和<code>popTail</code>行为尽可能隔离开</p><h3 id="victim"><a href="#victim" class="headerlink" title="victim"></a>victim</h3><p>通过<strong>victim</strong>二级缓存降低GC开销</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/133638023" title="" target="">深度解密Go语言之sync.Pool</a></li><li><a href="https://xargin.com/lock-contention-in-go/" title="" target="">几个Go系统可能遇到的锁问题</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goroutine</title>
      <link href="2020/05/11/go/goroutine/"/>
      <url>2020/05/11/go/goroutine/</url>
      
        <content type="html"><![CDATA[<blockquote><p>runtime/HACKING.md</p></blockquote><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>一个goroutine是一个g对象，main也是一个g</li><li>p数量默认为cpu核线程数，通过<code>GOMAXPROCS</code>调整</li><li>m数量一般比p多一点，最大10000个</li><li>goroutine入口<code>newproc</code>，m入口<code>mstart</code></li><li>getg()获取g，g.m关联的m，g.m.p关联的p</li><li>一般getg顺序为本地pop/全局拿最多32个/其他p偷一半(timer)/network</li><li>m通过<code>schedule</code>/<code>findrunnable</code>不断找活干，处于<strong>spinning</strong>状态。如果已经没活，退出spinning状态，调用<code>stopm</code>进入全局midle，同时释放p进入全局pidle</li><li><code>newproc</code>中的g不会直接分配给m，而是由spinning的m自己找g处理。当有idle的p和非spinning的m，则将全局midle设置为<strong>spinning</strong>，然后找g处理。若m不足使用newm新创建m(比如程序刚开始启动时)</li><li><code>sysmon</code>在main方法中注册，每个10ms检查g(初始20us逐渐增加到10ms，发生抢占后重置)，设置g.stackguard0=stackPreempt，在g运行过程中分配新stack时进行判断，将g放回全局runnable g队列，并调用一次schedule。每2分钟如果没有gc过，执行gc。若开启了strace，在sysmon中输出debug信息</li><li>gc根据上一次gc动态调整</li></ul><h2 id="g状态"><a href="#g状态" class="headerlink" title="g状态"></a>g状态</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> <span class="token punctuation">(</span>    _Gidle <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0 newg默认值为iota</span>    _Grunnable <span class="token comment">// 1 分配到runq</span>    _Grunning <span class="token comment">// 2 从runq等取出，与mp绑定执行go代码</span>    _Gsyscall <span class="token comment">// 3 执行系统调用，只与m绑定</span>    _Gwaiting <span class="token comment">// 4 阻塞等待io/gc/channel等，不在runq中</span>    _Gmoribund_unused <span class="token comment">// 5 保留</span>    _Gdead <span class="token comment">// 6 未使用状态，可能在本地或全局gFree，可能有stack或nostack</span>    _Genqueue_unused <span class="token comment">// 7 保留</span>    _Gcopystack <span class="token comment">// 8 running-&gt;copystack-&gt;running，避免stack拷贝过程中被gc</span>    _Gpreempted <span class="token comment">// 9 标示竞争</span>    <span class="token comment">// 用于标示gc</span>    _Gscan          <span class="token operator">=</span> <span class="token number">0x1000</span>    _Gscanrunnable  <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunnable  <span class="token comment">// 0x1001</span>    _Gscanrunning   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunning   <span class="token comment">// 0x1002</span>    _Gscansyscall   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gsyscall   <span class="token comment">// 0x1003</span>    _Gscanwaiting   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gwaiting   <span class="token comment">// 0x1004</span>    _Gscanpreempted <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gpreempted <span class="token comment">// 0x1009</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="入口"><a href="#入口" class="headerlink" title="入口"></a>入口</h2><blockquote><p>平台不同对应汇编文件不同</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// rt0_linux_arm64.s</span>TEXT <span class="token function">main</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token operator">|</span>NOFRAME<span class="token punctuation">,</span>$<span class="token number">0</span>    MOVD    $runtime·<span class="token function">rt0_go</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> R2    BL    <span class="token punctuation">(</span>R2<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// asm_arm64.s</span><span class="token comment">// 启动顺序:</span><span class="token comment">//</span><span class="token comment">//    call osinit</span><span class="token comment">//    call schedinit</span><span class="token comment">//    make &amp; queue new G</span><span class="token comment">//    call runtime·mstart</span><span class="token comment">//</span><span class="token comment">// The new G calls runtime·main.</span>TEXT runtime·<span class="token function">rt0_go</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span>    <span class="token comment">// 初始化g0，m0</span>    CALL    runtime·<span class="token function">args</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>    CALL    runtime·<span class="token function">osinit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>    CALL    runtime·<span class="token function">schedinit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>    <span class="token comment">// create a new goroutine to start program</span>    MOVD    $runtime·<span class="token function">mainPC</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span> R0        <span class="token comment">// mainPC是main的入口</span>    MOVD    RSP<span class="token punctuation">,</span> R7    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>    MOVD<span class="token punctuation">.</span>W    R0<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>    MOVD<span class="token punctuation">.</span>W    $<span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token function">8</span><span class="token punctuation">(</span>R7<span class="token punctuation">)</span>    MOVD    R7<span class="token punctuation">,</span> RSP    BL    runtime·<span class="token function">newproc</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// 调用newproc为mainPC创建goroutine</span>    ADD    $<span class="token number">32</span><span class="token punctuation">,</span> RSP    <span class="token comment">// start this M</span>    BL    runtime·<span class="token function">mstart</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span> <span class="token comment">// m的入口</span><span class="token comment">// mstart() =&gt; schedule() =&gt; execute() =&gt; xxx() =&gt; goexit()</span>TEXT runtime·<span class="token function">goexit</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span><span class="token punctuation">,</span>NOSPLIT<span class="token punctuation">,</span>$<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span>    BYTE    $<span class="token number">0x90</span>    <span class="token comment">// NOP</span>    CALL    runtime·<span class="token function">goexit1</span><span class="token punctuation">(</span>SB<span class="token punctuation">)</span>    <span class="token comment">// does not return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>schedinit使用cpu线程数或环境变量<code>GOMAXPROCS</code>初始化全局allp</p></blockquote><ol><li>allp不够大的话进行扩容和拷贝旧p</li><li>增加procs时，对增量p初始化，当前g的p复用</li><li>减少procs且当前p比新值小时，释放当前p，使用allp[0]</li><li>调小procs时，释放nprocs～old的p资源</li><li>关联有g的p和空闲m，空g的p放入全局空p对象，并返回第一个可用p</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    sched<span class="token punctuation">.</span>maxmcount <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">// m最大10000个，一般比p多一点</span>    <span class="token operator">...</span>    <span class="token comment">// cpu线程数或环境变量GOMAXPROCS设置p数量</span>    procs <span class="token operator">:=</span> ncpu    <span class="token keyword">if</span> n<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">atoi32</span><span class="token punctuation">(</span><span class="token function">gogetenv</span><span class="token punctuation">(</span><span class="token string">"GOMAXPROCS"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>        procs <span class="token operator">=</span> n    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token function">procresize</span><span class="token punctuation">(</span>procs<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unknown runnable goroutine during bootstrap"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">procresize</span><span class="token punctuation">(</span>nprocs <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>p <span class="token punctuation">{</span>    old <span class="token operator">:=</span> gomaxprocs    <span class="token comment">// 1. Grow allp if necessary.</span>    <span class="token keyword">if</span> nprocs <span class="token operator">&gt;</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// Synchronize with retake, which could be running</span>        <span class="token comment">// concurrently since it doesn't run on a P.</span>        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>        <span class="token keyword">if</span> nprocs <span class="token operator">&lt;=</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            allp <span class="token operator">=</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span>nprocs<span class="token punctuation">]</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            nallp <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>p<span class="token punctuation">,</span> nprocs<span class="token punctuation">)</span>            <span class="token comment">// Copy everything up to allp's cap so we</span>            <span class="token comment">// never lose old allocated Ps.</span>            <span class="token function">copy</span><span class="token punctuation">(</span>nallp<span class="token punctuation">,</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">cap</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            allp <span class="token operator">=</span> nallp        <span class="token punctuation">}</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. initialize new P's</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> old<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nprocs<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        pp <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">if</span> pp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            pp <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        pp<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>        <span class="token function">atomicstorep</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>pp<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 2. 增加procs，复用g的p</span>    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>id <span class="token operator">&lt;</span> nprocs <span class="token punctuation">{</span>        <span class="token comment">// continue to use the current P</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>status <span class="token operator">=</span> _Prunning        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mcache<span class="token punctuation">.</span><span class="token function">prepareForSweep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 3. 减少procs且当前g的p比新值小，释放当前g的p，使用allp[0]</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p <span class="token operator">=</span> <span class="token number">0</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>mcache <span class="token operator">=</span> <span class="token boolean">nil</span>        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        p<span class="token punctuation">.</span>m <span class="token operator">=</span> <span class="token number">0</span>        p<span class="token punctuation">.</span>status <span class="token operator">=</span> _Pidle        <span class="token function">acquirep</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 调小procs，释放nprocs～old的p资源</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> nprocs<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> old<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        p<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// can't free P itself because it can be referenced by an M in syscall</span>    <span class="token punctuation">}</span>    <span class="token comment">// Trim allp.</span>    <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> nprocs <span class="token punctuation">{</span>        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>        allp <span class="token operator">=</span> allp<span class="token punctuation">[</span><span class="token punctuation">:</span>nprocs<span class="token punctuation">]</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 关联有g的p和空闲m，空g的p放入全局空p对象，并返回第一个可用p</span>    <span class="token keyword">var</span> runnablePs <span class="token operator">*</span>p    <span class="token keyword">for</span> i <span class="token operator">:=</span> nprocs <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>        p <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> p <span class="token punctuation">{</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        p<span class="token punctuation">.</span>status <span class="token operator">=</span> _Pidle        <span class="token keyword">if</span> <span class="token function">runqempty</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">pidleput</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            p<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token function">mget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            p<span class="token punctuation">.</span>link<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>runnablePs<span class="token punctuation">)</span>            runnablePs <span class="token operator">=</span> p        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    stealOrder<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token function">uint32</span><span class="token punctuation">(</span>nprocs<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> int32p <span class="token operator">*</span><span class="token builtin">int32</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>gomaxprocs <span class="token comment">// make compiler check that gomaxprocs is an int32</span>    atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uint32</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>int32p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>nprocs<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> runnablePs<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="newproc"><a href="#newproc" class="headerlink" title="newproc"></a>newproc</h3><blockquote><p>newproc是goroutine入口(main也是goroutine)</p></blockquote><ol><li>获取free g<br> 1.1 本地free g队列获取g<br> 1.2 若本地free g队列空，全局free g队列获取最多32个g到本地，优先取有栈g<br> 1.3 若全局free g队列空，创建新g，默认stack为2k，状态默认idle-&gt;dead，避免gc</li><li>栈信息拷贝</li><li>状态dead-&gt;runnable</li><li>从goidcache设置goid，采用了预分配id段，预分配加解锁一次，设置无需锁</li><li>保存g到p<br> 5.1 保存g到runnext，旧的runnext排到本地runnable g队列尾(大小固定256)<br> 5.2 若本地runnable g队列满，取一半放到全局runnable g队列</li><li>有空闲p，并且没有spinning状态m，调用wakep消化g。 main函数也是一个goroutine，通过mainStarted过滤，无需执行wakep<br> 6.1 wakep调用startm，首先查看有无全局midle，若有直接绑定gpm，若没有newm创建一个spinning的m，由m调用mstart找g处理</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">newproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>    argp <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">)</span>    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// debug trace用</span>    pc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">newproc1</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> argp<span class="token punctuation">,</span> siz<span class="token punctuation">,</span> gp<span class="token punctuation">,</span> pc<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">newproc1</span><span class="token punctuation">(</span>fn <span class="token operator">*</span>funcval<span class="token punctuation">,</span> argp unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> narg <span class="token builtin">int32</span><span class="token punctuation">,</span> callergp <span class="token operator">*</span>g<span class="token punctuation">,</span> callerpc <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">acquirem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    _p_ <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    newg <span class="token operator">:=</span> <span class="token function">gfget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token comment">// 1. 获取free g</span>    <span class="token comment">// 如果本地g和全局g都用完，创建新g，newg=new(g)</span>    <span class="token comment">// _StackMin=2048，因此默认创建出来的g栈大小为2k</span>    <span class="token keyword">if</span> newg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        newg <span class="token operator">=</span> <span class="token function">malg</span><span class="token punctuation">(</span>_StackMin<span class="token punctuation">)</span>        <span class="token function">casgstatus</span><span class="token punctuation">(</span>newg<span class="token punctuation">,</span> _Gidle<span class="token punctuation">,</span> _Gdead<span class="token punctuation">)</span> <span class="token comment">// 状态_Gidle -&gt; _Gdead</span>        <span class="token function">allgadd</span><span class="token punctuation">(</span>newg<span class="token punctuation">)</span> <span class="token comment">// publishes with a g-&gt;status of Gdead so GC scanner doesn't look at uninitialized stack.</span>    <span class="token punctuation">}</span>    <span class="token comment">// 2. 拷贝栈信息</span>    newg<span class="token punctuation">.</span>ancestors <span class="token operator">=</span> <span class="token function">saveAncestors</span><span class="token punctuation">(</span>callergp<span class="token punctuation">)</span> <span class="token comment">// 用于go trace</span>    <span class="token function">casgstatus</span><span class="token punctuation">(</span>newg<span class="token punctuation">,</span> _Gdead<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span> <span class="token comment">// 3. 状态_Gdead -&gt; _Grunnable</span>    <span class="token comment">// 4. 防止每次访问全局计数器goidgen，采用预分配id段方式</span>    <span class="token keyword">if</span> _p_<span class="token punctuation">.</span>goidcache <span class="token operator">==</span> _p_<span class="token punctuation">.</span>goidcacheend <span class="token punctuation">{</span>        _p_<span class="token punctuation">.</span>goidcache <span class="token operator">=</span> atomic<span class="token punctuation">.</span><span class="token function">Xadd64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>goidgen<span class="token punctuation">,</span> _GoidCacheBatch<span class="token punctuation">)</span>        _p_<span class="token punctuation">.</span>goidcache <span class="token operator">-=</span> _GoidCacheBatch <span class="token operator">-</span> <span class="token number">1</span>        _p_<span class="token punctuation">.</span>goidcacheend <span class="token operator">=</span> _p_<span class="token punctuation">.</span>goidcache <span class="token operator">+</span> _GoidCacheBatch    <span class="token punctuation">}</span>    newg<span class="token punctuation">.</span>goid <span class="token operator">=</span> <span class="token function">int64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>goidcache<span class="token punctuation">)</span>    _p_<span class="token punctuation">.</span>goidcache<span class="token operator">++</span>    <span class="token comment">// 5. 保存g到p</span>    <span class="token function">runqput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> newg<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>    <span class="token comment">// 6. 有空闲p，并且没有spinning状态m，重新唤醒p。 main函数也是一个goroutine，通过mainStarted过滤，无需执行wakep</span>    <span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> mainStarted <span class="token punctuation">{</span>        <span class="token function">wakep</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">releasem</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="p-runnext测试"><a href="#p-runnext测试" class="headerlink" title="p.runnext测试"></a>p.runnext测试</h4><p>单cpu下每次输出都为9012345678，9是runnext，0-8是本地runnable g队列</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    runtime<span class="token punctuation">.</span><span class="token function">GOMAXPROCS</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 如果设置为多核，不同核间顺序随机</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">go</span> fmt<span class="token punctuation">.</span><span class="token function">Print</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    runtime<span class="token punctuation">.</span><span class="token function">Gosched</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token number">9</span> <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token number">5</span> <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="mstart"><a href="#mstart" class="headerlink" title="mstart"></a>mstart</h3><blockquote><p>mstart是m的入口，调用顺序mstart-&gt;schedule-&gt;execute</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">mstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token function">mstart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">...</span>    <span class="token function">mexit</span><span class="token punctuation">(</span>osStack<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">mstart1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>schedule是单次调度的公共函数，找一个g放m上执行，调用excute</p></blockquote><ol><li>有locked g，直接在上面跑execute</li><li>61轮一次从全局runnable g取 (增加循环间隔，避免全局g被某几个goroutine占有)</li><li>从本地runnable g取，优先取runnext</li><li>调用findrunnable()获取runnable g，直到取到1个g为止</li><li>若当前m处于spinning，取消spinning</li><li>获取的g已有lockedm，绑定g和lockedm，从2.重新判断</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    <span class="token comment">// 1. 有locked g，直接在上面跑execute</span>    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token function">stoplockedm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token function">execute</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>lockedg<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// Never returns.</span>    <span class="token punctuation">}</span>top<span class="token punctuation">:</span>    pp <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    pp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">false</span>    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token function">gcstopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">goto</span> top    <span class="token punctuation">}</span>    <span class="token keyword">var</span> gp <span class="token operator">*</span>g    <span class="token keyword">var</span> inheritTime <span class="token builtin">bool</span>    <span class="token comment">// 2. 61轮一次从全局runnable g取</span>    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment">// Check the global runnable queue once in a while to ensure fairness.</span>        <span class="token comment">// Otherwise two goroutines can completely occupy the local runqueue</span>        <span class="token comment">// by constantly respawning each other.</span>        <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">%</span><span class="token number">61</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            gp <span class="token operator">=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 从本地runnable g取，优先取runnext</span>    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 4. 调用findrunnable()获取runnable g，直到取到1个g为止</span>    <span class="token keyword">if</span> gp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        gp<span class="token punctuation">,</span> inheritTime <span class="token operator">=</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// blocks until work is available</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 若当前m处于spinning，取消spinning</span>    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>        <span class="token function">resetspinning</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 6. 获取的g已有lockedm，绑定g和lockedm，从2.重新判断</span>    <span class="token keyword">if</span> gp<span class="token punctuation">.</span>lockedm <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token comment">// Hands off own p to the locked m,</span>        <span class="token comment">// then blocks waiting for a new p.</span>        <span class="token function">startlockedm</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>        <span class="token keyword">goto</span> top    <span class="token punctuation">}</span>    <span class="token function">execute</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> inheritTime<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>findrunnable()尝试从本地g/全局g/net poll/其他p偷取g或timer g/执行gc 各种途径find a work</p></blockquote><ol><li>再尝试从本地runnable g取</li><li>从全局runnable g取</li><li>从net poll取g</li><li>大量m已处于spinning，而非idle的p数量少，通常为代码并发度低，跳过5.</li><li>从其他p偷取一半本地runnable g，尝试4次，最后一次会尝试偷取runNext和p2的到期timer g<br> 5.1 若有timer，可能有timer g结束入队，重新从1.开始判断</li><li>gc阶段，查看有无gc工作可做</li><li>再尝试从全局runnable g取</li><li>释放p，放回全局pidle<br> 8.1 m状态变为非spinning，nmspinning计数-1</li><li>从allp重新获取idle的p，并设置spinning和nmspinning+1，重新从1.开始判断</li><li>处于gc阶段，重新从6.开始判断</li><li>再次从net poll取g</li><li>将m放入全局idle m，并与当前g关联，重新从1.开始判断</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">findrunnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>top<span class="token punctuation">:</span>    _p_ <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// 1. 再尝试从本地runnable g取</span>    <span class="token keyword">if</span> gp<span class="token punctuation">,</span> inheritTime <span class="token operator">:=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> inheritTime    <span class="token punctuation">}</span>    <span class="token comment">// 2. 从全局runnable g取</span>    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        gp <span class="token operator">:=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token keyword">if</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 3. 从net poll取g</span>    procs <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>gomaxprocs<span class="token punctuation">)</span>    ranTimer <span class="token operator">:=</span> <span class="token boolean">false</span>    <span class="token comment">// If number of spinning M's &gt;= number of busy P's, block.</span>    <span class="token comment">// 4. 大量m已处于spinning，而非idle的p数量少，通常为代码并发度低</span>    <span class="token keyword">if</span> <span class="token operator">!</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">&amp;&amp;</span> <span class="token number">2</span><span class="token operator">*</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> procs<span class="token operator">-</span>atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">goto</span> stop    <span class="token punctuation">}</span>    <span class="token keyword">if</span> <span class="token operator">!</span>_g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 设置为spinning</span>        atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 从其他p偷取一半本地runnable g，尝试4次，最后一次会尝试偷取runNext和p2的到期timer g</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> enum <span class="token operator">:=</span> stealOrder<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token function">fastrand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>enum<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> enum<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>                <span class="token keyword">goto</span> top            <span class="token punctuation">}</span>            stealRunNextG <span class="token operator">:=</span> i <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token comment">// first look for ready queues with more than 1 g</span>            p2 <span class="token operator">:=</span> allp<span class="token punctuation">[</span>enum<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> _p_ <span class="token operator">==</span> p2 <span class="token punctuation">{</span>                <span class="token keyword">continue</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> gp <span class="token operator">:=</span> <span class="token function">runqsteal</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> p2<span class="token punctuation">,</span> stealRunNextG<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>            <span class="token punctuation">}</span>            <span class="token comment">// 偷取p2的timer g</span>            <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> <span class="token function">shouldStealTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span> <span class="token punctuation">{</span>                tnow<span class="token punctuation">,</span> w<span class="token punctuation">,</span> ran <span class="token operator">:=</span> <span class="token function">checkTimers</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> now<span class="token punctuation">)</span>                now <span class="token operator">=</span> tnow                <span class="token keyword">if</span> w <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pollUntil <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> w <span class="token operator">&lt;</span> pollUntil<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    pollUntil <span class="token operator">=</span> w                <span class="token punctuation">}</span>                <span class="token keyword">if</span> ran <span class="token punctuation">{</span>                    <span class="token comment">// p2的timer g入队，可以偷取</span>                    <span class="token keyword">if</span> gp<span class="token punctuation">,</span> inheritTime <span class="token operator">:=</span> <span class="token function">runqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span><span class="token punctuation">;</span> gp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> inheritTime                    <span class="token punctuation">}</span>                    ranTimer <span class="token operator">=</span> <span class="token boolean">true</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 5. 若有timer，可能有timer g结束入队，重新从1.开始判断</span>    <span class="token keyword">if</span> ranTimer <span class="token punctuation">{</span>        <span class="token comment">// Running a timer may have made some goroutine ready.</span>        <span class="token keyword">goto</span> top    <span class="token punctuation">}</span>stop<span class="token punctuation">:</span>    <span class="token comment">// 6. gc阶段，查看有无gc工作可做</span>    <span class="token keyword">if</span> gcBlackenEnabled <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _p_<span class="token punctuation">.</span>gcBgMarkWorker <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">gcMarkWorkAvailable</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">{</span>        _p_<span class="token punctuation">.</span>gcMarkWorkerMode <span class="token operator">=</span> gcMarkWorkerIdleMode        gp <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>gcBgMarkWorker<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Gwaiting<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">)</span>        <span class="token keyword">if</span> trace<span class="token punctuation">.</span>enabled <span class="token punctuation">{</span>            <span class="token function">traceGoUnpark</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token comment">// 7. 再尝试从全局runnable g取</span>    <span class="token keyword">if</span> sched<span class="token punctuation">.</span>runqsize <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        gp <span class="token operator">:=</span> <span class="token function">globrunqget</span><span class="token punctuation">(</span>_p_<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token keyword">return</span> gp<span class="token punctuation">,</span> <span class="token boolean">false</span>    <span class="token punctuation">}</span>    <span class="token comment">// 8. 释放m的p，放回全局pidle</span>    <span class="token keyword">if</span> <span class="token function">releasep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> _p_ <span class="token punctuation">{</span>        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"findrunnable: wrong p"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">pidleput</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    <span class="token comment">// 8.1 m状态变为非spinning，nmspinning-1</span>    wasSpinning <span class="token operator">:=</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning    <span class="token keyword">if</span> _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token punctuation">{</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">false</span>        <span class="token keyword">if</span> <span class="token function">int32</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"findrunnable: negative nmspinning"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 9. 从allp重新获取idle的p，并设置spinning和nmspinning+1，重新从1.开始判断</span>    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> _p_ <span class="token operator">:=</span> <span class="token keyword">range</span> allpSnapshot <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">runqempty</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            _p_ <span class="token operator">=</span> <span class="token function">pidleget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            <span class="token keyword">if</span> _p_ <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>                <span class="token function">acquirep</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>                <span class="token keyword">if</span> wasSpinning <span class="token punctuation">{</span>                    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>spinning <span class="token operator">=</span> <span class="token boolean">true</span>                    atomic<span class="token punctuation">.</span><span class="token function">Xadd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>                <span class="token punctuation">}</span>                <span class="token keyword">goto</span> top            <span class="token punctuation">}</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// 10. 处于gc阶段，重新从6.开始判断</span>    <span class="token comment">// 11. 再次从net poll取g</span>    <span class="token comment">// 12. 将m放入全局idle m，并与当前g关联，重新从1.开始判断</span>    <span class="token function">stopm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">goto</span> top<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>execute设置g状态为running，并执行g</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">execute</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">,</span> inheritTime <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    _g_ <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">=</span> gp    gp<span class="token punctuation">.</span>m <span class="token operator">=</span> _g_<span class="token punctuation">.</span>m    <span class="token function">casgstatus</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> _Grunnable<span class="token punctuation">,</span> _Grunning<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">!</span>inheritTime <span class="token punctuation">{</span>        _g_<span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>schedtick<span class="token operator">++</span>    <span class="token punctuation">}</span>    <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span> <span class="token comment">// gp.sched在newproc中设置，调用asm_arm64.s汇编函数gogo执行g代码</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="抢占"><a href="#抢占" class="headerlink" title="抢占"></a>抢占</h2><blockquote><p><code>runtime/proc.go</code>的main函数中注册了sysmon</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    g <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment">// Max stack size is 1 GB on 64-bit, 250 MB on 32-bit.</span>    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>PtrSize <span class="token operator">==</span> <span class="token number">8</span> <span class="token punctuation">{</span>        maxstacksize <span class="token operator">=</span> <span class="token number">1000000000</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        maxstacksize <span class="token operator">=</span> <span class="token number">250000000</span>    <span class="token punctuation">}</span>    <span class="token comment">// Allow newproc to start new Ms.</span>    mainStarted <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token keyword">if</span> GOARCH <span class="token operator">!=</span> <span class="token string">"wasm"</span> <span class="token punctuation">{</span> <span class="token comment">// no threads on wasm yet, so no sysmon</span>        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">newm</span><span class="token punctuation">(</span>sysmon<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fn <span class="token operator">:=</span> main_main <span class="token comment">// go:linkname main_main main.main</span>    <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> x <span class="token operator">*</span><span class="token builtin">int32</span>        <span class="token operator">*</span>x <span class="token operator">=</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>sysmon</code>为死循环，调用<code>retake</code>来调度长时间执行的g；调用<code>gcTrigger.test</code>方法判断2分钟没执行过gc；如果设置strace，根据设置间隔输出debug信息</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    sched<span class="token punctuation">.</span>nmsys<span class="token operator">++</span>    <span class="token function">checkdead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>    lasttrace <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    idle <span class="token operator">:=</span> <span class="token number">0</span>    delay <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> idle <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// start with 20us sleep...</span>            delay <span class="token operator">=</span> <span class="token number">20</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> idle <span class="token operator">&gt;</span> <span class="token number">50</span> <span class="token punctuation">{</span> <span class="token comment">// start doubling the sleep after 1ms...</span>            delay <span class="token operator">*=</span> <span class="token number">2</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> delay <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">{</span> <span class="token comment">// up to 10ms</span>            delay <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span>        <span class="token punctuation">}</span>        <span class="token function">usleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>        now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// retake P's blocked in syscalls</span>        <span class="token comment">// and preempt long running G's</span>        <span class="token keyword">if</span> <span class="token function">retake</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            idle <span class="token operator">=</span> <span class="token number">0</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            idle<span class="token operator">++</span>        <span class="token punctuation">}</span>        <span class="token comment">// check if we need to force a GC，判断在t.test()中</span>        <span class="token keyword">if</span> t <span class="token operator">:=</span> <span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerTime<span class="token punctuation">,</span> now<span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>            <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>            forcegc<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">var</span> list gList            list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>forcegc<span class="token punctuation">.</span>g<span class="token punctuation">)</span>            <span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>            <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> debug<span class="token punctuation">.</span>schedtrace <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lasttrace<span class="token operator">+</span><span class="token function">int64</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>schedtrace<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span> <span class="token operator">&lt;=</span> now <span class="token punctuation">{</span>            lasttrace <span class="token operator">=</span> now            <span class="token function">schedtrace</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>scheddetail <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>retake</code>遍历allp判断执行超过10ms的p，传给<code>preemptone</code></p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> forcePreemptNS <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token comment">// 10ms</span><span class="token keyword">func</span> <span class="token function">retake</span><span class="token punctuation">(</span>now <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span> <span class="token punctuation">{</span>    n <span class="token operator">:=</span> <span class="token number">0</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>allp<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>        _p_ <span class="token operator">:=</span> allp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>        <span class="token keyword">if</span> _p_ <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token comment">// 在procresize代码中，还没初始化</span>            <span class="token keyword">continue</span>        <span class="token punctuation">}</span>        pd <span class="token operator">:=</span> <span class="token operator">&amp;</span>_p_<span class="token punctuation">.</span>sysmontick        s <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>status        sysretake <span class="token operator">:=</span> <span class="token boolean">false</span>        <span class="token keyword">if</span> s <span class="token operator">==</span> _Prunning <span class="token operator">||</span> s <span class="token operator">==</span> _Psyscall <span class="token punctuation">{</span>            <span class="token comment">// Preempt G if it's running for too long.</span>            t <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>_p_<span class="token punctuation">.</span>schedtick<span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token function">int64</span><span class="token punctuation">(</span>pd<span class="token punctuation">.</span>schedtick<span class="token punctuation">)</span> <span class="token operator">!=</span> t <span class="token punctuation">{</span>                pd<span class="token punctuation">.</span>schedtick <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span>                pd<span class="token punctuation">.</span>schedwhen <span class="token operator">=</span> now            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> pd<span class="token punctuation">.</span>schedwhen<span class="token operator">+</span>forcePreemptNS <span class="token operator">&lt;=</span> now <span class="token punctuation">{</span>                <span class="token function">preemptone</span><span class="token punctuation">(</span>_p_<span class="token punctuation">)</span>                sysretake <span class="token operator">=</span> <span class="token boolean">true</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>allpLock<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token function">uint32</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><code>preemptone</code>设置g.stackguard0=stackPreempt。<br>创建新g后stack默认2k，之后根据代码执行不断调整stack大小。<br>调用汇编函数<code>morestack</code>，CALL <code>newstack</code>时检查<strong>stackPreempt</strong>，将g放回全局runnable g队列，并调用schedule</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">preemptone</span><span class="token punctuation">(</span>_p_ <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>    mp <span class="token operator">:=</span> _p_<span class="token punctuation">.</span>m<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    gp <span class="token operator">:=</span> mp<span class="token punctuation">.</span>curg    gp<span class="token punctuation">.</span>preempt <span class="token operator">=</span> <span class="token boolean">true</span>    <span class="token comment">// Every call in a go routine checks for stack overflow by</span>    <span class="token comment">// comparing the current stack pointer to gp-&gt;stackguard0.</span>    <span class="token comment">// Setting gp-&gt;stackguard0 to StackPreempt folds</span>    <span class="token comment">// preemption into the normal stack overflow check.</span>    gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> stackPreempt    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token comment">// stack.go</span><span class="token keyword">func</span> <span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    preempt <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">Loaduintptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>stackguard0<span class="token punctuation">)</span> <span class="token operator">==</span> stackPreempt    <span class="token keyword">if</span> preempt <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">canPreemptM</span><span class="token punctuation">(</span>thisg<span class="token punctuation">.</span>m<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// Let the goroutine keep running for now.</span>            <span class="token comment">// gp-&gt;preempt is set, so it will be preempted next time.</span>            gp<span class="token punctuation">.</span>stackguard0 <span class="token operator">=</span> gp<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>lo <span class="token operator">+</span> _StackGuard            <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span> <span class="token comment">// never return</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> preempt <span class="token punctuation">{</span>        <span class="token operator">...</span>        <span class="token comment">// 将g放回全局runnable g队列，调用schedule</span>        <span class="token function">gopreempt_m</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token operator">...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="schedtrace"><a href="#schedtrace" class="headerlink" title="schedtrace"></a>schedtrace</h2><ul><li>gomaxprocs:      p数量</li><li>idleprocs:       idle p数量</li><li>threads:         m数量</li><li>spinningthreads: spinning状态的m</li><li>nmidle:          idle m数量</li><li>runqueue:        全局runnable g队列长度</li><li>[x, y, z..]:     per p的本地runnable g队列长度</li></ul><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">schedtrace</span><span class="token punctuation">(</span>detailed <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"SCHED "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>now<span class="token operator">-</span>starttime<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1e6</span><span class="token punctuation">,</span> <span class="token string">"ms: gomaxprocs="</span><span class="token punctuation">,</span> gomaxprocs<span class="token punctuation">,</span> <span class="token string">" idleprocs="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>npidle<span class="token punctuation">,</span> <span class="token string">" threads="</span><span class="token punctuation">,</span> <span class="token function">mcount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">" spinningthreads="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>nmspinning<span class="token punctuation">,</span> <span class="token string">" idlethreads="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>nmidle<span class="token punctuation">,</span> <span class="token string">" runqueue="</span><span class="token punctuation">,</span> sched<span class="token punctuation">.</span>runqsize<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h2><p>runtime/mgc.go</p><p>通过<code>gcSetTriggerRatio</code>动态调整gc速度，略</p><h2 id="tool"><a href="#tool" class="headerlink" title="tool"></a>tool</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ GODEBUG=schedtrace=1000 godoc -http=:6060SCHED 0ms: gomaxprocs=4 idleprocs=3 threads=3 spinningthreads=0 idlethreads=0 runqueue=0 [0 0 0 0]using module mode; GOMOD=/PATHTO/go.modSCHED 0ms: gomaxprocs=4 idleprocs=1 threads=4 spinningthreads=1 idlethreads=0 runqueue=0 [1 0 0 0]SCHED 1005ms: gomaxprocs=4 idleprocs=4 threads=20 spinningthreads=0 idlethreads=15 runqueue=0 [0 0 0 0]SCHED 2013ms: gomaxprocs=4 idleprocs=4 threads=20 spinningthreads=0 idlethreads=16 runqueue=0 [0 0 0 0]<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go inferface</title>
      <link href="2020/05/07/go/interface/"/>
      <url>2020/05/07/go/interface/</url>
      
        <content type="html"><![CDATA[<h2 id="接口类型判断"><a href="#接口类型判断" class="headerlink" title="接口类型判断"></a>接口类型判断</h2><ol><li>对于S类型仅能看到S的方法，<em>S类型能看到S和</em>S的所有方法</li><li>接口类型判断方法，判断时严格匹配类型的可见函数</li></ol><blockquote><p>变量.(类型) // 判断是不是某个具体类型<br>switch 变量.(type) // 返回具体类型的值拷贝，必须搭配swith语句</p></blockquote><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">type</span> I1 <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">type</span> I2 <span class="token keyword">interface</span> <span class="token punctuation">{</span>    <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span>    n <span class="token builtin">int</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>s <span class="token operator">*</span>S<span class="token punctuation">)</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    s<span class="token punctuation">.</span>n<span class="token operator">++</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token punctuation">(</span>s S<span class="token punctuation">)</span> <span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    s<span class="token punctuation">.</span>n <span class="token operator">=</span> s<span class="token punctuation">.</span>n <span class="token operator">*</span> s<span class="token punctuation">.</span>n<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestI1</span><span class="token punctuation">(</span>i I1<span class="token punctuation">)</span> <span class="token punctuation">{</span>    i<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    i<span class="token punctuation">.</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">TestI2</span><span class="token punctuation">(</span>i I2<span class="token punctuation">)</span> <span class="token punctuation">{</span>    i<span class="token punctuation">.</span><span class="token function">sqr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">PrintIf</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>I1<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I1 type[%T] %v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> v<span class="token punctuation">,</span> ok <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span>I2<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I2 type[%T] %v\n"</span><span class="token punctuation">,</span> v<span class="token punctuation">,</span> v<span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">PrintSwtich</span><span class="token punctuation">(</span>i <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%p %v\n"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> i<span class="token punctuation">)</span>    <span class="token keyword">switch</span> t <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> I1<span class="token punctuation">:</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I1 type[%T] %v\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>    <span class="token keyword">case</span> I2<span class="token punctuation">:</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"I2 type[%T] %v\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> t<span class="token punctuation">)</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"unknow\n"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> s S    <span class="token function">TestI1</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>    <span class="token comment">// TestI1(s)</span>    <span class="token comment">// cannot use s (type S) as type I1 in argument to TestI1:</span>    <span class="token comment">// does not implement I1 (add method has pointer receiver)</span>    <span class="token function">TestI2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>    <span class="token function">TestI2</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token function">PrintIf</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token function">PrintIf</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"------------\n"</span><span class="token punctuation">)</span>    <span class="token function">PrintSwtich</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>    <span class="token function">PrintSwtich</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">I2 <span class="token keyword">type</span><span class="token punctuation">[</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// S类型只能看到sqr方法，仅能匹配I2</span>I1 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// *S类型可以匹配I1</span>I2 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// 和I2</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token number">0xc0001021e0</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>I2 <span class="token keyword">type</span><span class="token punctuation">[</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// S类型只能看到sqr方法，仅能匹配I2</span><span class="token number">0xc0001021f0</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span>I1 <span class="token keyword">type</span><span class="token punctuation">[</span><span class="token operator">*</span>main<span class="token punctuation">.</span>S<span class="token punctuation">]</span> <span class="token operator">&amp;</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span> <span class="token comment">// *S类型可以匹配I1，switch分支退出</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="接口组成"><a href="#接口组成" class="headerlink" title="接口组成"></a>接口组成</h2><p>从接口源码看，接口组成为<code>类型</code>和<code>数据</code>，判断两个接口是否相等，就是看<code>类型</code>和<code>数据</code>是否相等<br><code>类型</code>和<code>数据</code>都为nil，才代表该接口为nil</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">var a interface{}var b interface{} = (*int)(nil)fmt.Println(a == nil, b == nil) //true false<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h2 id="接口类型转换-多态"><a href="#接口类型转换-多态" class="headerlink" title="接口类型转换(多态)"></a>接口类型转换(多态)</h2><p>不包含任何方法的空接口A，任意类型都符合转换成A<br>即使B=nil，A本身非nil，仅A.数据=nil<br>若要对A判断空，需构造B的空对象用于A的判断</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">type</span> A <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">type</span> B <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">var</span> b_nil <span class="token operator">=</span> B<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> A <span class="token punctuation">{</span>    <span class="token keyword">var</span> b <span class="token operator">*</span>B <span class="token comment">// b = nil</span>    <span class="token keyword">return</span> b <span class="token comment">// 函数返回触发值拷贝，A.类型=*B, A.数据=nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f_nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> A <span class="token punctuation">{</span>    <span class="token keyword">return</span> b_nil<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    a <span class="token operator">:=</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// a = (A)(nil&lt;*B&gt;)，此处类型为A，数据为*B类型的nil</span>    <span class="token keyword">if</span> a <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil B"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"non nil A"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    a <span class="token operator">=</span> <span class="token function">f_nil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> a <span class="token operator">==</span> b_nil <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"nil B"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">non <span class="token boolean">nil</span> A<span class="token boolean">nil</span> B<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h2 id="interface-和-interface"><a href="#interface-和-interface" class="headerlink" title="interface{}和*interface{}"></a>interface{}和*interface{}</h2><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">type</span> S <span class="token keyword">struct</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// all type is OK</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>x <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token comment">// only *interface{} is OK</span><span class="token keyword">func</span> <span class="token function">g</span><span class="token punctuation">(</span>x <span class="token operator">*</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    s <span class="token operator">:=</span> S<span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// var</span>    p <span class="token operator">:=</span> <span class="token operator">&amp;</span>s  <span class="token comment">// point</span>    <span class="token function">f</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>     <span class="token comment">// var -&gt; interface: OK</span>    <span class="token function">g</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>     <span class="token comment">// error</span>    <span class="token function">f</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>     <span class="token comment">// point -&gt; interface: OK</span>    <span class="token function">g</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>     <span class="token comment">// error</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="接口结构"><a href="#接口结构" class="headerlink" title="接口结构"></a>接口结构</h2><p>接口分空接口和非空接口，runtime2.go:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 空接口定义</span><span class="token keyword">type</span> eface <span class="token keyword">struct</span> <span class="token punctuation">{</span>    _type <span class="token operator">*</span>_type    data  unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">}</span><span class="token comment">// 非空接口定义</span><span class="token keyword">type</span> iface <span class="token keyword">struct</span> <span class="token punctuation">{</span>    tab  <span class="token operator">*</span>itab    data unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// 指向runtime申请的内存，存储实际数据</span><span class="token punctuation">}</span><span class="token keyword">type</span> itab <span class="token keyword">struct</span> <span class="token punctuation">{</span>    inter <span class="token operator">*</span>interfacetype <span class="token comment">// 接口类型</span>    _type <span class="token operator">*</span>_type <span class="token comment">// 数据类型，iface.data指向值的类型信息</span>    hash  <span class="token builtin">uint32</span> <span class="token comment">// copy of _type.hash. Used for type switches. golang Duck-typing机制</span>    <span class="token boolean">_</span>     <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token builtin">byte</span>    <span class="token comment">// 函数地址占位符</span>    <span class="token comment">// fun[0]==0 means _type does not implement inter.</span>    <span class="token comment">// fun[0]!=0，fun存放第一个接口方法的地址，其他方法依次向后存放，空间换时间，对应_type中也可以查到方法，使用时不用再动态查找</span>    fun   <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span><span class="token punctuation">}</span><span class="token keyword">type</span> interfacetype <span class="token keyword">struct</span> <span class="token punctuation">{</span>    typ     _type    pkgpath name <span class="token comment">// 接口包名</span>    mhdr    <span class="token punctuation">[</span><span class="token punctuation">]</span>imethod <span class="token comment">// 接口中定义的函数，由连接器嵌入</span><span class="token punctuation">}</span><span class="token keyword">type</span> imethod <span class="token keyword">struct</span> <span class="token punctuation">{</span>    name nameOff <span class="token comment">// name of method</span>    ityp typeOff <span class="token comment">// .(*FuncType) underneath</span><span class="token punctuation">}</span><span class="token keyword">type</span> _type <span class="token keyword">struct</span> <span class="token punctuation">{</span>    size       <span class="token builtin">uintptr</span>    ptrdata    <span class="token builtin">uintptr</span> <span class="token comment">// size of memory prefix holding all pointers</span>    hash       <span class="token builtin">uint32</span>    tflag      tflag    align      <span class="token builtin">uint8</span>    fieldAlign <span class="token builtin">uint8</span>    kind       <span class="token builtin">uint8</span>    <span class="token comment">// function for comparing objects of this type</span>    <span class="token comment">// (ptr to object A, ptr to object B) -&gt; ==?</span>    equal <span class="token keyword">func</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span>    <span class="token comment">// gcdata stores the GC type data for the garbage collector.</span>    <span class="token comment">// If the KindGCProg bit is set in kind, gcdata is a GC program.</span>    <span class="token comment">// Otherwise it is a ptrmask bitmap. See mbitmap.go for details.</span>    gcdata    <span class="token operator">*</span><span class="token builtin">byte</span>    str       nameOff    ptrToThis typeOff<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="全局itab"><a href="#全局itab" class="headerlink" title="全局itab"></a>全局itab</h2><p>全局itab使用数组保存，iface.go:</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">const</span> itabInitSize <span class="token operator">=</span> <span class="token number">512</span><span class="token keyword">var</span> <span class="token punctuation">(</span>    itabLock      mutex                               <span class="token comment">// lock for accessing itab table</span>    itabTable     <span class="token operator">=</span> <span class="token operator">&amp;</span>itabTableInit                    <span class="token comment">// pointer to current table</span>    itabTableInit <span class="token operator">=</span> itabTableType<span class="token punctuation">{</span>size<span class="token punctuation">:</span> itabInitSize<span class="token punctuation">}</span> <span class="token comment">// starter table</span><span class="token punctuation">)</span><span class="token comment">// Note: change the formula in the mallocgc call in itabAdd if you change these fields.</span><span class="token keyword">type</span> itabTableType <span class="token keyword">struct</span> <span class="token punctuation">{</span>    size    <span class="token builtin">uintptr</span>             <span class="token comment">// 数组大小，2的幂次方</span>    count   <span class="token builtin">uintptr</span>             <span class="token comment">// 已保存记录数</span>    entries <span class="token punctuation">[</span>itabInitSize<span class="token punctuation">]</span><span class="token operator">*</span>itab <span class="token comment">// *itab数组，初始大小512</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="接口转换函数"><a href="#接口转换函数" class="headerlink" title="接口转换函数"></a>接口转换函数</h2><p>接口转换调用conv系列函数</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 类型转为空接口，</span><span class="token keyword">func</span> <span class="token function">convT2E</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>e eface<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>        <span class="token function">raceReadObjectPC</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>convT2E<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> msanenabled <span class="token punctuation">{</span>        <span class="token function">msanread</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    x <span class="token operator">:=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>size<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// mallocgc内存用于拷贝源值</span>    <span class="token comment">// TODO: We allocate a zeroed object only to overwrite it with actual data.</span>    <span class="token comment">// Figure out how to avoid zeroing. Also below in convT2Eslice, convT2I, convT2Islice.</span>    <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> x<span class="token punctuation">,</span> elem<span class="token punctuation">)</span>    e<span class="token punctuation">.</span>_type <span class="token operator">=</span> t <span class="token comment">// type直接复制源type</span>    e<span class="token punctuation">.</span>data <span class="token operator">=</span> x <span class="token comment">// data指针指向mallocgc内存</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 类型转为非空接口</span><span class="token keyword">func</span> <span class="token function">convT2I</span><span class="token punctuation">(</span>tab <span class="token operator">*</span>itab<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">(</span>i iface<span class="token punctuation">)</span> <span class="token punctuation">{</span>    t <span class="token operator">:=</span> tab<span class="token punctuation">.</span>_type    <span class="token keyword">if</span> raceenabled <span class="token punctuation">{</span>        <span class="token function">raceReadObjectPC</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">funcPC</span><span class="token punctuation">(</span>convT2I<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> msanenabled <span class="token punctuation">{</span>        <span class="token function">msanread</span><span class="token punctuation">(</span>elem<span class="token punctuation">,</span> t<span class="token punctuation">.</span>size<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    x <span class="token operator">:=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>size<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// // mallocgc内存用于拷贝源值</span>    <span class="token function">typedmemmove</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> x<span class="token punctuation">,</span> elem<span class="token punctuation">)</span>    i<span class="token punctuation">.</span>tab <span class="token operator">=</span> tab <span class="token comment">// tab指向类型T的同一个tab，由编译器生成</span>    i<span class="token punctuation">.</span>data <span class="token operator">=</span> x <span class="token comment">// data指针指向mallocgc内存</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 接口转为接口</span><span class="token keyword">func</span> <span class="token function">convI2I</span><span class="token punctuation">(</span>inter <span class="token operator">*</span>interfacetype<span class="token punctuation">,</span> i iface<span class="token punctuation">)</span> <span class="token punctuation">(</span>r iface<span class="token punctuation">)</span> <span class="token punctuation">{</span>    tab <span class="token operator">:=</span> i<span class="token punctuation">.</span>tab    <span class="token keyword">if</span> tab <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> tab<span class="token punctuation">.</span>inter <span class="token operator">==</span> inter <span class="token punctuation">{</span>        r<span class="token punctuation">.</span>tab <span class="token operator">=</span> tab        r<span class="token punctuation">.</span>data <span class="token operator">=</span> i<span class="token punctuation">.</span>data        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    r<span class="token punctuation">.</span>tab <span class="token operator">=</span> <span class="token function">getitab</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> tab<span class="token punctuation">.</span>_type<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token comment">// 调用getitab函数获取tab</span>    r<span class="token punctuation">.</span>data <span class="token operator">=</span> i<span class="token punctuation">.</span>data    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token comment">// 其他特定类型转换，如果是0值指向zeroVal[0]，非0值使用mallocgc开辟内存空间</span><span class="token keyword">func</span> <span class="token function">convTstring</span><span class="token punctuation">(</span>val <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>x unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> val <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{</span>        x <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>zeroVal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        x <span class="token operator">=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">,</span> stringType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">=</span> val    <span class="token punctuation">}</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="getitab流程"><a href="#getitab流程" class="headerlink" title="getitab流程"></a>getitab流程</h2><ol><li>t=itabTable地址，保存地址避免执行find时地址被改变，t.find查找，不加锁</li><li>加锁使用itabTable.find，在itabAdd函数中新添加的itab在此处查到</li><li>加锁后没查到，新建m，调用itabAdd函数添加到itabTable</li><li>itabAdd函数中，容量超过3/4会进行翻倍扩容</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">getitab</span><span class="token punctuation">(</span>inter <span class="token operator">*</span>interfacetype<span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> canfail <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token operator">*</span>itab <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"internal error - misuse of itab"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token comment">// easy case</span>    <span class="token keyword">if</span> typ<span class="token punctuation">.</span>tflag<span class="token operator">&amp;</span>tflagUncommon <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> canfail <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token boolean">nil</span>        <span class="token punctuation">}</span>        name <span class="token operator">:=</span> inter<span class="token punctuation">.</span>typ<span class="token punctuation">.</span><span class="token function">nameOff</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TypeAssertionError<span class="token punctuation">{</span><span class="token boolean">nil</span><span class="token punctuation">,</span> typ<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inter<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> name<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> m <span class="token operator">*</span>itab    <span class="token comment">// First, look in the existing table to see if we can find the itab we need.</span>    <span class="token comment">// This is by far the most common case, so do it without locks.</span>    <span class="token comment">// Use atomic to ensure we see any previous writes done by the thread</span>    <span class="token comment">// that updates the itabTable field (with atomic.Storep in itabAdd).</span>    t <span class="token operator">:=</span> <span class="token punctuation">(</span><span class="token operator">*</span>itabTableType<span class="token punctuation">)</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Loadp</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabTable<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> m <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> typ<span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">goto</span> finish    <span class="token punctuation">}</span>    <span class="token comment">// Not found.  Grab the lock and try again.</span>    <span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>    <span class="token keyword">if</span> m <span class="token operator">=</span> itabTable<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>inter<span class="token punctuation">,</span> typ<span class="token punctuation">)</span><span class="token punctuation">;</span> m <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>        <span class="token keyword">goto</span> finish    <span class="token punctuation">}</span>    <span class="token comment">// Entry doesn't exist yet. Make a new entry &amp; add it.</span>    m <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>itab<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">persistentalloc</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>itab<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>inter<span class="token punctuation">.</span>mhdr<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>memstats<span class="token punctuation">.</span>other_sys<span class="token punctuation">)</span><span class="token punctuation">)</span>    m<span class="token punctuation">.</span>inter <span class="token operator">=</span> inter    m<span class="token punctuation">.</span>_type <span class="token operator">=</span> typ    <span class="token comment">// The hash is used in type switches. However, compiler statically generates itab's</span>    <span class="token comment">// for all interface/type pairs used in switches (which are added to itabTable</span>    <span class="token comment">// in itabsinit). The dynamically-generated itab's never participate in type switches,</span>    <span class="token comment">// and thus the hash is irrelevant.</span>    <span class="token comment">// Note: m.hash is _not_ the hash used for the runtime itabTable hash table.</span>    m<span class="token punctuation">.</span>hash <span class="token operator">=</span> <span class="token number">0</span>    m<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">itabAdd</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>    <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itabLock<span class="token punctuation">)</span>finish<span class="token punctuation">:</span>    <span class="token keyword">if</span> m<span class="token punctuation">.</span>fun<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> m    <span class="token punctuation">}</span>    <span class="token keyword">if</span> canfail <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token boolean">nil</span>    <span class="token punctuation">}</span>    <span class="token comment">// this can only happen if the conversion</span>    <span class="token comment">// was already done once using the , ok form</span>    <span class="token comment">// and we have a cached negative result.</span>    <span class="token comment">// The cached result doesn't record which</span>    <span class="token comment">// interface function was missing, so initialize</span>    <span class="token comment">// the itab again to get the missing function name.</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TypeAssertionError<span class="token punctuation">{</span>concrete<span class="token punctuation">:</span> typ<span class="token punctuation">,</span> asserted<span class="token punctuation">:</span> <span class="token operator">&amp;</span>inter<span class="token punctuation">.</span>typ<span class="token punctuation">,</span> missingMethod<span class="token punctuation">:</span> m<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/125488954" title="" target="">Golang中interface内部构造</a></li><li><a href="https://www.jianshu.com/p/5f8ecbe4f6af" title="" target="">剖析golang interface实现</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go defer</title>
      <link href="2020/05/07/go/defer/"/>
      <url>2020/05/07/go/defer/</url>
      
        <content type="html"><![CDATA[<h2 id="栗子"><a href="#栗子" class="headerlink" title="栗子"></a>栗子</h2><h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>先进后出的栈，在return后倒序执行</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">func1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">func2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">func3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">CBA<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="作用于函数返回值参数"><a href="#作用于函数返回值参数" class="headerlink" title="作用于函数返回值参数"></a>作用于函数返回值参数</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">returnWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>t <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 1. t = 0</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        t <span class="token operator">=</span> t <span class="token operator">*</span> <span class="token number">10</span> <span class="token comment">// 3. t= 1*10</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">1</span> <span class="token comment">// 2. t = 1</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">returnWithDefer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token number">10</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="panic和recover执行顺序"><a href="#panic和recover执行顺序" class="headerlink" title="panic和recover执行顺序"></a>panic和recover执行顺序</h3><p>根据出栈顺序先执行defer后输出panic，如不捕获panic直接异常退出</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token punctuation">(</span>    <span class="token string">"fmt"</span><span class="token punctuation">)</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"main return"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer1 before panic, with recover"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer2 before panic, without recover"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"normal message before panic"</span><span class="token punctuation">)</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"panic message"</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"defer after panic is unreachable"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">normal message before <span class="token builtin">panic</span>defer2 before <span class="token builtin">panic</span><span class="token punctuation">,</span> without <span class="token builtin">recover</span>defer1 before <span class="token builtin">panic</span><span class="token punctuation">,</span> with <span class="token builtin">recover</span><span class="token builtin">panic</span> messagemain <span class="token keyword">return</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="panic捕获顺序"><a href="#panic捕获顺序" class="headerlink" title="panic捕获顺序"></a>panic捕获顺序</h3><p>根据出栈顺序捕获最后一个panic</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> err <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"fatal"</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"defer1 panic message"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"defer2 panic message"</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"panic message"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">defer</span> <span class="token builtin">panic</span> message<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="参数包含子函数"><a href="#参数包含子函数" class="headerlink" title="参数包含子函数"></a>参数包含子函数</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">package</span> main<span class="token keyword">import</span> <span class="token string">"fmt"</span><span class="token keyword">func</span> <span class="token function">f</span><span class="token punctuation">(</span>src <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>dst <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>    dst <span class="token operator">=</span> src <span class="token operator">+</span> <span class="token string">"'"</span>    <span class="token keyword">return</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">"a"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token function">f</span><span class="token punctuation">(</span><span class="token string">"b"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-go" data-language="go"><code class="language-go">a <span class="token comment">// f(f("a"))入栈，执行f("a")结果作为参数传入f(f("a"))</span>b <span class="token comment">// f(f("b"))入栈，执行f("b")结果作为参数传入f(f("b"))</span>b<span class="token string">' // f(f("b")a'</span> <span class="token comment">// f(f("a")</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h2><p>defer在编译阶段转换为<code>runtime.deferproc</code>，创建defer函数并注册到原函数中，使用单向链表保存，新注册defer添加到链表头<br>原函数的exit中插入<code>runtime.deferreturn</code>，负责函数exit返回前执行链表中的defer函数<br>per-P保存本地defer池，sched保存全局defer池，一般defer创建每次先从本地取，若本地池空，从全局池取到本地填满一半，用完后返回池子。如果是大空间defer使用mallocgc新分配空间，用完释放空间，不返回池子。</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> _defer <span class="token keyword">struct</span> <span class="token punctuation">{</span>    siz     <span class="token builtin">int32</span> <span class="token comment">// 参数+返回</span>    sp        <span class="token builtin">uintptr</span>  <span class="token comment">// 栈指针</span>    pc        <span class="token builtin">uintptr</span>  <span class="token comment">// 返回地址</span>    fn        <span class="token operator">*</span>funcval <span class="token comment">// 传入函数</span>    _panic    <span class="token operator">*</span>_panic  <span class="token comment">// panic that is running defer</span>    link      <span class="token operator">*</span>_defer <span class="token comment">// 单向链表指针，指向下一个defer</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">deferproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token operator">...</span>    d <span class="token operator">:=</span> <span class="token function">newdefer</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span>    d<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn    d<span class="token punctuation">.</span>pc <span class="token operator">=</span> callerpc    d<span class="token punctuation">.</span>sp <span class="token operator">=</span> sp    <span class="token keyword">switch</span> siz <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token comment">// Do nothing.</span>    <span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">memmove</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    <span class="token function">return0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">newdefer</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">)</span> <span class="token operator">*</span>_defer <span class="token punctuation">{</span>    <span class="token keyword">var</span> d <span class="token operator">*</span>_defer    sc <span class="token operator">:=</span> <span class="token function">deferclass</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> sc <span class="token operator">&lt;</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>deferpool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 普通defer使用per-P本地池，如果为空从全局池取，取满到本地池一半的量</span>    <span class="token punctuation">}</span>    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token comment">// Allocate new defer+args.</span>        <span class="token function">systemstack</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            total <span class="token operator">:=</span> <span class="token function">roundupsize</span><span class="token punctuation">(</span><span class="token function">totaldefersize</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            d <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>_defer<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> deferType<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    d<span class="token punctuation">.</span>siz <span class="token operator">=</span> siz    d<span class="token punctuation">.</span>heap <span class="token operator">=</span> <span class="token boolean">true</span>    d<span class="token punctuation">.</span>link <span class="token operator">=</span> gp<span class="token punctuation">.</span>_defer    gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d    <span class="token keyword">return</span> d<span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">deferreturn</span><span class="token punctuation">(</span>arg0 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    d <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_defer    <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    sp <span class="token operator">:=</span> <span class="token function">getcallersp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> d<span class="token punctuation">.</span>sp <span class="token operator">!=</span> sp <span class="token punctuation">{</span> <span class="token comment">// 判断是否为caller注册的defer，用于函数返回</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    <span class="token keyword">switch</span> d<span class="token punctuation">.</span>siz <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token comment">// Do nothing.</span>    <span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">default</span><span class="token punctuation">:</span>        <span class="token function">memmove</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token punctuation">}</span>    fn <span class="token operator">:=</span> d<span class="token punctuation">.</span>fn    d<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token boolean">nil</span>    gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link    <span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>    <span class="token boolean">_</span> <span class="token operator">=</span> fn<span class="token punctuation">.</span>fn    <span class="token function">jmpdefer</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 实现defer循环</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">freedefer</span><span class="token punctuation">(</span>d <span class="token operator">*</span>_defer<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token operator">!</span>d<span class="token punctuation">.</span>heap <span class="token punctuation">{</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    sc <span class="token operator">:=</span> <span class="token function">deferclass</span><span class="token punctuation">(</span><span class="token function">uintptr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> sc <span class="token operator">&gt;=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">.</span>deferpool<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 大空间defer不返回池子中</span>        <span class="token keyword">return</span>    <span class="token punctuation">}</span>    pp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>m<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">cap</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 本地per-P的defer池子满，先放一半到全局defer池</span>    <span class="token punctuation">}</span>    <span class="token comment">// 清空d信息</span>    pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>pp<span class="token punctuation">.</span>deferpool<span class="token punctuation">[</span>sc<span class="token punctuation">]</span><span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token comment">// 加入本地池</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="嵌套defer"><a href="#嵌套defer" class="headerlink" title="嵌套defer"></a>嵌套defer</h3><ol><li>A的defer链表为A2-&gt;A1</li><li>A返回前，A2.sp==sp of A，将A2从链表删除，同时执行A2的函数<code>_ = fn.fn</code>，<br>链表变为B2-&gt;B1-&gt;A1，执行<code>jmpdefer</code>跳转到A2</li><li>A2返回前，B2.s==sp of A2，将B2从链表删除，链表变为B1-&gt;A1</li><li>A2返回前，B1.s==sp of A2，将B1从链表删除，链表变为A1</li><li>此时A1.sp!=sp of A2，退出A2 defer的deferreturn，A2执行结束</li><li>A返回前，A1.sp==sp of A，将A1从链表删除</li><li>A返回</li></ol><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">A</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token function">A1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">A2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">A2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">defer</span> <span class="token function">B1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">defer</span> <span class="token function">B2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="panic-recover"><a href="#panic-recover" class="headerlink" title="panic / recover"></a>panic / recover</h2><p>panic时，如果g有注册defer链表，使用<code>reflectcall</code>调用defer函数<br>若无recover，调用<code>fatalpanic</code>终止程序<br>若有recover，通过设置<strong>recovered</strong>字段标示，最后调用<code>recovery</code>恢复程序执行</p><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">type</span> _panic <span class="token keyword">struct</span> <span class="token punctuation">{</span>  argp unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// defer函数指针</span>  arg <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// panic参数</span>  link <span class="token operator">*</span>_panic <span class="token comment">// panic的单向链表指针</span>  pc <span class="token builtin">uintptr</span>  sp unsafe<span class="token punctuation">.</span>Pointer  recovered <span class="token builtin">bool</span> <span class="token comment">// recover标示</span>  aborted <span class="token builtin">bool</span>  goexit <span class="token builtin">bool</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">gopanic</span><span class="token punctuation">(</span>e <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">var</span> p _panic    p<span class="token punctuation">.</span>arg <span class="token operator">=</span> e    p<span class="token punctuation">.</span>link <span class="token operator">=</span> gp<span class="token punctuation">.</span>_panic    gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>_panic<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">noescape</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> <span class="token punctuation">{</span>        d <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_defer        <span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>            <span class="token keyword">break</span>        <span class="token punctuation">}</span>        <span class="token comment">// 执行reflectcall调用注册的defer函数</span>        <span class="token keyword">if</span> d<span class="token punctuation">.</span>openDefer <span class="token punctuation">{</span>            done <span class="token operator">=</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> d<span class="token punctuation">)</span>            <span class="token keyword">if</span> done <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>d<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>recovered <span class="token punctuation">{</span>                <span class="token function">addOneOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            p<span class="token punctuation">.</span>argp <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token function">getargp</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token function">reflectcall</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> p<span class="token punctuation">.</span>recovered <span class="token punctuation">{</span>            gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> p<span class="token punctuation">.</span>link            <span class="token keyword">for</span> gp<span class="token punctuation">.</span>_panic <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> gp<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>aborted <span class="token punctuation">{</span>                gp<span class="token punctuation">.</span>_panic <span class="token operator">=</span> gp<span class="token punctuation">.</span>_panic<span class="token punctuation">.</span>link            <span class="token punctuation">}</span>            <span class="token keyword">if</span> gp<span class="token punctuation">.</span>_panic <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// must be done with signal</span>                gp<span class="token punctuation">.</span>sig <span class="token operator">=</span> <span class="token number">0</span>            <span class="token punctuation">}</span>            gp<span class="token punctuation">.</span>sigcode0 <span class="token operator">=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>sp<span class="token punctuation">)</span>            gp<span class="token punctuation">.</span>sigcode1 <span class="token operator">=</span> pc            <span class="token function">mcall</span><span class="token punctuation">(</span>recovery<span class="token punctuation">)</span> <span class="token comment">// 调用recovery恢复程序</span>            <span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"recovery failed"</span><span class="token punctuation">)</span> <span class="token comment">// mcall should not return</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">preprintpanics</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>_panic<span class="token punctuation">)</span>    <span class="token function">fatalpanic</span><span class="token punctuation">(</span>gp<span class="token punctuation">.</span>_panic<span class="token punctuation">)</span> <span class="token comment">// 终止程序</span>    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span>      <span class="token comment">// not reached</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">gorecover</span><span class="token punctuation">(</span>argp <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>    gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    p <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_panic    <span class="token keyword">if</span> p <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>goexit <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>p<span class="token punctuation">.</span>recovered <span class="token operator">&amp;&amp;</span> argp <span class="token operator">==</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>argp<span class="token punctuation">)</span> <span class="token punctuation">{</span>        p<span class="token punctuation">.</span>recovered <span class="token operator">=</span> <span class="token boolean">true</span>        <span class="token keyword">return</span> p<span class="token punctuation">.</span>arg    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token keyword">func</span> <span class="token function">recovery</span><span class="token punctuation">(</span>gp <span class="token operator">*</span>g<span class="token punctuation">)</span> <span class="token punctuation">{</span>    sp <span class="token operator">:=</span> gp<span class="token punctuation">.</span>sigcode0    pc <span class="token operator">:=</span> gp<span class="token punctuation">.</span>sigcode1    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>sp <span class="token operator">=</span> sp    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>pc <span class="token operator">=</span> pc    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>lr <span class="token operator">=</span> <span class="token number">0</span>    gp<span class="token punctuation">.</span>sched<span class="token punctuation">.</span>ret <span class="token operator">=</span> <span class="token number">1</span>    <span class="token function">gogo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gp<span class="token punctuation">.</span>sched<span class="token punctuation">)</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/115472856" title="" target="">Golang中的Defer必掌握的7知识点</a></li><li><a href="https://www.bilibili.com/video/BV1E5411x7NC" title="" target="">defer1.12</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>dlv调试</title>
      <link href="2020/05/05/go/dlv/"/>
      <url>2020/05/05/go/dlv/</url>
      
        <content type="html"><![CDATA[<h2 id="dlv安装"><a href="#dlv安装" class="headerlink" title="dlv安装"></a>dlv安装</h2><p><a href="https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md">https://github.com/go-delve/delve/blob/master/Documentation/installation/osx/install.md</a></p><p>使用<code>make install</code>安装</p><h2 id="vscode调试"><a href="#vscode调试" class="headerlink" title="vscode调试"></a>vscode调试</h2><p><a href="https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code">https://github.com/Microsoft/vscode-go/wiki/Debugging-Go-code-using-VS-Code</a></p>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>go module</title>
      <link href="2020/05/04/go/modules/"/>
      <url>2020/05/04/go/modules/</url>
      
        <content type="html"><![CDATA[<h2 id="go-module"><a href="#go-module" class="headerlink" title="go_module"></a>go_module</h2><h3 id="1-11之前"><a href="#1-11之前" class="headerlink" title="1.11之前"></a>1.11之前</h3><ul><li>依赖<code>$GOPATH</code></li><li>版本使用克隆时分支代码</li><li>采用 vendor手动版本管理 / godep锁定版本管理</li></ul><h3 id="最小化版本选择-MVS-Minimal-Version-Selection"><a href="#最小化版本选择-MVS-Minimal-Version-Selection" class="headerlink" title="最小化版本选择 MVS(Minimal Version Selection)"></a>最小化版本选择 MVS(Minimal Version Selection)</h3><img src="/2020/05/04/go/modules/go-modules-mvs-1.png" class=""><ol><li>godep会选择D的1.X.X最新最大版本，在语义版本化和遵守社会契约的前提下可以正常工作。</li><li>go会选择最小版本：</li></ol><ul><li>A -&gt; D v1.0.6</li><li>A+B -&gt; D v1.2.0</li><li>A+B+C -&gt; D v1.3.2</li></ul><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol><li>go.mod文件，它与package.json或Pipfile文件的功能类似。</li><li>验证文件go.sum。</li><li>不再有GOPATH限制。模块可以位于任何路径中。</li></ol><h3 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h3><pre class="line-numbers language-go" data-language="go"><code class="language-go"><span class="token keyword">go</span> mod init github<span class="token punctuation">.</span>com<span class="token operator">/</span>username<span class="token operator">/</span>repository<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h3 id="升级依赖关系，默认最小化升级"><a href="#升级依赖关系，默认最小化升级" class="headerlink" title="升级依赖关系，默认最小化升级"></a>升级依赖关系，默认最小化升级</h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ go get -t -d -v ./...<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><blockquote><p>-t flag：考虑构建测试所需的module。<br>-d flag：下载每个module的源代码，但不要构建或安装它们。<br>-v flag：提供详细输出。<br>./… ：在整个源代码树中执行这些操作，并且仅更新所需的依赖项。<br>-u flag 最新最大升级，通常不使用</p></blockquote><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><h4 id="列出软件包的可用版本"><a href="#列出软件包的可用版本" class="headerlink" title="列出软件包的可用版本"></a>列出软件包的可用版本</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ go list -m -versions github.com/getsentry/raven-gogithub.com/getsentry/raven-go v0.1.0 v0.1.1 v0.1.2 v0.2.0<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h4><p>添加依赖项是隐式的。在代码中导入依赖项后，运行go build或go test命令将获取模块的最新版本并将其添加到go.mod文件中。<br>如果要显式添加依赖项，请运行go get github.com/username/repository。</p><h4 id="依赖项的升级-降级"><a href="#依赖项的升级-降级" class="headerlink" title="依赖项的升级/降级"></a>依赖项的升级/降级</h4><p>go get github.com/username/repository@vx.x.x下载并设置依赖项和更新go.mod文件的特定版本</p><h4 id="mod命令"><a href="#mod命令" class="headerlink" title="mod命令"></a>mod命令</h4><ul><li>go mod init：生成 go.mod 文件</li><li>go mod download : 下载 go.mod 文件中指明的所有依赖</li><li>go mod tidy: 整理现有的依赖</li><li>go mod graph: 查看现有的依赖结构</li><li>go mod edit : 编辑 go.mod 文件</li><li>go mod vendor : 导出项目所有的依赖到vendor目录</li><li>go mod verify: 校验一个模块是否被篡改过</li><li>go mod why : 查看为什么需要依赖某模块</li></ul><h3 id="GOPROXY"><a href="#GOPROXY" class="headerlink" title="GOPROXY"></a>GOPROXY</h3><ul><li><p>阿里云<br><a href="https://mirrors.aliyun.com/goproxy/">https://mirrors.aliyun.com/goproxy/</a></p></li><li><p>七牛云<br>goproxy.cn,direct</p></li></ul><p>设置：<br><code>$ go env -w GOPROXY=https://goproxy.cn,direct</code><br>direct用于proxy代理返404后回源到源地址</p><h3 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h3><p>GOOS=linux GOARCH=amd64 go build</p><h2 id="node-module"><a href="#node-module" class="headerlink" title="node_module"></a>node_module</h2><h3 id="依赖黑洞"><a href="#依赖黑洞" class="headerlink" title="依赖黑洞"></a>依赖黑洞</h3><p>项目依赖A和C，A和C依赖不同版本的B</p><img src="/2020/05/04/go/modules/npm_v0.jpg" class=""><img src="/2020/05/04/go/modules/npm_v1.jpg" class=""><p>考虑两个问题：</p><ol><li>B的次要版本可以共存，并且没有副作用。但node有js全局污染可能。</li><li>B的次要版本可以共存，如何保证A和C正确加载<code>B v2.0</code></li></ol><h3 id="npm解决方式"><a href="#npm解决方式" class="headerlink" title="npm解决方式"></a>npm解决方式</h3><p>递归向上查找node_modules里的package，如果在 ‘/home/my/projects/foo.js’ 文件里调用了 require(‘bar.js’)，则 Node.js 会按以下顺序查找：</p><ul><li>/home/my/projects/node_modules/bar.js</li><li>/home/my/node_modules/bar.js</li><li>/home/node_modules/bar.js</li><li>/node_modules/bar.js</li></ul><p>算法核心</p><ul><li>优先读取最近的node_modules的依赖</li><li>递归向上查找node_modules依赖</li></ul><p>假设D也依赖<code>B v2.0</code>，node_modules结构如下</p><img src="/2020/05/04/go/modules/npm_v1.1.jpg" class=""><p> 相同的<code>B v2.0</code>被依赖了两次，在node中lodash等公用插件会造成极大空间浪费</p><p>利用<code>递归向上</code>特性，将公共库放在顶层</p><img src="/2020/05/04/go/modules/npm_v3.jpg" class=""><p>若B和E依赖<code>B v1.0</code>，C和D依赖<code>B v2.0</code>，问题依旧存在</p><img src="/2020/05/04/go/modules/npm_v3.1.jpg" class=""><h3 id="幻依赖"><a href="#幻依赖" class="headerlink" title="幻依赖"></a>幻依赖</h3><img src="/2020/05/04/go/modules/Phantom_1.jpg" class=""><img src="/2020/05/04/go/modules/Phantom_2.jpg" class=""><p>glob和brace-expansion都不在depdencies里，但是我们开发和运行时都可以正常工作（因为这个是rimraf的依赖），一旦将该库发布，因为用户安装我们的库的时候并不会安装库的devDepdency，这导致在用户的地方会运行报错。</p><h3 id="yarn-lock-vs-npm-lock"><a href="#yarn-lock-vs-npm-lock" class="headerlink" title="yarn lock vs npm lock"></a>yarn lock vs npm lock</h3><img src="/2020/05/04/go/modules/package.jpg" class=""><img src="/2020/05/04/go/modules/yarn.jpg" class=""><p>通过lock开发版本在生产复现环境。但无法规避npm全局cli。</p><h3 id="库里应该提交lock文件吗"><a href="#库里应该提交lock文件吗" class="headerlink" title="库里应该提交lock文件吗"></a>库里应该提交lock文件吗</h3><p>应该。可以很大程度避免环境差异。</p><h3 id="确定性"><a href="#确定性" class="headerlink" title="确定性"></a>确定性</h3><img src="/2020/05/04/go/modules/yarn.lock.jpg" class=""><p>yarn.lock仅提供版本确定性，无法保证node_modules拓扑，如下两种拓扑都是合理的</p><p>第一种</p><img src="/2020/05/04/go/modules/topo1.jpg" class=""><p>第二种</p><img src="/2020/05/04/go/modules/topo2.jpg" class=""><p>npm的lock包含拓扑信息</p><img src="/2020/05/04/go/modules/npm_topo.jpg" class=""><h3 id="PNPM"><a href="#PNPM" class="headerlink" title="PNPM"></a>PNPM</h3><p>npm和yarn通过文件目录和node resolve算法模拟的实际上是有向无环图的一个超集（多出了很多错误祖先节点和兄弟节点之间的链接），这导致了很多的问题，所以我们需要更加接近DAG的模拟。pnpm正是采取了这种解决方式，通过更加精确的模拟DAG来解决yarn和npm代理的问题。</p><p>npm的结构</p><img src="/2020/05/04/go/modules/npm_arch.jpg" class=""><p>代码可以使用<code>express</code>引入的<code>debug</code>模块，即使没有显式的引入</p><img src="/2020/05/04/go/modules/pnpm_package.jpg" class=""><pre class="line-numbers language-js" data-language="js"><code class="language-js"><span class="token comment">// src/index.js</span><span class="token keyword">const</span> debug <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'debug'</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>pnpm的结构</p><img src="/2020/05/04/go/modules/pnpm_arch.jpg" class=""><p>顶层已没有<code>debug</code>模块，因此代码里不会错误的引用</p><h3 id="pnpm-vs-yarn"><a href="#pnpm-vs-yarn" class="headerlink" title="pnpm vs yarn"></a>pnpm vs yarn</h3><pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token comment">// package.json</span><span class="token punctuation">{</span>  <span class="token property">"dependencies"</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token property">"debug"</span><span class="token operator">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span>    <span class="token property">"express"</span><span class="token operator">:</span> <span class="token string">"4.0.0"</span><span class="token punctuation">,</span>    <span class="token property">"koa"</span><span class="token operator">:</span> <span class="token string">"^2.11.0"</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-js" data-language="js"><code class="language-js">dependencies<span class="token operator">:</span>debug <span class="token number">3.1</span><span class="token number">.0</span>express <span class="token number">4.0</span><span class="token number">.0</span>├── debug <span class="token number">0.8</span><span class="token number">.1</span>├─┬ send <span class="token number">0.2</span><span class="token number">.0</span>│ └── debug <span class="token number">1.0</span><span class="token number">.5</span>└─┬ serve<span class="token operator">-</span><span class="token keyword">static</span> <span class="token number">1.0</span><span class="token number">.1</span>  └─┬ send <span class="token number">0.1</span><span class="token number">.4</span>    └── debug <span class="token number">1.0</span><span class="token number">.5</span>koa <span class="token number">2.11</span><span class="token number">.0</span>└── debug <span class="token number">3.1</span><span class="token number">.0</span><span class="token operator">%</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>yarn放在不同层级，依赖递归查找算法来选择版本</p><img src="/2020/05/04/go/modules/pnpm_module.jpg" class=""><p>pnpm将不同版本放在同一层级里通过软链选择加载版本，彻底避免了包重复问题，节省大量时间和空间</p><img src="/2020/05/04/go/modules/monorepo_sample.jpg" class=""><h2 id="TODO-mvn"><a href="#TODO-mvn" class="headerlink" title="TODO mvn"></a>TODO mvn</h2><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul><li><a href="https://semver.org/lang/zh-CN/" title="" target="">语义化版本</a></li><li><a href="https://zhuanlan.zhihu.com/p/137535779" title="" target="">知乎 - node_modules 困境</a></li><li><a href="https://tonybai.com/2019/09/21/brief-history-of-go-package-management/" title="" target="">Go语言包管理简史</a></li><li><a href="https://tonybai.com/2019/12/21/go-modules-minimal-version-selection/" title="" target="">Go modules：最小版本选择</a></li><li><a href="https://zhuanlan.zhihu.com/p/41627929" title="" target="">关于Go Module的争吵</a></li><li><a href="https://research.swtch.com/vgo-principles" title="" target="">The Principles of Versioning in Go</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>数据库测试</title>
      <link href="2020/04/30/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/"/>
      <url>2020/04/30/mysql/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<h2 id="mysql"><a href="#mysql" class="headerlink" title="mysql"></a>mysql</h2><h3 id="版本5-7"><a href="#版本5-7" class="headerlink" title="版本5.7"></a>版本5.7</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-----------+</span><span class="token operator">|</span> version<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+</span><span class="token operator">|</span> <span class="token number">5.7</span><span class="token number">.29</span>    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="范围查询包含非key字段"><a href="#范围查询包含非key字段" class="headerlink" title="范围查询包含非key字段"></a>范围查询包含非key字段</h3><h4 id="1个字符，4000W"><a href="#1个字符，4000W" class="headerlink" title="1个字符，4000W"></a>1个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">1</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">5</span> min <span class="token number">19.25</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="90-范围查询，带text字段，不走索引"><a href="#90-范围查询，带text字段，不走索引" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41863640</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.13</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-范围查询，带text字段，不走索引"><a href="#10-范围查询，带text字段，不走索引" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41863640</span> <span class="token operator">|</span>    <span class="token number">19.10</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.12</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="树高度"><a href="#树高度" class="headerlink" title="树高度"></a>树高度</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">SELECT</span> b<span class="token punctuation">.</span>name<span class="token punctuation">,</span> a<span class="token punctuation">.</span>name<span class="token punctuation">,</span> index_id<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">,</span> a<span class="token punctuation">.</span>space<span class="token punctuation">,</span> a<span class="token punctuation">.</span>PAGE_NO <span class="token keyword">FROM</span> information_schema<span class="token punctuation">.</span>INNODB_SYS_INDEXES a<span class="token punctuation">,</span> information_schema<span class="token punctuation">.</span>INNODB_SYS_TABLES b <span class="token keyword">WHERE</span> a<span class="token punctuation">.</span>table_id <span class="token operator">=</span> b<span class="token punctuation">.</span>table_id <span class="token operator">AND</span> a<span class="token punctuation">.</span>space <span class="token operator">&lt;&gt;</span> <span class="token number">0</span> <span class="token operator">and</span> b<span class="token punctuation">.</span>name<span class="token operator">=</span><span class="token string">'test/test'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span><span class="token operator">|</span> name      <span class="token operator">|</span> name    <span class="token operator">|</span> index_id <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> space <span class="token operator">|</span> PAGE_NO <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span><span class="token operator">|</span> test<span class="token operator">/</span>test <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span>       <span class="token number">93</span> <span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">60</span> <span class="token operator">|</span>       <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">|</span> test<span class="token operator">/</span>test <span class="token operator">|</span> uk1     <span class="token operator">|</span>       <span class="token number">94</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">60</span> <span class="token operator">|</span>       <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------+----------+------+-------+---------+</span><span class="token number">2</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.08</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">// 主键 3*16384+64，level为0x02，高度为3$ hexdump -s 49216 -n 10 test.ibd000c040 00 02 00 00 00 00 00 00 00 5d000c04a// uk1 4*16384+64，level为0x02，高度为3$ hexdump -s 65600 -n 10 test.ibd0010040 00 02 00 00 00 00 00 00 00 5e001004a<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="5个字符，4000W"><a href="#5个字符，4000W" class="headerlink" title="5个字符，4000W"></a>5个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>            <span class="token number">5</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">4</span> min <span class="token number">55.59</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="90-范围查询，带text字段，不走索引-1"><a href="#90-范围查询，带text字段，不走索引-1" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41853552</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.03</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-范围查询，带text字段，不走索引-1"><a href="#10-范围查询，带text字段，不走索引-1" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> id<span class="token punctuation">,</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41853552</span> <span class="token operator">|</span>    <span class="token number">19.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="200个字符，4000W"><a href="#200个字符，4000W" class="headerlink" title="200个字符，4000W"></a>200个字符，4000W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>  <span class="token number">4194304</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">6</span> min <span class="token number">58.89</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="90-范围查询，带text字段，不走索引-2"><a href="#90-范围查询，带text字段，不走索引-2" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41342675</span> <span class="token operator">|</span>    <span class="token number">50.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="90-范围查询，仅查询索引字段或count-计数，走索引"><a href="#90-范围查询，仅查询索引字段或count-计数，走索引" class="headerlink" title="90%范围查询，仅查询索引字段或count(*)计数，走索引"></a>90%范围查询，仅查询索引字段或count(*)计数，走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+----------+----------+--------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-范围查询，带text字段，不走索引-2"><a href="#10-范围查询，带text字段，不走索引-2" class="headerlink" title="10%范围查询，带text字段，不走索引"></a>10%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41342675</span> <span class="token operator">|</span>    <span class="token number">19.34</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="主键查询固定走索引"><a href="#主键查询固定走索引" class="headerlink" title="主键查询固定走索引"></a>主键查询固定走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> id <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>     <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>       <span class="token operator">|</span> <span class="token keyword">PRIMARY</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">20671337</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+---------+---------+------+----------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.02</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="200个字符，1W"><a href="#200个字符，1W" class="headerlink" title="200个字符，1W"></a>200个字符，1W</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token keyword">date</span><span class="token punctuation">,</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> length<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span>          <span class="token number">200</span> <span class="token operator">|</span>     <span class="token number">1024</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------------+--------------+----------+</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.11</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="90-范围查询，带text字段，不走索引-3"><a href="#90-范围查询，带text字段，不走索引-3" class="headerlink" title="90%范围查询，带text字段，不走索引"></a>90%范围查询，带text字段，不走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/10 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">10140</span> <span class="token operator">|</span>    <span class="token number">90.89</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+-------+----------+-------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="10-范围查询，带text字段，走索引"><a href="#10-范围查询，带text字段，走索引" class="headerlink" title="10%范围查询，带text字段，走索引"></a>10%范围查询，带text字段，走索引</h5><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">'2020/04/01 00:00:00'</span> <span class="token operator">and</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'2020/04/02 00:00:00'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span> <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> uk1           <span class="token operator">|</span> uk1  <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">1024</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-----------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="200个字符，4000W，耗时比较"><a href="#200个字符，4000W，耗时比较" class="headerlink" title="200个字符，4000W，耗时比较"></a>200个字符，4000W，耗时比较</h4><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">$ time mysql test -e "select * from test where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'" &gt; /dev/nullreal 2m54.656suser 1m4.118ssys 0m4.271s$ time mysql test -e "select * from test force index(uk1) where date &gt;= '2020/04/01 00:00:00' and date &lt; '2020/04/02 00:00:00'" &gt; /dev/nullreal 1m43.517suser 0m59.562ssys 0m3.959s<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                                                                                                                                                                                                            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk1<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">42990946</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">'2020/04/01'</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- insert into test values(1,'2020/04/01', repeat('a', 5));</span><span class="token comment">-- insert into test values(1,'2020/04/01', repeat('a', 200));</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/01'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="autoincrement-uuid-insert速度比较"><a href="#autoincrement-uuid-insert速度比较" class="headerlink" title="autoincrement / uuid  insert速度比较"></a>autoincrement / uuid  insert速度比较</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> test02<span class="token punctuation">(</span>id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span><span class="token keyword">date</span> <span class="token keyword">timestamp</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token keyword">default</span> <span class="token keyword">current_timestamp</span> <span class="token keyword">on</span> <span class="token keyword">update</span> <span class="token keyword">current_timestamp</span><span class="token punctuation">,</span>name <span class="token keyword">text</span><span class="token punctuation">,</span><span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">key</span> uk1 <span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">innodb</span> <span class="token keyword">default</span> <span class="token keyword">charset</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token number">1048577</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test01<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/15'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1048577</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">12.73</span> sec<span class="token punctuation">)</span>Records: <span class="token number">1048577</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token number">1048577</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test02<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'2020/04/15'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1048576</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">17.31</span> sec<span class="token punctuation">)</span>Records: <span class="token number">1048576</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token number">16777232</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test01<span class="token punctuation">(</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token string">'2020/04/30'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test01 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">16777232</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">4</span> min <span class="token number">11.18</span> sec<span class="token punctuation">)</span>Records: <span class="token number">16777232</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token number">16777216</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test02<span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">date</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span> <span class="token keyword">select</span> <span class="token keyword">replace</span><span class="token punctuation">(</span>uuid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'-'</span><span class="token punctuation">,</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">'2020/04/30'</span><span class="token punctuation">,</span>name <span class="token keyword">from</span> test02 <span class="token keyword">where</span> <span class="token keyword">date</span><span class="token operator">=</span><span class="token string">'2020/04/01'</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">16777216</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">5</span> min <span class="token number">41.65</span> sec<span class="token punctuation">)</span>Records: <span class="token number">16777216</span>  Duplicates: <span class="token number">0</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="view"><a href="#view" class="headerlink" title="view"></a>view</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span>  <span class="token number">1048576</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.29</span> sec<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">from</span> test_view<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token operator">|</span> <span class="token number">10485760</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----------+</span><span class="token number">1</span> <span class="token keyword">row</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">34.62</span> sec<span class="token punctuation">)</span><span class="token keyword">explain</span> <span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span>  test_view <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">500</span> <span class="token operator">and</span> id2 <span class="token operator">between</span> <span class="token number">700</span> <span class="token operator">and</span> <span class="token number">710</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span>   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">104695</span> <span class="token operator">|</span>    <span class="token number">11.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> test01     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1047386</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test02     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test03     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test04     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test05     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test06     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test07     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test08     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test09     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test10     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>        <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+------+---------------+-------------+---------+-------+---------+----------+-------------+</span><span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span class="token keyword">explain</span> <span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span>  test_view_pk <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">500</span> <span class="token operator">and</span> id2 <span class="token operator">between</span> <span class="token number">700</span> <span class="token operator">and</span> <span class="token number">710</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>      <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>         <span class="token operator">|</span> key_len <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token keyword">rows</span>    <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token operator">&lt;</span>derived2<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> ref   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span>   <span class="token operator">|</span> <span class="token operator">&lt;</span>auto_key0<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> const <span class="token operator">|</span>  <span class="token number">104695</span> <span class="token operator">|</span>    <span class="token number">11.11</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span> DERIVED     <span class="token operator">|</span> test01     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1047386</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test02     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test03     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">5</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test04     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">6</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test05     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">7</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test06     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test07     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">9</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test08     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test09     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">11</span> <span class="token operator">|</span> <span class="token keyword">UNION</span>       <span class="token operator">|</span> test10     <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>     <span class="token operator">|</span> <span class="token number">8</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span>  <span class="token operator">|</span> <span class="token number">1046904</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span>              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+------------+------------+-------+---------------+-------------+---------+-------+---------+----------+--------------------------+</span><span class="token number">11</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span><span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="语句-1"><a href="#语句-1" class="headerlink" title="语句"></a>语句</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test01<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id1<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>id2<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name1<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name2<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id1<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>id2<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span><span class="token comment">-- test02 -- test10</span><span class="token keyword">create</span> <span class="token keyword">view</span> test_view <span class="token keyword">as</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test02<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test03<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test04<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test05<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test06<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test07<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test08<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test09<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test10<span class="token keyword">create</span> <span class="token keyword">view</span> test_view_pk <span class="token keyword">as</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test01<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test02<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test03<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test04<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test05<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test06<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test07<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test08<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test09<span class="token keyword">union</span> <span class="token keyword">all</span><span class="token keyword">select</span> id1<span class="token punctuation">,</span> id2 <span class="token keyword">from</span> test10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">#!/bin/bashfor i in {1..1024}do    s=""    for j in {1..1024}    do        s+="($i, $j, 'a', 'b')"        s+=","    done    mysql test -e "insert into test01 values${s%,}" &amp;donewait<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test02 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test10 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><h3 id="binlog-row-image"><a href="#binlog-row-image" class="headerlink" title="binlog_row_image"></a>binlog_row_image</h3><p>full： before image和after image都为全量字段<br>minimal： before image仅用于区分记录字段(主键等)，after image仅语句指定字段(更新字段)</p><h4 id="create-table"><a href="#create-table" class="headerlink" title="create table"></a>create table</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>c1<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>c2<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>s1<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>s2<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>c1<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span>c2<span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="full"><a href="#full" class="headerlink" title="full"></a>full</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a1'</span><span class="token punctuation">,</span> <span class="token string">'b1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">### INSERT INTO `test`.`test`</span><span class="token comment">### SET</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">### DELETE FROM `test`.`test`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token keyword">update</span> test00 <span class="token keyword">set</span> s2<span class="token operator">=</span><span class="token string">'c123'</span> <span class="token keyword">where</span> s1<span class="token operator">=</span><span class="token string">'a1'</span><span class="token punctuation">;</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b3' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @1=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a1' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='c123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="minimal"><a href="#minimal" class="headerlink" title="minimal"></a>minimal</h4><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> test <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'a2'</span><span class="token punctuation">,</span> <span class="token string">'b2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">### INSERT INTO `test`.`test`</span><span class="token comment">### SET</span><span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @3='a2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">###   @4='b2' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">### DELETE FROM `test`.`test`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token keyword">update</span> test00 <span class="token keyword">set</span> s2<span class="token operator">=</span><span class="token string">'d123'</span> <span class="token keyword">where</span> s1<span class="token operator">=</span><span class="token string">'a2'</span><span class="token punctuation">;</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=1 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span class="token comment">### UPDATE `mysqltt`.`test00`</span><span class="token comment">### WHERE</span><span class="token comment">###   @1=2 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">###   @2=3 /* INT meta=0 nullable=0 is_null=0 */</span><span class="token comment">### SET</span><span class="token comment">###   @4='d123' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="使用备份idb快速恢复历史数据"><a href="#使用备份idb快速恢复历史数据" class="headerlink" title="使用备份idb快速恢复历史数据"></a>使用备份idb快速恢复历史数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">45.11</span> sec<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span>ERROR <span class="token number">1814</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Tablespace</span> has been discarded <span class="token keyword">for</span> <span class="token keyword">table</span> <span class="token string">'test'</span>flush <span class="token keyword">table</span> test <span class="token keyword">for</span> export<span class="token punctuation">;</span>scp <span class="token operator">/</span>backup_node<span class="token operator">/</span>path_to_dat<span class="token operator">/</span>test<span class="token punctuation">.</span>ibd <span class="token operator">/</span>recover_node<span class="token operator">/</span>path_to_dat<span class="token operator">/</span><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected<span class="token punctuation">,</span> <span class="token number">1</span> warning <span class="token punctuation">(</span><span class="token number">18.73</span> sec<span class="token punctuation">)</span><span class="token keyword">show</span> <span class="token keyword">full</span> processlist<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span><span class="token operator">|</span> Id <span class="token operator">|</span> <span class="token keyword">User</span> <span class="token operator">|</span> Host      <span class="token operator">|</span> db   <span class="token operator">|</span> Command <span class="token operator">|</span> <span class="token keyword">Time</span> <span class="token operator">|</span> State       <span class="token operator">|</span> Info                               <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span><span class="token operator">|</span>  <span class="token number">8</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> test <span class="token operator">|</span> Query   <span class="token operator">|</span>   <span class="token number">16</span> <span class="token operator">|</span> System <span class="token keyword">lock</span> <span class="token operator">|</span> <span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span> <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">12</span> <span class="token operator">|</span> root <span class="token operator">|</span> localhost <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> Query   <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span> <span class="token keyword">starting</span>    <span class="token operator">|</span> <span class="token keyword">show</span> <span class="token keyword">full</span> processlist              <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+------+-----------+------+---------+------+-------------+------------------------------------+</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span><span class="token operator">|</span> id <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span> name  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span> aaaaa <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+---------------------+-------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="锁等待"><a href="#锁等待" class="headerlink" title="锁等待"></a>锁等待</h3><ul><li><code>show engine innodb status</code>看死锁/锁等待</li><li><code>information_schema.innodb_locks</code>和<code>information_schema.innodb_lock_waits</code>看锁关系信息</li><li><code>performance_schema.events_statements_history</code>和<code>performance_schema.threads</code>看<code>show processlist</code>中pid执行历史语句</li><li><code>information_schema.innodb_trx</code>看当前执行中未提交事务</li></ul><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session1</span><span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session2</span><span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session3</span><span class="token keyword">show</span> <span class="token keyword">engine</span> <span class="token keyword">innodb</span> <span class="token keyword">status</span>\G<span class="token punctuation">;</span>LIST <span class="token keyword">OF</span> <span class="token keyword">TRANSACTIONS</span> <span class="token keyword">FOR</span> EACH <span class="token keyword">SESSION</span>:<span class="token comment">---TRANSACTION 281479529381440, not started</span><span class="token number">0</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token comment">---TRANSACTION 160786, ACTIVE 16 sec starting index read</span>mysql <span class="token keyword">tables</span> <span class="token operator">in</span> <span class="token keyword">use</span> <span class="token number">1</span><span class="token punctuation">,</span> locked <span class="token number">1</span><span class="token keyword">LOCK</span> WAIT <span class="token number">2</span> <span class="token keyword">lock</span> struct<span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> heap size <span class="token number">1136</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> <span class="token keyword">lock</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>MySQL thread id <span class="token number">2</span><span class="token punctuation">,</span> OS thread handle <span class="token number">123145348661248</span><span class="token punctuation">,</span> query id <span class="token number">74</span> localhost root updating<span class="token keyword">delete</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span><span class="token comment">------- TRX HAS BEEN WAITING 16 SEC FOR THIS LOCK TO BE GRANTED:</span>RECORD LOCKS space id <span class="token number">66</span> page <span class="token keyword">no</span> <span class="token number">4</span> n bits <span class="token number">552</span> <span class="token keyword">index</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">of</span> <span class="token keyword">table</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>test01<span class="token punctuation">`</span> trx id <span class="token number">160786</span> lock_mode X locks rec but <span class="token operator">not</span> gap waitingRecord <span class="token keyword">lock</span><span class="token punctuation">,</span> heap <span class="token keyword">no</span> <span class="token number">2</span> PHYSICAL RECORD: n_fields <span class="token number">6</span><span class="token punctuation">;</span> compact format<span class="token punctuation">;</span> info bits <span class="token number">32</span> <span class="token number">0</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token number">1</span>: len <span class="token number">4</span><span class="token punctuation">;</span> hex <span class="token number">80000001</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token number">2</span>: len <span class="token number">6</span><span class="token punctuation">;</span> hex <span class="token number">000000027411</span><span class="token punctuation">;</span> <span class="token keyword">asc</span>     t <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token number">3</span>: len <span class="token number">7</span><span class="token punctuation">;</span> hex <span class="token number">310000013</span>f2879<span class="token punctuation">;</span> <span class="token keyword">asc</span> <span class="token number">1</span>   ?<span class="token punctuation">(</span>y<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token number">4</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">61</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> a<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token number">5</span>: len <span class="token number">1</span><span class="token punctuation">;</span> hex <span class="token number">62</span><span class="token punctuation">;</span> <span class="token keyword">asc</span> b<span class="token punctuation">;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session4</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_lock_waits<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span><span class="token operator">|</span> requesting_trx_id <span class="token operator">|</span> requested_lock_id <span class="token operator">|</span> blocking_trx_id <span class="token operator">|</span> blocking_lock_id <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span><span class="token operator">|</span> <span class="token number">160787</span>            <span class="token operator">|</span> <span class="token number">160787</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span>     <span class="token operator">|</span> <span class="token number">160785</span>          <span class="token operator">|</span> <span class="token number">160785</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span>    <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------+-------------------+-----------------+------------------+</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_locks<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span><span class="token operator">|</span> lock_id       <span class="token operator">|</span> lock_trx_id <span class="token operator">|</span> lock_mode <span class="token operator">|</span> lock_type <span class="token operator">|</span> lock_table      <span class="token operator">|</span> lock_index <span class="token operator">|</span> lock_space <span class="token operator">|</span> lock_page <span class="token operator">|</span> lock_rec <span class="token operator">|</span> lock_data <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span><span class="token operator">|</span> <span class="token number">160787</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">160787</span>      <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>test01<span class="token punctuation">`</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">66</span> <span class="token operator">|</span>         <span class="token number">4</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">|</span> <span class="token number">160785</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">2</span> <span class="token operator">|</span> <span class="token number">160785</span>      <span class="token operator">|</span> X         <span class="token operator">|</span> RECORD    <span class="token operator">|</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>test01<span class="token punctuation">`</span> <span class="token operator">|</span> <span class="token keyword">PRIMARY</span>    <span class="token operator">|</span>         <span class="token number">66</span> <span class="token operator">|</span>         <span class="token number">4</span> <span class="token operator">|</span>        <span class="token number">2</span> <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span>      <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">---------------+-------------+-----------+-----------+-----------------+------------+------------+-----------+----------+-----------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session5</span><span class="token keyword">SELECT</span> THREAD_ID<span class="token punctuation">,</span>TIMER_START<span class="token punctuation">,</span>TIMER_END<span class="token punctuation">,</span>TIMER_WAIT<span class="token punctuation">,</span>SQL_TEXT<span class="token punctuation">,</span>MESSAGE_TEXT <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>events_statements_history <span class="token keyword">WHERE</span> thread_id <span class="token operator">=</span> <span class="token punctuation">(</span>     <span class="token keyword">SELECT</span> THREAD_ID <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>threads <span class="token keyword">WHERE</span> PROCESSLIST_ID <span class="token operator">=</span> <span class="token number">10</span> <span class="token punctuation">)</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">36</span> TIMER_START: <span class="token number">2048071080000000</span>   TIMER_END: <span class="token number">2048071201000000</span>  TIMER_WAIT: <span class="token number">121000000</span>    SQL_TEXT: <span class="token keyword">select</span> @<span class="token variable">@version_comment</span> <span class="token keyword">limit</span> <span class="token number">1</span>MESSAGE_TEXT: <span class="token boolean">NULL</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">36</span> TIMER_START: <span class="token number">2049834364000000</span>   TIMER_END: <span class="token number">2049834417000000</span>  TIMER_WAIT: <span class="token number">53000000</span>    SQL_TEXT: <span class="token keyword">begin</span>MESSAGE_TEXT: <span class="token boolean">NULL</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">3.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">36</span> TIMER_START: <span class="token number">2055696930000000</span>   TIMER_END: <span class="token number">2055730415000000</span>  TIMER_WAIT: <span class="token number">33485000000</span>    SQL_TEXT: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span>MESSAGE_TEXT: <span class="token boolean">NULL</span><span class="token keyword">SELECT</span> THREAD_ID<span class="token punctuation">,</span>TIMER_START<span class="token punctuation">,</span>TIMER_END<span class="token punctuation">,</span>TIMER_WAIT<span class="token punctuation">,</span>SQL_TEXT<span class="token punctuation">,</span>MESSAGE_TEXT <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>events_statements_history <span class="token keyword">WHERE</span> thread_id <span class="token operator">=</span> <span class="token punctuation">(</span>     <span class="token keyword">SELECT</span> THREAD_ID <span class="token keyword">FROM</span> performance_schema<span class="token punctuation">.</span>threads <span class="token keyword">WHERE</span> PROCESSLIST_ID <span class="token operator">=</span> <span class="token number">12</span> <span class="token punctuation">)</span>\G<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">38</span> TIMER_START: <span class="token number">2197004107000000</span>   TIMER_END: <span class="token number">2197008105000000</span>  TIMER_WAIT: <span class="token number">3998000000</span>    SQL_TEXT: <span class="token keyword">select</span> @<span class="token variable">@version_comment</span> <span class="token keyword">limit</span> <span class="token number">1</span>MESSAGE_TEXT: <span class="token boolean">NULL</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">38</span> TIMER_START: <span class="token number">2198577580000000</span>   TIMER_END: <span class="token number">2198577653000000</span>  TIMER_WAIT: <span class="token number">73000000</span>    SQL_TEXT: <span class="token keyword">begin</span>MESSAGE_TEXT: <span class="token boolean">NULL</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">3.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>   THREAD_ID: <span class="token number">38</span> TIMER_START: <span class="token number">2200660449000000</span>   TIMER_END: <span class="token number">2251869851000000</span>  TIMER_WAIT: <span class="token number">51209402000000</span>    SQL_TEXT: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">1</span>MESSAGE_TEXT: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment"># session 6</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> information_schema<span class="token punctuation">.</span>innodb_trx\G<span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>                    trx_id: <span class="token number">169733</span>                 trx_state: <span class="token keyword">LOCK</span> WAIT               trx_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">47</span>     trx_requested_lock_id: <span class="token number">169733</span>:<span class="token number">66</span>:<span class="token number">4</span>:<span class="token number">3</span>          trx_wait_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">47</span>                trx_weight: <span class="token number">2</span>       trx_mysql_thread_id: <span class="token number">3</span>                 trx_query: <span class="token keyword">delete</span> <span class="token keyword">from</span> test<span class="token punctuation">.</span>test01 <span class="token keyword">where</span> id1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> id2<span class="token operator">=</span><span class="token number">2</span>       trx_operation_state: <span class="token keyword">starting</span> <span class="token keyword">index</span> <span class="token keyword">read</span>         trx_tables_in_use: <span class="token number">1</span>         trx_tables_locked: <span class="token number">1</span>          trx_lock_structs: <span class="token number">2</span>     trx_lock_memory_bytes: <span class="token number">1136</span>           trx_rows_locked: <span class="token number">1</span>         trx_rows_modified: <span class="token number">0</span>   trx_concurrency_tickets: <span class="token number">0</span>       trx_isolation_level: <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span>         trx_unique_checks: <span class="token number">1</span>    trx_foreign_key_checks: <span class="token number">1</span>trx_last_foreign_key_error: <span class="token boolean">NULL</span> trx_adaptive_hash_latched: <span class="token number">0</span> trx_adaptive_hash_timeout: <span class="token number">0</span>          trx_is_read_only: <span class="token number">0</span>trx_autocommit_non_locking: <span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">2.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>                    trx_id: <span class="token number">169732</span>                 trx_state: RUNNING               trx_started: <span class="token number">2020</span><span class="token operator">-</span><span class="token number">07</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">23</span>:<span class="token number">09</span>:<span class="token number">32</span>     trx_requested_lock_id: <span class="token boolean">NULL</span>          trx_wait_started: <span class="token boolean">NULL</span>                trx_weight: <span class="token number">3</span>       trx_mysql_thread_id: <span class="token number">2</span>                 trx_query: <span class="token boolean">NULL</span>       trx_operation_state: <span class="token boolean">NULL</span>         trx_tables_in_use: <span class="token number">0</span>         trx_tables_locked: <span class="token number">1</span>          trx_lock_structs: <span class="token number">2</span>     trx_lock_memory_bytes: <span class="token number">1136</span>           trx_rows_locked: <span class="token number">1</span>         trx_rows_modified: <span class="token number">1</span>   trx_concurrency_tickets: <span class="token number">0</span>       trx_isolation_level: <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span>         trx_unique_checks: <span class="token number">1</span>    trx_foreign_key_checks: <span class="token number">1</span>trx_last_foreign_key_error: <span class="token boolean">NULL</span> trx_adaptive_hash_latched: <span class="token number">0</span> trx_adaptive_hash_timeout: <span class="token number">0</span>          trx_is_read_only: <span class="token number">0</span>trx_autocommit_non_locking: <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> test\G<span class="token punctuation">;</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span> <span class="token number">1.</span> <span class="token keyword">row</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>       <span class="token keyword">Table</span>: test<span class="token keyword">Create</span> <span class="token keyword">Table</span>: <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>test<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>  <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">text</span><span class="token punctuation">,</span>  <span class="token keyword">UNIQUE</span> <span class="token keyword">KEY</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token keyword">KEY</span> <span class="token punctuation">`</span>uk1<span class="token punctuation">`</span> <span class="token punctuation">(</span><span class="token punctuation">`</span><span class="token keyword">date</span><span class="token punctuation">`</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token operator">=</span><span class="token number">42990946</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">05</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">06</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">07</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">08</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">09</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">4194304</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">10</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token number">10</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">19.10</span> sec<span class="token punctuation">)</span><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test <span class="token keyword">where</span> <span class="token keyword">date</span> <span class="token operator">&lt;</span> <span class="token string">'20200402'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span> <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>     <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test  <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">ALL</span>  <span class="token operator">|</span> uk1           <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>    <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">41849498</span> <span class="token operator">|</span>    <span class="token number">19.87</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">where</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+------+---------------+------+---------+------+----------+----------+-------------+</span><span class="token comment">## 约束</span>ERROR <span class="token number">1503</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: A <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> must include <span class="token keyword">all</span> <span class="token keyword">columns</span> <span class="token operator">in</span> the <span class="token keyword">table</span><span class="token string">'s partitioning functiondu -sh test.ibd2.1G   test.ibdalter table test partition by range columns(date)(  partition p20200331 values less than ('</span><span class="token number">20200401</span><span class="token string">'),  partition p20200401 values less than ('</span><span class="token number">20200402</span><span class="token string">'),  partition p20200402 values less than ('</span><span class="token number">20200403</span><span class="token string">'),  partition p20200403 values less than ('</span><span class="token number">20200404</span><span class="token string">'),  partition p20200404 values less than ('</span><span class="token number">20200405</span><span class="token string">'),  partition p20200405 values less than ('</span><span class="token number">20200406</span><span class="token string">'),  partition p20200406 values less than ('</span><span class="token number">20200407</span><span class="token string">'),  partition p20200407 values less than ('</span><span class="token number">20200408</span><span class="token string">'),  partition p20200408 values less than ('</span><span class="token number">20200409</span><span class="token string">'),  partition p20200409 values less than ('</span><span class="token number">20200410</span><span class="token string">'),  partition p20200410 values less than ('</span><span class="token number">20200411</span><span class="token string">'));du -sh test*.ibd112Ktest#P#p20200331.ibd225Mtest#P#p20200401.ibd225Mtest#P#p20200402.ibd225Mtest#P#p20200403.ibd225Mtest#P#p20200404.ibd225Mtest#P#p20200405.ibd225Mtest#P#p20200406.ibd225Mtest#P#p20200407.ibd225Mtest#P#p20200408.ibd225Mtest#P#p20200409.ibd225Mtest#P#p20200410.ibd 44Mtest01.ibd 44Mtest02.ibd 44Mtest03.ibd 44Mtest04.ibd 44Mtest05.ibd 44Mtest06.ibd 44Mtest07.ibd 44Mtest08.ibd 44Mtest09.ibd 44Mtest10.ibdinsert into test(date,name) values('</span><span class="token number">20200430</span><span class="token string">', '</span>bbbbb'<span class="token punctuation">)</span><span class="token punctuation">;</span>ERROR <span class="token number">1526</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Table</span> has <span class="token keyword">no</span> <span class="token keyword">partition</span> <span class="token keyword">for</span> <span class="token keyword">value</span> <span class="token keyword">from</span> column_list<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="partition快速删除分区数据"><a href="#partition快速删除分区数据" class="headerlink" title="partition快速删除分区数据"></a>partition快速删除分区数据</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">date</span> <span class="token keyword">from</span> test <span class="token keyword">group</span> <span class="token keyword">by</span> <span class="token keyword">date</span> <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token keyword">date</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token operator">|</span> <span class="token function">count</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">date</span>                <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">31</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">01</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">02</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">03</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">|</span>   <span class="token number">1048576</span> <span class="token operator">|</span> <span class="token number">2020</span><span class="token operator">-</span><span class="token number">04</span><span class="token operator">-</span><span class="token number">04</span> <span class="token number">00</span>:<span class="token number">00</span>:<span class="token number">00</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-----------+---------------------+</span><span class="token comment">-- 阻塞DML，备份partition ibd物理文件</span>flush <span class="token keyword">table</span> test <span class="token keyword">for</span> export<span class="token punctuation">;</span><span class="token comment">-- discard</span><span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">discard</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span><span class="token comment">-- 拷贝回保留partition ibd文件，删除需要清理partition</span><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">drop</span> <span class="token keyword">partition</span> p20200331<span class="token punctuation">,</span>p20200401<span class="token punctuation">;</span><span class="token comment">-- import</span><span class="token keyword">alter</span> <span class="token keyword">table</span> test <span class="token keyword">import</span> <span class="token keyword">tablespace</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="MRR"><a href="#MRR" class="headerlink" title="MRR"></a>MRR</h3><blockquote><p>默认mrr_cost为on且代价非常高，直接关闭。<code>set @@optimizer_switch='mrr=on,mrr_cost_based=off'</code></p></blockquote><p>2级索引查询对主键排序后回表，磁盘接近顺序IO</p><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test01 <span class="token keyword">where</span> id2 <span class="token operator">&gt;</span> <span class="token number">10</span> <span class="token operator">and</span> id2 <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span>  <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>  <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                            <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> test01 <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> range <span class="token operator">|</span> idx1          <span class="token operator">|</span> idx1 <span class="token operator">|</span> <span class="token number">4</span>       <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">17592</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span> condition<span class="token punctuation">;</span> <span class="token keyword">Using</span> MRR <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+--------+------------+-------+---------------+------+---------+------+-------+----------+----------------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="自增变量未持久化"><a href="#自增变量未持久化" class="headerlink" title="自增变量未持久化"></a>自增变量未持久化</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span> id <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test_auto <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test_auto <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span> id <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">4</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token keyword">delete</span> <span class="token keyword">from</span> test_auto <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">-- restart mysql server</span><span class="token keyword">insert</span> <span class="token keyword">into</span> test_auto <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token boolean">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> test_auto<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span> id <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>  <span class="token number">3</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="DDL非原子"><a href="#DDL非原子" class="headerlink" title="DDL非原子"></a>DDL非原子</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token operator">like</span> <span class="token string">'test1%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span class="token operator">|</span> Tables_in_test <span class="token punctuation">(</span>test1<span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span class="token operator">|</span> test10                  <span class="token operator">|</span><span class="token operator">|</span> test11                  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span class="token keyword">drop</span> <span class="token keyword">table</span> test11<span class="token punctuation">,</span>test12<span class="token punctuation">;</span>ERROR <span class="token number">1051</span> <span class="token punctuation">(</span><span class="token number">42</span>S02<span class="token punctuation">)</span>: Unknown <span class="token keyword">table</span> <span class="token string">'test.test12'</span><span class="token keyword">show</span> <span class="token keyword">tables</span> <span class="token operator">like</span> <span class="token string">'test1%'</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span class="token operator">|</span> Tables_in_test <span class="token punctuation">(</span>test1<span class="token operator">%</span><span class="token punctuation">)</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span class="token operator">|</span> test10                  <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="创建降序索引仍为升序"><a href="#创建降序索引仍为升序" class="headerlink" title="创建降序索引仍为升序"></a>创建降序索引仍为升序</h3><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t1<span class="token punctuation">(</span>c1 <span class="token keyword">int</span><span class="token punctuation">,</span>c2 <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">index</span> idx_c1_c2<span class="token punctuation">(</span>c1<span class="token punctuation">,</span>c2 <span class="token keyword">desc</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">show</span> <span class="token keyword">create</span> <span class="token keyword">table</span> t1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span><span class="token operator">|</span> <span class="token keyword">Table</span> <span class="token operator">|</span> <span class="token keyword">Create</span> <span class="token keyword">Table</span>                                                                         <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span><span class="token operator">|</span> t1    <span class="token operator">|</span> <span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>t1<span class="token punctuation">`</span> <span class="token punctuation">(</span>  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8 <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">-------+--------------------------------------------------------------------------------------+</span><span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">;</span><span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">select</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span><span class="token punctuation">,</span> rand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100000</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token keyword">explain</span> <span class="token keyword">select</span> <span class="token operator">*</span><span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> c1 <span class="token punctuation">,</span> c2 <span class="token keyword">desc</span> <span class="token keyword">limit</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span><span class="token operator">|</span> id <span class="token operator">|</span> select_type <span class="token operator">|</span> <span class="token keyword">table</span> <span class="token operator">|</span> partitions <span class="token operator">|</span> <span class="token keyword">type</span>  <span class="token operator">|</span> possible_keys <span class="token operator">|</span> <span class="token keyword">key</span>  <span class="token operator">|</span> key_len <span class="token operator">|</span> ref  <span class="token operator">|</span> <span class="token keyword">rows</span>   <span class="token operator">|</span> filtered <span class="token operator">|</span> Extra                       <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span><span class="token operator">|</span>  <span class="token number">1</span> <span class="token operator">|</span> <span class="token keyword">SIMPLE</span>      <span class="token operator">|</span> t1    <span class="token operator">|</span> <span class="token boolean">NULL</span>       <span class="token operator">|</span> <span class="token keyword">index</span> <span class="token operator">|</span> <span class="token boolean">NULL</span>          <span class="token operator">|</span> idx1 <span class="token operator">|</span> <span class="token number">10</span>      <span class="token operator">|</span> <span class="token boolean">NULL</span> <span class="token operator">|</span> <span class="token number">327519</span> <span class="token operator">|</span>   <span class="token number">100.00</span> <span class="token operator">|</span> <span class="token keyword">Using</span> <span class="token keyword">index</span><span class="token punctuation">;</span> <span class="token keyword">Using</span> filesort <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">----+-------------+-------+------------+-------+---------------+------+---------+------+--------+----------+-----------------------------+</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="innodb-rollback-on-timeout"><a href="#innodb-rollback-on-timeout" class="headerlink" title="innodb_rollback_on_timeout"></a>innodb_rollback_on_timeout</h3><blockquote><p>需重启生效，影响事务原子性，建议设为<code>ON</code></p></blockquote><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--my.cnf</span><span class="token comment">--innodb_rollback_on_timeout = OFF</span><span class="token comment">--innodb_lock_wait_timeout = 10</span><span class="token comment">-- session1</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment">-- session2</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment">-- session 1</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span class="token keyword">commit</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">3</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-sql" data-language="sql"><code class="language-sql"><span class="token comment">--my.cnf</span><span class="token comment">--innodb_rollback_on_timeout = ON</span><span class="token comment">--innodb_lock_wait_timeout = 10</span><span class="token comment">-- session1</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment">-- session2</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token comment">-- session 1</span><span class="token keyword">begin</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">1</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span>  Changed: <span class="token number">1</span>  <span class="token keyword">Warnings</span>: <span class="token number">0</span><span class="token keyword">update</span> t1 <span class="token keyword">set</span> c1<span class="token operator">=</span><span class="token number">4</span> <span class="token keyword">where</span> c1<span class="token operator">=</span><span class="token number">2</span> <span class="token operator">and</span> c2<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span><span class="token keyword">commit</span><span class="token punctuation">;</span>Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1<span class="token punctuation">;</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span> c1   <span class="token operator">|</span> c2   <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">1</span> <span class="token operator">|</span><span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span>    <span class="token number">2</span> <span class="token operator">|</span><span class="token operator">+</span><span class="token comment">------+------+</span><span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="delete备库回放"><a href="#delete备库回放" class="headerlink" title="delete备库回放"></a>delete备库回放</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show create table test_no_primary;+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+| Table           | Create Table                                                                                                                                          |+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+| test_no_primary | CREATE TABLE `test_no_primary` (  `c1` int(11) DEFAULT NULL,  `c2` varchar(20) DEFAULT NULL,  KEY `i1` (`c1`)) ENGINE=InnoDB DEFAULT CHARSET=utf8 |+-----------------+-------------------------------------------------------------------------------------------------------------------------------------------------------+1 row in set (0.00 sec)mysql&gt; select * from test_no_primary;+------+------+| c1   | c2   |+------+------+|    1 | a    ||    1 | b    ||    1 | c    |+------+------+3 rows in set (0.00 sec)mysql&gt; delete from test_no_primary where c1=1;Query OK, 3 rows affected (0.01 sec)# 主库-&gt;备库日志#201023 21:44:30 server id 2454784635  end_log_pos 5657 CRC32 0x7b63ea86  Delete_rows: table id 282 flags: STMT_END_F### DELETE FROM `test`.`test_no_primary`### WHERE###   @1=1 /* INT meta=0 nullable=1 is_null=0 */###   @2='a' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */### DELETE FROM `test`.`test_no_primary`### WHERE###   @1=1 /* INT meta=0 nullable=1 is_null=0 */###   @2='b' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */### DELETE FROM `test`.`test_no_primary`### WHERE###   @1=1 /* INT meta=0 nullable=1 is_null=0 */###   @2='c' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */# at 5657mysql&gt; show create table test_with_primary;+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| Table             | Create Table                                                                                                                                                                                                                            |+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+| test_with_primary | CREATE TABLE `test_with_primary` (  `c0` int(11) NOT NULL AUTO_INCREMENT,  `c1` int(11) DEFAULT NULL,  `c2` varchar(20) DEFAULT NULL,  PRIMARY KEY (`c0`),  KEY `i1` (`c1`)) ENGINE=InnoDB AUTO_INCREMENT=31 DEFAULT CHARSET=utf8 |+-------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+1 row in set (0.00 sec)mysql&gt; select * from test_with_primary;+----+------+------+| c0 | c1   | c2   |+----+------+------+|  1 |    1 | a    || 11 |    1 | b    || 21 |    1 | c    |+----+------+------+3 rows in set (0.00 sec)mysql&gt; delete from test_with_primary where c1=1;Query OK, 3 rows affected (0.00 sec)# 主库-&gt;备库日志#201023 21:53:59 server id 2454784635  end_log_pos 7005 CRC32 0xc0c83f05  Delete_rows: table id 284 flags: STMT_END_F### DELETE FROM `test`.`test_with_primary`### WHERE###   @1=1 /* INT meta=0 nullable=0 is_null=0 */###   @2=1 /* INT meta=0 nullable=1 is_null=0 */###   @3='a' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */### DELETE FROM `test`.`test_with_primary`### WHERE###   @1=11 /* INT meta=0 nullable=0 is_null=0 */###   @2=1 /* INT meta=0 nullable=1 is_null=0 */###   @3='b' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */### DELETE FROM `test`.`test_with_primary`### WHERE###   @1=21 /* INT meta=0 nullable=0 is_null=0 */###   @2=1 /* INT meta=0 nullable=1 is_null=0 */###   @3='c' /* VARSTRING(60) meta=60 nullable=1 is_null=0 */# at 7005<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="uuid-gt-auto-increment"><a href="#uuid-gt-auto-increment" class="headerlink" title="uuid -> auto_increment"></a>uuid -&gt; auto_increment</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; select * from test;+--------------------------------------+------+| c1                                   | c2   |+--------------------------------------+------+| 17f6ea4e-1ea8-11eb-95f7-b54d65122ba1 | aaa  || 1ab073fe-1ea8-11eb-95f7-b54d65122ba1 | bbb  || 1c2a32d8-1ea8-11eb-95f7-b54d65122ba1 | ccc  |+--------------------------------------+------+mysql&gt; desc test;+-------+-------------+------+-----+---------+-------+| Field | Type        | Null | Key | Default | Extra |+-------+-------------+------+-----+---------+-------+| c1    | varchar(36) | NO   | PRI | NULL    |       || c2    | varchar(20) | YES  |     | NULL    |       |+-------+-------------+------+-----+---------+-------+mysql&gt; alter table test drop primary key;mysql&gt; alter table test add column c3 int auto_increment primary key;mysql&gt; select * from test;+--------------------------------------+------+----+| c1                                   | c2   | c3 |+--------------------------------------+------+----+| 17f6ea4e-1ea8-11eb-95f7-b54d65122ba1 | aaa  |  1 || 1ab073fe-1ea8-11eb-95f7-b54d65122ba1 | bbb  |  2 || 1c2a32d8-1ea8-11eb-95f7-b54d65122ba1 | ccc  |  3 |+--------------------------------------+------+----+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="字符串索引数字查询"><a href="#字符串索引数字查询" class="headerlink" title="字符串索引数字查询"></a>字符串索引数字查询</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show create table test\G;*************************** 1. row ***************************       Table: testCreate Table: CREATE TABLE `test` (  `c1` int(11) NOT NULL AUTO_INCREMENT,  `c2` varchar(20) DEFAULT NULL,  `c3` char(36) DEFAULT NULL,  `c4` char(36) DEFAULT NULL,  `c5` char(36) DEFAULT NULL,  PRIMARY KEY (`c1`),  KEY `i1` (`c2`),  KEY `i2` (`c2`)) ENGINE=InnoDB AUTO_INCREMENT=1376221 DEFAULT CHARSET=utf81 row in set (0.05 sec)mysql&gt; explain select * from test where c2='1';+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref   | rows | filtered | Extra |+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+|  1 | SIMPLE      | test  | NULL       | ref  | i1,i2         | i1   | 63      | const |    1 |   100.00 | NULL  |+----+-------------+-------+------------+------+---------------+------+---------+-------+------+----------+-------+mysql&gt; explain select * from test where c2=1;+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows    | filtered | Extra       |+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+|  1 | SIMPLE      | test  | NULL       | ALL  | i1,i2         | NULL | NULL    | NULL | 1044395 |    10.00 | Using where |+----+-------------+-------+------------+------+---------------+------+---------+------+---------+----------+-------------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>官方解释：<br>For comparisons of a string column with a number, MySQL cannot use an index on the column to look up the value quickly. If str_col is an indexed string column, the index cannot be used when performing the lookup in the following statement</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">SELECT * FROM tbl_name WHERE str_col=1;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>The reason for this is that there are many different strings that may convert to the value 1, such as ‘1’, ‘ 1’, or ‘1a’.</p><h3 id="show-status-like-‘handler-read-’"><a href="#show-status-like-‘handler-read-’" class="headerlink" title="show status like ‘handler%read%’"></a>show status like ‘handler%read%’</h3><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; show create table test.test\G;*************************** 1. row ***************************       Table: testCreate Table: CREATE TABLE `test` (  `c1` int(11) NOT NULL AUTO_INCREMENT,  `c2` varchar(20) DEFAULT NULL,  `c3` char(36) DEFAULT NULL,  `c4` char(36) DEFAULT NULL,  `c5` char(36) DEFAULT NULL,  PRIMARY KEY (`c1`),  KEY `i1` (`c2`),  KEY `i2` (`c2`)) ENGINE=InnoDB AUTO_INCREMENT=1310694 DEFAULT CHARSET=utf8show status like 'handler%read%';+-----------------------+-------+| Variable_name         | Value |+-----------------------+-------+| Handler_read_first    | 0     || Handler_read_key      | 0     || Handler_read_last     | 0     || Handler_read_next     | 0     || Handler_read_prev     | 0     || Handler_read_rnd      | 0     || Handler_read_rnd_next | 0     |+-----------------------+-------+select * from test.test where c2='1';+----+------+------+------+------+| c1 | c2   | c3   | c4   | c5   |+----+------+------+------+------+|  1 | 1    | NULL | NULL | NULL |+----+------+------+------+------+show status like 'handler%read%';+-----------------------+-------+| Variable_name         | Value |+-----------------------+-------+| Handler_read_first    | 0     || Handler_read_key      | 1     || Handler_read_last     | 0     || Handler_read_next     | 1     || Handler_read_prev     | 0     || Handler_read_rnd      | 0     || Handler_read_rnd_next | 0     |+-----------------------+-------+select * from test.test where c3='1';Empty set (0.40 sec)show status like 'handler%read%';+-----------------------+---------+| Variable_name         | Value   |+-----------------------+---------+| Handler_read_first    | 1       || Handler_read_key      | 2       || Handler_read_last     | 0       || Handler_read_next     | 1       || Handler_read_prev     | 0       || Handler_read_rnd      | 0       || Handler_read_rnd_next | 1048577 |+-----------------------+---------+<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ibtmp1-临时表空间"><a href="#ibtmp1-临时表空间" class="headerlink" title="ibtmp1 临时表空间"></a>ibtmp1 临时表空间</h3><p>explain为Using temporary的使用ibtmp1，无法自动释放</p><pre class="line-numbers language-mysql" data-language="mysql"><code class="language-mysql">mysql&gt; SELECT @@innodb_temp_data_file_path;+------------------------------+| @@innodb_temp_data_file_path |+------------------------------+| ibtmp1:12M:autoextend        |+------------------------------+mysql&gt; explain insert into test_tmp(c2) select c2 from test_tmp;+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra           |+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+|  1 | INSERT      | test_tmp | NULL       | ALL  | NULL          | NULL | NULL    | NULL | NULL |     NULL | NULL            ||  1 | SIMPLE      | test_tmp | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    2 |   100.00 | Using temporary |+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+-----------------+$ du -sh /usr/local/var/mysql/test/test_tmp.ibd 513M/usr/local/var/mysql/test/test_tmp.ibd$ du -sh /usr/local/var/mysql/ibtmp1 273M/usr/local/var/mysql/ibtmp1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h3 id=""><a href="#" class="headerlink" title=""></a><a href="https://redis.io/topics/notifications" title="" target="">Notifications</a></h3><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">127.0.0.1:6379&gt; config set notify-keyspace-events KEAOK127.0.0.1:6379&gt; psubscribe '*'Reading messages... (press Ctrl-C to quit)1) "psubscribe"2) "*"3) (integer) 11) "pmessage"2) "*"3) "__keyspace@0__:foo"4) "set"1) "pmessage"2) "*"3) "__keyevent@0__:set"4) "foo"<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">127.0.0.1:6379&gt; set foo 1OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> 数据库 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 测试 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>goim源码</title>
      <link href="2020/04/30/go/goim/"/>
      <url>2020/04/30/go/goim/</url>
      
        <content type="html"><![CDATA[<p>mid: member id<br>key: 绑定mid的会话key, auth时若token里没有, 在logic层使用uuid生成<br>accepts: mid的channel watch accepts, 在ch.NeedPush中check</p><h2 id="bufio"><a href="#bufio" class="headerlink" title="bufio"></a>bufio</h2><p>缓冲Reader/Writer, pop()复用peek()前移游标出栈, 读/写包头</p><h2 id="comet"><a href="#comet" class="headerlink" title="comet"></a>comet</h2><h3 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h3><p>p.ReadTCP(rr): 从rr pop一个proto<br>p.WriteTCP(wr): 如果是raw包, 直接用p.Body写wr; 否则写头+p.Body</p><h3 id="authTCP"><a href="#authTCP" class="headerlink" title="authTCP()"></a>authTCP()</h3><p>ch.CliProto.<font color="cyan">Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取auth proto<br>调用logic rpc connect进行auth, p.Body为token<br>调用p.WriteTCP(wr), 写authReply</p><h2 id="Operate"><a href="#Operate" class="headerlink" title="Operate()"></a>Operate()</h2><ul><li>OpChangeRoom: p.Body为rid, 将ch换到room</li><li>OpSub: ch.Watch, p.Body为ops</li><li>OpUnsub: ch.UnWatch, p.Body为ops</li><li>其他: logic rpc Receive, logic侧无处理</li></ul><h2 id="dispatchTCP"><a href="#dispatchTCP" class="headerlink" title="dispatchTCP()"></a>dispatchTCP()</h2><h3 id="ch-CliProto-Get-读取一个proto"><a href="#ch-CliProto-Get-读取一个proto" class="headerlink" title="ch.CliProto.Get()读取一个proto"></a>ch.CliProto.<font color="red">Get()</font>读取一个proto</h3><ul><li>OpHeartbeatReply: 调用p.WriteTCPHeart()写当前ch.room的online数</li><li>其他: 调用p.WriteTCP(wr), 写对应reply</li></ul><h2 id="TCP逻辑"><a href="#TCP逻辑" class="headerlink" title="TCP逻辑"></a>TCP逻辑</h2><p>绑定一个channel的Reader/Writer到conn</p><ol><li>handshake, 若timout则close conn</li><li>调用authTCP()认证, 返回accepts, key, rid, hb</li><li>1 根据accepts得到ch.Watch</li><li>2 根据key得到这个conn对应的Bucket, 使用CityHash32计算, 共32个桶</li><li>3 根据rid将ch放到对应的room里</li><li>重置心跳超时</li><li>开启go dispatchTCP(), ch.CliProto.<font color="cyan">Set()</font>得到一个proto, 调用p.ReadTCP(rr), 读取proto</li><li>1 <em>OpHeartbeat</em>: 调用logic rpc Heartbeat</li><li>2 <em>其他</em>: 调用s.Operate()</li><li>处理完proto后触发dispatchTCP()写对应reply</li></ol><h2 id="RenewOnline逻辑"><a href="#RenewOnline逻辑" class="headerlink" title="RenewOnline逻辑"></a>RenewOnline逻辑</h2><p>comet侧go onlineproc统计所有bucket的所有room的online<br>调用rpc RenewOnline<br>logic侧根据roomId计算hashKey, redis存储格式server -&gt; hashKey:online, hashKey使用CityHash32放64个桶</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Online struct {    Server    string           `json:"server"`    RoomCount map[string]int32 `json:"room_count"`    // logic侧5分钟未更新则DEL server    Updated   int64            `json:"updated"` }<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Round"><a href="#Round" class="headerlink" title="Round"></a>Round</h2><p>reader/writer/timer资源池, 轮询获取降低高并发资源争用</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Round struct {    readers []bytes.Pool    writers []bytes.Pool    timers  []time.Timer    options RoundOptions}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="pool"><a href="#pool" class="headerlink" title="pool"></a>pool</h2><p>链表栈, 顶出顶入, 若无buf可用, 调用grow, 若入速度小于出速度会有内存溢出</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Buffer struct {    buf  []byte    next *Buffer // next free buffer}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Pool struct {    lock sync.Mutex    free *Buffer    max  int    num  int    size int}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="ring"><a href="#ring" class="headerlink" title="ring"></a>ring</h2><p>Proto的缓冲池，data数组大小[0:num-1], 游标wp比游标rp快会导致rp脏读</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Ring struct {    // read    rp   uint64   // rp&amp;mask寻址data    num  uint64   // 2^N    mask uint64   // num-1    // write    wp   uint64   // wp&amp;mask寻址data    data []grpc.Proto}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h2><p>memberId绑定的channel, 保存Proto的缓冲池Ring<br>通过Signal()通知有一个proto待处理; 通过开一个goroutin的Ready()通知处理一个proto写wr<br>若proto写wr太慢, rp游标移动比wp慢, 可能导致rp脏读<br>广播/房播/单播 的proto直接写wr</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Channel struct {    Room     *Room    CliProto Ring    signal   chan *grpc.Proto    Writer   bufio.Writer    Reader   bufio.Reader    Next     *Channel    Prev     *Channel    Mid      int64    Key      string    IP       string    watchOps map[int32]struct{}   // Watch(ops)添加ops; UnWatch(ops)删除ops; NeedPush(op)检查op in watch    mutex    sync.RWMutex   // lock for watchOps}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="room"><a href="#room" class="headerlink" title="room"></a>room</h2><p>保存channel链表</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Room struct {    ID        string    rLock     sync.RWMutex    next      *Channel    drop      bool   // true if Online-- == 0    Online    int32    AllOnline int32   // dirty read because Bucket.UpRoomsCount with RLock}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="Bucket"><a href="#Bucket" class="headerlink" title="Bucket"></a>Bucket</h2><p>存放room和channel, channel可以change/put room, 自动创建new room<br>所有channel广播 或 指定room房播<br>routines处理job kafka rpc</p><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Bucket struct {    c     *conf.Bucket    cLock sync.RWMutex          // lock for chs/rooms    chs   map[string]*Channel   // 1024    // room    rooms       map[string]*Room   // 1024    routines    []chan *grpc.BroadcastRoomReq   // 32 (go b.roomproc((chan *grpc.BroadcastRoomReq, 1024)))    routinesNum uint64   // routinesNum % 32    ipCnts map[string]int32   // ip counter}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><img src="/2020/04/30/go/goim/%E6%88%BF%E9%97%B4%E4%BF%A1%E6%81%AF%E6%8E%A8%E9%80%81%E6%B5%81%E7%A8%8B.png" class=""><h2 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h2><p>根据SubKey获取Bucket</p><p>Operate:</p><ul><li>bucket.ChangeRoom</li><li>channel.Watch</li><li>channel.UnWatch</li></ul><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">type Server struct {    c         *conf.Config    round     *Round      // accept round store    buckets   []*Bucket   // 32    bucketIdx uint32      // 32    serverID  string    rpcClient logic.LogicClient}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="job"><a href="#job" class="headerlink" title="job"></a>job</h2><p>job从kafka consume, 通过rpc调用comet</p><p>根据pushMsg.Type分:</p><ul><li>单播</li><li>房播</li><li>广播</li></ul><pre class="line-numbers language-golang" data-language="golang"><code class="language-golang">// clinetvar XXXRoutineSize intvar XXXChanSize intvar XXXChan = make([]chan *server.XXXReq, XXXRoutineSize)var XXXChanCursor uint64for i := 0; i &lt; XXXRoutineSize; i++ {    XXXChan[i] = make(chan *server.XXXReq, XXXChanSize)    go process(XXXChan[i])}func (c *client) process(XXXChan chan *server.XXXReq){    for {        select XXXArg := &lt;- XXXChan:            reply, err := c.serverClient.XXX(context.Background(), &amp;server.XXXReq{                key: XXXArg.value,            })        ...    }}func (c *client) XXXFunc(arg *server.XXXReq) {    idx := atomic.AddUint64(&amp;XXXChanCursor, 1) % XXXRoutineSize    XXXChan[idx] &lt;- arg}// serverfunc (s *server) XXX(ctx context.Context, req *server.XXXReq) (reply *server.XXXReply, err error){    ...}<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="job-room-kafka房播msg流程"><a href="#job-room-kafka房播msg流程" class="headerlink" title="job.room kafka房播msg流程"></a>job.room kafka房播msg流程</h2><ol><li>根据msg.roomId调用getRoom(), 若没有则NewRoom() -&gt; go pushproc()监听, 然后Push()</li><li>pushproc:  SigTime=1S, Batch=20, Idle=15M</li><li>1 循环消费kafka msg, 直到超过1S未收到新msg，或&gt;=20次写</li><li>2 调用rpc房播, 等待最大15M若未收到新msg则退出循环</li></ol><h2 id="logic"><a href="#logic" class="headerlink" title="logic"></a>logic</h2><p>redis存储格式</p><ul><li>mid -&gt; key:server</li><li>key -&gt; server</li><li>server -&gt; hashKey:online<br><code>hashKey使用roomId通过cityHash32算出,共64个桶</code><br><code>将1024个room装进64个桶里</code></li></ul><h2 id="business-http-push参照doc"><a href="#business-http-push参照doc" class="headerlink" title="business http push参照doc"></a>business http push参照doc</h2>]]></content>
      
      
      <categories>
          
          <category> go </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-6.数据库和日志</title>
      <link href="2020/04/29/zk/zkSrc_db/"/>
      <url>2020/04/29/zk/zkSrc_db/</url>
      
        <content type="html"><![CDATA[<h2 id="数据库格式"><a href="#数据库格式" class="headerlink" title="数据库格式"></a>数据库格式</h2><p>ZKDatabase负责记录节点的数据信息，事务日志以及Snapshot日志，以及watch的管理，相关类图如下:</p><img src="/2020/04/29/zk/zkSrc_db/database.png" class=""><p>主要的类信息如下:</p><ul><li>ZKDatabase 数据库类的封装</li><li>FileTxnSnapLog 日志类封装，包括事务日志和Snapshot日志的管理</li><li>SnapShot为Shapshot日志接口，FileSnap为具体实现类。</li><li>TxnLog为事务日志接口，FileTxnLog为具体实现类。</li><li>DataTree为节点数据管理类，负责保存节点的数据以及管理数据的Watcher。</li><li>DataNode保存节点的数据信息，状态信息以及子节点信息。</li></ul><h2 id="节点数据"><a href="#节点数据" class="headerlink" title="节点数据"></a>节点数据</h2><p>ZooKeeper的节点类似Linux文件目录，根目录为/,每个目录有唯一的路径，同时，在节点上可以绑定用户指定的数据。</p><h3 id="节点数据定义"><a href="#节点数据定义" class="headerlink" title="节点数据定义"></a>节点数据定义</h3><p>节点的目录信息存储于DataTree.nodes信息中，为树形结构。<br>节点的状态信息存储于类StatPersisted，具体字段的含义如下:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> czxid<span class="token punctuation">;</span> 节点创建时的zxid<span class="token keyword">private</span> <span class="token keyword">long</span> mzxid<span class="token punctuation">;</span> 最后一次修改节点数据的zxid<span class="token keyword">private</span> <span class="token keyword">long</span> ctime<span class="token punctuation">;</span> 创建节点的时间<span class="token keyword">private</span> <span class="token keyword">long</span> mtime<span class="token punctuation">;</span> 最后一次修改节点数据的时间<span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span> 节点的版本号，创建时为<span class="token number">0</span>，修改时<span class="token operator">+</span><span class="token number">1</span><span class="token keyword">private</span> <span class="token keyword">int</span> cversion<span class="token punctuation">;</span> 孩子节点版本信息，每创建一个孩子节点<span class="token operator">+</span><span class="token number">1</span><span class="token keyword">private</span> <span class="token keyword">int</span> aversion<span class="token punctuation">;</span> ACL版本信息<span class="token keyword">private</span> <span class="token keyword">long</span> ephemeralOwner<span class="token punctuation">;</span> 节点的类型信息<span class="token keyword">private</span> <span class="token keyword">long</span> pzxid<span class="token punctuation">;</span>  节点本身和孩子节点的最后一次修改zxid。<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="节点类型定义"><a href="#节点类型定义" class="headerlink" title="节点类型定义"></a>节点类型定义</h3><p>总共有四种类型的节点，具体定义为enum EphemeralType，每种类型的含义为:</p><ul><li>VOID 持久化的节点，用户连接关闭后节点会一直存在。</li><li>NORMAL 临时节点，用户连接断开后临时节点会被删除。临时节点信息存储在DataTree.ephemerals中。</li><li>CONTAINER 和VOID节点一样，但是当该节点的孩子被删除后，该节点会被删除。Container节点信息存储在DataTree.containers中。</li><li>TTL 和VOID节点一样，但是当该节点无孩子节点，并且当前时间距离上次修改时间超过ttl时间，该节点会被删除。TTL节点信息存储在DataTree.ttls中。</li></ul><hr><h2 id="特殊节点类型"><a href="#特殊节点类型" class="headerlink" title="特殊节点类型"></a>特殊节点类型</h2><blockquote><p>ZooKeeper的节点有两个特殊的目录:</p></blockquote><h3 id="zookeeper-quota"><a href="#zookeeper-quota" class="headerlink" title="/zookeeper/quota"></a>/zookeeper/quota</h3><p>配置某个节点的配额信息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* Rather than fight it, let root have an alias */</span><span class="token comment">// "/"</span>nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>nodes<span class="token punctuation">.</span><span class="token function">putWithoutDigest</span><span class="token punctuation">(</span>rootZookeeper<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">/** add the proc node and quota node */</span><span class="token comment">// "/zookeeper"</span>root<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>procChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">,</span> procDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// "/zookeeper/quota"</span>procDataNode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>quotaChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>quotaZookeeper<span class="token punctuation">,</span> quotaDataNode<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>如某个节点的路径为/xx/yy,则对应的配额信息路径为/zookeeper/quota/xx/yy，其中/zookeeper/quota/xx/yy/zookeeper_limits包含管理员设置的配额信息，/zookeeper/quota/xx/yy/zookeeper_stats包含节点当前已使用的信息。</li><li>配额信息包含两个参数，分别表示大小(bytes)和节点数量(counts)。</li><li>在创建节点时会更新配额的信息，并检查是否超过配额。</li><li>配额设置详见cli包下SetQuotaCommand.java。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// also check to update the quotas for this node</span><span class="token class-name">String</span> lastPrefix <span class="token operator">=</span> <span class="token function">getMaxPrefixWithQuota</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> bytes <span class="token operator">=</span> data <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>lastPrefix <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// ok we have some match and need to update</span>    <span class="token function">updateCountBytes</span><span class="token punctuation">(</span>lastPrefix<span class="token punctuation">,</span> bytes<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * update the count/count of bytes of this stat datanode * * @param lastPrefix *            the path of the node that is quotaed. * @param bytesDiff *            the diff to be added to number of bytes * @param countDiff *            the diff to be added to the count */</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateCountBytes</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastPrefix<span class="token punctuation">,</span> <span class="token keyword">long</span> bytesDiff<span class="token punctuation">,</span> <span class="token keyword">int</span> countDiff<span class="token punctuation">)</span> <span class="token punctuation">{</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="zookeeper-config"><a href="#zookeeper-config" class="headerlink" title="/zookeeper/config"></a>/zookeeper/config</h3><p>保存所有节点信息</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * create a /zookeeper/config node for maintaining the configuration (membership and quorum system) info for * zookeeper */</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addConfigNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">DataNode</span> zookeeperZnode <span class="token operator">=</span> nodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>procZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>zookeeperZnode <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// should always be the case</span>        zookeeperZnode<span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>configChildZookeeper<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">assert</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token string">"There's no /zookeeper znode - this should never happen."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    nodes<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">DataNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StatPersisted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token comment">// Reconfig node is access controlled by default (ZOOKEEPER-2014).</span>        <span class="token function">setACL</span><span class="token punctuation">(</span>configZookeeper<span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span>READ_ACL_UNSAFE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException<span class="token punctuation">.</span>NoNodeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">assert</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token string">"There's no "</span> <span class="token operator">+</span> configZookeeper <span class="token operator">+</span> <span class="token string">" znode - this should never happen."</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>PrepRequestProcessor::run处理request流程中，对<code>OpCode.reconfig</code>会更改config node信息</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">OpCode</span><span class="token punctuation">.</span>reconfig<span class="token operator">:</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    nodeRecord <span class="token operator">=</span> <span class="token function">getRecordForPath</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs</span><span class="token punctuation">.</span>CONFIG_NODE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// "/zookeeper/config"</span>    zks<span class="token punctuation">.</span><span class="token function">checkACL</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>cnxn<span class="token punctuation">,</span> nodeRecord<span class="token punctuation">.</span>acl<span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Perms</span><span class="token punctuation">.</span>WRITE<span class="token punctuation">,</span> request<span class="token punctuation">.</span>authInfo<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">SetDataTxn</span> setDataTxn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SetDataTxn</span><span class="token punctuation">(</span><span class="token class-name">ZooDefs</span><span class="token punctuation">.</span>CONFIG_NODE<span class="token punctuation">,</span> request<span class="token punctuation">.</span>qv<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    nodeRecord<span class="token punctuation">.</span>data <span class="token operator">=</span> setDataTxn<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// request.qv.toString().getBytes()</span>    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    <span class="token function">addChangeRecord</span><span class="token punctuation">(</span>nodeRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>request.qv.toString() 记录QuorumMaj中集群所有成员信息</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">StringBuilder</span> sw <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">QuorumServer</span> member <span class="token operator">:</span> <span class="token function">getAllMembers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">"server."</span> <span class="token operator">+</span> member<span class="token punctuation">.</span>id<span class="token punctuation">;</span>        <span class="token class-name">String</span> value <span class="token operator">=</span> member<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>        sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">String</span> hexVersion <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>version<span class="token punctuation">)</span><span class="token punctuation">;</span>    sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"version="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sw<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>hexVersion<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> sw<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="Watcher管理"><a href="#Watcher管理" class="headerlink" title="Watcher管理"></a>Watcher管理</h2><p>有两种类型的Watcher</p><ul><li>childWatches 新增或者删除孩子节点时触发，可以在getChildren时注册。</li><li>dataWatches 在创建，删除，修改时触发。</li></ul><hr><h2 id="日志管理"><a href="#日志管理" class="headerlink" title="日志管理"></a>日志管理</h2><h3 id="TxnLog"><a href="#TxnLog" class="headerlink" title="TxnLog"></a>TxnLog</h3><p>事务日志的文件格式如下所示:</p><table><thead><tr><th>文件头(16Byte)</th><th>事务列表</th><th>0补齐</th></tr></thead></table><p>文件头的格式为class FileHeader:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> magic<span class="token punctuation">;</span>   <span class="token comment">//字符串"ZKLG"</span><span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span> <span class="token comment">//默认为2</span><span class="token keyword">private</span> <span class="token keyword">long</span> dbid<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>事务列表由多个事务组成，每个事务的格式如下:</p><table><thead><tr><th>校验和(8Bye)</th><th>数据长度(4Byte)</th><th>事务头信息(32Byte)</th><th>请求数据</th><th>结束符(0x42)</th></tr></thead></table><p>事务头的格式为class TxnHeader:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> clientId<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">int</span> cxid<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">long</span> zxid<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">long</span> time<span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token keyword">int</span> type<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>写事务的详细逻辑见FileTxnLog.append,该函数会先检查日志文件是否存在，若不存在，则先创建文件，再写日志。每个日志文件的命名格式为log.{该文件第一个日志的zxid}。在commit到disk时判断是否需要roll一个新FileTxnLog。<br>日志文件生成后没有固定清理机制，需通过运维方法清理，或设置自动清理参数<code>autopurge.purgeInterval</code>，代码实现见DatadirCleanupManager::PurgeTask</p><h3 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h3><p>Snapshot文件格式如下:</p><table><thead><tr><th>文件头(16Byte)</th><th>session信息</th><th>节点信息</th></tr></thead></table><p>文件头格式和事务日志一样，只是Magic为“ZKSN”。</p><p>Session信息格式如下:</p><p>Count(4Byte)|1-id(8Byte)|1-Timeout(4Byte)|…|N-id|N-Timeout</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">serializeSnapshot</span><span class="token punctuation">(</span><span class="token class-name">DataTree</span> dt<span class="token punctuation">,</span> <span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessions<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> sessSnap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>sessions<span class="token punctuation">)</span><span class="token punctuation">;</span>    oa<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>sessSnap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> sessSnap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        oa<span class="token punctuation">.</span><span class="token function">writeLong</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">longValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        oa<span class="token punctuation">.</span><span class="token function">writeInt</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    dt<span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span>oa<span class="token punctuation">,</span> <span class="token string">"tree"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="节点信息"><a href="#节点信息" class="headerlink" title="节点信息"></a>节点信息</h3><p>节点信息由类DataTree.serialize实现，该类会先序列化ACL信息，再按节点的树形结构序列化节点以及对应的状态信息，具体格式见代码。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">OutputArchive</span> oa<span class="token punctuation">,</span> <span class="token class-name">String</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token function">serializeAcls</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">serializeNodes</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-5.客户端响应请求</title>
      <link href="2020/04/29/zk/zkSrc_processPacket/"/>
      <url>2020/04/29/zk/zkSrc_processPacket/</url>
      
        <content type="html"><![CDATA[<p>NIOServerCnxn / NettyServerCnxn 调用ZooKeeperServer.processPacket，内部会调用submitRequest，最后submitRequest会将Request派发到firstProcessor</p><hr><h2 id="配置Processors"><a href="#配置Processors" class="headerlink" title="配置Processors"></a>配置Processors</h2><h3 id="Follower节点配置Processors"><a href="#Follower节点配置Processors" class="headerlink" title="Follower节点配置Processors"></a>Follower节点配置Processors</h3><p>Follower节点配置Processors详见FollowerZooKeeperServer.setupRequestProcessors, 链表结构如下:</p><img src="/2020/04/29/zk/zkSrc_processPacket/follower_processors.png" class=""><h3 id="Leader节点配置Processors"><a href="#Leader节点配置Processors" class="headerlink" title="Leader节点配置Processors"></a>Leader节点配置Processors</h3><p>Leader节点配置Processors详见LeaderZooKeeperServer.setupRequestProcessors, 链表结构如下:</p><img src="/2020/04/29/zk/zkSrc_processPacket/leader_processors.png" class=""><h3 id="客户端请求处理"><a href="#客户端请求处理" class="headerlink" title="客户端请求处理"></a>客户端请求处理</h3><p>Zookeeper将客户端的请求实际上分为两种类型:</p><ul><li>第一种类型的请求可以叫做读请求，如getData，getChildren等。<br>这种类型的请求不会修改zookeeper数据库的内容，因为zookeeper每个节点的数据库内容是一致的(不同的节点之间由于同步的时间不一致，可能会导致数据有不一致)，所以读请求只用在本地节点的数据库即可。</li><li>第二种节点会修改数据库内容，如create,delete等。<br>非Leader节点接收到此种请求，会先转发到Leader节点，Leader会按照先Proposal，后Commit的方式将请求同步到所有节点。</li></ul><h2 id="处理请求流程"><a href="#处理请求流程" class="headerlink" title="处理请求流程"></a>处理请求流程</h2><h3 id="Leader处理请求流程"><a href="#Leader处理请求流程" class="headerlink" title="Leader处理请求流程"></a>Leader处理请求流程</h3><h4 id="LeaderRequestProcessor"><a href="#LeaderRequestProcessor" class="headerlink" title="LeaderRequestProcessor"></a>LeaderRequestProcessor</h4><ul><li>如果是LocalSession，并且用户请求为创建临时节点（Session关闭时节点会删除），则升级Session到GlobalSession，并且创建一条createSession请求（upgradeRequest）。</li><li>如果createSession请求不为null，转发到PrepRequestProcessor。</li><li>转发用户请求到PrepRequestProcessor</li></ul><h4 id="PrepRequestProcessor"><a href="#PrepRequestProcessor" class="headerlink" title="PrepRequestProcessor"></a>PrepRequestProcessor</h4><p>PrepRequestProcessor设置Request的transcation信息，该Processor运行于独立的线程中。对于会改写zookeeper数据库的操作，该Processor会添加transcation信息，并且增加TxnHeader。对于读操作，则只检查session合法性。</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pRequest2Txn</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">long</span> zxid<span class="token punctuation">,</span> <span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">Record</span> <span class="token keyword">record</span><span class="token punctuation">,</span> <span class="token keyword">boolean</span> deserialize<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">RequestProcessorException</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getHdr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        request<span class="token punctuation">.</span><span class="token function">setHdr</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxnHeader</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>sessionId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>cxid<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span>                <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentWallTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setTxnDigest</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">,</span> <span class="token class-name">PrecalculatedDigest</span> preCalculatedDigest<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>preCalculatedDigest <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    request<span class="token punctuation">.</span><span class="token function">setTxnDigest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TxnDigest</span><span class="token punctuation">(</span>digestCalculator<span class="token punctuation">.</span><span class="token function">getDigestVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preCalculatedDigest<span class="token punctuation">.</span>treeDigest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="ProposalRequestProcessor"><a href="#ProposalRequestProcessor" class="headerlink" title="ProposalRequestProcessor"></a>ProposalRequestProcessor</h4><ul><li>ProposalRequestProcessor会先将请求派发给CommitProcessor</li><li>随后ProposalRequestProcessor检查哪些请求被添加了transcation信息，如果被添加了transcation信息，则会发送Proposal包给集群内所有节点。发送Proposal的时序图如下:</li></ul><img src="/2020/04/29/zk/zkSrc_processPacket/proposal_seq.png" class=""><ul><li>发送完Proposal之后，再将该请求发送到SyncRequestProcessor。</li></ul><h4 id="SyncRequestProcessor"><a href="#SyncRequestProcessor" class="headerlink" title="SyncRequestProcessor"></a>SyncRequestProcessor</h4><p>SyncRequestProcessor用于存储请求Transcation日志以及数据库的Snapshot日志到文件，存储的逻辑详见run函数：</p><ul><li>通过snapCount和snapSizeInBytes控制多少次请求或多大log生成一个新的Transcation日志文件和保存Snapshot文件。</li><li>为了防止不同的节点都在相同的时间点进行snap，每次生成新的随机数，随机打散每个zk节点的snap时间点</li><li>Transcation日志格式以及Snapshot文件格式详见数据库格式。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>zks<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>si<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">shouldSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token function">resetSnapshotStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">resetSnapshotStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    randRoll <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>snapCount <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    randSize <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token punctuation">(</span>snapSizeInBytes <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h4 id="AckRequestProcessor"><a href="#AckRequestProcessor" class="headerlink" title="AckRequestProcessor"></a>AckRequestProcessor</h4><p>在SyncRequestProcessor flush后，AckRequestProcessor仅仅是发送一个正在处理请求的ACK到Leader自己，用来模拟收到Leader节点的ACK。</p><h4 id="Leader-Proposal-ACK管理"><a href="#Leader-Proposal-ACK管理" class="headerlink" title="Leader Proposal ACK管理"></a>Leader Proposal ACK管理</h4><p>LearnerHandler在完成选举之后，会调用startSendingPackets来启动发送Packet的线程</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Start thread that blast packets in the queue to learner</span><span class="token function">startSendingPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>同时进入接收该节点返回数据的循环。 </p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>在收到Proposal Packet的ACK后，LearnerHandler处理流程为：</p><img src="/2020/04/29/zk/zkSrc_processPacket/proposal_ack.png" class=""><ul><li>接收到节点所发的Proposal ACK数据，调用Leader.processAck</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>ACK<span class="token operator">:</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>learnerType <span class="token operator">==</span> <span class="token class-name">LearnerType</span><span class="token punctuation">.</span>OBSERVER<span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Received ACK from Observer {}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    syncLimitCheck<span class="token punctuation">.</span><span class="token function">updateAck</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    learnerMaster<span class="token punctuation">.</span><span class="token function">processAck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sid<span class="token punctuation">,</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> sock<span class="token punctuation">.</span><span class="token function">getLocalSocketAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>将ACK的节点id添加到Proposal数据中，调用tryToCommit,尝试Commit该Request。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">Proposal</span> p <span class="token operator">=</span> outstandingProposals<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">boolean</span> hasCommitted <span class="token operator">=</span> <span class="token function">tryToCommit</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> followerAddr<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><ul><li>调用Proposal.hasAllQuorums检查ACK的节点是否超过集群数量一半(包括Leader本身)，若超过，则向所有Follower发送Commit。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">commit</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Create a commit packet and send it to all the members of the quorum * * @param zxid */</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lastCommitted <span class="token operator">=</span> zxid<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>COMMIT<span class="token punctuation">,</span> zxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sendPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>COMMIT_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>向所有Observer节点发送Inform。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">inform</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * Create an inform packet and send it to all observers. */</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">inform</span><span class="token punctuation">(</span><span class="token class-name">Proposal</span> proposal<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>INFORM<span class="token punctuation">,</span> proposal<span class="token punctuation">.</span>request<span class="token punctuation">.</span>zxid<span class="token punctuation">,</span> proposal<span class="token punctuation">.</span>packet<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">sendObserverPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>通知CommitProcessor该请求已Commit。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">zk<span class="token punctuation">.</span>commitProcessor<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><h4 id="CommitProcessor"><a href="#CommitProcessor" class="headerlink" title="CommitProcessor"></a>CommitProcessor</h4><p>CommitProcessor用于管理Session需要Commit的请求，该Processor Leader和Follower节点共用，CommitProcessor有自己的运行线程。</p><ul><li>接收到Request后，若该Request需要Commit，或者该Session中存在pendingRequest,则将该Request添加到对应Session的pendingRequest中。否则，直接将Request发送给下一个Processor。该处理方法能保证同一个Session 处理Request的顺序，例如该Session先发送了一个修改数据库的操作，又发送一个读数据库的操作，读的操作肯定会在写操作之后。</li><li>CommitProcessor收到某个Request已经Commit之后，（如上，Leader将Commit发送给Follower之后，或者Follower接收到Leader发送的Commit），将Commit的请求转发给下一个Processor。Follower和Leader都有两种Commit的请求。<ul><li>Follower Commit请求类型<ul><li>自己节点上的Session发送的修改数据库的请求。此种情况下，该Session对应的pendingReqeust的第一个Request肯定是Commit请求；</li><li>或者是Leader发送的其他节点接收到的修改数据库的请求，此种情况无对应的pendingRequest，触发入口来自Follower.processPacket。</li></ul></li><li>Leader Commit请求类型<ul><li>自己节点上Session发送的修改数据库请求。</li><li>Follower节点转发的，但是处理流程和自己节点上接收到的一样，触发入口来自LearnerHander.run调用LeaderZooKeeperServer.submitLearnerRequest。</li></ul></li></ul></li><li>CommitProcessor将已经Commit的Request发送给下一个Processor，并且将该Session上pendingRequest随后的读请求转发给下一个Processor。</li></ul><h4 id="Leader-TobeAppliedRequestProcessor"><a href="#Leader-TobeAppliedRequestProcessor" class="headerlink" title="Leader.TobeAppliedRequestProcessor"></a>Leader.TobeAppliedRequestProcessor</h4><p>在Commit Request之前，Leader会记录已Commit但未修改到数据库的写操作Proposal，该记录用于Follower和Leader选举之后的同步数据。本Processor的作用就是在操作数据库之前清除保存的Proposal信息。</p><h4 id="FinalRequestProcessor"><a href="#FinalRequestProcessor" class="headerlink" title="FinalRequestProcessor"></a>FinalRequestProcessor</h4><p>FinalRequestProcessor是操作数据库来响应对应的读或写操作。</p><h3 id="Follower处理请求流程"><a href="#Follower处理请求流程" class="headerlink" title="Follower处理请求流程"></a>Follower处理请求流程</h3><p>CommitProcessor和FinalRequestProcessor前面已说明，所以此处只用介绍FollowerRequestProcessor。</p><h4 id="FollowerRequestProcessor"><a href="#FollowerRequestProcessor" class="headerlink" title="FollowerRequestProcessor"></a>FollowerRequestProcessor</h4><p>FollowerRequestProcessor运行于独立的线程中。主要工作如下:</p><ul><li>提交Request时，如果Request是local session，且创建了临时节点，则升级session到Global类型，并且插入一个createSession request。</li><li>将Request转发到CommitProcessor。</li><li>如果为写请求，转发到Leader。</li></ul>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-4.客户端连接管理</title>
      <link href="2020/04/29/zk/zkSrc_serverCnxn/"/>
      <url>2020/04/29/zk/zkSrc_serverCnxn/</url>
      
        <content type="html"><![CDATA[<p>默认使用NIO，可配置为Netty</p><img src="/2020/04/29/zk/zkSrc_serverCnxn/client_cnxn_class.png" class=""><p>configure在QuorumPeerMain中调用，入口在QuorumPeer.startServerCnxnFactory</p><p>Factory使用Set&lt;ServerCnxn&gt;保存所有ServerCnxn</p><p>NIO Factory 使用一个AcceptThread接受所有连接，按照round-robin分配到Collection&lt;SelectorThread&gt;，每个SelectorThread创建一个NIOServerCnxn，通过WorkerService调度执行<br>Netty Factory 为pipeline添加@Sharable的CnxnChannelHandler处理函数，每个新连接创建NettyServerCnxn处理，</p><hr><h2 id="Netty实现"><a href="#Netty实现" class="headerlink" title="Netty实现"></a>Netty实现</h2><h3 id="启动服务器"><a href="#启动服务器" class="headerlink" title="启动服务器"></a>启动服务器</h3><p>客户端的网络事件NettyServerCnxnFactory.CnxnChannelHandler</p><h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>有新客户端连接，调用NettyServerCnxnFactory.CnxnChannelHandler.channelActive，新建NettyServerCnxn实例并保存</p><h3 id="处理客户端数据"><a href="#处理客户端数据" class="headerlink" title="处理客户端数据"></a>处理客户端数据</h3><p>NettyServerCnxn使用原子变量throttled，表示是否处理用户发送的请求。例如若客户端的连接未建立完成，则不会处理客户端的请求</p><h4 id="接收客户端数据"><a href="#接收客户端数据" class="headerlink" title="接收客户端数据"></a>接收客户端数据</h4><p>当服务器接收到数据时，调用NettyServerCnxnFactory.CnxnChannelHandler.processMessage接口。处理流程为</p><img src="/2020/04/29/zk/zkSrc_serverCnxn/receive_data_flow.png" class=""><h4 id="处理数据流程"><a href="#处理数据流程" class="headerlink" title="处理数据流程"></a>处理数据流程</h4><p>处理数据接口为NettyServerCnxn.receiveMessage。有两个ByteBuffer用来保存客户端发送过来的数据。处理流程为</p><ul><li>bbLen用于保存数据长度，或者判断请求是否是Command。对于普通的请求，前4个字节(Integer型长度)是请求数据长度；而对于Command，使用The Four Letter Words形式，即命令占用4个字节，正好是一个Integer型长度。bbLen固定为4Byte缓冲区。</li><li>bb用户保存请求的数据，该缓冲区默认为null。<ul><li>!initialized， 调用ZooKeeperServer.processConnectRequest</li><li>initialized， 调用ZooKeeperServer.processPacket</li></ul></li></ul><img src="/2020/04/29/zk/zkSrc_serverCnxn/process_data_flow.png" class=""><h4 id="返回数据"><a href="#返回数据" class="headerlink" title="返回数据"></a>返回数据</h4><p>在ZooKeeperServer.processPacket中调用NettyServerCnxn.sendResponse返回结果给客户端。</p><h4 id="Watch通知"><a href="#Watch通知" class="headerlink" title="Watch通知"></a>Watch通知</h4><p>zookeeper client可以监听数据的生命周期以及数据变化，client监听数据时，FinalRequestProcessor会调用ZKdatabase.setWatches将ServerCnxn添加到监听列表。当有事件发生时，会调用ServerCnxn.process发送数据回client。</p>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-3.状态转换</title>
      <link href="2020/04/29/zk/zkSrc_state/"/>
      <url>2020/04/29/zk/zkSrc_state/</url>
      
        <content type="html"><![CDATA[<p>在选举完成后，进入FOLLOWING或LEADING状态。在其能对外提供服务之前，需要对各个服务器之间状态进行同步，使服务器的数据保持一致。</p><hr><h2 id="Leader同步"><a href="#Leader同步" class="headerlink" title="Leader同步"></a>Leader同步</h2><img src="/2020/04/29/zk/zkSrc_state/leader_sync.png" class=""><p>在创建Leader对象时，会创建Leader监听的socket，在LeanerCnxAcceptor中会accept该连接，并且创建LearnerHandler的实例，该实例会新建线程，并处理和该新建的连接通信。</p><hr><h2 id="Follower同步"><a href="#Follower同步" class="headerlink" title="Follower同步"></a>Follower同步</h2><img src="/2020/04/29/zk/zkSrc_state/follower_sync.png" class=""><hr><h2 id="tcp报文-FastLeaderElection-buildMsg"><a href="#tcp报文-FastLeaderElection-buildMsg" class="headerlink" title="tcp报文 FastLeaderElection::buildMsg"></a>tcp报文 FastLeaderElection::buildMsg</h2><p>length-&gt;ByteBuffer</p><p>ByteBuffer[state, leader, zxid, electionEpoch, epoch, version, configDataLength, configData]</p><hr><h2 id="lastMessageSent-异常重启时重发最后消息，重复消息可正确处理"><a href="#lastMessageSent-异常重启时重发最后消息，重复消息可正确处理" class="headerlink" title="lastMessageSent 异常重启时重发最后消息，重复消息可正确处理"></a>lastMessageSent 异常重启时重发最后消息，重复消息可正确处理</h2><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">&gt;</span></span> bq <span class="token operator">=</span> queueSendMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>bq <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isSendQueueEmpty</span><span class="token punctuation">(</span>bq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ByteBuffer</span> b <span class="token operator">=</span> lastMessageSent<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Attempting to send lastMessage to sid={}"</span><span class="token punctuation">,</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">send</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="状态同步"><a href="#状态同步" class="headerlink" title="状态同步"></a>状态同步</h2><img src="/2020/04/29/zk/zkSrc_state/sync_detail.png" class=""><blockquote><h3 id="FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程"><a href="#FOLLOW-registerWithLeader-Leader-FOLLOWERINFO-状态同步流程" class="headerlink" title="FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程"></a>FOLLOW registerWithLeader(Leader.FOLLOWERINFO) 状态同步流程</h3></blockquote><ul><li>Follower节点在建立到Leader的连接后，立即发送<strong>FollowerInfo</strong>,数据中包括自身节点类型，zxid，协议号(0x10000)，以及节点ID(sid)。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">registerWithLeader</span><span class="token punctuation">(</span><span class="token keyword">int</span> pktType<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">/*     * Send follower info, including last zxid and sid     */</span>    <span class="token keyword">long</span> lastLoggedZxid <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">getLastLoggedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">QuorumPacket</span> qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    qp<span class="token punctuation">.</span><span class="token function">setType</span><span class="token punctuation">(</span>pktType<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// FOLLOWERINFO 或 OBSERVERINFO</span>    qp<span class="token punctuation">.</span><span class="token function">setZxid</span><span class="token punctuation">(</span><span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">/*     * Add sid to payload     */</span>    <span class="token comment">// 协议固定0x10000</span>    <span class="token class-name">LearnerInfo</span> li <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LearnerInfo</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x10000</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ByteArrayOutputStream</span> bsid <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">BinaryOutputArchive</span> boa <span class="token operator">=</span> <span class="token class-name">BinaryOutputArchive</span><span class="token punctuation">.</span><span class="token function">getArchive</span><span class="token punctuation">(</span>bsid<span class="token punctuation">)</span><span class="token punctuation">;</span>    boa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>li<span class="token punctuation">,</span> <span class="token string">"LearnerInfo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    qp<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>bsid<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 发送FollowerInfo 或 OBSERVERINFO</span>    <span class="token function">writePacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Leader回复<strong>LeaderInfo</strong>信息，信息包括zxid,以及版本号</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> ver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ver<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token number">0x10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">QuorumPacket</span> newEpochPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>LEADERINFO<span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> ver<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>newEpochPacket<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>messageTracker<span class="token punctuation">.</span><span class="token function">trackSent</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>LEADERINFO<span class="token punctuation">)</span><span class="token punctuation">;</span>bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Follower回复<strong>ACKEPOCH</strong>,信息包括lastLoggedZxid，epoch信息。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token function">readPacket</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">final</span> <span class="token keyword">long</span> newEpoch <span class="token operator">=</span> <span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">getEpochFromZxid</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>LEADERINFO<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// we are connected to a 1.0 server so accept the new epoch and read the next packet</span>    leaderProtocolVersion <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0x10000</span>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> epochBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> wrappedEpochBytes <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>epochBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>newEpoch <span class="token operator">&gt;</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        wrappedEpochBytes<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> self<span class="token punctuation">.</span><span class="token function">getCurrentEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        self<span class="token punctuation">.</span><span class="token function">setAcceptedEpoch</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>newEpoch <span class="token operator">==</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// since we have already acked an epoch equal to the leaders, we cannot ack</span>        <span class="token comment">// again, but we still need to send our lastZxid to the leader so that we can</span>        <span class="token comment">// sync with it if it does assume leadership of the epoch.</span>        <span class="token comment">// the -1 indicates that this reply should not count as an ack for the new epoch</span>        wrappedEpochBytes<span class="token punctuation">.</span><span class="token function">putInt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">"Leaders epoch, "</span>                              <span class="token operator">+</span> newEpoch                              <span class="token operator">+</span> <span class="token string">" is less than accepted epoch, "</span>                              <span class="token operator">+</span> self<span class="token punctuation">.</span><span class="token function">getAcceptedEpoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">QuorumPacket</span> ackNewEpoch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>ACKEPOCH<span class="token punctuation">,</span> lastLoggedZxid<span class="token punctuation">,</span> epochBytes<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">writePacket</span><span class="token punctuation">(</span>ackNewEpoch<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token class-name">ZxidUtils</span><span class="token punctuation">.</span><span class="token function">makeZxid</span><span class="token punctuation">(</span>newEpoch<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Leader等待超过半数节点回复的<strong>ACKEPOCH</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">QuorumPacket</span> ackEpochPacket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>messageTracker<span class="token punctuation">.</span><span class="token function">trackReceived</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>ACKEPOCH<span class="token punctuation">)</span> <span class="token punctuation">{</span>    LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"{} is not ACKEPOCH"</span><span class="token punctuation">,</span> ackEpochPacket<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token class-name">ByteBuffer</span> bbepoch <span class="token operator">=</span> <span class="token class-name">ByteBuffer</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>ackEpochPacket<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ss <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StateSummary</span><span class="token punctuation">(</span>bbepoch<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ackEpochPacket<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>learnerMaster<span class="token punctuation">.</span><span class="token function">waitForEpochAck</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ss<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><h3 id="FOLLOW-syncWithLeader-newEpochZxid-状态同步流程"><a href="#FOLLOW-syncWithLeader-newEpochZxid-状态同步流程" class="headerlink" title="FOLLOW syncWithLeader(newEpochZxid) 状态同步流程"></a>FOLLOW syncWithLeader(newEpochZxid) 状态同步流程</h3></blockquote><ul><li>Leader会根据Follower发送的zxid信息，判断采用何种方式和Follower同步数据，并将同步数据的Request添加到队列。注意，此时消息并未发送，只是添加到队列。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">peerLastZxid <span class="token operator">=</span> ss<span class="token punctuation">.</span><span class="token function">getLastZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Take any necessary action if we need to send TRUNC or DIFF</span><span class="token comment">// startForwarding() will be called in all cases</span><span class="token keyword">boolean</span> needSnap <span class="token operator">=</span> <span class="token function">syncFollower</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">,</span> learnerMaster<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">/*     * It is possible that committedLog is empty. In that case     * setting these value to the latest txn in learnerMaster db     * will reduce the case that we need to handle     *     * Here is how each case handle by the if block below     * 1. lastProcessZxid == peerZxid -&gt; Handle by (2)     * 2. lastProcessZxid &lt; peerZxid -&gt; Handle by (3)     * 3. lastProcessZxid &gt; peerZxid -&gt; Handle by (5)     */</span>    minCommittedLog <span class="token operator">=</span> lastProcessedZxid<span class="token punctuation">;</span>    maxCommittedLog <span class="token operator">=</span> lastProcessedZxid<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">/* * Here are the cases that we want to handle * * 1. Force sending snapshot (for testing purpose) * 2. Peer and learnerMaster is already sync, send empty diff * 3. Follower has txn that we haven't seen. This may be old leader *    so we need to send TRUNC. However, if peer has newEpochZxid, *    we cannot send TRUNC since the follower has no txnlog * 4. Follower is within committedLog range or already in-sync. *    We may need to send DIFF or TRUNC depending on follower's zxid *    We always send empty DIFF if follower is already in-sync * 5. Follower missed the committedLog. We will try to use on-disk *    txnlog + committedLog to sync with follower. If that fail, *    we will send snapshot */</span>needSnap <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>forceSnapSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// for testing purpose</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>lastProcessedZxid <span class="token operator">==</span> peerLastZxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 若Follower的事务id和Leader一样，则发送Leader.DIFF，表示不需要同步数据</span>    <span class="token function">queueOpPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>DIFF<span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">;</span>    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>peerLastZxid <span class="token operator">&gt;</span> maxCommittedLog <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isPeerNewEpochZxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 若Follower的事务id &gt; Leader事务id，则发送Leader.TRUNC，截断Follower的数据，使其和Leader保持一致</span>    <span class="token function">queueOpPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>TRUNC<span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>maxCommittedLog <span class="token operator">&gt;=</span> peerLastZxid<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>minCommittedLog <span class="token operator">&lt;=</span> peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 若minCommittedLog &lt;= Follower事务id &lt;= maxCommittedLog, 则从ZKDatabase缓存中获取请求，将需要同步的每条请求先发送一条Proposal，再发送一条Commit。</span>    LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Using committedLog for peer sid: {}"</span><span class="token punctuation">,</span> <span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> itr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>itr<span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>    needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>peerLastZxid <span class="token operator">&lt;</span> minCommittedLog <span class="token operator">&amp;&amp;</span> txnLogSyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// 若Follower事务id &lt; minCommittedLog, 则会从事务日志和ZKDatabase缓存中获取请求同步到Follower，每条请求也是先发送一条Proposal，再发送一条Commit。</span>    <span class="token comment">// Use txnlog and committedLog to sync</span>    <span class="token comment">// Calculate sizeLimit that we allow to retrieve txnlog from disk</span>    <span class="token keyword">long</span> sizeLimit <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">calculateTxnLogSizeLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// This method can return empty iterator if the requested zxid</span>    <span class="token comment">// is older than on-disk txnlog</span>    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> txnLogItr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getProposalsFromTxnLog</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">,</span> sizeLimit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>txnLogItr<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 非空</span>        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Use txnlog and committedLog for peer sid: {}"</span><span class="token punctuation">,</span> <span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 从 disk事务日志 同步</span>        currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>txnLogItr<span class="token punctuation">,</span> peerLastZxid<span class="token punctuation">,</span> minCommittedLog<span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>currentZxid <span class="token operator">&lt;</span> minCommittedLog<span class="token punctuation">)</span> <span class="token punctuation">{</span>            LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>                <span class="token string">"Detected gap between end of txnlog: 0x{} and start of committedLog: 0x{}"</span><span class="token punctuation">,</span>                <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>currentZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>minCommittedLog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            currentZxid <span class="token operator">=</span> peerLastZxid<span class="token punctuation">;</span>            <span class="token comment">// 退回为snap</span>            queuedPackets<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            needOpPacket <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Queueing committedLog 0x{}"</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>currentZxid<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 从 ZKDatabase缓存 同步</span>            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Proposal</span><span class="token punctuation">&gt;</span></span> committedLogItr <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">getCommittedLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            currentZxid <span class="token operator">=</span> <span class="token function">queueCommittedProposals</span><span class="token punctuation">(</span>committedLogItr<span class="token punctuation">,</span> currentZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> maxCommittedLog<span class="token punctuation">)</span><span class="token punctuation">;</span>            needSnap <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">// closing the resources</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>txnLogItr <span class="token keyword">instanceof</span> <span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">TxnLogProposalIterator</span> txnProposalItr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">TxnLogProposalIterator</span><span class="token punctuation">)</span> txnLogItr<span class="token punctuation">;</span>        txnProposalItr<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>如果最后需要snap，发送<strong>snap</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span>needSnap<span class="token punctuation">)</span> <span class="token punctuation">{</span>    syncThrottler <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getLearnerSnapSyncThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncThrottler<span class="token punctuation">.</span><span class="token function">beginSync</span><span class="token punctuation">(</span>exemptFromThrottle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">try</span> <span class="token punctuation">{</span>        <span class="token keyword">long</span> zxidToSend <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDataTreeLastProcessedZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        oa<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>SNAP<span class="token punctuation">,</span> zxidToSend<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        messageTracker<span class="token punctuation">.</span><span class="token function">trackSent</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>SNAP<span class="token punctuation">)</span><span class="token punctuation">;</span>        bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        LOG<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>            <span class="token string">"Sending snapshot last zxid of peer is 0x{}, zxid of leader is 0x{}, "</span>                <span class="token operator">+</span> <span class="token string">"send zxid of db as 0x{}, {} concurrent snapshot sync, "</span>                <span class="token operator">+</span> <span class="token string">"snapshot sync was {} from throttle"</span><span class="token punctuation">,</span>            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>peerLastZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>leaderLastZxid<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>zxidToSend<span class="token punctuation">)</span><span class="token punctuation">,</span>            syncThrottler<span class="token punctuation">.</span><span class="token function">getSyncInProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            exemptFromThrottle <span class="token operator">?</span> <span class="token string">"exempt"</span> <span class="token operator">:</span> <span class="token string">"not exempt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// Dump data to peer</span>        learnerMaster<span class="token punctuation">.</span><span class="token function">getZKDatabase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">serializeSnapshot</span><span class="token punctuation">(</span>oa<span class="token punctuation">)</span><span class="token punctuation">;</span>        oa<span class="token punctuation">.</span><span class="token function">writeString</span><span class="token punctuation">(</span><span class="token string">"BenWasHere"</span><span class="token punctuation">,</span> <span class="token string">"signature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>        <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SNAP_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    syncThrottler <span class="token operator">=</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getLearnerDiffSyncThrottler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    syncThrottler<span class="token punctuation">.</span><span class="token function">beginSync</span><span class="token punctuation">(</span>exemptFromThrottle<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ServerMetrics</span><span class="token punctuation">.</span><span class="token function">getMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>DIFF_COUNT<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>将<strong>NEWLEADER</strong>添加到队列。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">QuorumPacket</span> newLeaderQP <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>NEWLEADER<span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> learnerMaster<span class="token punctuation">.</span><span class="token function">getQuorumVerifierBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>newLeaderQP<span class="token punctuation">)</span><span class="token punctuation">;</span>bufferedOutput<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>发送队列的消息，因为同步数据的队列在前，<strong>NEWLEADER</strong>在后，所以会先和Follower同步数据，再发送<strong>NEWLEADER</strong>。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// Start thread that blast packets in the queue to learner</span><span class="token function">startSendingPackets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>Follower收到<strong>NEWLEADER</strong>后回复<strong>ACK</strong>。</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>NEWLEADER<span class="token operator">:</span>    <span class="token function">writePacket</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>ACK<span class="token punctuation">,</span> newLeaderZxid<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><ul><li>Leader 等待大部分节点回复<strong>ACK</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * Have to wait for the first ACK, wait until * the learnerMaster is ready, and only then we can * start processing messages. */</span>qp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>ia<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>qp<span class="token punctuation">,</span> <span class="token string">"packet"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>messageTracker<span class="token punctuation">.</span><span class="token function">trackReceived</span><span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>ACK<span class="token punctuation">)</span> <span class="token punctuation">{</span>    LOG<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Next packet was supposed to be an ACK, but received packet: {}"</span><span class="token punctuation">,</span> <span class="token function">packetToString</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span>LOG<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Received NEWLEADER-ACK message from {}"</span><span class="token punctuation">,</span> sid<span class="token punctuation">)</span><span class="token punctuation">;</span>learnerMaster<span class="token punctuation">.</span><span class="token function">waitForNewLeaderAck</span><span class="token punctuation">(</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> qp<span class="token punctuation">.</span><span class="token function">getZxid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>Leader发送<strong>UPTODATE</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java">queuedPackets<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">QuorumPacket</span><span class="token punctuation">(</span><span class="token class-name">Leader</span><span class="token punctuation">.</span>UPTODATE<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li>FOLLOW接收<strong>UPTODATE</strong></li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>UPTODATE<span class="token operator">:</span>    self<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span>    self<span class="token punctuation">.</span>adminServer<span class="token punctuation">.</span><span class="token function">setZooKeeperServer</span><span class="token punctuation">(</span>zk<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">break</span> outerLoop<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>在上述步骤完成后，集群状态已经稳定，可以对外提供服务。<br>心跳检测逻辑</p><pre class="line-numbers language-java" data-language="java"><code class="language-java">    <span class="token comment">// We ping twice a tick, so we only update the tick every other</span>    <span class="token comment">// iteration</span>    <span class="token keyword">boolean</span> tickSkip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token comment">// If not null then shutdown this leader</span>    <span class="token class-name">String</span> shutdownMessage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">long</span> cur <span class="token operator">=</span> start<span class="token punctuation">;</span>            <span class="token keyword">long</span> end <span class="token operator">=</span> start <span class="token operator">+</span> self<span class="token punctuation">.</span>tickTime <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">wait</span><span class="token punctuation">(</span>end <span class="token operator">-</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>                cur <span class="token operator">=</span> <span class="token class-name">Time</span><span class="token punctuation">.</span><span class="token function">currentElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip<span class="token punctuation">)</span> <span class="token punctuation">{</span>                self<span class="token punctuation">.</span>tick<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// 使用SyncedLearnerTracker来确认自己是否维持着quorum</span>            <span class="token class-name">SyncedLearnerTracker</span> syncedAckSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncedLearnerTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            syncedAckSet<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span>                <span class="token operator">&amp;&amp;</span> self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> self<span class="token punctuation">.</span><span class="token function">getQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                syncedAckSet<span class="token punctuation">.</span><span class="token function">addQuorumVerifier</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getLastSeenQuorumVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            syncedAckSet<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 检测每个追随者</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LearnerHandler</span> f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// current tick &lt;= tick+syncLimit</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">synced</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    syncedAckSet<span class="token punctuation">.</span><span class="token function">addAck</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span><span class="token function">getSid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token comment">// check leader running status</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// set shutdown flag</span>                shutdownMessage <span class="token operator">=</span> <span class="token string">"Unexpected internal error"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tickSkip <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>syncedAckSet<span class="token punctuation">.</span><span class="token function">hasAllQuorums</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token comment">// quorum没过半数，退出leader</span>                shutdownMessage <span class="token operator">=</span> <span class="token string">"Not sufficient followers synced, only synced with sids: [ "</span>                                  <span class="token operator">+</span> syncedAckSet<span class="token punctuation">.</span><span class="token function">ackSetsToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                  <span class="token operator">+</span> <span class="token string">" ]"</span><span class="token punctuation">;</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            tickSkip <span class="token operator">=</span> <span class="token operator">!</span>tickSkip<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// 1个tick time内ping两次</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">LearnerHandler</span> f <span class="token operator">:</span> <span class="token function">getLearners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            f<span class="token punctuation">.</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>``` java    <span class="token keyword">switch</span> <span class="token punctuation">(</span>qp<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">case</span> <span class="token class-name">Leader</span><span class="token punctuation">.</span>PING<span class="token operator">:</span>        <span class="token function">ping</span><span class="token punctuation">(</span>qp<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">break</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-2.启动和选举</title>
      <link href="2020/04/29/zk/zkSrc_election/"/>
      <url>2020/04/29/zk/zkSrc_election/</url>
      
        <content type="html"><![CDATA[<h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><ol><li>QuorumPeerMain读取config</li><li>调用QuorumPeer.start()</li><li>1 loadDataBase() 载入当前节点的数据库</li><li>2 startServerCnxnFactory() 启动客户端连接监听</li><li>3 startLeaderElection() 开始选举</li><li>4 调用run() 获取选举结果并执行响应</li></ol><h2 id="载入数据库"><a href="#载入数据库" class="headerlink" title="载入数据库"></a>载入数据库</h2><h2 id="启动客户端连接监听"><a href="#启动客户端连接监听" class="headerlink" title="启动客户端连接监听"></a>启动客户端连接监听</h2><p>监听分为两种模式，默认使用ServerCnxnFactory的NioServerCnxnFactory</p><ul><li>ServerCnxnFactory cnxnFactory<ul><li>NioServerCnxnFactory</li><li>NettyServerCnxnFactory</li></ul></li><li>ServerCnxnFactory secureCnxnFactory</li></ul><h2 id="选举"><a href="#选举" class="headerlink" title="选举"></a>选举</h2><p>节点启动时，节点状态初始化为ServerState.LOOKING，此时ZK会获取当前的Leader或者会发起一个选举。</p><img src="/2020/04/29/zk/zkSrc_election/peer_state.png" class=""><p>ZooKeeper实现了四种选举模式，默认选用FastLeaderElection</p><ol><li>LeaderElection</li><li>AuthFastLeaderElection with authenticate disabled</li><li>AuthFastLeaderElection with authenticate enabled</li><li>FastLeaderElection</li></ol><img src="/2020/04/29/zk/zkSrc_election/election_class.png" class=""><h3 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h3><p>QuorumVerifier用于检查一个服务器列表能否构成一个可用的服务器集群。实现类有</p><ul><li>QuorumMaj 简单过半投票，默认策略</li><li>QuorumHierarchical 基于权重投票策略</li></ul><p>QuorumMaj 主要接口如下:</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span> allMembers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span> votingMembers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span> observingMembers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">QuorumServer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>containsQuorum 选举的结果是否超过集群半数节点。</li><li>getAllMembers 获取集群中所有的节点。</li><li>getVotingMembers 获取集群中参与选举的节点。</li><li>getObservingMembers 获取集群中Observer节点。</li></ul><p>SyncedLearnerTracker用于FastLeaderElection中，保存集群和选举的映射关系。主要接口如下:</p><ul><li>addQuorumVerifier 添加集群信息</li><li>addAck 添加选举响应</li><li>hasAllQuorums 调用QuorumVerifier.containsQuorum()判断集群中参与选举的节点是否超过集群半数节点。</li></ul><p>节点中维护了两个QuorumVerifier的实例，分别是QuorumPeer类中的如下两个:</p><ul><li>quorumVerifier 最后Commit的节点的Verifier</li><li>lastSeenQuorumVerifier 最后Proposed节点的Verifier</li></ul><h3 id="FastLeaderElection实现"><a href="#FastLeaderElection实现" class="headerlink" title="FastLeaderElection实现"></a>FastLeaderElection实现</h3><img src="/2020/04/29/zk/zkSrc_election/fast_election_class.png" class=""><p>Election为选举基类，lookForLeader()会循环阻塞在LOOKING状态，一直到成功获取Leader节点。</p><ol><li>节点首先更新Proposed为自己，广播通知，并循环获取<code>recvqueue</code>队列通知</li><li>超时，重新广播通知</li><li>忽略不在自己members中的通知和OBSERVING的通知</li><li>收到LOOKING的通知</li><li>1 选举轮次超过自己，使用<code>选举策略</code>判断若超过<strong>自身</strong>信息，更新Proposed和轮次，清空<code>本轮票数</code>，广播通知</li><li>2 选举轮次落后自己，忽略</li><li>3 相同选举轮次，使用<code>选举策略</code>判断若超过<strong>当前Proposed</strong>信息，Proposed更新为新接受的选举信息，广播通知</li><li>4 如果<code>本轮票数</code>过半，且使用<code>选举策略</code>判断<code>recvqueue</code>中没有剩余超过<strong>当前Proposed</strong>信息的通知，设置LEADER信息(可能为自己)，退出选举；否则返回1</li><li>收到FOLLOWING和LEADING的通知</li><li>1 相同选举轮次，如果<code>本轮票数</code>过半，且收到过该Leader的通知(防止有节点选举已crash的非自身节点为Leader)，设置LEADER信息(可能为自己)，退出选举</li><li>2 非相同选举轮次，如果<code>非本轮票数</code>过半，且收到过该Leader的通知，设置LEADER信息，退出选举</li></ol><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/* * 选举策略 * We return true if one of the following three cases hold: * 1- New epoch is higher * 2- New epoch is the same as current epoch, but new zxid is higher * 3- New epoch is the same as current epoch, new zxid is the same *  as current zxid, but server id is higher. */</span><span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newEpoch <span class="token operator">&gt;</span> curEpoch<span class="token punctuation">)</span>        <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newEpoch <span class="token operator">==</span> curEpoch<span class="token punctuation">)</span>            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newZxid <span class="token operator">&gt;</span> curZxid<span class="token punctuation">)</span>                <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>newZxid <span class="token operator">==</span> curZxid<span class="token punctuation">)</span>                    <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>newId <span class="token operator">&gt;</span> curId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>QuorumCnxManager负责选举中的连接管理，该类包含三个inner class。</p><ul><li>Listener 负责监接收新连接，并且管理连接，在单独的线程运行。</li><li>SendWorker 负责发送数据到其他节点，所发送的数据由FastLeaderElection提供，在单独的线程运行。</li><li>RecvWorker 负责从其他节点接收数据，并且将数据发送给FastLeaderElection，在单独的线程运行。</li></ul><p>FastLeaderElection负责选举的算法处理，该类包含如下主要inner class。</p><ul><li>Messenger 发送和接收数据的管理类。注意，此处的发送和接收数据更关注的是打包和解包相关的逻辑，而不和网络相关，网络相关的部分由QuorumCnxManager负责。</li><li>WorkerSender 负责打包选举数据，发送到其他节点，在单独的线程运行。</li><li>WorkerReceiver 负责解析接收到数据，并根据结果反馈对应的ACK，在单独的线程运行。</li></ul><blockquote><p>WorkerSender和WorkerReceiver为守护线程</p></blockquote><p><strong>选举启动流程:</strong>  </p><img src="/2020/04/29/zk/zkSrc_election/fast_election_flow.png" class=""><p>FastLeader启动后：  </p><ul><li>创建QuorumCnxManager实例，并且开始监听其他节点新建的连接。</li><li>创建FastLeaderElection实例，并且开启发送和接收数据的线程。(Messenger类会启动WorkerSender和WorkReceiver的线程)</li></ul><p><strong>触发选举:</strong></p><p>新启动节点的状态为LOOKING，在节点主线程启动后(QuorumPeer.run)，调用Election的lookForLeader方法获取Leader信息。</p><p>发送数据到其他节点的数据流向：</p><img src="/2020/04/29/zk/zkSrc_election/send_flow.png" class=""><p>详细时序图：</p><img src="/2020/04/29/zk/zkSrc_election/send_seq.png" class=""><p>当FastLeaderElection要发送数据时，会通过向sendqueue发送数据来异步调用 WorkerSender.process。<br>在QuorumCnxManager.toSend的实现中，若到发送目标节点的连接不存在，则会主动建立连接。<br>QuorumCnxManager调用connectOne通过将数据添加到发送列表来异步调用SendWorker.send。</p><p>在发送端建立连接时，首先会发送一个头信息，包括：</p><ul><li>版本信息</li><li>前节点的server id</li><li>ip地址信息</li></ul><p>详细信息详见QuorumCnxManager.initiateConnection</p><p>接收方收到连接的时序图：</p><img src="/2020/04/29/zk/zkSrc_election/listen_seq.png" class=""><p>在接收端收到新连接时，首先会解析发送方发送的头信息。为了保证两个节点之间只有一个连接（即不会出现A建立连接到B，同时B也建立连接到A），zk会检查建立连接的节点的id。若发起连接的节点id小于当前节点，zk会断开这连接，并且主动建立一个到对方节点的连接。</p><p>接收数据的流向为:</p><img src="/2020/04/29/zk/zkSrc_election/recv_flow.png" class=""><p>详细时序图：</p><img src="/2020/04/29/zk/zkSrc_election/recv_seq.png" class=""><p>RecvWorker在收到数据后，调用addToRecvQueue将数据添加到队列，WorkerReceiver从队列取数据处理。WorkerReceiver处理逻辑如下:</p><ul><li>检查对方节点是否参与选举，不参与选举的话直接返回当前节点的结果。</li><li>若当前节点也在LOOKING状态，则将对方节点选举的结果添加到接收队列。若对方节点处于LOOKING状态，且electionEpoch落后于当前节点logicalclock，则发送当前节点的proposed选举信息到对方节点。</li><li>若当前节点处于选举成功状态(不是LOOKING状态)，则发送当前节点的选举结果到对方节点。</li></ul><h2 id="zxid以及ElectionEpoch"><a href="#zxid以及ElectionEpoch" class="headerlink" title="zxid以及ElectionEpoch"></a>zxid以及ElectionEpoch</h2><h3 id="zxid"><a href="#zxid" class="headerlink" title="zxid"></a>zxid</h3><p>选举中会使用到数据库中最新的事务id(ZKDatabase.getDataTreeLastProcessedZxid()), 事务id由两部分组成，高32位表示Epoch，每次有新的节点当选会+1(Leader.lead())；后32位为事务id，有新的节点当选，该部分会从0重新开始。当数据库有写操作时，整个事务id会+1（参考ZooKeeperServer.getNextZxid()的引用）</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZxidUtils</span> <span class="token punctuation">{</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getEpochFromZxid</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> zxid <span class="token operator">&gt;&gt;</span> <span class="token number">32L</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">getCounterFromZxid</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> zxid <span class="token operator">&amp;</span> <span class="token number">0</span>xffffffffL<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">makeZxid</span><span class="token punctuation">(</span><span class="token keyword">long</span> epoch<span class="token punctuation">,</span> <span class="token keyword">long</span> counter<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// 前32位表示Epoch，后32位表示当前Epoch的事务号，新Leader节点lead()函数epoch+1，count从0开始</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span>epoch <span class="token operator">&lt;&lt;</span> <span class="token number">32L</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>counter <span class="token operator">&amp;</span> <span class="token number">0</span>xffffffffL<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">zxidToString</span><span class="token punctuation">(</span><span class="token keyword">long</span> zxid<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toHexString</span><span class="token punctuation">(</span>zxid<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ElectionEpoch"><a href="#ElectionEpoch" class="headerlink" title="ElectionEpoch"></a>ElectionEpoch</h3><p>当前节点的ElectionEpoch定义于FastLeaderElection.logicalclock中，每发起一次新选举，该值会自+1。若其他节点选举信息中的ElectionEpoch大于当前节点，则会设置当前节点的值为接收到的值。</p><hr><h2 id="ZOOKEEPER-1732"><a href="#ZOOKEEPER-1732" class="headerlink" title="ZOOKEEPER-1732"></a>ZOOKEEPER-1732</h2><p>QuorumPeer.updateElectionVote<br>Vote.equals</p>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-1.架构</title>
      <link href="2020/04/29/zk/zkSrc_arch/"/>
      <url>2020/04/29/zk/zkSrc_arch/</url>
      
        <content type="html"><![CDATA[<h2 id="节点架构"><a href="#节点架构" class="headerlink" title="节点架构"></a>节点架构</h2><img src="/2020/04/29/zk/zkSrc_arch/%E8%8A%82%E7%82%B9%E6%9E%B6%E6%9E%84.png" class=""><ol><li>QuorumPeerMain<br>服务器启动main入口，创建DatadirCleanupManager，按照config启动QuorumPeer  </li><li>QuorumPeer<br>节点类，根据节点类型管理和启动对应服务，管理选举算法及客户端连接。</li><li>Election<br>QuorumPeer根据配置选取合适的选举算法。</li><li>ServerCnxnFactory<br>管理客户端连接，QuorumPeer根据配置选取合适的实现。</li><li>ZooKeeperServer<br>zk服务器节点，根据不同类型实现不同方法。</li><li>ZKDatabase<br>zk内存数据库，详细数据保存在DataTree类中。</li><li>RequestProcessor<br>客户端请求处理类，不同zk节点类型会定义不同的处理类。</li></ol><hr><h2 id="节点类型"><a href="#节点类型" class="headerlink" title="节点类型"></a>节点类型</h2><ul><li>Leader</li><li>Follower</li><li>Observer</li></ul><p>Leader和Follower参与新Leader的选举，Observer不参与选举。  </p><img src="/2020/04/29/zk/zkSrc_arch/%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B.png" class=""><h3 id="Leader节点"><a href="#Leader节点" class="headerlink" title="Leader节点"></a>Leader节点</h3><p>Leader负责数据的写操作和各节点数据一致性</p><img src="/2020/04/29/zk/zkSrc_arch/leader_class.png" class=""><h4 id="LeaderZooKeeperServer"><a href="#LeaderZooKeeperServer" class="headerlink" title="LeaderZooKeeperServer"></a>LeaderZooKeeperServer</h4><p>Leader节点对应的设置</p><h4 id="Leader"><a href="#Leader" class="headerlink" title="Leader"></a>Leader</h4><p>负责管理Leader相关逻辑的类。维护了一组LearnerHandler信息来处理和Learner的交互。</p><h4 id="LearnerHandler"><a href="#LearnerHandler" class="headerlink" title="LearnerHandler"></a>LearnerHandler</h4><p>LearnerHandler用来处理Leader和Learner之间的交互，例如发送Packets到Learner，从Learner接收Packet并处理等。</p><h4 id="Leader-Processors"><a href="#Leader-Processors" class="headerlink" title="Leader Processors"></a>Leader Processors</h4><p>Processor用来处理客户端的请求，Leader的firstProcessor为LeaderRequestProcessor的一个实例。处理Request使用的是职责链模式，Processor之间的虚线表示的是Request的处理流程。</p><h3 id="Follower节点"><a href="#Follower节点" class="headerlink" title="Follower节点"></a>Follower节点</h3><p>Follower节点对外提供服务，同时参与选举Leader。</p><h4 id="FollowerZooKeeperServer"><a href="#FollowerZooKeeperServer" class="headerlink" title="FollowerZooKeeperServer"></a>FollowerZooKeeperServer</h4><p>Follower节点对应的设置。</p><h4 id="Follower"><a href="#Follower" class="headerlink" title="Follower"></a>Follower</h4><p>负责Follower相关逻辑的类，主要用于管理和Leader节点的交互，如PING，PROPOSAL，COMMIT等Request的处理等。</p><h4 id="Follower-Processors"><a href="#Follower-Processors" class="headerlink" title="Follower Processors"></a>Follower Processors</h4><p>Follower的Processors主要用来处理来自客户端的请求，Follower的firstProcessor为FollowerRequestProcessor，也是职责链模式，流程处理由虚线表示。</p><h3 id="Observer节点"><a href="#Observer节点" class="headerlink" title="Observer节点"></a>Observer节点</h3><p>TODO</p>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>zookeeper源码-0.调试</title>
      <link href="2020/04/29/zk/zkSrc_debug/"/>
      <url>2020/04/29/zk/zkSrc_debug/</url>
      
        <content type="html"><![CDATA[<h2 id="使用intelliJ-IDEA调试-zookeeper源码"><a href="#使用intelliJ-IDEA调试-zookeeper源码" class="headerlink" title="使用intelliJ IDEA调试 zookeeper源码"></a>使用intelliJ IDEA调试 zookeeper源码</h2><p>zookeeper之前版本使用ant build，目前master的3.7.0版本开始改用mvn管理</p><p>将源码导入IDEA，导入方式选择maven</p><h2 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h2><p>IDEA右侧maven菜单，点击图标”Generate Sources and Update Folders For All Projects”，重新build</p><img src="/2020/04/29/zk/zkSrc_debug/src_build.png" class=""><h2 id="修改jre"><a href="#修改jre" class="headerlink" title="修改jre"></a>修改jre</h2><p>打开项目结构<strong>（⌘ + ;）</strong>，指定jdk为<code>1.8</code><br>若使用jdk13，不支持的com.sun.nio.file方法编译报错，<a href="https://github.com/apache/zookeeper/pull/1269" title="com.sun.nio.file.SensitivityWatchEventModifier" target="">issue</a></p><h2 id="修改gitignore文件"><a href="#修改gitignore文件" class="headerlink" title="修改gitignore文件"></a>修改gitignore文件</h2><p>由于开发环境需要进行调试，临时配置文件是不需要进代码仓库的，所以进行排除。</p><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell"># Ignore debug confconf/zoo.cfgconf/zoo*.cfgzookeeper-server/src/main/resources/log4j.properties<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h2 id="config配置"><a href="#config配置" class="headerlink" title="config配置"></a>config配置</h2><ol><li>拷贝zoo_sample.cfg文件至相同文件夹下，名为: zoo.cfg，配置全部使用默认</li><li>创建/tmp/zookeeper目录，用于存放zk数据；</li><li>拷贝log4j.properties文件至: zookeeper-server/src/main/resources，文件名还是log4j.properties不变</li><li>打开项目结构，将resources目录标记为Resources类型（不配置的话日志配置不生效）</li></ol><img src="/2020/04/29/zk/zkSrc_debug/src_resource_config.png" class=""><h2 id="debug启动项"><a href="#debug启动项" class="headerlink" title="debug启动项"></a>debug启动项</h2><pre class="line-numbers language-shell" data-language="shell"><code class="language-shell">QuorumPeerMainorg.apache.zookeeper.server.quorum.QuorumPeerMainconf/zoo.cfg<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><img src="/2020/04/29/zk/zkSrc_debug/src_debug_config.png" class=""><h2 id="info-version"><a href="#info-version" class="headerlink" title="info version"></a>info version</h2><p>src/main/java/org/apache/zookeeper/version/util/VerGen.java 的main方法用于生成Info.java版本信息</p><h2 id="启动报错"><a href="#启动报错" class="headerlink" title="启动报错"></a>启动报错</h2><p>Caused by: java.lang.ClassNotFoundException: com.codahale.metrics.Reservoir</p><p>AppClassLoader的URL中报错，临时改代码解决方法: 将QuorumPeerMain的main方法搬到test包中规避，debug启动项路径也调整至test</p>]]></content>
      
      
      <categories>
          
          <category> zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 源码 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
